<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>CONTRATISTAS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --primary:#06402B;
      --primary-2:#04281C;
      --ok:#16a34a;
      --error:#dc2626;
      --scrim:rgba(0,0,0,.35);
    }
    html,body{
      margin:0; padding:0; height:100%; width:100%;
      overflow-x:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
      background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905870/fondo_verde_tvntsi.png') center/cover fixed no-repeat;
    }
    .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

    .view{ display:none; opacity:0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      box-sizing:border-box; padding:16px;
    }
    .view.active{ display:block; opacity:1; transform: translateY(0); }

    .card{
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(3px);
      border: 2px solid #ddd; border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      max-width: 820px; margin: 16px auto; padding: 20px 20px 16px;
    }
    h1,h2,h3{ margin: 8px 0 12px; text-align:center; }
    p.helper{ color:#444; font-size:.95rem; text-align:center; margin:8px 0 16px; }
    label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
    input, select, textarea, button{
      width:100%; padding:12px; box-sizing:border-box;
      border:1.5px solid #ccc; border-radius:8px; background:#fff;
      outline:none; transition: border-color .2s ease, transform .08s ease;
      font-size:16px;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
    button{
      cursor:pointer; border:2px solid var(--primary);
      background:#fff; color:#000; font-weight:700;
    }
    button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-row{ display:flex; gap:12px; flex-wrap:wrap; }
    .btn-row > *{ flex:1; }
    .muted{ color:#666; font-size:.85rem; }
    .center{ text-align:center; }
    .image-center{ display:flex; justify-content:center; }
    .brand{ width:240px; border-radius:12px; display:block; margin:12px auto 4px; }
    .chip{
      padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
      background:#fff; font-weight:700; color:#000; text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .danger{ background:#e11; border-color:#e11; color:#fff; }

    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
    }
    .loader.hidden{ opacity:0; pointer-events:none; }
    .spinner-ios{ position:relative; width:64px; height:64px; }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px;
      opacity:.2; animation:iosFade 1.2s linear infinite; transform-origin: center center;
    }
    @keyframes iosFade{ 0%, 39%, 100% { opacity:.2; } 40% { opacity:1; } }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    .hidden{ display:none !important; }
    .narrow{ max-width: 560px; margin: 0 auto; }
    .spaced{ margin-top:12px; }

    /* Overlay Men√∫ */
    .overlay{ position: fixed; inset: 0; pointer-events:none; }
    .overlay .scrim{ position:absolute; inset:0; background:var(--scrim); opacity:0; transition:opacity .25s ease; }
    .overlay .panel{
      position:absolute; top:0; left:0; width:min(360px, 90vw); height:100%;
      background:#06402B; color:#fff; padding:16px 16px 8px 16px; box-sizing:border-box;
      transform: translateX(-100%); transition: transform .25s ease;
      display:flex; flex-direction:column; gap:10px; overflow-y:auto; min-height: 0;
    }
    .overlay.open{ pointer-events:auto; }
    .overlay.open .scrim{ opacity:1; }
    .overlay.open .panel{ transform: translateX(0); }
    .panel h3{ margin: 4px 0 8px; text-align:center; }
    .menu-btn{
      background:#7de3ef; color:#000; border:0; font-weight:800;
      border-radius:999px; padding:12px; box-shadow: 0 6px 12px rgba(0,0,0,.18);
    }

    .avatar-emoji{
      width:120px; height:120px; display:block; margin:0 auto;
      position:relative;
    }

    /* Notificaci√≥n estilo referencia: campana + badge y "Ponte al d√≠a" a la derecha del emoji */
    .notif-wrap{ position:absolute; right:-10px; top:-6px; }
    .notif-bell{
      width:28px; height:28px; display:none;
      animation:heartbeat 1.2s infinite;
    }
    .notif-bell.active{ display:block; }
    .notif-count{
      position:absolute; right:-6px; top:-6px;
      background:#e11; color:#fff; border-radius:999px; min-width:18px; height:18px; line-height:18px;
      text-align:center; padding:0 4px; font-size:12px; font-weight:800; display:none;
      box-shadow: 0 0 0 2px #fff;
    }
    .notif-count.active{ display:inline-block; }
    .notif-label{
      position:absolute; left:calc(100% + 6px); top:-6px;
      height:28px; line-height:28px; padding:0 10px;
      background:#7de3ef; color:#000; border-radius:999px;
      font-weight:800; font-size:14px; white-space:nowrap; display:none;
      animation:heartbeat 1.2s infinite;
      cursor: pointer;
    }
    .notif-label.active{ display:inline-block; }
    @keyframes heartbeat{
      0%{ transform: scale(1); }
      20%{ transform: scale(1.15); }
      40%{ transform: scale(1); }
      60%{ transform: scale(1.15); }
      100%{ transform: scale(1); }
    }

    @media (max-width: 700px){ .btn-row{ flex-direction:column; } }

    /* Picker modal reutilizado */
    .picker-modal { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .picker-box { width: 90%; max-width: 520px; background: #fff; border-radius: 8px; padding: 16px; }
    .picker-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 12px 0; }
    .picker-grid select { width: 100%; height: 180px; font-size: 16px; }
    .picker-actions { display:flex; gap: 8px; justify-content: flex-end; }
    .btn { padding: 8px 14px; border-radius: 6px; border: 1px solid #ddd; cursor: pointer; }
    .btn-ok { background: #16a34a; color: #fff; border-color: #16a34a; }
    .btn-cancel { background: #fff; color: #111; }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <div class="container">
    <!-- VISTA INSTALAR -->
    <section id="view-instalar" class="view">
      <div class="card narrow" style="text-align:center;">
        <h2 style="color:var(--primary);">APP CONTRATISTAS</h2>
        <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p style="font-weight:600;">Herramienta para Contratistas</p>
        <div class="btn-row" style="justify-content:center; margin-top:12px;">
          <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
        </div>
        <p class="center muted" style="margin-top:14px;">Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.</p>
      </div>
    </section>

    <!-- VISTA LOGIN -->
    <section id="view-login" class="view active">
      <div class="card narrow">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">CONTRATISTAS</h1>
        <p class="helper"><b>Acceso exclusivo para Contratistas activos.</b></p>

        <label>Contrase√±a</label>
        <div class="pwd-wrapper" style="position:relative;">
          <input id="login-doc" type="password" inputmode="numeric" autocomplete="off" placeholder="Sin puntos ni espacios" />
          <button type="button" id="toggle-doc" aria-label="Mostrar documento" style="position:absolute;top:50%;right:10px;transform:translateY(-50%);background:transparent;border:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:6px;">
            <img id="toggle-doc-img" src="https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png" alt="Mostrar" style="width:22px;height:22px;">
          </button>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
        </div>

        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA INICIO -->
    <section id="view-inicio" class="view">
      <div class="card narrow" style="position:relative;">
        <div class="btn-row" style="margin-bottom:12px;">
          <button class="chip danger" id="btn-logout">Cerrar Sesi√≥n</button>
          <button class="chip" id="btn-open-menu">MEN√ö</button>
        </div>

        <div class="image-center" style="position:relative;">
          <img class="avatar-emoji" id="emoji-user" src="https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png" alt="">
          <div class="notif-wrap">
            <img id="notif-bell" class="notif-bell" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759767447/Notificaci%C3%B3n_jtptyw.webp" alt="">
            <span id="notif-count" class="notif-count">0</span>
            <span id="notif-label" class="notif-label" title="Ponte al d√≠a">Ponte al d√≠a</span>
          </div>
        </div>

        <h2 id="inicio-nombre" style="color:var(--primary); font-weight:900; margin-top:6px;"></h2>
        <p id="inicio-sub" class="center muted" style="margin-top:0; font-weight:300;"></p>

        <div class="narrow" style="margin-top:10px;">
          <p><b>CC:</b> <span id="inicio-cc"></span></p>
          <p><b>CONTACTO:</b> <span id="inicio-contacto"></span></p>
          <p><b>DIRECCI√ìN:</b> <span id="inicio-direccion"></span></p>
          <p><b>CORREO:</b> <span id="inicio-correo"></span></p>
          <p><b>CUENTA N¬∞:</b> <span id="inicio-cuenta"></span></p>
          <p><b>EPS:</b> <span id="inicio-eps"></span></p>
          <p><b>AFP:</b> <span id="inicio-afp"></span></p>
          <p><b>ARL:</b> <span id="inicio-arl"></span></p>
          <p><b>SUPERVISOR:</b> <span id="inicio-supervisor"></span></p>
        </div>

        <img id="inicio-firma" class="brand" alt="Firma" src="" style="display:none; max-width:260px; border-radius:12px; border:1.5px solid #d8e4ff; margin-top:8px;" />
        <!-- Se elimina el bot√≥n inferior de ver noticias -->

        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- OVERLAY MEN√ö -->
    <div class="overlay" id="overlay">
      <div class="scrim" id="ovlClose"></div>
      <aside class="panel">
        <div class="btn-row">
          <button id="btn-ovl-back">ATR√ÅS</button>
        </div>
        <div class="image-center">
          <img alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" style="max-width:180px;border-radius:10px;" />
        </div>
        <h3>Selecciona una opci√≥n</h3>
        <button class="menu-btn" id="go-noticias">
          Ponte al d√≠a üìÖ
          <span id="go-feed-badge" class="notif-count" style="position:static; box-shadow:none; margin-left:8px;">0</span>
        </button>
        <button class="menu-btn" id="go-contrato">DATOS DEL CONTRATO üìÑ</button>
        <button class="menu-btn" id="go-personales">DATOS PERSONALES üë§</button>
        <div style="height:24px"></div>
        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </aside>
    </div>

    <!-- VISTA REGISTRO -->
    <section id="view-registro" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">COMPLETANDO REGISTRO</h2>

        <label>Municipio de Expedici√≥n del Documento</label>
        <input id="reg-expedida" list="dl-expedida" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
        <datalist id="dl-expedida"></datalist>

        <label>Tel√©fono L√≠nea WhatsApp</label>
        <input id="reg-telefono" type="tel" inputmode="numeric" placeholder="sin puntos ni espacios">

        <label>Direcci√≥n de Residencia</label>
        <textarea id="reg-direccion" rows="2" placeholder="Usa abreviaciones. No escribas el municipio. Ej: Mz 5 Casa 16 B/ Orqu√≠deas II."></textarea>

        <label>Municipio de Residencia</label>
        <input id="reg-municipio" list="dl-municipio" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
        <datalist id="dl-municipio"></datalist>

        <label>Correo Personal</label>
        <input id="reg-correo" type="email" placeholder="correo que te pertenezca">

        <label>Tipo de cuenta</label>
        <select id="reg-tipoCuenta">
          <option value="" disabled selected>Selecciona tipo de cuenta</option>
          <option>AHORROS</option><option>CORRIENTE</option>
        </select>

        <label>Numero de cuenta</label>
        <input id="reg-numeroCuenta" type="tel" inputmode="numeric" placeholder="Ingresa n√∫mero de cuenta">

        <label>Banco</label>
        <select id="reg-banco"></select>

        <label>EPS</label>
        <select id="reg-eps"></select>

        <label>Fondo de Pensiones (AFP)</label>
        <div class="muted" style="margin:6px 0 8px;">
          <b>S√≠ eres Pensionado(a), selecciona N/A</b><br>Esto implica que, en cada cuenta debes presentar alguno de los siguientes soportes:<br>- Certificaci√≥n de Pensionado(a)<br>- Resoluci√≥n de Pensi√≥n<br>- Certificaci√≥n de Devoluci√≥n del Saldo por Vejez.
        </div>
        <select id="reg-pension"></select>

        <label>ARL</label>
        <select id="reg-arl"></select>

        <label>Imagen de Firma</label>
        <input type="file" id="reg-firma" accept="image/*" />
        <img id="reg-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <label>Fecha de nacimiento</label>
        <input id="reg-cumple" type="text" placeholder="dd/mm/AAAA" required readonly onclick="abrirPickerNacimiento()" />
        <!-- Modal Nacimiento -->
        <div id="nacimientoModal" class="picker-modal" aria-hidden="true">
          <div class="picker-box">
            <h3 style="margin:0 0 8px 0;">Selecciona tu fecha de nacimiento</h3>
            <div class="picker-grid">
              <div>
                <small>D√≠a</small>
                <select id="pickerDiaNac" size="10"></select>
              </div>
              <div>
                <small>Mes</small>
                <select id="pickerMesNac" size="12"></select>
              </div>
              <div>
                <small>A√±o</small>
                <select id="pickerAnioNac" size="10"></select>
              </div>
            </div>
            <div class="picker-actions">
              <button type="button" class="btn btn-cancel" onclick="cancelarPickerNacimiento()">Cancelar</button>
              <button type="button" class="btn btn-ok" onclick="confirmarPickerNacimiento()">Ok</button>
            </div>
          </div>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="reg-guardar">Guardar</button>
          <button id="reg-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA DATOS DEL CONTRATO -->
    <section id="view-contrato" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">DATOS DEL CONTRATO</h2>

        <!-- Lectura: muestra todos los campos -->
        <div id="contrato-lectura" class="narrow"></div>

        <div class="btn-row spaced">
          <button id="contrato-editar" class="btn-primary">Actualizar</button>
          <button id="contrato-volver" class="danger">Regresar</button>
        </div>

        <!-- Form de edici√≥n: s√≥lo los campos solicitados -->
        <div id="contrato-form" class="hidden" style="margin-top:10px;">
          <label>Fecha de Inicio</label>
          <input id="c-fechaInicio" type="text" placeholder="dd/mm/2026" required readonly onclick="abrirPickerContratoInicio()">
          <input id="c-diaInicio" type="text" readonly style="display:none;">
          <input id="c-mesInicio" type="text" readonly style="display:none;">

          <label>Fecha de Terminaci√≥n</label>
          <input id="c-fechaTermino" type="text" placeholder="dd/mm/2026" required readonly onclick="abrirPickerContratoTermino()">
          <input id="c-diaTermino" type="text" readonly style="display:none;">
          <input id="c-mesTermino" type="text" readonly style="display:none;">

          <label>Meses de contrato</label>
          <input id="c-meses" type="tel" inputmode="numeric" placeholder="Autom√°tico; puedes editar">
          <label>D√≠as de complemento si Aplica</label>
          <input id="c-dias" type="tel" inputmode="numeric" placeholder="Autom√°tico; puedes editar">
          <label>Tiempo de ejecuci√≥n</label>
          <input id="c-ejecucion" type="text" readonly>

          <label>Registro Presupuestal (RP)</label>
          <input id="c-rp" type="tel" inputmode="numeric" placeholder="N¬∞ de RP" maxlength="10" style="border:1.5px solid #ccc;">

          <label>¬øR√©gimen SIMPLE?</label>
          <select id="c-costos" required>
            <option value="" disabled selected>Selecciona</option>
            <option value="SI tomar√© costos o deducciones.">SI</option>
            <option value="NO tomar√© costos o deducciones.">NO</option>
          </select>
          <input id="c-regimen" type="text" readonly style="display:none;">

          <div class="btn-row spaced" style="margin-top:12px;">
            <button id="c-guardar" class="btn-primary">Guardar Cambios</button>
            <button id="c-cancelar" class="danger">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Modales Fechas de Contrato -->
    <div id="fechaModalInicio" class="picker-modal" aria-hidden="true">
      <div class="picker-box">
        <h3 style="margin:0 0 8px 0;">Selecciona la fecha de inicio</h3>
        <div class="picker-grid">
          <div>
            <small>D√≠a</small>
            <select id="pickerDiaInicio" size="10"></select>
          </div>
          <div>
            <small>Mes</small>
            <select id="pickerMesInicio" size="12"></select>
          </div>
          <div>
            <small>A√±o</small>
            <select id="pickerAnioInicio" size="3" disabled>
              <option selected>2026</option>
            </select>
          </div>
        </div>
        <div class="picker-actions">
          <button type="button" class="btn btn-cancel" onclick="cancelarPickerContratoInicio()">Cancelar</button>
          <button type="button" class="btn btn-ok" onclick="confirmarPickerContratoInicio()">Ok</button>
        </div>
      </div>
    </div>
    <div id="fechaModalTermino" class="picker-modal" aria-hidden="true">
      <div class="picker-box">
        <h3 style="margin:0 0 8px 0;">Selecciona la fecha de terminaci√≥n</h3>
        <div class="picker-grid">
          <div>
            <small>D√≠a</small>
            <select id="pickerDiaTerm" size="10"></select>
          </div>
          <div>
            <small>Mes</small>
            <select id="pickerMesTerm" size="12"></select>
          </div>
          <div>
            <small>A√±o</small>
            <select id="pickerAnioTerm" size="3" disabled>
              <option selected>2026</option>
            </select>
          </div>
        </div>
        <div class="picker-actions">
          <button type="button" class="btn btn-cancel" onclick="cancelarPickerContratoTermino()">Cancelar</button>
          <button type="button" class="btn btn-ok" onclick="confirmarPickerContratoTermino()">Ok</button>
        </div>
      </div>
    </div>

    <!-- VISTA DATOS PERSONALES -->
    <section id="view-personales" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">Tus Datos Personales</h2>

        <div id="personales-lectura" class="narrow"></div>

        <div class="btn-row spaced">
          <button id="personales-editar" class="btn-primary">Actualizar</button>
          <button id="personales-volver" class="danger">Regresar</button>
        </div>

        <div id="personales-form" class="hidden" style="margin-top:10px;">
          <label>Municipio de Expedici√≥n del Documento</label>
          <input id="p-expedida" list="dl-expedida2" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
          <datalist id="dl-expedida2"></datalist>

          <label>Tel√©fono L√≠nea WhatsApp</label>
          <input id="p-telefono" type="tel" inputmode="numeric" placeholder="10 d√≠gitos">

          <label>Direcci√≥n de Residencia</label>
          <textarea id="p-direccion" rows="2" placeholder="Usa abreviaciones."></textarea>

          <label>Municipio de Residencia</label>
          <input id="p-municipio" list="dl-municipio2" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
          <datalist id="dl-municipio2"></datalist>

          <label>Correo Personal</label>
          <input id="p-correo" type="email" placeholder="correo que te pertenezca">

          <label>Tipo de cuenta</label>
          <select id="p-tipoCuenta">
            <option value="" disabled selected>Selecciona tipo de cuenta</option>
            <option>AHORROS</option><option>CORRIENTE</option>
          </select>

          <label>Numero de cuenta</label>
          <input id="p-numeroCuenta" type="tel" inputmode="numeric" placeholder="Ingresa n√∫mero de cuenta">

          <label>Banco</label>
          <select id="p-banco"></select>

          <label>EPS</label>
          <select id="p-eps"></select>

          <label>Fondo de Pensiones (AFP)</label>
          <select id="p-pension"></select>

          <label>ARL</label>
          <select id="p-arl"></select>

          <label>Actualizar Firma</label>
          <input type="file" id="p-firma" accept="image/*" />
          <img id="p-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

          <label>Fecha de nacimiento</label>
          <input id="p-cumple" type="text" placeholder="dd/mm/AAAA" required readonly onclick="abrirPickerNacimiento()" />

          <div class="btn-row spaced" style="margin-top:12px;">
            <button id="p-guardar" class="btn-primary">Guardar Cambios</button>
            <button id="p-cancelar" class="danger">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VISTA VER NOTICIAS (lista) -->
    <section id="view-noticias" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">¬°PONTE AL D√çA!</h2>
        <div id="feed-list" style="display:flex; flex-direction:column; gap:12px;"></div>
        <div class="btn-row spaced">
          <button id="feed-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA DETALLE NOTICIA -->
    <section id="view-noticia-detalle" class="view">
      <div class="card narrow" style="text-align:center;">
        <img id="fd-thumb" src="" alt="" style="width:180px; height:180px; object-fit:cover; border-radius:12px; border:1px solid #ddd; background:#eee; display:block; margin: 0 auto 10px;">
        <h3 id="fd-title" style="margin:6px 0 10px; color:#111; font-weight:900;">T√≠tulo</h3>
        <p id="fd-sub" class="muted" style="margin: 0 0 8px;"></p>
        <p id="fd-desc" style="text-align:justify; color:#222; white-space:pre-line;"></p>
        <div class="btn-row spaced" style="margin-top:12px;">
          <a id="fd-link" class="chip" href="#" target="_blank" rel="noopener" style="display:none;">Abrir V√≠nculo</a>
          <button id="fd-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>
  </div>

<script>
/* ================== CONFIGURACI√ìN ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbx5nz42xZ53WEM55Kmt_i9ngh9bn_qZjjHo3_Ub_nSz3MO0B8YDbapwk7s0LQhhnG0X/exec'; // Tu despliegue

/* ================== SONIDOS ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
  logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3',
  menu: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Namedrop_Popup_ale2zy.mp3',
  notify: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759767435/Notificacion_d1woxv.mp3'
};
function playSoundOnce(url){
  try{ const a=new Audio(url); a.preload='auto'; a.play().catch(()=>{}); }catch(e){}
}
if (window.Swal && typeof Swal.fire === 'function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options = {}, ...rest){
    try{
      const icon = options.icon || options.type;
      if (options.soundTag === 'resumen'){ playSoundOnce(SOUNDS.info); }
      else if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
    }catch(e){}
    return __fire(options, ...rest);
  }
}

/* ================== LOADER ================== */
const loader = document.getElementById('loader');
let loadingCount = 0, loaderTimer = null;
function startLoading(){
  loadingCount++;
  if (loadingCount === 1){
    loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer = null; }, 120);
  }
}
function stopLoading(){
  if (loadingCount === 0) return;
  loadingCount--;
  if (loadingCount === 0){
    if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
    loader.classList.add('hidden');
  }
}

/* ================== API ================== */
async function apiGet(action, params = {}, useLoader = true){
  if(useLoader) startLoading();
  try{
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({ action, ...params }).toString();
    const r = await fetch(url.toString(), { method: 'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { if(useLoader) stopLoading(); }
}
async function apiPost(action, body = {}){
  startLoading();
  try{
    const url = API_BASE + '?action=' + encodeURIComponent(action);
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}

/* ================== ESTADO ================== */
let currentUser = null;

/* ================== VISTAS ================== */
function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  document.getElementById(id)?.classList.add('active');
  overlay.classList.remove('open');
  window.scrollTo({ top: 0, behavior: 'smooth' });

  // Al entrar a inicio, refrescar badge si hay noticias cargadas
  if(id==='view-inicio'){ refreshNotificationsBadge(); }
}

/* ================== INPUT SANITIZERS ================== */
function bindNumericSanitizer(id, maxLen){
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', ()=>{
    const raw = (el.value || '').replace(/\D/g,'');
    el.value = maxLen ? raw.slice(0, maxLen) : raw;
  });
}

/* ================== LOGIN ================== */
const loginDoc = document.getElementById('login-doc');
document.getElementById('toggle-doc').addEventListener('click', ()=>{
  const oculto = loginDoc.type === 'password';
  loginDoc.type = oculto ? 'text' : 'password';
  const src = oculto
    ? 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Ocultar_lgdxpd.png'
    : 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png';
  document.getElementById('toggle-doc-img').src = src;
  document.getElementById('toggle-doc').setAttribute('aria-label', (oculto?'Ocultar':'Mostrar') + ' documento');
});
bindNumericSanitizer('login-doc', 10);

document.getElementById('btn-login').addEventListener('click', async ()=>{
  const documento = (loginDoc.value||'').trim();
  if(documento === ''){
    Swal.fire({ icon:'question', title:'¬øDeseas comenzar?', text:'Ingresa un Documento para validar.', timer:3000 });
    return;
  }
  if(!/^\d{6,10}$/.test(documento)){
    Swal.fire({
      icon:'error',
      title:'CONTRASE√ëA INCORRECTA',
      text:'La contrase√±a contiene entre 6 y 10 digitos num√©ricos.',
      timer:3000,
      showConfirmButton:false
    });
    return;
  }
  try{
    const res = await apiGet('loginContratista', { documento });
    if(!res?.existe){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A√öN',
        text:'Una vez sea ingresada la informaci√≥n de tu contrato podr√°s acceder.',
        timer:6000,
        showConfirmButton:false
      });
      return;
    }
    if(String(res.estado||'').toUpperCase()==='INACTIVO'){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A√öN',
        text:'Una vez sea ingresada la informaci√≥n de tu contrato podr√°s acceder.',
        timer:6000,
        showConfirmButton:false
      });
      return;
    }
    // ACTIVO
    currentUser = { documento: res.documento };
    if(res.incompleto){ // H..S vac√≠as
      showView('view-registro');
    }else{
      await cargarInicio();
      playSoundOnce(SOUNDS.login);
      // Preparar noticias y badge r√°pidamente
      await cargarNoticias();
      showView('view-inicio');
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  currentUser = null;
  loginDoc.value = '';
  showView('view-login');
});

/* ================== MEN√ö ================== */
const overlay = document.getElementById('overlay');
document.getElementById('btn-open-menu').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.menu);
  overlay.classList.add('open');
});
document.getElementById('btn-ovl-back').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});
document.getElementById('ovlClose').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});

document.getElementById('go-noticias').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarNoticias();
  showView('view-noticias');
});
// El label ‚ÄúPonte al d√≠a‚Äù junto a emoji abre noticias
document.getElementById('notif-label').addEventListener('click', async ()=>{
  await cargarNoticias();
  showView('view-noticias');
});
document.getElementById('go-contrato').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarContratoLectura();
  showView('view-contrato');
});
document.getElementById('go-personales').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarPersonalesLectura();
  showView('view-personales');
});

/* ================== INICIO ================== */
function thumbById(id){ return id ? ('https://drive.google.com/thumbnail?sz=w1000&id='+id) : ''; }
async function cargarInicio(){
  if(!currentUser) return;
  const d = await apiGet('getInicio', { documento: currentUser.documento });
  document.getElementById('inicio-nombre').textContent = d.nombre || '';
  document.getElementById('inicio-sub').textContent = 'CONTRATISTA - ' + (d.secretaria || '');
  document.getElementById('inicio-cc').textContent = (d.documento || '') + (d.expedida ? (' de ' + d.expedida) : '');
  document.getElementById('inicio-contacto').textContent = d.telefono || '';
  document.getElementById('inicio-direccion').textContent = ((d.direccion||'') + ' ' + (d.municipio||'')).trim();
  document.getElementById('inicio-correo').textContent = d.correo || '';
  document.getElementById('inicio-cuenta').textContent = ((d.cuenta||'') + ' ' + (d.tipoCuenta||'') + ' ' + (d.banco||'')).trim();
  document.getElementById('inicio-eps').textContent = d.eps || '';
  document.getElementById('inicio-afp').textContent = d.pension || '';
  document.getElementById('inicio-arl').textContent = d.arl || '';
  document.getElementById('inicio-supervisor').textContent = d.supervisor || '';
  const firmaEl = document.getElementById('inicio-firma');
  if(d.firmaId){ firmaEl.src = thumbById(d.firmaId); firmaEl.style.display=''; } else { firmaEl.style.display='none'; }
}

/* ================== SELECTS (banco/eps/afp/arl) ================== */
const BANKS = [
"BANCOLOMBIA","DAVIVIENDA","BANCO DE BOGOT√Å","BANCO CAJA SOCIAL","BANCO POPULAR","BANCO BBVA COLOMBIA S.A.","BANCO AV VILLAS","BANCO DE OCCIDENTE","BANCO AGRARIO DE COLOMBIA","BANCAMIA S.A.","BANCO SANTANDER COLOMBIA","BANCO FALABELLA","BANCO MUNDO MUJER S.A.","NEQUI","DAVIPLATA","DALE","NU","BANCOOMEVA S.A.","BANCO PICHINCHA S.A.","BANCO ITAU","CITIBANK COLOMBIA","BANCO COOPERATIVO COOPCENTRAL","DING","GLOBAL66","IRIS","JFK COOPERATIVA FINANCIERA","FINANCIERA JURISCOOP SA COMPA√ëIA DE FINANCIAMIENTO","ALIANZA FIDUCIARIA","BAN100","BANCO SERFINANZA","BOLD CF","COINK SA","COTRAFA","CREZCAMOS","COLTEFINANCIERA","CONFIAR COOPERATIVA FINANCIERA","CFA COOPERATIVA FINANCIERA","BANCO UNION","SCOTIABANK COLPATRIA","BANCO GNB SUDAMERIS","BANCO J.P. MORGAN COLOMBIA S.A.","BANCO FINANDINA S.A. BIC"
];
const EPS = ["SALUD TOTAL","SANITAS","FAMISANAR","NUEVA EPS","COMPENSAR","SANIDAD FUERZAS MILITARES","CONVIDA","COOSALUD","ALIANSALUD","ADRES MIN002"];
const AFP = ["PROTECCION","PORVENIR","COLFONDOS","OLD MUTUAL","COLPENSIONES","N/A"];
const ARL = ["SURA","POSITIVA","AXA COLPATRIA","COLMENA","BOLIVAR","LIBERTY","LA EQUIDAD"];

function fillSelect(id, options){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = '<option value="" disabled selected>Selecciona</option>' + options.map(o=>`<option value="${o}">${o}</option>`).join('');
}

/* ================== QUERY MUNICIPIOS ================== */
function bindQuery(inputId, datalistId){
  const input = document.getElementById(inputId);
  const list = document.getElementById(datalistId);
  if(!input || !list) return;
  input.addEventListener('input', async ()=>{
    const q = input.value.trim();
    list.innerHTML = '';
    if(q.length === 0) return;
    const opts = await apiGet('getFilteredResidencias', { query: q }, false);
    (opts||[]).forEach(opt=>{
      const o = document.createElement('option');
      o.value = opt;
      list.appendChild(o);
    });
  });
}
async function validarMunicipioExacto(valor){
  const opts = await apiGet('getMunicipiosAll', {}, false);
  const low = String(valor||'').trim().toLowerCase();
  return (opts||[]).some(v => String(v||'').trim().toLowerCase() === low);
}

/* ================== REGISTRO ================== */
let regFirmaDataUrl = '';
document.getElementById('reg-firma').addEventListener('change', (e)=>{
  const file = e.target.files && e.target.files[0];
  const prev = document.getElementById('reg-firma-preview');
  if(!file){ regFirmaDataUrl=''; prev.style.display='none'; prev.src=''; return; }
  const reader = new FileReader();
  reader.onload = ev => { regFirmaDataUrl = ev.target.result; prev.src = regFirmaDataUrl; prev.style.display='block'; };
  reader.readAsDataURL(file);
});
bindNumericSanitizer('reg-telefono', 10);
bindNumericSanitizer('reg-numeroCuenta', 16);

fillSelect('reg-banco', BANKS);
fillSelect('reg-eps', EPS);
fillSelect('reg-pension', AFP);
fillSelect('reg-arl', ARL);

bindQuery('reg-expedida','dl-expedida');
bindQuery('reg-municipio','dl-municipio');

/* Modal Nacimiento (1936‚Äì2008) */
(function initPickerNacimiento(){
  const dia = document.getElementById('pickerDiaNac');
  const mes = document.getElementById('pickerMesNac');
  const anio = document.getElementById('pickerAnioNac');
  if(!dia || !mes || !anio) return;
  for(let d=1; d<=31; d++){ const o=document.createElement('option'); o.value=String(d).padStart(2,'0'); o.textContent=o.value; dia.appendChild(o); }
  const mesesN = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=String(i+1).padStart(2,'0'); o.textContent=mesesN[i]; mes.appendChild(o); }
  for(let y=1936; y<=2008; y++){ const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); anio.appendChild(o); }
})();
function abrirPickerNacimiento(){ document.getElementById('nacimientoModal').style.display='flex'; }
function cancelarPickerNacimiento(){ document.getElementById('nacimientoModal').style.display='none'; document.getElementById('reg-cumple').value=''; document.getElementById('p-cumple').value=''; }
function confirmarPickerNacimiento(){
  const dSel = (document.getElementById('pickerDiaNac').value) || '01';
  const mSel = (document.getElementById('pickerMesNac').value) || '01';
  const aSel = (document.getElementById('pickerAnioNac').value) || '2000';
  const val = `${dSel}/${mSel}/${aSel}`;
  if(document.activeElement && document.activeElement.id === 'p-cumple'){
    document.getElementById('p-cumple').value = val;
  }else{
    document.getElementById('reg-cumple').value = val;
  }
  document.getElementById('nacimientoModal').style.display='none';
}

/* Guardar registro */
document.getElementById('reg-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const telefonoRegex = /^[0-9]{10}$/;
  const correoRegex = /^[^\s@]+@(example\.org|nomedominio\.net|dominio\.edu\.co|examplo\.edu\.co|empresa\.com|nombreempresa\.org|correo\.es|dominio\.es|outlook\.com|hotmail\.com|live\.com|gmail\.com|icloud\.com|me\.com|[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})$/;
  const numeroCuentaRaw = (document.getElementById('reg-numeroCuenta').value||'').replace(/\D/g,'');
  const body = {
    documento: currentUser.documento,
    expedida: document.getElementById('reg-expedida').value.trim(),
    telefono: document.getElementById('reg-telefono').value.trim(),
    direccion: document.getElementById('reg-direccion').value.trim(),
    municipio: document.getElementById('reg-municipio').value.trim(),
    correo: document.getElementById('reg-correo').value.trim(),
    tipoCuenta: document.getElementById('reg-tipoCuenta').value,
    numeroCuenta: numeroCuentaRaw,
    banco: document.getElementById('reg-banco').value,
    eps: document.getElementById('reg-eps').value,
    pension: document.getElementById('reg-pension').value,
    arl: document.getElementById('reg-arl').value,
    firmaDataUrl: regFirmaDataUrl || '',
    cumpleISO: document.getElementById('reg-cumple').value || ''
  };
  const requiredOk = body.expedida && body.telefono && body.direccion && body.municipio && body.correo && body.tipoCuenta && body.numeroCuenta && body.banco && body.eps && body.pension && body.arl && body.firmaDataUrl && body.cumpleISO;
  if(!requiredOk){ Swal.fire({icon:'warning', title:'Faltan campos Requeridos'}); return; }
  if(!telefonoRegex.test(body.telefono)){ Swal.fire({icon:'warning', title:'Whatsapp inv√°lido'}); return; }
  if(!correoRegex.test(body.correo)){ Swal.fire({icon:'warning', title:'Correo inv√°lido'}); return; }
  if(!(body.numeroCuenta.length>=7 && body.numeroCuenta.length<=16)){ Swal.fire({icon:'warning', title:'N√∫mero de cuenta inv√°lido'}); return; }
  const expOk = await validarMunicipioExacto(body.expedida);
  const munOk = await validarMunicipioExacto(body.municipio);
  if(!expOk || !munOk){ Swal.fire({icon:'warning', title:'Municipio inv√°lido', text:'Verifica que Expedida y Municipio coincidan con la lista oficial.'}); return; }

  const resumenHtml = `
    <b>Expedida:</b> ${body.expedida}<br>
    <b>Whatsapp:</b> ${body.telefono}<br>
    <b>Direcci√≥n:</b> ${body.direccion}<br>
    <b>Municipio:</b> ${body.municipio}<br>
    <b>Correo:</b> ${body.correo}<br>
    <b>Cuenta:</b> ${body.numeroCuenta} ${body.tipoCuenta} ${body.banco}<br>
    <b>EPS:</b> ${body.eps}<br>
    <b>AFP:</b> ${body.pension}<br>
    <b>ARL:</b> ${body.arl}<br><br>
    <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" alt="">
  `;
  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Registro', html:resumenHtml,
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  try{
    const r = await apiPost('saveRegistro', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Registro Exitoso', timer:1800, showConfirmButton:false });
      await cargarInicio();
      showView('view-inicio');
      await Swal.fire({ icon:'info', title:'DATOS DEL CONTRATO', text:'No olvides completar los datos de tu contrato sin errores', timer:4000, showConfirmButton:false });
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
document.getElementById('reg-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  // Reset de la vista
  ['reg-expedida','reg-telefono','reg-direccion','reg-municipio','reg-correo','reg-tipoCuenta','reg-numeroCuenta','reg-banco','reg-eps','reg-pension','reg-arl','reg-cumple'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return;
    if(el.tagName==='SELECT') el.value='';
    else el.value='';
  });
  document.getElementById('reg-firma').value=''; document.getElementById('reg-firma-preview').style.display='none'; document.getElementById('reg-firma-preview').src='';
  showView('view-login');
});

/* ================== CONTRATO (lectura + edici√≥n) ================== */
document.getElementById('contrato-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  // reset form
  document.getElementById('contrato-form').classList.add('hidden');
  ['c-fechaInicio','c-diaInicio','c-mesInicio','c-fechaTermino','c-diaTermino','c-mesTermino','c-meses','c-dias','c-ejecucion','c-rp','c-costos','c-regimen'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.value=''; }
  });
  showView('view-inicio');
});
document.getElementById('contrato-editar').addEventListener('click', ()=>{
  document.getElementById('contrato-form').classList.remove('hidden');
});
bindNumericSanitizer('c-meses', 3);
bindNumericSanitizer('c-dias', 3);
bindNumericSanitizer('c-rp', 10);

document.getElementById('c-costos').addEventListener('change', function(){
  const simple = document.getElementById('c-regimen');
  if (this.value === 'SI tomar√© costos o deducciones.') {
    simple.value = 'Si pertenezco al R√©gimen Simple, por lo que se adjunta el RUT vigente, actualizado con la responsabilidad 47.';
  } else if (this.value === 'NO tomar√© costos o deducciones.') {
    simple.value = 'NO pertenezco al R√©gimen Simple';
  }
});

/* Modal Contrato (Inicio/Termino, a√±o fijo 2026) */
function initContratoPickers(){
  const d1=document.getElementById('pickerDiaInicio'), m1=document.getElementById('pickerMesInicio');
  const d2=document.getElementById('pickerDiaTerm'), m2=document.getElementById('pickerMesTerm');
  if(d1 && m1){
    d1.innerHTML=''; m1.innerHTML='';
    for(let d=1; d<=31; d++){ const o=document.createElement('option'); o.value=String(d).padStart(2,'0'); o.textContent=o.value; d1.appendChild(o); }
    const mesesN = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=String(i+1).padStart(2,'0'); o.textContent=mesesN[i]; m1.appendChild(o); }
  }
  if(d2 && m2){
    d2.innerHTML=''; m2.innerHTML='';
    for(let d=1; d<=31; d++){ const o=document.createElement('option'); o.value=String(d).padStart(2,'0'); o.textContent=o.value; d2.appendChild(o); }
    const mesesN = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=String(i+1).padStart(2,'0'); o.textContent=mesesN[i]; m2.appendChild(o); }
  }
}
function abrirPickerContratoInicio(){ initContratoPickers(); document.getElementById('fechaModalInicio').style.display='flex'; }
function cancelarPickerContratoInicio(){ document.getElementById('fechaModalInicio').style.display='none'; document.getElementById('c-fechaInicio').value=''; document.getElementById('c-diaInicio').value=''; document.getElementById('c-mesInicio').value=''; actualizarEjecucion(); }
function confirmarPickerContratoInicio(){
  const dSel = (document.getElementById('pickerDiaInicio').value) || '01';
  const mSel = (document.getElementById('pickerMesInicio').value) || '01';
  const anio = '2026';
  document.getElementById('c-fechaInicio').value = `${dSel}/${mSel}/${anio}`;
  document.getElementById('c-diaInicio').value = dSel;
  const mesesN = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const idx = Math.max(1, Math.min(12, parseInt(mSel, 10))) - 1;
  document.getElementById('c-mesInicio').value = mesesN[idx];
  document.getElementById('fechaModalInicio').style.display='none';
  calcularPlazo();
}
function abrirPickerContratoTermino(){ initContratoPickers(); document.getElementById('fechaModalTermino').style.display='flex'; }
function cancelarPickerContratoTermino(){ document.getElementById('fechaModalTermino').style.display='none'; document.getElementById('c-fechaTermino').value=''; document.getElementById('c-diaTermino').value=''; document.getElementById('c-mesTermino').value=''; actualizarEjecucion(); }
function confirmarPickerContratoTermino(){
  const dSel = (document.getElementById('pickerDiaTerm').value) || '01';
  const mSel = (document.getElementById('pickerMesTerm').value) || '01';
  const anio = '2026';
  document.getElementById('c-fechaTermino').value = `${dSel}/${mSel}/${anio}`;
  document.getElementById('c-diaTermino').value = dSel;
  const mesesN = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const idx = Math.max(1, Math.min(12, parseInt(mSel, 10))) - 1;
  document.getElementById('c-mesTermino').value = mesesN[idx];
  document.getElementById('fechaModalTermino').style.display='none';
  calcularPlazo();
}

/* Tiempo de ejecuci√≥n en MAY√öSCULAS exacto */
function numTextoMayus(n){
  const unidades = ["", "UN", "DOS", "TRES", "CUATRO", "CINCO", "SEIS", "SIETE", "OCHO", "NUEVE"];
  const decenas  = ["", "DIEZ", "VEINTE", "TREINTA", "CUARENTA", "CINCUENTA", "SESENTA", "SETENTA", "OCHENTA", "NOVENTA"];
  const centenas = ["", "CIENTO", "DOSCIENTOS", "TRESCIENTOS", "CUATROCIENTOS", "QUINIENTOS", "SEISCIENTOS", "SETECIENTOS", "OCHOCIENTOS", "NOVECIENTOS"];
  const especiales = ["DIEZ", "ONCE", "DOCE", "TRECE", "CATORCE", "QUINCE", "DIECISEIS", "DIECISIETE", "DIECINUEVE"];
  function c(n){ if(n===100) return "CIEN"; if(n>100) return (centenas[Math.floor(n/100)] + " " + d(n%100)).trim(); return d(n); }
  function d(n){ if(n<10) return unidades[n]; if(n<20) return especiales[n-10]; if(n===20) return "VEINTE"; if(n<30) return "VEINTI"+unidades[n%10]; return decenas[Math.floor(n/10)] + (n%10 ? " Y " + unidades[n%10] : ""); }
  function m(n){ if(n<1000) return c(n); if(n<1000000){ const miles=Math.floor(n/1000), r=n%1000; if(miles===1) return ("MIL " + (r?c(r):"")).trim(); return (c(miles) + " MIL " + (r?c(r):"")).trim(); }
    const millones=Math.floor(n/1000000), r=n%1000000; if(millones===1) return ("UN MILL√ìN " + (r?m(r):"DE")).trim(); return (c(millones) + " MILLONES " + (r?m(r):"DE")).trim();
  }
  let t = m(parseInt(n||0,10)); if(t.endsWith(" UNO")) t = t.slice(0,-4) + " UN"; return t;
}
function actualizarEjecucion(){
  const meses = parseInt(document.getElementById('c-meses').value)||0;
  const dias = parseInt(document.getElementById('c-dias').value)||0;
  let parts = [];
  if(meses>0){ parts.push(`${numTextoMayus(meses)} (${meses}) ${meses===1?'MES':'MESES'}`); }
  if(dias>0){ parts.push(`${numTextoMayus(dias)} (${dias}) ${dias===1?'DIA':'DIAS'}`); }
  document.getElementById('c-ejecucion').value = parts.join(' Y ');
}
document.getElementById('c-meses').addEventListener('input', actualizarEjecucion);
document.getElementById('c-dias').addEventListener('input', actualizarEjecucion);

/* c√°lculo meses/d√≠as contando ambos extremos ‚Äì corregido seg√∫n tu script */
function parseDMYToDate(dmy){
  const m = String(dmy||'').match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(!m) return null;
  const dd=parseInt(m[1],10), mm=parseInt(m[2],10), yyyy=parseInt(m[3],10);
  const d = new Date(yyyy, mm-1, dd);
  return isNaN(d) ? null : d;
}
function getDaysInMonth(y, mIndex){ // mIndex: 0..11
  return new Date(y, mIndex+1, 0).getDate();
}
function calcularPlazo(){
  const fiStr = document.getElementById('c-fechaInicio').value;
  const ftStr = document.getElementById('c-fechaTermino').value;
  if(!fiStr || !ftStr){
    document.getElementById('c-meses').value=0;
    document.getElementById('c-dias').value=0;
    actualizarEjecucion();
    return;
  }
  let fechaInicio = parseDMYToDate(fiStr);
  const fechaUltima = parseDMYToDate(ftStr);
  if(!fechaInicio || !fechaUltima || fechaUltima < fechaInicio){
    document.getElementById('c-meses').value=0;
    document.getElementById('c-dias').value=0;
    actualizarEjecucion();
    return;
  }
  // Contar ambos extremos (+1 d√≠a)
  let diffTime = Math.abs(fechaUltima - fechaInicio) + (1000*60*60*24);
  let diffDays = Math.ceil(diffTime / (1000*60*60*24));

  let meses = 0;
  let dias = 0;

  while (diffDays > 0) {
    const daysInMonth = getDaysInMonth(fechaInicio.getFullYear(), fechaInicio.getMonth());
    const remainingThisMonth = daysInMonth - (fechaInicio.getDate() - 1); // incluye el d√≠a actual
    if (diffDays >= remainingThisMonth) {
      meses++;
      diffDays -= remainingThisMonth;
      fechaInicio.setMonth(fechaInicio.getMonth() + 1);
      fechaInicio.setDate(1);
    } else {
      dias = diffDays;
      diffDays = 0;
    }
  }

  document.getElementById('c-meses').value = meses;
  document.getElementById('c-dias').value = dias;
  actualizarEjecucion();
}

document.getElementById('c-rp').addEventListener('input', ()=>{
  const el = document.getElementById('c-rp');
  const raw = (el.value||'').replace(/\D/g,'').slice(0,10);
  el.value = raw;
  el.style.border = '';
  if(raw.length===10 && raw.startsWith('2026')){
    el.style.border = '2px solid green';
  }
});

document.getElementById('c-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const body = {
    documento: currentUser.documento,
    fechaInicioDMY: document.getElementById('c-fechaInicio').value||'',
    diaInicio: document.getElementById('c-diaInicio').value||'',
    mesInicio: document.getElementById('c-mesInicio').value||'',
    fechaTerminoDMY: document.getElementById('c-fechaTermino').value||'',
    diaTermino: document.getElementById('c-diaTermino').value||'',
    mesTermino: document.getElementById('c-mesTermino').value||'',
    meses: document.getElementById('c-meses').value||'0',
    dias: document.getElementById('c-dias').value||'0',
    ejecucion: document.getElementById('c-ejecucion').value||'',
    rp: (document.getElementById('c-rp').value||'').replace(/\D/g,''),
    costos: document.getElementById('c-costos').value||'',
    regimen: document.getElementById('c-regimen').value||''
  };
  if(!/^\d{2}\/\d{2}\/\d{4}$/.test(body.fechaInicioDMY) || !/^\d{2}\/\d{2}\/\d{4}$/.test(body.fechaTerminoDMY)){
    Swal.fire({icon:'warning', title:'Fechas requeridas'}); return;
  }
  if(!body.costos){ Swal.fire({icon:'warning', title:'Selecciona costos/deducciones'}); return; }
  if(!/^\d{1,10}$/.test(body.rp)){ Swal.fire({icon:'warning', title:'RP inv√°lido'}); return; }

  const resumenHtml = `
    <b>Inicio:</b> ${body.fechaInicioDMY}<br>
    <b>Terminaci√≥n:</b> ${body.fechaTerminoDMY}<br>
    <b>Meses/D√≠as:</b> ${body.meses} / ${body.dias}<br>
    <b>Ejecuci√≥n:</b> ${body.ejecucion}<br>
    <b>RP:</b> ${body.rp}<br>
    <b>Costos:</b> ${body.costos}<br>
    <b>R√©gimen:</b> ${body.regimen}<br>
  `;
  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Cambios', html:resumenHtml,
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  try{
    const r = await apiPost('saveDatosContrato', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Actualizaci√≥n Exitosa', timer:1600, showConfirmButton:false });
      await cargarContratoLectura();
      // cerrar y limpiar
      document.getElementById('contrato-form').classList.add('hidden');
      ['c-fechaInicio','c-diaInicio','c-mesInicio','c-fechaTermino','c-diaTermino','c-mesTermino','c-meses','c-dias','c-ejecucion','c-rp','c-costos','c-regimen'].forEach(id=>{
        const el=document.getElementById(id); if(el){ el.value=''; }
      });
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
document.getElementById('c-cancelar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  document.getElementById('contrato-form').classList.add('hidden');
  ['c-fechaInicio','c-diaInicio','c-mesInicio','c-fechaTermino','c-diaTermino','c-mesTermino','c-meses','c-dias','c-ejecucion','c-rp','c-costos','c-regimen'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.value=''; }
  });
});

/* ================== PERSONALES (lectura + edici√≥n) ================== */
let pFirmaDataUrl = '';
document.getElementById('p-firma').addEventListener('change', (e)=>{
  const file = e.target.files && e.target.files[0];
  const prev = document.getElementById('p-firma-preview');
  if(!file){ pFirmaDataUrl=''; prev.style.display='none'; prev.src=''; return; }
  const reader = new FileReader();
  reader.onload = ev => { pFirmaDataUrl = ev.target.result; prev.src = pFirmaDataUrl; prev.style.display='block'; };
  reader.readAsDataURL(file);
});
bindNumericSanitizer('p-telefono', 10);
bindNumericSanitizer('p-numeroCuenta', 16);

fillSelect('p-banco', BANKS);
fillSelect('p-eps', EPS);
fillSelect('p-pension', AFP);
fillSelect('p-arl', ARL);

bindQuery('p-expedida','dl-expedida2');
bindQuery('p-municipio','dl-municipio2');

document.getElementById('personales-volver').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  // reset
  document.getElementById('personales-form').classList.add('hidden');
  ['p-expedida','p-telefono','p-direccion','p-municipio','p-correo','p-tipoCuenta','p-numeroCuenta','p-banco','p-eps','p-pension','p-arl','p-cumple'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return; el.value='';
  });
  document.getElementById('p-firma').value=''; document.getElementById('p-firma-preview').style.display='none'; document.getElementById('p-firma-preview').src='';
  showView('view-inicio');
});
document.getElementById('personales-editar').addEventListener('click', ()=>{
  document.getElementById('personales-form').classList.remove('hidden');
});
document.getElementById('p-cancelar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  document.getElementById('personales-form').classList.add('hidden');
  ['p-expedida','p-telefono','p-direccion','p-municipio','p-correo','p-tipoCuenta','p-numeroCuenta','p-banco','p-eps','p-pension','p-arl','p-cumple'].forEach(id=>{
    const el=document.getElementById(id); if(!el) return; el.value='';
  });
  document.getElementById('p-firma').value=''; document.getElementById('p-firma-preview').style.display='none'; document.getElementById('p-firma-preview').src='';
});

document.getElementById('p-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const telefonoRegex = /^[0-9]{10}$/;
  const correoRegex = /^[^\s@]+@(example\.org|nomedominio\.net|dominio\.edu\.co|examplo\.edu\.co|empresa\.com|nombreempresa\.org|correo\.es|dominio\.es|outlook\.com|hotmail\.com|live\.com|gmail\.com|icloud\.com|me\.com|[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})$/;

  const body = {
    documento: currentUser.documento,
    expedida: document.getElementById('p-expedida').value.trim(),
    telefono: document.getElementById('p-telefono').value.trim(),
    direccion: document.getElementById('p-direccion').value.trim(),
    municipio: document.getElementById('p-municipio').value.trim(),
    correo: document.getElementById('p-correo').value.trim(),
    tipoCuenta: document.getElementById('p-tipoCuenta').value,
    numeroCuenta: (document.getElementById('p-numeroCuenta').value||'').replace(/\D/g,''),
    banco: document.getElementById('p-banco').value,
    eps: document.getElementById('p-eps').value,
    pension: document.getElementById('p-pension').value,
    arl: document.getElementById('p-arl').value,
    firmaDataUrl: pFirmaDataUrl || '',
    cumpleISO: document.getElementById('p-cumple').value || ''
  };

  const resumen = [];
  Object.entries(body).forEach(([k,v])=>{ if(k!=='documento' && v) resumen.push(`<b>${k}:</b> ${v}`); });
  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Cambios', html:resumen.join('<br>'),
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  if(body.telefono && !telefonoRegex.test(body.telefono)){ Swal.fire({icon:'warning', title:'Whatsapp inv√°lido'}); return; }
  if(body.correo && !correoRegex.test(body.correo)){ Swal.fire({icon:'warning', title:'Correo inv√°lido'}); return; }
  if(body.numeroCuenta && !(body.numeroCuenta.length>=7 && body.numeroCuenta.length<=16)){ Swal.fire({icon:'warning', title:'N√∫mero de cuenta inv√°lido'}); return; }
  if(body.expedida && !(await validarMunicipioExacto(body.expedida))){ Swal.fire({icon:'warning', title:'Municipio de expedici√≥n inv√°lido'}); return; }
  if(body.municipio && !(await validarMunicipioExacto(body.municipio))){ Swal.fire({icon:'warning', title:'Municipio de residencia inv√°lido'}); return; }

  try{
    const r = await apiPost('saveDatosPersonales', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Actualizaci√≥n Exitosa', timer:1600, showConfirmButton:false });
      await cargarPersonalesLectura();
      document.getElementById('personales-form').classList.add('hidden');
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

/* ================== NOTICIAS ================== */
let FEED_CACHE = [];
const FEED_READ_KEY_PREFIX = 'feedReadIds@contr:'; // por documento
function feedReadKey(){ return FEED_READ_KEY_PREFIX + (currentUser?.documento || 'anon'); }
function getReadMap(){ try{ const raw=localStorage.getItem(feedReadKey()); return raw?JSON.parse(raw):{}; }catch(_){ return {}; } }
function setReadMap(m){ try{ localStorage.setItem(feedReadKey(), JSON.stringify(m||{})); }catch(_){} }
function isRead(id){ return !!getReadMap()[id]; }
function markRead(id){ const m=getReadMap(); m[id]=true; setReadMap(m); }
function extractFirstUrl(text){
  if(!text) return null;
  const m = String(text).match(/(https?:\/\/[^\s'"<>]+|www\.[^\s'"<>]+)/i);
  if(!m) return null;
  let u = m[0];
  if(u.startsWith('www.')) u = 'https://' + u;
  return u;
}
async function cargarNoticias(){
  const list = await apiGet('listComunicados', {}, false);
  FEED_CACHE = Array.isArray(list) ? list.slice(0,20) : [];
  const wrap = document.getElementById('feed-list');
  wrap.innerHTML='';
  if(!FEED_CACHE.length){
    const p = document.createElement('p'); p.className='muted center'; p.textContent='No hay noticias disponibles.'; wrap.appendChild(p); refreshNotificationsBadge(); return;
  }
  const emojiUrl = document.getElementById('emoji-user').src;
  let anyUnread = false;
  FEED_CACHE.forEach(it=>{
    const item = document.createElement('div');
    item.style.cssText = 'display:flex;gap:12px;align-items:flex-start;background:rgba(255,255,255,.9);border:2px solid #ddd;border-radius:16px;padding:10px;box-shadow:0 6px 14px rgba(0,0,0,.12);cursor:pointer;';
    item.dataset.id = it.id;
    const img = document.createElement('img');
    img.style.cssText='width:64px;height:64px;border-radius:10px;object-fit:cover;flex-shrink:0;background:#eee;border:1px solid #ddd;';
    img.alt='';
    const thumbUrl = it.imagenId ? thumbById(it.imagenId) : emojiUrl;
    img.src = thumbUrl;

    const ct = document.createElement('div'); ct.style.flex='1'; ct.style.minWidth='0';
    const h = document.createElement('h4'); h.style.margin='0 0 4px 0'; h.style.fontWeight='800'; h.textContent = String(it.titulo||'');
    const p = document.createElement('p'); p.style.margin='0'; p.style.color='#333'; p.textContent = String(it.subtitulo||'');
    ct.appendChild(h); ct.appendChild(p);

    item.appendChild(img); item.appendChild(ct);
    if(!isRead(it.id)){
      anyUnread = true;
      const dot = document.createElement('span');
      dot.style.cssText='width:12px;height:12px;background:#e11;border-radius:999px;flex-shrink:0;margin-left:6px;margin-top:4px;box-shadow:0 0 0 2px #fff;';
      item.appendChild(dot);
    }
    item.addEventListener('click', ()=> abrirNoticia(it));
    wrap.appendChild(item);
  });
  if(anyUnread){ playSoundOnce(SOUNDS.notify); }
  refreshNotificationsBadge();
}
function abrirNoticia(it){
  const emojiUrl = document.getElementById('emoji-user').src;
  const thumb = document.getElementById('fd-thumb');
  const title = document.getElementById('fd-title');
  const sub   = document.getElementById('fd-sub');
  const desc  = document.getElementById('fd-desc');
  const link  = document.getElementById('fd-link');

  thumb.src = it.imagenId ? thumbById(it.imagenId) : emojiUrl;
  title.textContent = String(it.titulo||'');
  sub.textContent   = String(it.subtitulo||'');
  desc.textContent  = String(it.contenido||'');

  const urlFromDesc = extractFirstUrl(it.contenido);
  const firstUrl = urlFromDesc || it.first_link || '';
  if(firstUrl){ link.href = firstUrl; link.style.display=''; } else { link.href='#'; link.style.display='none'; }

  markRead(it.id);
  refreshNotificationsBadge();
  showView('view-noticia-detalle');
}
document.getElementById('fd-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-noticias'); });
document.getElementById('feed-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-inicio'); });

function unreadCountFrom(items){
  if(!Array.isArray(items) || !items.length) return 0;
  let n = 0;
  for(const it of items){ if(!isRead(it.id)) n++; }
  return n;
}
function refreshNotificationsBadge(){
  const count = unreadCountFrom(FEED_CACHE);
  const bell = document.getElementById('notif-bell');
  const label = document.getElementById('notif-label');
  const btnBadge = document.getElementById('go-feed-badge');
  if(btnBadge){
    btnBadge.textContent = String(count);
    if(count>0) btnBadge.classList.add('active'); else btnBadge.classList.remove('active');
  }
  if(count>0){
    bell && bell.classList.add('active');
    label && label.classList.add('active');
  }else{
    bell && bell.classList.remove('active');
    label && label.classList.remove('active');
  }
}

/* ================== CONTRATO: cargar lectura ================== */
async function cargarContratoLectura(){
  if(!currentUser) return;
  const d = await apiGet('getDatosContrato', { documento: currentUser.documento });
  const box = document.getElementById('contrato-lectura');
  const lines = [
    `<b>Secretar√≠a:</b> ${d.secretaria||''}`,
    `<b>Supervisor:</b> ${d.supervisor||''}`,
    `<b>Contrato N¬∞:</b> ${d.contrato||''} de ${d.fechaContrato||''}`,
    `<b>Tipo de Contrato:</b> ${d.tipoContrato||''}`,
    `<b>Objeto:</b> ${d.objeto||''}`
  ];
  (d.obligaciones||[]).forEach((o,i)=>{ lines.push(`<b>Obligaci√≥n ${i+1}:</b> ${o}`); });
  box.innerHTML = lines.map(l=>`<p>${l}</p>`).join('');
}

/* ================== PERSONALES: cargar lectura ================== */
async function cargarPersonalesLectura(){
  if(!currentUser) return;
  const d = await apiGet('getDatosPersonales', { documento: currentUser.documento });
  const box = document.getElementById('personales-lectura');
  const lines = [
    `<b>NOMBRE:</b> ${d.nombre||''}`,
    `<b>CC:</b> ${d.documento||''}`,
    `<b>Expedida:</b> ${d.expedida||''}`,
    `<b>Whatsapp:</b> ${d.telefono||''}`,
    `<b>Direcci√≥n:</b> ${d.direccion||''}`,
    `<b>Municipio:</b> ${d.municipio||''}`,
    `<b>Correo:</b> ${d.correo||''}`,
    `<b>Cuenta:</b> ${d.cuenta||''} ${d.tipoCuenta||''} ${d.banco||''}`,
    `<b>EPS:</b> ${d.eps||''}`,
    `<b>AFP:</b> ${d.pension||''}`,
    `<b>ARL:</b> ${d.arl||''}`,
    `<b>Cumplea√±os:</b> ${d.cumple||''}`
  ];
  box.innerHTML = lines.map(l=>`<p>${l}</p>`).join('');
}
/* ================== PWA AVANZADO ================== */
let deferredPrompt = null;
let __installStartShown = false;    // bandera: ya mostramos "App instal√°ndose"
let __installSuccessShown = false;  // bandera: ya mostramos "Instalaci√≥n exitosa"

function isStandalone(){
  const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const dmInstalled  = window.matchMedia('(display-mode: installed)').matches;
  const iosStandalone = (window.navigator.standalone === true);
  return dmStandalone || dmInstalled || iosStandalone;
}
function isIOS(){
  return /(iphone|ipad|ipod)/i.test(navigator.userAgent || '');
}
function isMarkedInstalled(){
  try{ return localStorage.getItem('pwaInstalledFlag') === '1'; }catch(_){ return false; }
}
function markInstalled(){
  try{ localStorage.setItem('pwaInstalledFlag', '1'); }catch(_){}
}
function clearInstalledMark(){
  try{ localStorage.removeItem('pwaInstalledFlag'); }catch(_){}
}
async function detectInstalled(){
  if (isStandalone()) return true;
  if (typeof navigator.getInstalledRelatedApps === 'function'){
    try{
      const apps = await navigator.getInstalledRelatedApps();
      const found = apps.some(a =>
        a.platform === 'webapp' &&
        typeof a.url === 'string' &&
        /manifest\.webmanifest$/.test(a.url)
      );
      if (found){
        markInstalled();
        return true;
      } else {
        clearInstalledMark();
      }
    }catch(_){}
  }
  return isMarkedInstalled();
}
function updateInstallButtonsVisibility(){
  const btn1 = document.getElementById('btn-instalar');
  const canPrompt = !!deferredPrompt;
  const installed = isMarkedInstalled() || isStandalone();
  const shouldShow = !installed && (canPrompt || isIOS());
  if(btn1) btn1.style.display = shouldShow ? '' : 'none';
}

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  updateInstallButtonsVisibility();
});

window.addEventListener('appinstalled', ()=>{
  markInstalled();
  deferredPrompt = null;
  updateInstallButtonsVisibility();
});

document.getElementById('btn-instalar').addEventListener('click', async ()=>{
  // Flujo iOS: se respeta exactamente tu alerta e instrucciones
  if(isIOS()){
    Swal.fire({
      icon:'info',
      title:'Para Instalar en tu Iphone',
      html:'1) Toca Compartir (cuadro con flecha en la parte inferior).<br>2) Elige "Agregar a pantalla de inicio".<br>3) Confirma "Agregar".'
    });
    return;
  }
  // Android: requiere beforeinstallprompt (deferredPrompt)
  if(!deferredPrompt){
    Swal.fire({icon:'info',title:'Instalaci√≥n no disponible todav√≠a'});
    return;
  }

  const dp = deferredPrompt;
  dp.prompt();                           // muestra di√°logo nativo de instalaci√≥n
  const choice = await dp.userChoice;    // espera la elecci√≥n del usuario
  deferredPrompt = null;                 // limpia el prompt (solo se usa una vez)

  if (choice.outcome === 'accepted'){
    // Primera alerta (Android): confirma inicio de instalaci√≥n por 6 segundos
    markInstalled();
    __installStartShown = true;
    Swal.fire({
  icon: 'success',
  title: '¬°App instal√°ndose!',
  html: `
    <div style="text-align:center; margin-top:8px;">
      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1764209976/Robot_c2vtua.gif"
        alt="Instalando app"
        style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
      >
      <div>Debes esperar unos segundos mientras el sistema instala la App.</div>
      <div style="margin-top:10px;">
        <b>Ya puedes salir de esta vista, aparecer√° en la pantalla principal de este dispositivo.</b>
      </div>
    </div>
  `,
  timer: 12000,
  showConfirmButton: false
});
  } else {
    Swal.fire({icon:'info',title:'Instalaci√≥n cancelada'});
  }

  updateInstallButtonsVisibility();
});

async function initPWAVista(){
  const installed = await detectInstalled();
  if (installed){
    showView('view-login');
  } else {
    showView('view-instalar');
    updateInstallButtonsVisibility();
  }
}
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
window.addEventListener('load', initPWAVista);
  

/* ================== FIN ================== */
</script>
</body>
</html>
