<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>CONTRATISTA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1763928947/Logo_lt365u.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
     
  <style>
  :root{
    --primary:#06402B;
    --primary-2:#04281C;
    --ok:#16a34a;
    --error:#dc2626;
    --scrim:rgba(0,0,0,.35);
  }
  html,body{
    margin:0; padding:0; height:100%; width:100%;
    overflow-x:hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:#111;
      background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905870/fondo_verde_tvntsi.png') center/cover fixed no-repeat;
    }
    .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

    .view{ display:none; opacity:0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      box-sizing:border-box; padding:16px;
    }
    .view.active{ display:block; opacity:1; transform: translateY(0); }

    .card{
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(3px);
      border: 2px solid #ddd; border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      max-width: 820px; margin: 16px auto; padding: 20px 20px 16px;
    }
    h1,h2,h3{ margin: 8px 0 12px; text-align:center; }
    p.helper{ color:#444; font-size:.95rem; text-align:center; margin:8px 0 16px; }
    label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
    input, select, textarea, button{
      width:100%; padding:12px; box-sizing:border-box;
      border:1.5px solid #ccc; border-radius:8px; background:#fff;
      outline:none; transition: border-color .2s ease, transform .08s ease;
      font-size:16px;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
    button{
      cursor:pointer; border:2px solid var(--primary);
      background:#fff; color:#000; font-weight:700;
    }
    button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-row{ display:flex; gap:12px; flex-wrap:wrap; }
    .btn-row > *{ flex:1; }
    .muted{ color:#666; font-size:.85rem; }
    .center{ text-align:center; }
    .image-center{ display:flex; justify-content:center; }
    .brand{ width:240px; border-radius:12px; display:block; margin:12px auto 4px; }
    .chip{
      padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
      background:#fff; font-weight:700; color:#000; text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .danger{ background:#e11; border-color:#e11; color:#fff; }

    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
    }
    .loader.hidden{ opacity:0; pointer-events:none; }
    .spinner-ios{ position:relative; width:64px; height:64px; }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px;
      opacity:.2; animation:iosFade 1.2s linear infinite; transform-origin: center center;
    }
    @keyframes iosFade{ 0%, 39%, 100% { opacity:.2; } 40% { opacity:1; } }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    .hidden{ display:none !important; }
    .narrow{ max-width: 560px; margin: 0 auto; }
    .spaced{ margin-top:12px; }

    .oblig-block{
  background:#f8f8f8; border:1.5px solid #ccc; border-radius:12px;
  padding:10px 12px; margin:10px 0; display:flex; flex-direction:column; gap:6px;
}

    /* Overlay Men√∫ */
    .overlay{ position: fixed; inset: 0; pointer-events:none; }
    .overlay .scrim{ position:absolute; inset:0; background:var(--scrim); opacity:0; transition:opacity .25s ease; }
    .overlay .panel{
      position:absolute; top:0; left:0; width:min(360px, 90vw); height:100%;
      background:#06402B; color:#fff; padding:16px 16px 8px 16px; box-sizing:border-box;
      transform: translateX(-100%); transition: transform .25s ease;
      display:flex; flex-direction:column; gap:10px; overflow-y:auto; min-height: 0;
    }
    .overlay.open{ pointer-events:auto; }
    .overlay.open .scrim{ opacity:1; }
    .overlay.open .panel{ transform: translateX(0); }
    .panel h3{ margin: 4px 0 8px; text-align:center; }
    .menu-btn{
      background:#7de3ef; color:#000; border:0; font-weight:800;
      border-radius:999px; padding:12px; box-shadow: 0 6px 12px rgba(0,0,0,.18);
    }

    .avatar-emoji{
      width:120px; height:120px; display:block; margin:0 auto;
    }

    @media (max-width: 700px){ .btn-row{ flex-direction:column; } }

/* Estilo para previews en m√≥vil */
    .evi-preview{
  max-width:100%;
  max-height:320px;
  object-fit:contain;
  border-radius:10px;
  border:1.5px solid #d8e4ff;
  margin-top:8px;
}

/* Fuerza que TODOS los modales de fecha queden centrados horizontal y pegados abajo,
   incluso si el inline style pone align-items:center/justify-content:center */
.picker-modal{
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  z-index: 9999;
  align-items: flex-end !important;  /* sobrescribe inline */
  justify-content: center !important;/* sobrescribe inline */
  padding-bottom: 16px;              /* separa del borde inferior */
}
.picker-modal[aria-hidden="false"]{
  display: flex;
}
.picker-box{
  margin: 0;
  /* opcional: limitar ancho para que no tape el bot√≥n inferior completamente */
  width: 90%;
  max-width: 520px;
}

    /* INSERT: Badge ‚ÄúVer Noticias‚Äù + estilos de lista/detalle de COMUNICADOS */
    .notif-wrap{ position:relative; display:inline-block; }
    .notif-bell{
      position:absolute; right:-6px; top:-6px; width:28px; height:28px; display:none;
      animation:heartbeat 1.2s infinite;
    }
    .notif-bell.active{ display:block; }
    .notif-count{
      position:absolute; right:-2px; top:-2px;
      background:#e11; color:#fff; border-radius:999px; min-width:18px; height:18px; line-height:18px;
      text-align:center; padding:0 4px; font-size:12px; font-weight:800; display:none;
      box-shadow: 0 0 0 2px #fff;
    }
    .notif-count.active{ display:inline-block; }
    .notif-label{
      position:absolute; left:calc(100% + 6px); top:-6px;
      height:28px; line-height:28px; padding:0 10px;
      background:#7de3ef; color:#000; border-radius:999px;
      font-weight:800; font-size:14px; white-space:nowrap; display:none;
      animation:heartbeat 1.2s infinite;
    }
    .notif-label.active{ display:inline-block; }
    @keyframes heartbeat{
      0%{ transform: scale(1); }
      20%{ transform: scale(1.15); }
      40%{ transform: scale(1); }
      60%{ transform: scale(1.15); }
      100%{ transform: scale(1); }
    }

    .feed-list{ display:flex; flex-direction:column; gap:12px; }
    .feed-item{
      display:flex; gap:12px; align-items:center;
      background: rgba(255,255,255,.9);
      border:2px solid #ddd; border-radius:16px; padding:10px;
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      cursor:pointer;
    }
    .feed-thumb{
      width:64px; height:64px; border-radius:50%; object-fit:cover; flex-shrink:0;
      background:#eee; border:1px solid #ddd;
    }
    .feed-content{ flex:1; min-width:0; }
    .feed-title{ font-weight:800; color:#111; margin:0 0 2px 0; }
    .feed-sub{ color:#333; margin:0; font-size:.9rem; }
    .feed-dot{
      width:12px; height:12px; background:#e11; border-radius:999px; flex-shrink:0; margin-left:6px;
      box-shadow:0 0 0 2px #fff;
    }
    .feed-detail-card{
      background: rgba(255,255,255,.9);
      border:2px solid #ddd; border-radius:16px; padding:16px;
      box-shadow:0 8px 18px rgba(0,0,0,.15);
      max-width: 560px; margin: 12px auto; text-align:center;
    }
    .feed-detail-thumb{
      width:160px; height:160px; object-fit:cover; border-radius:50%;
      border:2px solid #ddd; background:#eee; display:block; margin:0 auto 10px;
    }
    .feed-detail-title{ margin:6px 0 4px; color:#111; font-weight:900; }
    .feed-detail-sub{ margin:0 0 8px; color:#333; font-weight:700; }
    .feed-detail-desc{ text-align:justify; color:#222; overflow-wrap:anywhere; }

    /* Solo para los 3 modales de INGRESAR CUENTA: caja blanca y posici√≥n arriba */
#icInicioModal,
#icFinModal,
#icRadicadoModal{
  align-items: flex-start !important;   /* fuerza arriba */
  padding-top: 16px;
  padding-bottom: 0;
  z-index: 10001;                       /* por si hay otros overlays */
}
#icInicioModal .picker-box,
#icFinModal .picker-box,
#icRadicadoModal .picker-box{
  background:#fff;
  border-radius:12px;
  padding:16px;
  box-shadow:0 8px 18px rgba(0,0,0,.15);
  width: 90%;
  max-width: 520px;
}
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <div class="container">
    <!-- VISTA INSTALAR -->
     <section id="view-instalar" class="view">
      <div class="card narrow" style="text-align:center;">
        <h2 style="color:var(--primary);">APP CONTRATISTA</h2>
        <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" />
        <p style="font-weight:600;">Herramienta de uso exclusivo para CONTRATISTAS activos de la Alcald√≠a de Flandes</p>
        <div class="btn-row" style="justify-content:center; margin-top:12px;">
          <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
        </div>
        <p class="muted" style="margin-top:14px;">Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.</p>
      </div>
    </section>

    <!-- VISTA LOGIN -->
    <section id="view-login" class="view active">
      <div class="card narrow">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">CONTRATISTA</h1>
        <p class="helper"><b>Acceso exclusivo para para CONTRATISTAS activos de la Alcald√≠a de Flandes.</b></p>

        <label>Contrase√±a</label>
        <div class="pwd-wrapper" style="position:relative;">
          <input id="login-doc" type="password" inputmode="numeric" autocomplete="off" placeholder="Sin puntos ni espacios" />
          <button type="button" id="toggle-doc" aria-label="Mostrar documento" style="position:absolute;top:50%;right:10px;transform:translateY(-50%);background:transparent;border:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:6px;">
            <img id="toggle-doc-img" src="https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png" alt="Mostrar" style="width:22px;height:22px;">
          </button>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
        </div>

        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA INICIO -->
    <section id="view-inicio" class="view">
      <div class="card narrow">
        <div class="btn-row" style="margin-bottom:12px;">
          <button class="chip danger" id="btn-logout">Cerrar Sesi√≥n</button>
          <button class="chip" id="btn-open-menu">MEN√ö</button>
        </div>

        <div class="image-center">
          <div class="notif-wrap">
            <img class="avatar-emoji" src="https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png" alt="">
            <img id="notif-bell" class="notif-bell" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759767447/Notificaci%C3%B3n_jtptyw.webp" alt="">
            <span id="notif-count" class="notif-count">0</span>
            <span id="notif-label" class="notif-label">Ver Noticias</span>
          </div>
        </div>

        <h2 id="inicio-nombre" style="color:var(--primary); font-weight:900; margin-top:6px;"></h2>
        <p id="inicio-sub" class="center muted" style="margin-top:0; font-weight:300;"></p>

        <div class="narrow" style="margin-top:10px;">
          <p><b>CC:</b> <span id="inicio-cc"></span></p>
          <p><b>CONTACTO:</b> <span id="inicio-contacto"></span></p>
          <p><b>DIRECCI√ìN:</b> <span id="inicio-direccion"></span></p>
          <p><b>CORREO:</b> <span id="inicio-correo"></span></p>
          <p><b>CUENTA N¬∞:</b> <span id="inicio-cuenta"></span></p>
          <p><b>EPS:</b> <span id="inicio-eps"></span></p>
          <p><b>AFP:</b> <span id="inicio-afp"></span></p>
          <p><b>ARL:</b> <span id="inicio-arl"></span></p>
          <p><b>SUPERVISOR:</b> <span id="inicio-supervisor"></span></p>
        </div>

        <img id="inicio-firma" class="brand" alt="Firma" src="" style="display:none; max-width:260px; border-radius:12px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- OVERLAY MEN√ö -->
    <div class="overlay" id="overlay">
      <div class="scrim" id="ovlClose"></div>
      <aside class="panel">
        <div class="btn-row">
          <button id="btn-ovl-back">ATR√ÅS</button>
        </div>
        <div class="image-center">
          <img alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" style="max-width:180px;border-radius:10px;" />
        </div>
        <h3>Selecciona una opci√≥n</h3>
        <button class="menu-btn" id="go-contrato">DATOS DEL CONTRATO</button>
        <button class="menu-btn" id="go-personales">DATOS PERSONALES</button>
        <button class="menu-btn" id="go-comunicados">COMUNICADOS</button>
        <button class="menu-btn" id="go-borrador">BORRADOR ACTIVIDADES</button>
        <button class="menu-btn" id="go-ingresar-cuenta">INGRESAR CUENTA</button>
        <button class="menu-btn" id="go-cuenta-drive">MI CUENTA DRIVE</button>
        <div style="height:24px"></div>
        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </aside>
    </div>

    <!-- VISTA REGISTRO -->
    <section id="view-registro" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">COMPLETANDO REGISTRO</h2>

        <label>Municipio de Expedici√≥n del Documento</label>
        <input id="reg-expedida" list="dl-expedida" placeholder="Escribe y selecciona" autocomplete="off">
        <datalist id="dl-expedida"></datalist>

        <label>Tel√©fono L√≠nea WhatsApp</label>
        <input id="reg-telefono" type="tel" inputmode="numeric" placeholder="Tel√©fono Personal">

        <label>Direcci√≥n de Residencia</label>
        <textarea id="reg-direccion" rows="2" placeholder="Usa abreviaciones. No escribas el municipio. Ej: Mz 5 Casa 16 B/ Orqu√≠deas II."></textarea>

        <label>Municipio de Residencia</label>
        <input id="reg-municipio" list="dl-municipio" placeholder="Escribe y selecciona" autocomplete="off">
        <datalist id="dl-municipio"></datalist>

        <label>Correo Personal</label>
        <input id="reg-correo" type="email" placeholder="correo que te pertenezca, NO Institucional">

        <label>Tipo de cuenta</label>
        <select id="reg-tipoCuenta">
          <option value="" disabled selected>Selecciona tipo de cuenta</option>
          <option>AHORROS</option><option>CORRIENTE</option>
        </select>

        <label>N√∫mero de cuenta</label>
        <input id="reg-numeroCuenta" type="tel" inputmode="numeric" placeholder="Ingresa n√∫mero de cuenta">

        <label>Banco</label>
        <select id="reg-banco"></select>

        <label>EPS</label>
        <select id="reg-eps"></select>

        <label>Fondo de Pensiones (AFP)</label>
        <div class="muted" style="margin:6px 0 8px;">
          <b>S√≠ eres Pensionado(a), selecciona N/A</b><br>Esto implica que, en cada cuenta debes presentar alguno de los siguientes soportes:<br>- Certificaci√≥n de Pensionado(a)<br>- Resoluci√≥n de Pensi√≥n<br>- Certificaci√≥n de Devoluci√≥n del Saldo por Vejez.
        </div>
        <select id="reg-pension"></select>

        <label>ARL</label>
        <select id="reg-arl"></select>

        <label>Imagen de Firma</label>
        <input type="file" id="reg-firma" accept="image/*" />
        <img id="reg-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <label>Fecha de nacimiento</label>
        <input
          id="reg-cumple"
          type="text"
          placeholder="dd/mm/aaaa"
          readonly
          onclick="abrirPickerCumple()" />

        <!-- Modal Fecha (ruleta) para Cumple: a√±os 1936..2008 -->
        <div id="cumpleModal" class="picker-modal" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:9999;">
          <div class="picker-box" style="width:90%; max-width:520px; background:#fff; border-radius:8px; padding:16px;">
            <h3 style="margin:0 0 8px 0;">Selecciona tu fecha de Nacimiento</h3>
            <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
              <div>
                <small>D√≠a</small>
                <select id="cumpleDia" size="10"></select>
              </div>
              <div>
                <small>Mes</small>
                <select id="cumpleMes" size="12"></select>
              </div>
              <div>
                <small>A√±o</small>
                <select id="cumpleAnio" size="10"></select>
              </div>
            </div>
            <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
              <button type="button" class="btn btn-cancel" onclick="cancelarPickerCumple()">Cancelar</button>
              <button type="button" class="btn btn-ok" onclick="confirmarPickerCumple()">Ok</button>
            </div>
          </div>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="reg-guardar">Guardar</button>
          <button id="reg-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA DATOS DEL CONTRATO -->
    <section id="view-contrato" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">DATOS DEL CONTRATO</h2>

        <div id="contrato-lectura" class="narrow"></div>

        <div class="btn-row spaced">
          <button id="contrato-editar" class="btn-primary">Actualizar</button>
          <button id="contrato-volver" class="danger">Regresar</button>
        </div>

        <div id="contrato-form" class="hidden" style="margin-top:10px;">
          <!-- Fecha Inicio (ruleta a√±o fijo 2026) -->
          <label>Fecha de Inicio</label>
          <input id="c-fechaInicio" type="text" placeholder="dd/mm/2026" readonly onclick="abrirPickerContrato('inicio')">
          <input id="c-diaInicio" type="text" readonly style="display:none;">
          <input id="c-mesInicio" type="text" readonly style="display:none;">

          <label>Fecha de Terminaci√≥n</label>
          <input id="c-fechaTermino" type="text" placeholder="dd/mm/2026" readonly onclick="abrirPickerContrato('termino')">
          <input id="c-diaTermino" type="text" readonly style="display:none;">
          <input id="c-mesTermino" type="text" readonly style="display:none;">

          <!-- Modal Picker (a√±o fijo 2026) -->
          <div id="contratoFechaModal" class="picker-modal" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:9999;">
            <div class="picker-box" style="width:90%; max-width:520px; background:#fff; border-radius:8px; padding:16px;">
              <h3 style="margin:0 0 8px 0;">Selecciona la fecha</h3>
              <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
                <div>
                  <small>D√≠a</small>
                  <select id="contratoDia" size="10"></select>
                </div>
                <div>
                  <small>Mes</small>
                  <select id="contratoMes" size="12"></select>
                </div>
                <div>
                  <small>A√±o</small>
                  <select id="contratoAnio" size="3" disabled>
                    <option selected>2026</option>
                  </select>
                </div>
              </div>
              <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" class="btn btn-cancel" onclick="cancelarPickerContrato()">Cancelar</button>
                <button type="button" class="btn btn-ok" onclick="confirmarPickerContrato()">Ok</button>
              </div>
            </div>
          </div>

          <label>Meses de contrato</label>
          <input id="c-meses" type="tel" inputmode="numeric" placeholder="Autom√°tico; puedes editar">
          <label>D√≠as de complemento si Aplica</label>
          <input id="c-dias" type="tel" inputmode="numeric" placeholder="Autom√°tico; puedes editar">
          <label>Tiempo de ejecuci√≥n</label>
          <input id="c-ejecucion" type="text" readonly>

          <label>Registro Presupuestal (RP)</label>
          <input id="c-rp" type="tel" inputmode="numeric" placeholder="N¬∞ de RP" maxlength="10" style="border:1.5px solid #ccc;">

          <label>¬øTe encuentras bajo el r√©gimen simple de tributaci√≥n (SIMPLE)?</label>
          <select id="c-costos">
            <option value="" disabled selected>Selecciona</option>
            <option value="SI tomar√© costos o deducciones.">SI</option>
            <option value="NO tomar√© costos o deducciones.">NO</option>
          </select>
          <input id="c-regimen" type="text" readonly style="display:none;">

          <div class="btn-row spaced" style="margin-top:12px;">
            <button id="c-guardar" class="btn-primary">Guardar Cambios</button>
            <button id="c-cancelar" class="danger">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VISTA DATOS PERSONALES -->
    <section id="view-personales" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">Tus Datos Personales</h2>

        <div id="personales-lectura" class="narrow"></div>

        <div class="btn-row spaced">
          <button id="personales-editar" class="btn-primary">Actualizar</button>
          <button id="personales-volver" class="danger">Regresar</button>
        </div>

        <div id="personales-form" class="hidden" style="margin-top:10px;">
          <label>Municipio de Expedici√≥n del Documento</label>
          <input id="p-expedida" list="dl-expedida2" placeholder="Escribe y selecciona" autocomplete="off">
          <datalist id="dl-expedida2"></datalist>

          <label>Tel√©fono L√≠nea WhatsApp</label>
          <input id="p-telefono" type="tel" inputmode="numeric" placeholder="N√∫mero Personal">

          <label>Direcci√≥n de Residencia</label>
          <textarea id="p-direccion" rows="2" placeholder="Usa abreviaciones y no escribas el nombre del Municipio. Ejemplo: Mz 5 Casa 16 B/ Orqu√≠deas II"></textarea>

          <label>Municipio de Residencia</label>
          <input id="p-municipio" list="dl-municipio2" placeholder="Escribe y selecciona" autocomplete="off">
          <datalist id="dl-municipio2"></datalist>

          <label>Correo Personal</label>
          <input id="p-correo" type="email" placeholder="correo que te pertenezca, NO Institucional">

          <label>Tipo de cuenta</label>
          <select id="p-tipoCuenta">
            <option value="" disabled selected>Selecciona tipo de cuenta</option>
            <option>AHORROS</option><option>CORRIENTE</option>
          </select>

          <label>N√∫mero de cuenta</label>
          <input id="p-numeroCuenta" type="tel" inputmode="numeric" placeholder="Ingresa n√∫mero de cuenta">

          <label>Banco</label>
          <select id="p-banco"></select>

          <label>EPS</label>
          <select id="p-eps"></select>

          <label>Fondo de Pensiones (AFP)</label>
          <div class="muted" style="margin:6px 0 8px;">
          <b>S√≠ eres Pensionado(a), selecciona N/A</b><br>Esto implica que, en cada cuenta debes presentar alguno de los siguientes soportes:<br>- Certificaci√≥n de Pensionado(a)<br>- Resoluci√≥n de Pensi√≥n<br>- Certificaci√≥n de Devoluci√≥n del Saldo por Vejez.
        </div>

          <select id="p-pension"></select>

          <label>ARL</label>
          <select id="p-arl"></select>

          <label>Actualizar Firma</label>
          <input type="file" id="p-firma" accept="image/*" />
          <img id="p-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

           <label>Fecha de nacimiento</label>
        <input
          id="p-cumple"
          type="text"
          placeholder="dd/mm/aaaa"
          readonly
          onclick="abrirPickerCumplePersonales()" />

          <!-- Modal Cumple (Personales) Independiente -->
<div id="pCumpleModal" class="picker-modal" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:9999;">
  <div class="picker-box" style="width:90%; max-width:520px; background:#fff; border-radius:8px; padding:16px;">
    <h3 style="margin:0 0 8px 0;">Selecciona tu fecha de Nacimiento</h3>
    <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
      <div>
        <small>D√≠a</small>
        <select id="pCumpleDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="pCumpleMes" size="12"></select>
      </div>
      <div>
        <small>A√±o</small>
        <select id="pCumpleAnio" size="10"></select>
      </div>
    </div>
    <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn btn-cancel" onclick="cancelarPickerCumplePersonales()">Cancelar</button>
      <button type="button" class="btn btn-ok" onclick="confirmarPickerCumplePersonales()">Ok</button>
    </div>
  </div>
</div>


          <div class="btn-row spaced" style="margin-top:12px;">
            <button id="p-guardar" class="btn-primary">Guardar Cambios</button>
            <button id="p-cancelar" class="danger">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VISTA COMUNICADOS -->
    <section id="view-comunicados" class="view">
      <div class="card narrow" style="padding-top:12px;">
        <h2 style="color:var(--primary); text-shadow: 0 2px 2px #031732; margin-bottom:10px;">¬°COMUNICADOS!</h2>
        <div id="com-list" class="feed-list"></div>
        <div class="btn-row spaced">
          <button id="com-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA COMUNICADO DETALLE -->
    <section id="view-comunicado-detalle" class="view">
      <div class="feed-detail-card">
        <img id="com-det-thumb" class="feed-detail-thumb" src="" alt="">
        <h3 id="com-det-title" class="feed-detail-title">T√≠tulo</h3>
        <p id="com-det-sub" class="feed-detail-sub">Subt√≠tulo</p>
        <p id="com-det-desc" class="feed-detail-desc">Contenido</p>
        <div class="btn-row spaced">
          <a id="com-det-link" class="chip" href="#" target="_blank" rel="noopener" style="display:none;">Abrir V√≠nculo</a>
          <button id="com-det-volver">Regresar</button>
        </div>
      </div>
    </section>

 <!-- VISTA BORRADOR DE ACTIVIDADES -->
<section id="view-borrador" class="view">
  <div class="card narrow">
    <h2 style="color:var(--primary)">TU BORRADOR DE ACTIVIDADES</h2>
    
          <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>DESCRIPCI√ìN DETALLADA CON LOS CASOS QUE APLIQUE:</b><br><b>1.</b> En tus Activudades relaciona metas del Plan de Desarrollo (Si Aplica)<br><b>2.</b> Lugares de realizaci√≥n de actividades (barrios, veredas, conjuntos, oficina, etc.)<br><b>3.</b> Relaci√≥n de Cantidades (Atenci√≥n al P√∫blico, Revisiones, limpiezas, estudios, creaci√≥n de archivos, recepci√≥n y env√≠o de Documentos, visitas, reuniones, suministros entregados, trabajos realizados, etc.)<br><b>4.</b> Personas Impactadas por la Actividad<br><b>5.</b> Medios de Corroboraci√≥n de la Informaci√≥n (Link Fanpage, Link Drive con permiso, descripci√≥n de archivos, etc.)<br><br>Esta informaci√≥n debe evidenciarse en el anexo fotogr√°fico y estar relacionada en alg√∫n archivo entregado al supervisor.<br><br><b>PRE-AVISOS:</b><br><b>1.</b> No copies las mismas actividades en cada cuenta (est√°n bajo seguimiento)<br><b>2.</b> Las cuentas que no cumplan los par√°metros seg√∫n los casos, ser√°n devueltas.<br><b>3. Un informe de cuenta tiene el mismo valor que un Informe de Gesti√≥n, por tal raz√≥n, los supervisores no pueden aprobar cuentas que no cumplan con los cr√≠terios.</b>
        </div>


    
    <p class="helper">INFORME: <span id="ba-informe" class="chip">1</span>
  &nbsp; DE:
  <input id="ba-total-input" type="text" placeholder="Total" style="display:inline-block; width:auto; min-width:80px;" />
</p>

    <div id="ba-list" class="narrow"></div>

    <div class="btn-row spaced">
      <button id="ba-guardar" class="btn-primary">Guardar</button>
      <button id="ba-volver" class="danger">Regresar</button>
    </div>
  </div>
</section>

    <!-- Vista INGRESAR CUENTA -->

    <section id="view-ingresar-cuenta" class="view">
  <div class="card narrow">
    <h2 style="color:var(--primary)">CREACI√ìN DE CUENTA</h2>
    <h3 class="center" style="margin-top:6px;color:#333;">RELACI√ìN DE PAGO</h3>

    <p class="helper">
      INFORME:
      <span id="ic-informe" class="chip">1</span>
      &nbsp; DE:
      <input id="ic-total" type="text" placeholder="Total" style="display:inline-block; width:auto; min-width:80px;" />
    </p>

    <!-- Fechas: inicio/fin periodo y radicaci√≥n -->
    <div class="narrow">
      <label>Inicio de Periodo Relacionado</label>
      <input id="ic-inicio" type="text" placeholder="dd/mm/aaaa" readonly onclick="icAbrirInicio()" />
      <input id="ic-diaRat1" type="text" readonly style="display:none;">
      <input id="ic-mesRat1" type="text" readonly style="display:none;">

      <div id="icInicioModal" class="picker-modal" aria-hidden="true">
  <div class="picker-box">
    <h3 style="margin:0 0 8px 0;">Selecciona Inicio del Periodo (2026)</h3>
    <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
      <div>
        <small>D√≠a</small>
        <select id="icInicioDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="icInicioMes" size="12"></select>
      </div>
      <div>
        <small>A√±o</small>
        <select id="icInicioAnio" size="3" disabled>
          <option selected>2026</option>
        </select>
      </div>
    </div>
    <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn btn-cancel" onclick="icCancelarInicio()">Cancelar</button>
      <button type="button" class="btn btn-ok" onclick="icConfirmarInicio()">Ok</button>
    </div>
  </div>
</div>

      <label>Fin de Periodo Relacionado</label>
      <input id="ic-fin" type="text" placeholder="dd/mm/aaaa" readonly onclick="icAbrirFin()" />
      <input id="ic-diaRat2" type="text" readonly style="display:none;">
      <input id="ic-mesRat2" type="text" readonly style="display:none;">

      <div id="icFinModal" class="picker-modal" aria-hidden="true">
  <div class="picker-box">
    <h3 style="margin:0 0 8px 0;">Selecciona Fin del Periodo (2026)</h3>
    <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
      <div>
        <small>D√≠a</small>
        <select id="icFinDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="icFinMes" size="12"></select>
      </div>
      <div>
        <small>A√±o</small>
        <select id="icFinAnio" size="3" disabled>
          <option selected>2026</option>
        </select>
      </div>
    </div>
    <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn btn-cancel" onclick="icCancelarFin()">Cancelar</button>
      <button type="button" class="btn btn-ok" onclick="icConfirmarFin()">Ok</button>
    </div>
  </div>
</div>

      <label>Fecha de Radicaci√≥n</label>
      <input id="ic-radicado" type="text" placeholder="dd/mm/aaaa (hoy o pr√≥ximos 2 d√≠as h√°biles)" readonly onclick="icAbrirRadicado()" />
      <input id="ic-diaRad" type="text" readonly style="display:none;">
      <input id="ic-mesRad" type="text" readonly style="display:none;">
    </div>

    <div id="icRadicadoModal" class="picker-modal" aria-hidden="true">
  <div class="picker-box">
    <h3 style="margin:0 0 8px 0;">Selecciona Fecha de Radicaci√≥n</h3>
    <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
      <div>
        <small>D√≠a</small>
        <select id="icRadDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="icRadMes" size="12" disabled></select>
      </div>
      <div>
        <small>A√±o</small>
        <select id="icRadAnio" size="3" disabled></select>
      </div>
    </div>
    <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn btn-cancel" onclick="icCancelarRadicado()">Cancelar</button>
      <button type="button" class="btn btn-ok" onclick="icConfirmarRadicado()">Ok</button>
    </div>
  </div>
</div>

    <h3 class="center" style="margin-top:12px;color:#333;">RELACI√ìN DE PAGO</h3>

    <div class="narrow">
      <label>Saldo Actual</label>
      <input id="ic-saldo" type="tel" inputmode="numeric" placeholder="Primera cuenta: valor del contrato">

      <label>Valor por Cobrar</label>
      <input id="ic-cobro" type="tel" inputmode="numeric" placeholder="Ingresa el valor de este periodo">

      <label>Nuevo Saldo</label>
      <input id="ic-nuevoSaldo" type="text" readonly placeholder="$ 0" />

      <label>N¬∞ de Planilla</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa que el N√∫mero de Planilla coincida</b>
        </div>
      <input id="ic-planilla" type="tel" inputmode="numeric" placeholder="Planilla ya pagada">

      <label>Mes Relacionado en la Planilla</label>
      <select id="ic-mesPlanilla"></select>

      <label>Base de Cotizaci√≥n</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla IBC</b>
        </div>
      <input id="ic-base" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla">

      <label>Aportes a Salud</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Salud, sin intereses</b>
        </div>
      <input id="ic-salud" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla">

      <label>Aportes a Pensi√≥n</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Pensi√≥n, sin intereses<br><br>Si NO realizas aportes escribe 0</b>
        </div>
      <input id="ic-fondo" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla">

      <label>Aportes a ARL</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Riesgos, sin intereses<br><br>Si la entidad realiza los aportes por ser Tipo 3, 4 √≥ 5; escribe el valor del aporte</b>
        </div>
      <input id="ic-riesgos" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla">

      <input id="ic-solidario" type="text" readonly style="display:none;">
      <input id="ic-aporte" type="text" readonly style="display:none;">
    </div>

    <div class="center" style="margin-top:10px;">
      <button id="btn-planilla2-show" class="chip">Relacionar Planilla Anexa</button>
    </div>

    <div id="ic-planilla2-wrap" class="narrow hidden" style="margin-top:8px;">
      <h3 class="center" style="margin-top:6px;color:#333;">RELACI√ìN DE PAGO PLANILLA ANEXA</h3>
      <label>N¬∞ de Planilla Anexa</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa que el N√∫mero de Planilla coincida</b>
        </div>
      <input id="ic-planilla2" type="tel" inputmode="numeric" placeholder="Planilla ya pagada (opcional)">

      <label>Mes Relacionado en la Planilla Anexa</label>
      <select id="ic-mesPlanilla2"></select>

      <label>Base de Cotizaci√≥n (Anexa)</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla IBC</b>
        </div>
      <input id="ic-base2" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla (opcional)">

      <label>Aportes a Salud (Anexa)</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Salud, sin intereses</b>
        </div>
      <input id="ic-salud2" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla (opcional)">

      <label>Aportes a Pensi√≥n (Anexa)</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Pensi√≥n, sin intereses<br><br>Si NO realizas aportes escribe 0</b>
        </div>
      <input id="ic-fondo2" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla (opcional)">

      <label>Aportes a ARL (Anexa)</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Riesgos, sin intereses<br><br>Si la entidad realiza los aportes por ser Tipo 3, 4 0 5; escribe el valor que consignado por la entidad</b>
        </div>
      <input id="ic-riesgos2" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla (opcional)">

      <input id="ic-solidario2" type="text" readonly style="display:none;">
      <input id="ic-aporte2" type="text" readonly style="display:none;">

      <div class="center" style="margin-top:8px;">
        <button id="btn-planilla2-hide" class="chip danger">Ocultar Planilla Anexa</button>
      </div>
    </div>

    <h3 class="center" style="margin-top:12px;color:#333;">RELACI√ìN DE ACTIVIDADES</h3>

     <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>DESCRIPCI√ìN DETALLADA CON LOS CASOS QUE APLIQUE:</b><br><b>1.</b> En tus Activudades relaciona metas del Plan de Desarrollo (Si Aplica)<br><b>2.</b> Lugares de realizaci√≥n de actividades (barrios, veredas, conjuntos, oficina, etc.)<br><b>3.</b> Relaci√≥n de Cantidades (Atenci√≥n al P√∫blico, Revisiones, limpiezas, estudios, creaci√≥n de archivos, recepci√≥n y env√≠o de Documentos, visitas, reuniones, suministros entregados, trabajos realizados, etc.)<br><b>4.</b> Personas Impactadas por la Actividad<br><b>5.</b> Medios de Corroboraci√≥n de la Informaci√≥n (Link Fanpage, Link Drive con permiso, descripci√≥n de archivos, etc.)<br><br>Esta informaci√≥n debe evidenciarse en el anexo fotogr√°fico y estar relacionada en alg√∫n archivo entregado al supervisor.<br><br><b>PRE-AVISOS:</b><br><b>1.</b> No copies las mismas actividades en cada cuenta (est√°n bajo seguimiento)<br><b>2.</b> Las cuentas que no cumplan los par√°metros seg√∫n los casos, ser√°n devueltas.<br><b>3. Un informe de cuenta tiene el mismo valor que un Informe de Gesti√≥n, por tal raz√≥n, los supervisores no pueden aprobar cuentas que no cumplan con los cr√≠terios.</b>
        </div>
    
    <div id="ic-oblig-wrap" class="narrow"></div>
    

    <div class="btn-row spaced">
      <button id="ic-guardar" class="btn-primary">Guardar</button>
      <button id="ic-volver" class="danger">Regresar</button>
    </div>
  </div>
</section>
    
<script>
/* ================== CONFIGURACI√ìN ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbx5nz42xZ53WEM55Kmt_i9ngh9bn_qZjjHo3_Ub_nSz3MO0B8YDbapwk7s0LQhhnG0X/exec';

/* ================== SONIDOS ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
  logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3',
  menu: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Namedrop_Popup_ale2zy.mp3',
  notify: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759767435/Notificacion_d1woxv.mp3'
};
function playSoundOnce(url){
  try{ const a=new Audio(url); a.preload='auto'; a.play().catch(()=>{}); }catch(e){}
}
if (window.Swal && typeof Swal.fire === 'function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options = {}, ...rest){
    try{
      const icon = options.icon || options.type;
      const soundTag = options.soundTag;
      if (soundTag === 'resumen'){ playSoundOnce(SOUNDS.info); }
      else if (icon && SOUNDS[icon]){ playSoundOnce(SOUNDS[icon]); }
      if ('soundTag' in options){ delete options.soundTag; } // evita el warning
    }catch(e){ /* noop */ }
    return __fire(options, ...rest);
  };
}

  /* ================== IM√ÅGENES (preview y compresi√≥n) ================== */
const MAX_IMAGE_MB = 5;
const MAX_IMG_DIM  = 1600;   // px lado mayor para evidencias/firmas
const JPEG_QUALITY = 0.78;
const EVI_SELECT_MAX_MB = 10;

function revokeObjUrl(url){ try{ if(url) URL.revokeObjectURL(url); }catch(_){ } }

/**
 * Convierte cualquier imagen (incluido HEIC) a JPEG, redimensiona al tope y devuelve dataURL.
 * Retorna { dataUrl, sizeMB, width, height }.
 */
function compressImageToDataUrl(file, { maxDim = MAX_IMG_DIM, quality = JPEG_QUALITY } = {}){
  return new Promise((resolve, reject)=>{
    if(!file) return resolve({ dataUrl:'', sizeMB:0 });
    const reader = new FileReader();
    reader.onload = ()=>{
      const img = new Image();
      img.onload = ()=>{
        const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
        const w = Math.round(img.width  * scale);
        const h = Math.round(img.height * scale);

        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        canvas.toBlob(blob=>{
          if(!blob) return reject(new Error('No se pudo comprimir la imagen'));
          const sizeMB = blob.size / (1024*1024);
          const fr = new FileReader();
          fr.onload = ()=> resolve({ dataUrl: fr.result, sizeMB, width:w, height:h });
          fr.onerror = ()=> reject(new Error('No se pudo leer la imagen comprimida'));
          fr.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      };
      img.onerror = ()=> reject(new Error('La imagen no se pudo cargar'));
      img.src = reader.result;
    };
    reader.onerror = ()=> reject(new Error('No se pudo leer el archivo'));
    reader.readAsDataURL(file);
  });
}

/* ================== LOADER ================== */
const loader = document.getElementById('loader');
let loadingCount = 0, loaderTimer = null; let suppressLoader = false;
function startLoading(){
  if (suppressLoader) return;
  loadingCount++;
  if (loadingCount === 1){
    loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer = null; }, 120);
  }
}
function stopLoading(){
  if (suppressLoader) return;
  if (loadingCount === 0) return;
  loadingCount--;
  if (loadingCount === 0){
    if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
    loader.classList.add('hidden');
  }
}

/* ================== API ================== */
async function apiGet(action, params = {}){
  startLoading();
  try{
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({ action, ...params }).toString();
    const r = await fetch(url.toString(), { method: 'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}
async function apiPost(action, body = {}){
  startLoading();
  try{
    const url = API_BASE + '?action=' + encodeURIComponent(action);
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}

/* ================== ESTADO ================== */
let currentUser = null;

/* ================== VISTAS ================== */
function resetVistas(){
  // Ocultar formularios de edici√≥n y limpiar datalists y campos seg√∫n vistas
  document.getElementById('contrato-form')?.classList.add('hidden');
  document.getElementById('personales-form')?.classList.add('hidden');

  // Limpiar datalists (evita acumulaci√≥n)
  ['dl-expedida','dl-municipio','dl-expedida2','dl-municipio2'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.innerHTML='';
  });

  // Limpiar previews
  const pf = document.getElementById('p-firma-preview'); if(pf){ pf.src=''; pf.style.display='none'; }
  const rf = document.getElementById('reg-firma-preview'); if(rf){ rf.src=''; rf.style.display='none'; }

  // Campos de contrato
  ['c-fechaInicio','c-diaInicio','c-mesInicio','c-fechaTermino','c-diaTermino','c-mesTermino','c-meses','c-dias','c-ejecucion','c-rp','c-costos','c-regimen'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.value=''; }
  });

  // Campos personales edici√≥n
  ['p-expedida','p-telefono','p-direccion','p-municipio','p-correo','p-tipoCuenta','p-numeroCuenta','p-banco','p-eps','p-pension','p-arl','p-cumple'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.value=''; }
  });

  // Campos registro
  ['reg-expedida','reg-telefono','reg-direccion','reg-municipio','reg-correo','reg-tipoCuenta','reg-numeroCuenta','reg-banco','reg-eps','reg-pension','reg-arl','reg-cumple'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.value=''; }
  });

  // Limpiar caches locales del feed visual (no borra le√≠do)
  const wrap = document.getElementById('feed-list'); if(wrap) wrap.innerHTML='';
}
function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  document.getElementById(id)?.classList.add('active');
  overlay.classList.remove('open');
  window.scrollTo({ top: 0, behavior: 'smooth' });
  resetVistas();
}

/* ================== INPUT SANITIZERS ================== */
function bindNumericSanitizer(id, maxLen){
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', ()=>{
    const raw = (el.value || '').replace(/\D/g,'');
    el.value = maxLen ? raw.slice(0, maxLen) : raw;
  });
}

/* ================== LOGIN ================== */
const loginDoc = document.getElementById('login-doc');
document.getElementById('toggle-doc').addEventListener('click', ()=>{
  const oculto = loginDoc.type === 'password';
  loginDoc.type = oculto ? 'text' : 'password';
  const src = oculto
    ? 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Ocultar_lgdxpd.png'
    : 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png';
  document.getElementById('toggle-doc-img').src = src;
  document.getElementById('toggle-doc').setAttribute('aria-label', (oculto?'Ocultar':'Mostrar') + ' documento');
});
bindNumericSanitizer('login-doc', 10);

document.getElementById('btn-login').addEventListener('click', async ()=>{
  const documento = (loginDoc.value||'').trim();
  if(documento === ''){
    Swal.fire({ icon:'question', title:'¬øDeseas comenzar?', text:'Ingresa un Documento para validar.', timer:3000 });
    return;
  }
  if(!/^\d{6,10}$/.test(documento)){
    Swal.fire({
      icon:'error',
      title:'CONTRASE√ëA INCORRECTA',
      text:'La contrase√±a contiene entre 6 y 10 digitos num√©ricos.',
      timer:3000,
      showConfirmButton:false
    });
    return;
  }

  try{
    const res = await apiGet('loginContratista', { documento });
    if(!res?.existe){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A√öN',
        text:'Una vez sea ingresada la informaci√≥n de tu contrato podr√°s acceder.',
        timer:6000,
        showConfirmButton:false
      });
      return;
    }
    if(String(res.estado||'').toUpperCase()==='INACTIVO'){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A√öN',
        text:'Una vez sea ingresada la informaci√≥n de tu contrato podr√°s acceder.',
        timer:6000,
        showConfirmButton:false
      });
      return;
    }

    // ACTIVO
    currentUser = { documento: res.documento };
    if(res.incompleto){ // H..S vac√≠as
      showView('view-registro');
    }else{
      // Bootstrap paralelo: INICIO + NOTICIAS en una sola llamada
      (async ()=>{
        const boot = await apiGet('bootstrapInicio', { documento: currentUser.documento });
        const d = boot?.inicio || {};
        const list = boot?.noticias || [];

        // Pintar INICIO
        document.getElementById('inicio-nombre').textContent = d.nombre || '';
        document.getElementById('inicio-sub').textContent = 'CONTRATISTA - ' + (d.secretaria || '');
        document.getElementById('inicio-cc').innerHTML = (d.documento || '') + (d.expedida ? (' <b>DE</b> ' + d.expedida) : '');
        document.getElementById('inicio-contacto').textContent = d.telefono || '';
        document.getElementById('inicio-direccion').textContent = ((d.direccion||'') + ' ' + (d.municipio||'')).trim();
        document.getElementById('inicio-correo').textContent = d.correo || '';
        document.getElementById('inicio-cuenta').textContent = ((d.cuenta||'') + ' ' + (d.tipoCuenta||'') + ' ' + (d.banco||'')).trim();
        document.getElementById('inicio-eps').textContent = d.eps || '';
        document.getElementById('inicio-afp').textContent = d.pension || '';
        document.getElementById('inicio-arl').textContent = d.arl || '';
        document.getElementById('inicio-supervisor').textContent = d.supervisor || '';
        const firmaEl = document.getElementById('inicio-firma');
        if(d.firmaId){ firmaEl.src = thumbById(d.firmaId); firmaEl.style.display=''; } else { firmaEl.style.display='none'; }

        // Cache noticias + badge
        NOTICIAS_CACHE = Array.isArray(list) ? list : [];
        renderNoticiasList(NOTICIAS_CACHE);
        refreshNoticiasBadge();

        playSoundOnce(SOUNDS.login);
        showView('view-inicio');
      })();
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

// Bot√≥n COMUNICADOS (sin recarga innecesaria)
document.getElementById('go-comunicados')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  showView('view-comunicados'); // usa NOTICIAS_CACHE ya cargado al iniciar sesi√≥n
});

document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  currentUser = null;
  loginDoc.value = '';
  showView('view-login');
});

/* ================== MEN√ö ================== */
const overlay = document.getElementById('overlay');
document.getElementById('btn-open-menu').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.menu);
  overlay.classList.add('open');
});
document.getElementById('btn-ovl-back').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});
document.getElementById('ovlClose').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});


document.getElementById('go-contrato').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  await cargarContratoLectura();
  showView('view-contrato');
});
document.getElementById('go-personales').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  await cargarPersonalesLectura();
  showView('view-personales');
});

/* ================== INICIO ================== */
function thumbById(id){ return id ? ('https://drive.google.com/thumbnail?sz=w1000&id='+id) : ''; }
async function cargarInicio(){
  if(!currentUser) return;
  const d = await apiGet('getInicio', { documento: currentUser.documento });
  document.getElementById('inicio-nombre').textContent = d.nombre || '';
  document.getElementById('inicio-sub').textContent = 'CONTRATISTA - ' + (d.secretaria || '');
  document.getElementById('inicio-cc').innerHTML = (d.documento || '') + (d.expedida ? (' <b>DE</b> ' + d.expedida) : '');
  document.getElementById('inicio-contacto').textContent = d.telefono || '';
  document.getElementById('inicio-direccion').textContent = ((d.direccion||'') + ' ' + (d.municipio||'')).trim();
  document.getElementById('inicio-correo').textContent = d.correo || '';
  document.getElementById('inicio-cuenta').textContent = ((d.cuenta||'') + ' ' + (d.tipoCuenta||'') + ' ' + (d.banco||'')).trim();
  document.getElementById('inicio-eps').textContent = d.eps || '';
  document.getElementById('inicio-afp').textContent = d.pension || '';
  document.getElementById('inicio-arl').textContent = d.arl || '';
  document.getElementById('inicio-supervisor').textContent = d.supervisor || '';
  const firmaEl = document.getElementById('inicio-firma');
  if(d.firmaId){ firmaEl.src = thumbById(d.firmaId); firmaEl.style.display=''; } else { firmaEl.style.display='none'; }

  // INSERT: cargar noticias para mostrar badge
  try{ await loadNoticias(); }catch(_){}
}

/* ================== COMUNICADOS (NOTICIAS) ================== */

let NOTICIAS_CACHE = [];
const READ_KEY_PREFIX = 'noticiasRead@v1:';
function readKey(){
  return READ_KEY_PREFIX + (currentUser?.documento || 'anon');
}
function getReadMap(){
  try{ const raw = localStorage.getItem(readKey()); return raw ? JSON.parse(raw) : {}; }catch(_){ return {}; }
}
function setReadMap(map){
  try{ localStorage.setItem(readKey(), JSON.stringify(map||{})); }catch(_){}
}
function isRead(id){ const m = getReadMap(); return !!m[id]; }
function markRead(id){ const m = getReadMap(); m[id] = true; setReadMap(m); }

function thumbByIdNoticias(id){ return id ? ('https://drive.google.com/thumbnail?sz=w1000&id='+id) : 'https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png'; }

/* Cargar lista desde backend (20 √∫ltimas) */
async function loadNoticias(){
  const list = await apiGet('listNoticias');
  NOTICIAS_CACHE = Array.isArray(list) ? list : [];
  renderNoticiasList(NOTICIAS_CACHE);
  refreshNoticiasBadge();
}

/* Badge en Inicio: campana + contador + ‚ÄúVer Noticias‚Äù */
function unreadNoticiasCount(items){
  if(!Array.isArray(items) || !items.length) return 0;
  let n=0; for(const it of items){ if(!isRead(it.id)) n++; }
  return n;
}
// Clave de sesi√≥n para controlar el sonido (una vez por sesi√≥n)
const NOTICIAS_SOUND_KEY = 'noticiasNotifyPlayed@session';

function refreshNoticiasBadge(){
  const count = unreadNoticiasCount(NOTICIAS_CACHE);
  const bell  = document.getElementById('notif-bell');
  const label = document.getElementById('notif-label');
  const badge = document.getElementById('notif-count');

  if(badge){
    badge.textContent = String(count);
    badge.classList.toggle('active', count > 0);
  }

  const active = count > 0;
  if(bell)  bell.classList.toggle('active', active);
  if(label) label.classList.toggle('active', active);

  // Sonar "notify" solo una vez por sesi√≥n mientras existan no le√≠das
  try{
    const played = sessionStorage.getItem(NOTICIAS_SOUND_KEY) === '1';
    if(active && !played){
      playSoundOnce(SOUNDS.notify);
      sessionStorage.setItem(NOTICIAS_SOUND_KEY, '1');
    }
    if(!active){
      sessionStorage.removeItem(NOTICIAS_SOUND_KEY);
    }
  }catch(_){}
}
/* Lista de comunicados */
function renderNoticiasList(items){
  const wrap = document.getElementById('com-list');
  if(!wrap) return;
  wrap.innerHTML = '';

  if(!items.length){
    const p = document.createElement('p');
    p.className = 'muted center';
    p.textContent = 'No hay comunicados disponibles.';
    wrap.appendChild(p);
    return;
  }

  for(const it of items){
    const item = document.createElement('div');
    item.className = 'feed-item';
    item.dataset.id = it.id;

    const img = document.createElement('img');
    img.className = 'feed-thumb';
    img.alt = '';
    img.src = thumbByIdNoticias(it.imagenId);

    const ct = document.createElement('div');
    ct.className = 'feed-content';
    const h = document.createElement('h4');
    h.className = 'feed-title';
    h.textContent = it.titulo || '';
    const s = document.createElement('p');
    s.className = 'feed-sub';
    s.textContent = it.subtitulo || '';

    ct.appendChild(h);
    ct.appendChild(s);

    item.appendChild(img);
    item.appendChild(ct);

    if(!isRead(it.id)){
      const dot = document.createElement('span');
      dot.className = 'feed-dot';
      item.appendChild(dot);
    }

    item.addEventListener('click', ()=> openComunicadoDetalle(it));
    wrap.appendChild(item);
  }
}

/* Detalle de comunicado */
function openComunicadoDetalle(it){
  const thumb = document.getElementById('com-det-thumb');
  const title = document.getElementById('com-det-title');
  const sub   = document.getElementById('com-det-sub');
  const desc  = document.getElementById('com-det-desc');
  const link  = document.getElementById('com-det-link');

  if(thumb){ thumb.src = thumbByIdNoticias(it.imagenId); }
  if(title) title.textContent = it.titulo || '';
  if(sub)   sub.textContent   = it.subtitulo || '';
  if(desc)  desc.textContent  = it.contenido || '';

  const first = String(it.first_link||'').trim();
  if(link){
    if(first){ link.href = first; link.style.display=''; }
    else { link.href='#'; link.style.display='none'; }
  }

  markRead(it.id);
  renderNoticiasList(NOTICIAS_CACHE);
  refreshNoticiasBadge();
  showView('view-comunicado-detalle');
}

/* Navegaci√≥n y eventos */
document.getElementById('go-comunicados')?.addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  showView('view-comunicados');
});
document.getElementById('com-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);         
  showView('view-inicio');
});
document.getElementById('com-det-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);          
  showView('view-comunicados');
});

/* Click en etiqueta ‚ÄúVer Noticias‚Äù abre COMUNICADOS */
document.addEventListener('DOMContentLoaded', ()=>{
  const label = document.getElementById('notif-label');
  const btn   = document.getElementById('go-comunicados');
  if(!label || !btn) return;
  const openList = ()=>{
    playSoundOnce(SOUNDS.login);         
    btn.click();
  };
  // Click con mouse
  label.addEventListener('click', openList);
  label.setAttribute('role','button');
  label.setAttribute('tabindex','0');
  label.setAttribute('aria-label','Abrir comunicados');
  label.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openList(); } });
});

  /* ================== BORRADOR ACTIVIDADES ================== */
let BA_STATE = { informe:1, obligaciones:[], actividades:[], cuentaExiste:false, activo:false, nombre:'' };

document.getElementById('go-borrador')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return;
  }
  try{
    const data = await apiGet('getBorradorActividades', { documento: currentUser.documento });
  if (data.blocked && String(data.estado||'').toUpperCase() !== 'DEVUELTA'){
  await Swal.fire({
    icon:'info',
    title:'A√öN NO PUEDES CREAR BORRADOR',
    text:'Tienes una cuenta pendiente por Terminar etapas del proceso',
    timer:5000,
    showConfirmButton:false
  });
  showView('view-inicio');
  return;
}

// 3) Si BJ es DEVUELTA: alerta 5s y regreso a inicio con mensaje especial
if (String(data.estado||'').toUpperCase() === 'DEVUELTA'){
  await Swal.fire({
    icon:'info',
    title:'OPCI√ìN NO V√ÅLIDA POR AHORA',
    text:'Toma la opci√≥n CORREGIR CUENTA',
    timer:5000,
    showConfirmButton:false
  });
  showView('view-inicio');
  return;
}

    if(data.activo === false){
      await Swal.fire({
        icon:'info',
        title:'Estado INACTIVO',
        text:'Tu contrato no est√° ACTIVO actualmente.',
        timer:4000,
        showConfirmButton:false
      });
    }
    BA_STATE = data || BA_STATE;
    renderBorradorActividades();
    showView('view-borrador');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});

function renderBorradorActividades(){
 const badge = document.getElementById('ba-informe');
  if(badge) badge.textContent = String(BA_STATE.informe||1);

  const totInput = document.getElementById('ba-total-input');
  if(totInput) totInput.value = BA_STATE.total ? String(BA_STATE.total) : '';

  const wrap = document.getElementById('ba-list');
  wrap.innerHTML = '';
  const n = Math.max(1, (BA_STATE.obligaciones||[]).length);
  for(let i=0;i<n && i<26;i++){
    const idx = i+1;
    const oblig = (BA_STATE.obligaciones[i]||'').toString();
    const act   = (BA_STATE.actividades && BA_STATE.actividades[i]) ? BA_STATE.actividades[i] : '';

    const block = document.createElement('div');
    block.className = 'oblig-block';

    const p = document.createElement('p');
    p.innerHTML = `<b>Obligaci√≥n ${idx}:</b> ${oblig || '-'}`;

    const lab = document.createElement('label');
    lab.textContent = 'Actividades por Obligaci√≥n ' + idx + ':';

    const ta = document.createElement('textarea');
    ta.id = 'ba-act-'+idx;
    ta.rows = 5;
    ta.placeholder = 'Describe la(s) actividad(es) que quieres guardar, recuerda todo el esquema explicado en la parte superior.';
    ta.value = act || '';

    block.appendChild(p);
    block.appendChild(lab);
    block.appendChild(ta);
    wrap.appendChild(block);
  }
}

document.getElementById('ba-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

document.getElementById('ba-guardar')?.addEventListener('click', async ()=>{
  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return;
  }
  const n = Math.max(1, (BA_STATE.obligaciones||[]).length);
  const actividades = [];
  for(let i=1;i<=Math.min(26,n);i++){
    const el = document.getElementById('ba-act-'+i);
    actividades.push((el && el.value) ? el.value.trim() : '');
  }
  
  const totalInput = document.getElementById('ba-total-input');
  const totalVal = totalInput ? totalInput.value : '';
  
try{
    await apiPost('saveBorradorActividades', {
      documento: currentUser.documento,
      nombre: BA_STATE.nombre || '',
      informe: BA_STATE.informe || 1,
      total: totalVal, // se guarda en columna E
      actividades
    });
    await Swal.fire({icon:'success', title:'Borrador guardado', timer:1800, showConfirmButton:false});
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});
  
/* ================== SELECTS (banco/eps/afp/arl) ================== */
const BANKS = [
"BANCOLOMBIA","DAVIVIENDA","BANCO DE BOGOT√Å","BANCO CAJA SOCIAL","BANCO POPULAR","BANCO BBVA COLOMBIA S.A.","BANCO AV VILLAS","BANCO DE OCCIDENTE","BANCO AGRARIO DE COLOMBIA","BANCAMIA S.A.","BANCO SANTANDER COLOMBIA","BANCO FALABELLA","BANCO MUNDO MUJER S.A.","NEQUI","DAVIPLATA","DALE","NU","BANCOOMEVA S.A.","BANCO PICHINCHA S.A.","BANCO ITAU","CITIBANK COLOMBIA","BANCO COOPERATIVO COOPCENTRAL","DING","GLOBAL66","IRIS","JFK COOPERATIVA FINANCIERA","FINANCIERA JURISCOOP SA COMPA√ëIA DE FINANCIAMIENTO","ALIANZA FIDUCIARIA","BAN100","BANCO SERFINANZA","BOLD CF","COINK SA","COTRAFA","CREZCAMOS","COLTEFINANCIERA","CONFIAR COOPERATIVA FINANCIERA","CFA COOPERATIVA FINANCIERA","BANCO UNION","SCOTIABANK COLPATRIA","BANCO GNB SUDAMERIS","BANCO J.P. MORGAN COLOMBIA S.A.","BANCO FINANDINA S.A. BIC"
];
const EPS = ["SALUD TOTAL","SANITAS","FAMISANAR","NUEVA EPS","COMPENSAR","SANIDAD FUERZAS MILITARES","CONVIDA","COOSALUD","ALIANSALUD","ADRES MIN002"];
const AFP = ["PROTECCION","PORVENIR","COLFONDOS","OLD MUTUAL","COLPENSIONES","N/A"];
const ARL = ["SURA","POSITIVA","AXA COLPATRIA","COLMENA","BOLIVAR","LIBERTY","LA EQUIDAD"];

function fillSelect(id, options){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = '<option value="" disabled selected>Selecciona</option>' + options.map(o=>`<option value="${o}">${o}</option>`).join('');
}

/* ================== QUERY MUNICIPIOS ================== */
function bindQuery(inputId, datalistId){
  const input = document.getElementById(inputId);
  const list = document.getElementById(datalistId);
  if(!input || !list) return;

  let t = null;
  let abortCtrl = null;
  const cache = new Map(); // cache por t√©rmino

  input.addEventListener('input', ()=>{
    const q = input.value.trim();
    list.innerHTML = '';
    if (t) clearTimeout(t);
    if (!q){ if (abortCtrl) abortCtrl.abort(); return; }

    t = setTimeout(async ()=>{
      // Cache-hit
      if(cache.has(q)){
        const opts = cache.get(q);
        opts.forEach(opt=>{
          const o = document.createElement('option');
          o.value = opt;
          list.appendChild(o);
        });
        return;
      }
      // Cancelar petici√≥n anterior
      if (abortCtrl) abortCtrl.abort();
      abortCtrl = new AbortController();
      try{
        const url = new URL(API_BASE);
        url.search = new URLSearchParams({ action: 'getFilteredResidencias', query: q }).toString();
        const r = await fetch(url.toString(), { method: 'GET', signal: abortCtrl.signal });
        const j = await r.json();
        const opts = (j && j.ok && Array.isArray(j.data)) ? j.data : [];
        cache.set(q, opts);
        opts.forEach(opt=>{
          const o = document.createElement('option');
          o.value = opt;
          list.appendChild(o);
        });
      }catch(_){ /* silencio */ }
    }, 5); // debounce corto
  });
}

    /* ================== INGRESAR CUENTA ================== */

  /* Constantes y helpers */
const IC_SOLIDARIO_UMBRAL = 5694000;
const MESES_LIT = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
function formatCOPView(n){
  const x = Number(String(n).replace(/\D/g,''))||0;
  return '$ ' + x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}
function numPure(s){ return Number(String(s||'').replace(/\D/g,''))||0; }
function monthNameDMY(dmy){
  const m = (String(dmy).split('/')[1]||'01'); const idx = Math.max(1,Math.min(12,parseInt(m,10))) - 1;
  return MESES_LIT[idx];
}

  function emptyIfZero(n){
  const x = Number(String(n||'').replace(/\D/g,''))||0;
  return x === 0 ? '' : String(x);
}
  
function pad2(n){ return String(n).padStart(2,'0'); }

/* Estado local */
let IC_STATE = {
  informe: 1,
  total: '',
  obligaciones: [],
  actividades: [],
  evidFiles: [],    // ya no guardaremos el File para subir
  evidData: [],     // dataURL comprimida para preview + backend
  evidSizes: [],    // tama√±o MB de la dataURL comprimida
  cuentaExiste: false,
  nextMode: false,
  contrato: '',
  carpetaContratista: '',
  rowTarget: null,
  nombre: '',
  saldoQ: ''
};

/* Bot√≥n men√∫: INGRESAR CUENTA (con sonido y navegaci√≥n) */
document.getElementById('go-ingresar-cuenta')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({icon:'warning',title:'Sesi√≥n inv√°lida'}); 
    return;
  }

  try{
    // Usa una sola llamada optimizada del backend (CONTRATISTAS + CUENTAS)
    const base = await apiGet('getIngresarCuentaData', { documento: currentUser.documento });

    // Bloqueos por estado BJ
    const bj = String(base.estado||'').toUpperCase();
    if (bj==='DEVUELTA' || bj==='INGRESADA'){
      await Swal.fire({icon:'info',title:'OPCI√ìN NO V√ÅLIDA POR AHORA',html:'Toma la opci√≥n <b>CORREGIR CUENTA</b>',timer:5000,showConfirmButton:false});
      showView('view-inicio'); 
      return;
    }
    if (bj==='REVISADA POR SUPERVISOR'){
      await Swal.fire({icon:'info',title:'DEBES ESPERAR UN POCO M√ÅS',text:'La oficina de Contrataci√≥n no ha Aprobado tu anterior cuenta',timer:5000,showConfirmButton:false});
      showView('view-inicio'); 
      return;
    }

    // Cargar estado √∫nico
    IC_STATE.informe       = Number(base.informe||1);
    IC_STATE.total         = String(base.total||'');
    IC_STATE.saldoQ        = String(base.saldoQ||''); 
    IC_STATE.obligaciones  = Array.isArray(base.obligaciones) ? base.obligaciones : [];
    IC_STATE.actividades   = Array.isArray(base.actividades) ? base.actividades : [];
    IC_STATE.cuentaExiste  = !!base.cuentaExiste;
    IC_STATE.nextMode      = !!base.nextMode;
    IC_STATE.contrato      = String(base.contrato||'').trim();
    IC_STATE.nombre        = String(base.nombre||'').trim();  

    // Pintar vista
    renderIngresarCuenta();

    // Precargar SALDO ACTUAL si viene
    const saldoEl = document.getElementById('ic-saldo');
    if(saldoEl){
      if(IC_STATE.saldoQ){
        saldoEl.value = IC_STATE.saldoQ;
        const cobro = numPure(document.getElementById('ic-cobro').value||'');
        document.getElementById('ic-nuevoSaldo').value = formatCOPView(numPure(IC_STATE.saldoQ) - cobro);
      }else{
        saldoEl.placeholder = 'Primera cuenta: valor del contrato';
      }
    }

    showView('view-ingresar-cuenta');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:String(e.message||e)});
  }
});
  
// Alerta si el usuario da OK sin elegir un valor en el picker
function showPickerSelectAlert(){
  Swal.fire({
    icon:'info',
    title:'DEBES SELECCIONAR',
    text:'Corrobora tu selecci√≥n',
    timer:1000,
    showConfirmButton:false
  });
}

// Formato COP en inputs
const COP_INPUT_IDS = ['ic-saldo','ic-cobro','ic-base','ic-salud','ic-riesgos','ic-base2','ic-salud2','ic-fondo','ic-fondo2','ic-riesgos2'];

function formatCOPInstant(el){
  if(!el) return;
  const raw = numPure(el.value);
  if(!raw){ el.value = '$ '; return; }
  el.value = formatCOPView(raw);
}

function bindCOPFormatters(){
  COP_INPUT_IDS.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    // Valor inicial "$ "
    if(!el.value) el.value = '$ ';
    el.addEventListener('input', ()=>formatCOPInstant(el));
    el.addEventListener('blur',  ()=>formatCOPInstant(el));
  });
}
  
/* Render de la vista */
function renderIngresarCuenta(){
  // Informe y total
  document.getElementById('ic-informe').textContent = String(IC_STATE.informe||1);
  const tot = document.getElementById('ic-total'); if(tot) tot.value = IC_STATE.total||'';

  // Precargar SALDO ACTUAL con Q (editable)
  const saldoEl = document.getElementById('ic-saldo');
  if(saldoEl){
    saldoEl.value = IC_STATE.saldoQ || '';
  }

  // Meses select
  const sel1 = document.getElementById('ic-mesPlanilla'); const sel2 = document.getElementById('ic-mesPlanilla2');
  if(sel1) sel1.innerHTML = '<option value="" disabled selected>Selecciona</option>' + MESES_LIT.map(m=>`<option>${m}</option>`).join('');
  if(sel2) sel2.innerHTML = '<option value="" disabled selected>Selecciona</option>' + MESES_LIT.map(m=>`<option>${m}</option>`).join('');

  // Planilla anexa toggle
  document.getElementById('btn-planilla2-show')?.addEventListener('click', ()=>{
    document.getElementById('ic-planilla2-wrap')?.classList.remove('hidden');
  });
  document.getElementById('btn-planilla2-hide')?.addEventListener('click', ()=>{
    document.getElementById('ic-planilla2-wrap')?.classList.add('hidden');
  });

  // Nuevo saldo din√°mico + solidario/aporte
  const recompute = ()=>{
    const saldo = numPure(document.getElementById('ic-saldo').value);
    const cobro = numPure(document.getElementById('ic-cobro').value);

    const nuevoSaldoEl = document.getElementById('ic-nuevoSaldo');
    if(!saldo && !cobro){
      nuevoSaldoEl.value = '$ ';
    } else if(cobro > saldo){
      nuevoSaldoEl.value = 'Error, revisa las cantidades';
    } else {
      nuevoSaldoEl.value = formatCOPView(saldo - cobro);
    }

    const base = numPure(document.getElementById('ic-base').value);
    if(base >= IC_SOLIDARIO_UMBRAL){
      document.getElementById('ic-solidario').value = String(Math.round(base * 0.01));
      document.getElementById('ic-aporte').value = 'COL PENSIONES';
    }else{
      document.getElementById('ic-solidario').value = '0';
      document.getElementById('ic-aporte').value = '-';
    }

   const base2 = numPure(document.getElementById('ic-base2').value);
    if(base2 >= IC_SOLIDARIO_UMBRAL){
      document.getElementById('ic-solidario2').value = String(Math.round(base2 * 0.01));
      document.getElementById('ic-aporte2').value = 'COL PENSIONES';
    }else{
      document.getElementById('ic-solidario2').value = '0';
      document.getElementById('ic-aporte2').value = '-';
    }
  };
  ['ic-saldo','ic-cobro','ic-base','ic-base2'].forEach(id=>{
    const el = document.getElementById(id); if(el){ el.addEventListener('input', recompute); }
  });

  // >>> Formato de pesos
  bindCOPFormatters();
  recompute();

  // Obligaciones + Actividades + Evidencias
  const wrap = document.getElementById('ic-oblig-wrap');
  wrap.innerHTML = '';
  const n = Math.max(1, IC_STATE.obligaciones.length);
  IC_STATE.evidFiles = new Array(n).fill(null);

  for(let i=0;i<n && i<26;i++){
    const idx = i + 1;
    const oblig = IC_STATE.obligaciones[i] || '-';
    const actVal = (IC_STATE.actividades && IC_STATE.actividades[i]) ? IC_STATE.actividades[i] : '';

    const block = document.createElement('div');
    block.className = 'oblig-block';

    const p = document.createElement('p');
    p.innerHTML = `<b>Obligaci√≥n ${idx}:</b> ${oblig}`;

    const lab = document.createElement('label');
    lab.textContent = 'Actividades por Obligaci√≥n ' + idx + ':';

    const ta = document.createElement('textarea');
    ta.id = 'ic-act-' + idx;
    ta.rows = 5;
    ta.placeholder = 'Describe la(s) actividad(es) que quieres ingresar, recuerda todo el esquema explicado al empezar esta secci√≥n.';
    ta.value = actVal;

    const labE = document.createElement('label');
    labE.textContent = 'Evidencia Actividades ' + idx + ' (opcional)';

    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'image/*';
    inp.id = 'ic-evi-' + idx;

    const prev = document.createElement('img');
    prev.id = 'ic-evi-prev-' + idx;
    prev.style.display = 'none';
    prev.style.maxWidth = '100%';
    prev.style.borderRadius = '10px';
    prev.style.border = '1.5px solid #d8e4ff';
    prev.style.marginTop = '8px';

     let previewUrl = '';
   const prev = document.createElement('img');
prev.id = 'ic-evi-prev-' + idx;
prev.className = 'evi-preview';
prev.loading = 'lazy';
prev.style.display = 'none';

inp.addEventListener('change', async (e)=>{
  const file = e.target.files && e.target.files[0];
  // limpiar estado previo
  IC_STATE.evidFiles[i] = null;
  IC_STATE.evidData[i]  = '';
  IC_STATE.evidSizes[i] = 0;
  prev.src = '';
  prev.style.display = 'none';

  if(!file){ return; }

  // L√≠mite temprano por peso original
  if(file.size > EVI_SELECT_MAX_MB * 1024 * 1024){
    await Swal.fire({
      icon:'warning',
      title:`Imagen ${idx} muy pesada`,
      text:`Elige una foto menor a ${EVI_SELECT_MAX_MB} MB.`
    });
    inp.value = '';
    return;
  }

  try{
    const { dataUrl, sizeMB } = await compressImageToDataUrl(file);
    if(sizeMB > MAX_IMAGE_MB){
      await Swal.fire({
        icon:'warning',
        title:`Imagen ${idx} a√∫n supera ${MAX_IMAGE_MB} MB`,
        text:'Usa una foto m√°s liviana o baja la resoluci√≥n antes de cargarla.'
      });
      inp.value = '';
      return;
    }
    IC_STATE.evidFiles[i] = null;      // ya no guardamos el File
    IC_STATE.evidData[i]  = dataUrl;   // usamos el dataURL comprimido
    IC_STATE.evidSizes[i] = sizeMB;

    prev.src = dataUrl;
    prev.style.display = 'block';
  }catch(err){
    inp.value = '';
    prev.src = '';
    prev.style.display = 'none';
    await Swal.fire({ icon:'error', title:'Error con la imagen', text:String(err.message||err) });
  }
});

    // A√ëADE TODOS LOS ELEMENTOS AL BLOQUE EN ORDEN
    block.appendChild(p);
    block.appendChild(lab);
    block.appendChild(ta);
    block.appendChild(labE);
    block.appendChild(inp);
    block.appendChild(prev);

    wrap.appendChild(block);
  }
}

   // Reset de cuenta
  function resetIngresarCuentaView(){
  // Limpiar inputs principales
  ['ic-total','ic-inicio','ic-diaRat1','ic-mesRat1','ic-fin','ic-diaRat2','ic-mesRat2',
   'ic-radicado','ic-diaRad','ic-mesRad','ic-saldo','ic-cobro','ic-nuevoSaldo','ic-planilla',
   'ic-mesPlanilla','ic-base','ic-salud','ic-fondo','ic-riesgos',
   'ic-planilla2','ic-mesPlanilla2','ic-base2','ic-salud2','ic-fondo2','ic-riesgos2',
   'ic-solidario','ic-aporte','ic-solidario2','ic-aporte2'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.value=''; }
  });

  // Limpiar actividades y evidencias previas
  const wrap = document.getElementById('ic-oblig-wrap');
    IC_STATE.evidData = [];
IC_STATE.evidSizes = [];
IC_STATE.evidFiles = [];
  if(wrap){ wrap.innerHTML=''; }

  // Reset estado local m√≠nimo
  IC_STATE = {
    informe: 1,
    total: '',
     obligaciones: [],
  actividades: [],
  evidFiles: [],
  evidData: [],
  evidSizes: [],
    cuentaExiste: false,
    nextMode: false,
    contrato: '',
    carpetaContratista: '',
    rowTarget: null,
    nombre: ''   // oculto
  };
}

/* Fechas: picker reutilizando tu base con targets distintos */
let __icPickerTarget = null; // 'inicio'|'fin'

// Garantiza que el modal de Cumple tenga opciones (si a√∫n no est√°n cargadas)
function ensureCumpleModalOptions(){
  const dSel = document.getElementById('cumpleDia');
  const mSel = document.getElementById('cumpleMes');
  const aSel = document.getElementById('cumpleAnio');

  if (dSel && !dSel.childElementCount){
    for(let d=1; d<=31; d++){
      const opt=document.createElement('option');
      opt.value=String(d).padStart(2,'0');
      opt.textContent=opt.value;
      dSel.appendChild(opt);
    }
  }
  if (mSel && !mSel.childElementCount){
    const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){
      const opt=document.createElement('option');
      opt.value=String(i+1).padStart(2,'0');
      opt.textContent=mesesNombres[i];
      mSel.appendChild(opt);
    }
  }
  if (aSel && !aSel.childElementCount){
    // Rango amplio para periodos (aj√∫stalo si deseas)
    for(let y=1936;y<=2035;y++){
      const opt=document.createElement('option');
      opt.value=String(y);
      opt.textContent=String(y);
      aSel.appendChild(opt);
    }
  }
}

function abrirPickerIC(target){
  __icPickerTarget = target;
  ensureCumpleModalOptions();
  // Abre el modal de "cumple" que ya tienes
  const m=document.getElementById('cumpleModal');
  if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
}

  
/* Fecha de Radicaci√≥n: modal limitado (hoy y siguientes 2 d√≠as h√°biles; fin de semana/festivos 2026) */
const FERIADOS_2026 = new Set(['23/03/2026','02/04/2026','03/04/2026','01/05/2026','18/05/2026','08/06/2026','15/06/2026','29/06/2026','20/07/2026','07/08/2026','17/08/2026','12/10/2026','02/11/2026','16/11/2026','08/12/2026','25/11/2026']);
function esHabil(d){ // d = Date
  const dd = pad2(d.getDate()), mm = pad2(d.getMonth()+1), yy = d.getFullYear();
  const key = `${dd}/${mm}/${yy}`;
  const dow = d.getDay(); // 0=Domingo, 6=S√°bado
  // Diciembre: todos los d√≠as habilitados excepto feriados (seg√∫n tu regla especial)
  if (mm==='12'){
    return !FERIADOS_2026.has(key);
  }
  if(dow===0 || dow===6) return false;
  if(FERIADOS_2026.has(key)) return false;
  return true;
}
function abrirPickerRadicadoLimitado(){
  const m = document.getElementById('contratoFechaModal');
  const dSel = document.getElementById('contratoDia');
  const mSel = document.getElementById('contratoMes');
  const aSel = document.getElementById('contratoAnio');
  if(!m || !dSel || !mSel || !aSel) return;

  // Limpiar y recomponer selects
  dSel.innerHTML = '';
  mSel.innerHTML = '';
  aSel.innerHTML = '';

  const hoy = new Date();
  const opciones = [];
  let count = 0;
  let cursor = new Date(hoy);

  // Junta hoy + 2 pr√≥ximos d√≠as h√°biles (regla especial para diciembre/festivos 2026)
  while(count<3){
    if(esHabil(cursor)){
      opciones.push(new Date(cursor));
      count++;
    }
    cursor.setDate(cursor.getDate()+1);
  }

  // Configura Mes/A√±o seg√∫n la primera opci√≥n
  const d0 = opciones[0];
  const anio = String(d0.getFullYear());
  const mesIdx = d0.getMonth(); // 0..11
  const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const optM = document.createElement('option');
  optM.value = pad2(mesIdx+1);
  optM.textContent = mesesNombres[mesIdx];
  mSel.appendChild(optM);

  const optY = document.createElement('option');
  optY.value = anio;
  optY.textContent = anio;
  aSel.appendChild(optY);

  // D√≠as habilitados
  opciones.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = pad2(d.getDate());
    opt.textContent = pad2(d.getDate());
    dSel.appendChild(opt);
  });

  // Abrir modal y configurar target
  m.style.display='flex'; m.setAttribute('aria-hidden','false');
  __pickerContratoTarget = 'radicado';
}

  

/* Volver con sonido */
document.getElementById('ic-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  resetIngresarCuentaView();  
  showView('view-inicio');
});

/* Guardar con resumen + backend saveNuevaCuenta + generaci√≥n de documentos */
document.getElementById('ic-guardar')?.addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning',title:'Sesi√≥n inv√°lida'}); return; }

  // Validar actividades obligatorias
  {
    const n = Math.max(1, IC_STATE.obligaciones.length);
    IC_STATE.evidFiles = new Array(n).fill(null);
IC_STATE.evidData  = new Array(n).fill('');
IC_STATE.evidSizes = new Array(n).fill(0);
    for(let i=1;i<=Math.min(26,n);i++){
      const el = document.getElementById('ic-act-'+i);
      const v = (el && el.value) ? el.value.trim() : '';
      if(!v){
        await Swal.fire({ icon:'warning', title:`Faltan actividades`, text:`Debes diligenciar la actividad para la obligaci√≥n ${i}.` });
        return;
      }
    }
  }

  // Validaciones m√≠nimas
  const required = {
    inicio: document.getElementById('ic-inicio').value,
    fin: document.getElementById('ic-fin').value,
    radicado: document.getElementById('ic-radicado').value,
    saldo: document.getElementById('ic-saldo').value,
    cobro: document.getElementById('ic-cobro').value,
    planilla: document.getElementById('ic-planilla').value,
    mesPlanilla: document.getElementById('ic-mesPlanilla').value,
    base: document.getElementById('ic-base').value,
    salud: document.getElementById('ic-salud').value,
    fondo: document.getElementById('ic-fondo').value,
    riesgos: document.getElementById('ic-riesgos').value
  };
  if(Object.values(required).some(v=>!String(v||'').trim())){
    Swal.fire({icon:'warning',title:'Faltan campos requeridos'}); return;
  }

  // Actividades
  const n = Math.max(1, IC_STATE.obligaciones.length);
  const actividades = [];
  for(let i=1;i<=Math.min(26,n);i++){
    const el = document.getElementById('ic-act-'+i);
    actividades.push((el && el.value) ? el.value.trim() : '');
  }

  // Evidencias (1 por obligaci√≥n) a dataURL
    // Evidencias (1 por obligaci√≥n) ‚Üí comprimir y validar peso
  const evidenciasData = [];
for(let i=0;i<Math.min(26,n);i++){
  const dataUrl = IC_STATE.evidData[i] || '';
  const sz = IC_STATE.evidSizes[i] || 0;
  if(dataUrl && sz > MAX_IMAGE_MB){
    await Swal.fire({
      icon:'warning',
      title:`Evidencia ${i+1} supera ${MAX_IMAGE_MB} MB`,
      text:'Vuelve a cargarla con menor peso.'
    });
    return;
  }
  evidenciasData.push(dataUrl);
}

  // C√°lculos
  const saldo = numPure(required.saldo);
  const cobro = numPure(required.cobro);
  const nuevoSaldo = saldo - cobro;
  const base = numPure(required.base);
  const solidario = base>=IC_SOLIDARIO_UMBRAL ? Math.round(base*0.01) : 0;
  const aporte = base>=IC_SOLIDARIO_UMBRAL ? 'COL PENSIONES' : '-';

  const base2 = numPure(document.getElementById('ic-base2').value||'');
  const solidario2 = base2>=IC_SOLIDARIO_UMBRAL ? Math.round(base2*0.01) : 0;
  const aporte2 = base2>=IC_SOLIDARIO_UMBRAL ? 'COL PENSIONES' : '-';

  // Fuerza dos d√≠gitos para d√≠as desde los inputs ocultos
  const diaRadicar  = pad2(document.getElementById('ic-diaRad').value||'');
  const diaRat1     = pad2(document.getElementById('ic-diaRat1').value||'');
  const diaRat2     = pad2(document.getElementById('ic-diaRat2').value||'');

  const body = {
    documento: currentUser.documento,
    nombre: IC_STATE.nombre || '',
    contrato: IC_STATE.contrato || '',
    informe: IC_STATE.informe || 1,
    total: String(document.getElementById('ic-total').value||''),
    fechaRadicar: document.getElementById('ic-radicado').value,
    diaRadicar: diaRadicar,            // 2 d√≠gitos
    mesRadicar: document.getElementById('ic-mesRad').value,
    inicioRatificar: document.getElementById('ic-inicio').value,
    diaRatificar1: diaRat1,            // 2 d√≠gitos
    mesRatificar1: document.getElementById('ic-mesRat1').value,
    finRatificar: document.getElementById('ic-fin').value,
    diaRatificar2: diaRat2,            // 2 d√≠gitos
    mesRatificar2: document.getElementById('ic-mesRat2').value,
    saldoActual: String(saldo),
    cobro: String(cobro),
    nuevoSaldo: String(nuevoSaldo),
    planilla: String(numPure(document.getElementById('ic-planilla').value)),
    mesPlanilla: document.getElementById('ic-mesPlanilla').value,
    base: String(base),
    salud: String(numPure(document.getElementById('ic-salud').value)),
    fondo: String(numPure(document.getElementById('ic-fondo').value)),
    riesgos: String(numPure(document.getElementById('ic-riesgos').value)),
    solidario: String(solidario),
    aporte: aporte,
    planilla2: emptyIfZero(document.getElementById('ic-planilla2').value||''),
    mesPlanilla2: document.getElementById('ic-mesPlanilla2').value || '',
    base2: emptyIfZero(document.getElementById('ic-base2').value||''),
    salud2: emptyIfZero(document.getElementById('ic-salud2').value||''),
    fondo2: emptyIfZero(document.getElementById('ic-fondo2').value||''),
    riesgos2: emptyIfZero(document.getElementById('ic-riesgos2').value||''),
    solidario2: emptyIfZero(document.getElementById('ic-solidario2').value||''),
    aporte2: aporte2,
    actividades,
    evidenciasData,
    overwrite: !IC_STATE.nextMode && IC_STATE.cuentaExiste
  };

  // Resumen breve para confirmar
  const resumen = [
    `<b>Informe:</b> ${body.informe} de ${body.total}`,
    `<b>Periodo:</b> ${body.inicioRatificar} ‚Äî ${body.finRatificar}`,
    `<b>Radicaci√≥n:</b> ${body.fechaRadicar} (${body.diaRadicar} / ${body.mesRadicar})`
  ].join('<br>');

  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Ingreso', html:resumen,
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar'
  });
  if(!rs.isConfirmed) return;

  // Suprime el loader nativo durante este flujo
  suppressLoader = true;
  loadingCount = 0;
  if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }

  const prevLoaderDisplay = loader?.style.display;
  if(loader){ loader.classList.add('hidden'); loader.style.display = 'none'; }

  const waitSwal = Swal.fire({
    title: 'CREANDO TUS DOCUMENTOS...',
    html: 'Por favor espera un par de minutos mientras termina el proceso.<br>No salgas de la App.',
    allowOutsideClick: false,
    allowEscapeKey: false,
    didOpen: () => { Swal.showLoading(); }
  });

  try{
    const r = await apiPost('saveNuevaCuenta', body);
    await Swal.close();
    if(r && r.success){
      Swal.fire({
        icon:'success',
        title:'PROCESO FINALIZADO',
        html:'La cuenta qued√≥ <b>INGRESADA</b>.<br><br>Toma la opci√≥n <b>MI CUENTA DRIVE</b> en el Men√∫ Principal para revisarlos',
        timer: 6000, 
        showConfirmButton: false
      });
      resetIngresarCuentaView();
      showView('view-inicio');
    } else {
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    await Swal.close();
    Swal.fire({ icon:'error', title:'Error', text:String(e.message||e) });
  }finally{
    // Restablece el loader y el flag
    suppressLoader = false;
    loadingCount = 0;
    if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
    if(loader){
      loader.style.display = prevLoaderDisplay || '';
      loader.classList.add('hidden');
    }
  }
});


/* ================== REGISTRO ================== */
let regFirmaDataUrl = '';
let regPreviewUrl = '';
const regFirmaInput = document.getElementById('reg-firma');
const regFirmaPreview = document.getElementById('reg-firma-preview');

if (regFirmaInput && regFirmaPreview) {
  regFirmaInput.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    regFirmaDataUrl = '';
    revokeObjUrl(regPreviewUrl);
    regPreviewUrl = '';

    if (!file) {
      regFirmaPreview.src = '';
      regFirmaPreview.style.display = 'none';
      return;
    }

    try {
      const { dataUrl, sizeMB } = await compressImageToDataUrl(file);
      if (sizeMB > MAX_IMAGE_MB) {
        await Swal.fire({
          icon: 'warning',
          title: 'Imagen muy pesada',
          text: `La firma supera ${MAX_IMAGE_MB} MB. Usa una foto m√°s liviana.`
        });
        regFirmaInput.value = '';
        regFirmaPreview.src = '';
        regFirmaPreview.style.display = 'none';
        return;
      }
      regPreviewUrl = URL.createObjectURL(file);
      regFirmaPreview.src = regPreviewUrl;
      regFirmaPreview.style.display = 'block';
      regFirmaDataUrl = dataUrl;
    } catch (err) {
      regFirmaPreview.src = '';
      regFirmaPreview.style.display = 'none';
      await Swal.fire({ icon: 'error', title: 'Error con la imagen', text: String(err.message || err) });
    }
  });
}
bindNumericSanitizer('reg-telefono', 10);
bindNumericSanitizer('reg-numeroCuenta', 16);

fillSelect('reg-banco', BANKS);
fillSelect('reg-eps', EPS);
fillSelect('reg-pension', AFP);
fillSelect('reg-arl', ARL);

bindQuery('reg-expedida','dl-expedida');
bindQuery('reg-municipio','dl-municipio');

document.getElementById('reg-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const telefonoRegex = /^[0-9]{10}$/;
  const correoRegex = /^[^\s@]+@(example\.org|nomedominio\.net|dominio\.edu\.co|examplo\.edu\.co|empresa\.com|nombreempresa\.org|correo\.es|dominio\.es|outlook\.com|hotmail\.com|live\.com|gmail\.com|icloud\.com|me\.com)$/; // solo dominios expl√≠citos
  const numeroCuentaRaw = (document.getElementById('reg-numeroCuenta').value||'').replace(/\D/g,'');
  const body = {
    documento: currentUser.documento,
    expedida: document.getElementById('reg-expedida').value.trim(),
    telefono: document.getElementById('reg-telefono').value.trim(),
    direccion: document.getElementById('reg-direccion').value.trim(),
    municipio: document.getElementById('reg-municipio').value.trim(),
    correo: document.getElementById('reg-correo').value.trim(),
    tipoCuenta: document.getElementById('reg-tipoCuenta').value,
    numeroCuenta: numeroCuentaRaw,
    banco: document.getElementById('reg-banco').value,
    eps: document.getElementById('reg-eps').value,
    pension: document.getElementById('reg-pension').value,
    arl: document.getElementById('reg-arl').value,
    firmaDataUrl: regFirmaDataUrl || '',
    cumpleISO: __cumpleISO || '' // se llena desde el modal
  };
  // Requeridos
  const requiredOk = body.expedida && body.telefono && body.direccion && body.municipio && body.correo && body.tipoCuenta && body.numeroCuenta && body.banco && body.eps && body.pension && body.arl && body.firmaDataUrl && body.cumpleISO;
  if(!requiredOk){ Swal.fire({icon:'warning', title:'Faltan campos Requeridos'}); return; }
  if(!telefonoRegex.test(body.telefono)){ Swal.fire({icon:'warning', title:'Whatsapp inv√°lido'}); return; }
  if(!correoRegex.test(body.correo)){ Swal.fire({icon:'warning', title:'Correo inv√°lido'}); return; }
  if(!(body.numeroCuenta.length>=7 && body.numeroCuenta.length<=16)){ Swal.fire({icon:'warning', title:'N√∫mero de cuenta inv√°lido'}); return; }

  // Validaci√≥n exacta de municipios (expedida/municipio) en GS tambi√©n, pero aplicamos verificaci√≥n previa
  const exactExp = await apiGet('validateMunicipioExact', { nombre: body.expedida });
  const exactMup = await apiGet('validateMunicipioExact', { nombre: body.municipio });
  if(!exactExp || !exactMup){
    Swal.fire({icon:'warning', title:'Municipio inv√°lido', text:'Debe coincidir exactamente con la lista.'});
    return;
  }

  const resumenHtml = [
    body.expedida && `<b>Municipio de Expedici√≥n:</b> ${body.expedida}`,
    body.telefono && `<b>Whatsapp:</b> ${body.telefono}`,
    body.direccion && `<b>Direcci√≥n:</b> ${body.direccion}`,
    body.municipio && `<b>Municipio de Residencia:</b> ${body.municipio}`,
    body.correo && `<b>Correo:</b> ${body.correo}`,
    `<b>Cuenta:</b> ${body.numeroCuenta} ${body.tipoCuenta} ${body.banco}`,
    `<b>EPS:</b> ${body.eps}`,
    `<b>AFP:</b> ${body.pension}`,
    `<b>ARL:</b> ${body.arl}`
  ].filter(Boolean).join('<br>') + `<br><br><img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" alt="">`;

  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Registro', html:resumenHtml,
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  try{
    const r = await apiPost('saveRegistro', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Registro Exitoso', timer:1800, showConfirmButton:false });
      await cargarInicio();
      showView('view-inicio');
      await Swal.fire({ icon:'info', title:'DATOS DEL CONTRATO', text:'No olvides completar los datos de tu contrato sin errores', timer:4000, showConfirmButton:false });
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
document.getElementById('reg-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-login'); });

/* ================== CONTRATO (lectura + edici√≥n) ================== */
document.getElementById('contrato-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-inicio'); });
document.getElementById('contrato-editar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  document.getElementById('contrato-form').classList.remove('hidden');
});
bindNumericSanitizer('c-meses', 3);
bindNumericSanitizer('c-dias', 3);
bindNumericSanitizer('c-rp', 10);

document.getElementById('c-costos').addEventListener('change', function(){
  const simple = document.getElementById('c-regimen');
  if (this.value === 'SI tomar√© costos o deducciones.'){
    simple.value = 'SI';
  } else if (this.value === 'NO tomar√© costos o deducciones.'){
    simple.value = 'NO';
  } else {
    simple.value = '';
  }
});

function convertirNumeroATexto(n){
  // Conversor en espa√±ol MAY√öSCULAS (unidades a millones)
  const unidades=["","UN","DOS","TRES","CUATRO","CINCO","SEIS","SIETE","OCHO","NUEVE"];
  const especiales=["DIEZ","ONCE","DOCE","TRECE","CATORCE","QUINCE","DIECISEIS","DIECISIETE","DIECIOCHO","DIECINUEVE"];
  const decenas=["","DIEZ","VEINTE","TREINTA","CUARENTA","CINCUENTA","SESENTA","SETENTA","OCHENTA","NOVENTA"];
  const centenas=["","CIENTO","DOSCIENTOS","TRESCIENTOS","CUATROCIENTOS","QUINIENTOS","SEISCIENTOS","SETECIENTOS","OCHOCIENTOS","NOVECIENTOS"];
  function cDec(n){ if(n<10) return unidades[n]; if(n<20) return especiales[n-10];
    if(n===20) return "VEINTE"; if(n<30) return "VEINTI"+unidades[n%10];
    return decenas[Math.floor(n/10)] + (n%10 ? " Y " + unidades[n%10] : "");
  }
  function cCent(n){ if(n===100) return "CIEN"; if(n>100) return (centenas[Math.floor(n/100)]+" "+cDec(n%100)).trim(); return cDec(n); }
  function cMiles(n){ if(n<1000) return cCent(n);
    if(n<1000000){ const miles=Math.floor(n/1000), resto=n%1000;
      if(miles===1) return ("MIL "+(resto?cCent(resto):"")).trim();
      return (cCent(miles)+" MIL "+(resto?cCent(resto):"")).trim();
    }
    const millones=Math.floor(n/1000000), resto=n%1000000;
    if(millones===1) return ("UN MILL√ìN "+(resto?cMiles(resto):"")).trim();
    return (cCent(millones)+" MILLONES "+(resto?cMiles(resto):"")).trim();
  }
  let t=cMiles(parseInt(n||0,10)); if(t.endsWith(" UNO")) t=t.slice(0,-4)+" UN"; return t;
}
function actualizarEjecucion(){
  const meses = parseInt(document.getElementById('c-meses').value)||0;
  const dias = parseInt(document.getElementById('c-dias').value)||0;
  let txt = '';
  if(meses>0){ txt += `${convertirNumeroATexto(meses)} (${meses}) ${meses===1?'MES':'MESES'}`; }
  if(dias>0){ if(txt!=='') txt += ' Y '; txt += `${convertirNumeroATexto(dias)} (${dias}) ${dias===1?'DIA':'DIAS'}`; }
  document.getElementById('c-ejecucion').value = txt;
}
document.getElementById('c-meses').addEventListener('input', actualizarEjecucion);
document.getElementById('c-dias').addEventListener('input', actualizarEjecucion);

function getDaysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function calcularPlazo(){
  const fi = __fechaInicioISO; // desde picker ruleta
  const ft = __fechaTerminoISO; // desde picker ruleta
  const mesesEl = document.getElementById('c-meses');
  const diasEl = document.getElementById('c-dias');
  if(!fi || !ft){
    mesesEl.value=0; diasEl.value=0; actualizarEjecucion(); return;
  }
  const [di,mi,yi] = fi.split('/').map(x=>parseInt(x,10));
  const [dt,mt,yt] = ft.split('/').map(x=>parseInt(x,10));
  let fechaInicio = new Date(yi, mi-1, di);
  let fechaTermino = new Date(yt, mt-1, dt);
  if(isNaN(fechaInicio)||isNaN(fechaTermino)||fechaTermino<fechaInicio){
    mesesEl.value=0; diasEl.value=0; actualizarEjecucion(); return;
  }
  // Contar ambos extremos (incluye d√≠a final)
  let diffTime = Math.abs(fechaTermino - fechaInicio) + (1000*60*60*24);
  let diffDays = Math.ceil(diffTime / (1000*60*60*24));
  let meses=0, dias=0;
  while(diffDays>0){
    const dim = getDaysInMonth(fechaInicio.getFullYear(), fechaInicio.getMonth());
    if(diffDays >= dim){
      meses++; diffDays -= dim; fechaInicio.setMonth(fechaInicio.getMonth()+1);
    }else{ dias = diffDays; diffDays = 0; }
  }
  mesesEl.value = meses;
  diasEl.value = dias;
  actualizarEjecucion();
}

document.getElementById('c-rp').addEventListener('input', ()=>{
  const el = document.getElementById('c-rp');
  const raw = (el.value||'').replace(/\D/g,'').slice(0,10);
  el.value = raw;
  el.style.border = '';
  if(raw.length===10 && raw.startsWith('2026')){
    el.style.border = '2px solid green';
  }
});

document.getElementById('c-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const body = {
    documento: currentUser.documento,
    fechaInicioISO: __fechaInicioISO || '',
    diaInicio: document.getElementById('c-diaInicio').value||'',
    mesInicio: document.getElementById('c-mesInicio').value||'',
    fechaTerminoISO: __fechaTerminoISO || '',
    diaTermino: document.getElementById('c-diaTermino').value||'',
    mesTermino: document.getElementById('c-mesTermino').value||'',
    meses: document.getElementById('c-meses').value||'0',
    dias: document.getElementById('c-dias').value||'0',
    ejecucion: document.getElementById('c-ejecucion').value||'',
    rp: (document.getElementById('c-rp').value||'').replace(/\D/g,''),
    costos: document.getElementById('c-costos').value||'',
    regimen: document.getElementById('c-regimen').value||''
  };

  const hayCambiosContrato =
  !!(body.fechaInicioISO || body.fechaTerminoISO || body.rp || body.costos || body.regimen) ||
  (String(body.meses) !== '0') ||
  (String(body.dias) !== '0') ||
  !!body.ejecucion;

if (!hayCambiosContrato) {
  Swal.fire({ icon:'info', title:'Sin cambios', text:'No hay campos editados para guardar.' });
  return;
}

  // Resumen: solo campos editados (no vac√≠os)
  const resumen = [];
  if(body.fechaInicioISO) resumen.push(`<b>Fecha de Inicio:</b> ${body.fechaInicioISO}`);
  if(body.fechaTerminoISO) resumen.push(`<b>Fecha de Terminaci√≥n:</b> ${body.fechaTerminoISO}`);
  if(body.meses || body.dias) resumen.push(`<b>Meses/D√≠as:</b> ${body.meses||'0'} / ${body.dias||'0'}`);
  if(body.ejecucion) resumen.push(`<b>Tiempo de Ejecuci√≥n:</b> ${body.ejecucion}`);
  if(body.rp) resumen.push(`<b>RP:</b> ${body.rp}`);
  if(body.costos) resumen.push(`<b>Regimen Simple:</b> ${body.costos}`);
  if(body.regimen) resumen.push(`<b>Costos Adicionales:</b> ${body.regimen}`);

  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Cambios', html:resumen.join('<br>'),
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  try{
    const r = await apiPost('saveDatosContrato', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Actualizaci√≥n Exitosa', timer:1600, showConfirmButton:false });
      await cargarContratoLectura();
      document.getElementById('contrato-form').classList.add('hidden');
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
document.getElementById('c-cancelar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  document.getElementById('contrato-form').classList.add('hidden');
});

/* ================== PERSONALES (lectura + edici√≥n) ================== */
let pFirmaDataUrl = '';
let pPreviewUrl = '';
const pFirmaInput = document.getElementById('p-firma');
const pFirmaPreview = document.getElementById('p-firma-preview');

if (pFirmaInput && pFirmaPreview) {
  pFirmaInput.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    pFirmaDataUrl = '';
    revokeObjUrl(pPreviewUrl);
    pPreviewUrl = '';

    if (!file) {
      pFirmaPreview.src = '';
      pFirmaPreview.style.display = 'none';
      return;
    }

    try {
      const { dataUrl, sizeMB } = await compressImageToDataUrl(file);
      if (sizeMB > MAX_IMAGE_MB) {
        await Swal.fire({
          icon: 'warning',
          title: 'Imagen muy pesada',
          text: `La firma supera ${MAX_IMAGE_MB} MB. Usa una foto m√°s liviana.`
        });
        pFirmaInput.value = '';
        pFirmaPreview.src = '';
        pFirmaPreview.style.display = 'none';
        return;
      }
      pPreviewUrl = URL.createObjectURL(file);
      pFirmaPreview.src = pPreviewUrl;
      pFirmaPreview.style.display = 'block';
      pFirmaDataUrl = dataUrl;
    } catch (err) {
      pFirmaPreview.src = '';
      pFirmaPreview.style.display = 'none';
      await Swal.fire({ icon: 'error', title: 'Error con la imagen', text: String(err.message || err) });
    }
  });
}
bindNumericSanitizer('p-telefono', 10);
bindNumericSanitizer('p-numeroCuenta', 16);

fillSelect('p-banco', BANKS);
fillSelect('p-eps', EPS);
fillSelect('p-pension', AFP);
fillSelect('p-arl', ARL);

bindQuery('p-expedida','dl-expedida2');
bindQuery('p-municipio','dl-municipio2');

document.getElementById('personales-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-inicio'); });
document.getElementById('personales-editar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  document.getElementById('personales-form').classList.remove('hidden');
});
document.getElementById('p-cancelar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  document.getElementById('personales-form').classList.add('hidden');
});

document.getElementById('p-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const telefonoRegex = /^[0-9]{10}$/;
  const correoRegex = /^[^\s@]+@(example\.org|nomedominio\.net|dominio\.edu\.co|examplo\.edu\.co|empresa\.com|nombreempresa\.org|correo\.es|dominio\.es|outlook\.com|hotmail\.com|live\.com|gmail\.com|icloud\.com|me\.com)$/;

  const body = {
    documento: currentUser.documento,
    expedida: document.getElementById('p-expedida').value.trim(),
    telefono: document.getElementById('p-telefono').value.trim(),
    direccion: document.getElementById('p-direccion').value.trim(),
    municipio: document.getElementById('p-municipio').value.trim(),
    correo: document.getElementById('p-correo').value.trim(),
    tipoCuenta: document.getElementById('p-tipoCuenta').value,
    numeroCuenta: (document.getElementById('p-numeroCuenta').value||'').replace(/\D/g,''),
    banco: document.getElementById('p-banco').value,
    eps: document.getElementById('p-eps').value,
    pension: document.getElementById('p-pension').value,
    arl: document.getElementById('p-arl').value,
    firmaDataUrl: pFirmaDataUrl || '',
    cumpleISO: __cumpleISO || ''
  };

  // Validaci√≥n exacta (expedida/municipio) si vienen
  if(body.expedida){
    const ok = await apiGet('validateMunicipioExact', { nombre: body.expedida });
    if(!ok){ Swal.fire({icon:'warning', title:'Municipio de Expedici√≥n inv√°lido', text:'Debe coincidir exactamente con la lista.'}); return; }
  }
  if(body.municipio){
    const ok = await apiGet('validateMunicipioExact', { nombre: body.municipio });
    if(!ok){ Swal.fire({icon:'warning', title:'Municipio de Residencia inv√°lido', text:'Debe coincidir exactamente con la lista.'}); return; }
  }

   const hayCambiosPersonales = [
  'expedida','telefono','direccion','municipio','correo',
  'tipoCuenta','numeroCuenta','banco','eps','pension','arl',
  'firmaDataUrl','cumpleISO'
].some(k => {
  const v = body[k];
  return v !== undefined && v !== null && String(v).trim() !== '';
});

if (!hayCambiosPersonales) {
  Swal.fire({ icon:'info', title:'Sin cambios', text:'No hay campos editados para guardar.' });
  return;
}
  
  // Resumen solo campos editados
  const resumen = [];
  Object.entries(body).forEach(([k,v])=>{
    if(k!=='documento' && v){ resumen.push(`<b>${k}:</b> ${k==='numeroCuenta' ? v : v}`); }
  });
  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Cambios', html:resumen.join('<br>'),
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  if(body.telefono && !telefonoRegex.test(body.telefono)){ Swal.fire({icon:'warning', title:'Whatsapp inv√°lido'}); return; }
  if(body.correo && !correoRegex.test(body.correo)){ Swal.fire({icon:'warning', title:'Correo inv√°lido'}); return; }
  if(body.numeroCuenta && !(body.numeroCuenta.length>=7 && body.numeroCuenta.length<=16)){ Swal.fire({icon:'warning', title:'N√∫mero de cuenta inv√°lido'}); return; }

  try{
    const r = await apiPost('saveDatosPersonales', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Actualizaci√≥n Exitosa', timer:1600, showConfirmButton:false });
      await cargarPersonalesLectura();
      document.getElementById('personales-form').classList.add('hidden');
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

/* ================== CONTRATO: cargar lectura ================== */
async function cargarContratoLectura(){
  if(!currentUser) return;
  const d = await apiGet('getDatosContrato', { documento: currentUser.documento });
  const box = document.getElementById('contrato-lectura');
  const lines = [
    `<b>Secretar√≠a:</b> ${d.secretaria||''}`,
    `<b>Supervisor:</b> ${d.supervisor||''}`,
    `<b>Contrato N¬∞:</b> ${d.contrato||''} <b>de:</b> ${d.fechaContrato||''}`,
    `<b>Tipo de Contrato:</b> ${d.tipoContrato||''}`,
    `<b>Objeto:</b> ${d.objeto||''}`,
    `<b>Fecha de Inicio:</b> ${d.fechaInicio||''}`,
    `<b>Fecha de Terminaci√≥n:</b> ${d.fechaTermino||''}`,
    `<b>Valor Inicial:</b> ${d.valor||''}`,
    `<b>MRA:</b> ${d.mar||''}`,
    `<b>Valor Final:</b> ${d.valorFinal||''}`,
    `<b>CDP:</b> ${d.cdp||''}`,
    `<b>RP:</b> ${d.rp||''}`,
    `<b>CDP Adici√≥n:</b> ${d.cdpAdicion||''}`,
    `<b>RP Adici√≥n:</b> ${d.rpAdicion||''}`,
    `<b>Regimen Simple:</b> ${d.regimen||''}`
  ];
  (d.obligaciones||[]).forEach((o,i)=>{ lines.push(`<b>Obligaci√≥n ${i+1}:</b> ${o}`); });
  box.innerHTML = lines.map(l=>`<p>${l}</p>`).join('');
}

/* ================== PERSONALES: cargar lectura ================== */
async function cargarPersonalesLectura(){
  if(!currentUser) return;
  const d = await apiGet('getDatosPersonales', { documento: currentUser.documento });
  const box = document.getElementById('personales-lectura');
  const lines = [
    `<b>NOMBRE:</b> ${d.nombre||''}`,
    `<b>CC:</b> ${d.documento||''}`,
    `<b>EXPEDIDA:</b> ${d.expedida||''}`,
    `<b>WHATSAPP:</b> ${d.telefono||''}`,
    `<b>DIRECCI√ìN:</b> ${d.direccion||''}`,
    `<b>MUNICIPIO:</b> ${d.municipio||''}`,
    `<b>CORREO:</b> ${d.correo||''}`,
    `<b>CUENTA:</b> ${d.cuenta||''} ${d.tipoCuenta||''} ${d.banco||''}`,
    `<b>EPS:</b> ${d.eps||''}`,
    `<b>AFP:</b> ${d.pension||''}`,
    `<b>ARL:</b> ${d.arl||''}`,
    `<b>FECHA DE NACIMIENTO:</b> ${d.cumple||''}`
  ];
  box.innerHTML = lines.map(l=>`<p>${l}</p>`).join('');
}

/* ================== PWA AVANZADO ================== */
let deferredPrompt = null;
let __installStartShown = false;    // bandera: ya mostramos "App instal√°ndose"
let __installSuccessShown = false;  // bandera: ya mostramos "Instalaci√≥n exitosa"

function isStandalone(){
  const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const dmInstalled  = window.matchMedia('(display-mode: installed)').matches;
  const iosStandalone = (window.navigator.standalone === true);
  return dmStandalone || dmInstalled || iosStandalone;
}
function isIOS(){
  return /(iphone|ipad|ipod)/i.test(navigator.userAgent || '');
}
function isMarkedInstalled(){
  try{ return localStorage.getItem('pwaInstalledFlag') === '1'; }catch(_){ return false; }
}
function markInstalled(){
  try{ localStorage.setItem('pwaInstalledFlag', '1'); }catch(_){}
}
function clearInstalledMark(){
  try{ localStorage.removeItem('pwaInstalledFlag'); }catch(_){}
}
async function detectInstalled(){
  if (isStandalone()) return true;
  if (typeof navigator.getInstalledRelatedApps === 'function'){
    try{
      const apps = await navigator.getInstalledRelatedApps();
      const found = apps.some(a =>
        a.platform === 'webapp' &&
        typeof a.url === 'string' &&
        /manifest\.webmanifest$/.test(a.url)
      );
      if (found){
        markInstalled();
        return true;
      } else {
        clearInstalledMark();
      }
    }catch(_){}
  }
  return isMarkedInstalled();
}
function updateInstallButtonsVisibility(){
  const btn1 = document.getElementById('btn-instalar');
  const canPrompt = !!deferredPrompt;
  const installed = isMarkedInstalled() || isStandalone();
  const shouldShow = !installed && (canPrompt || isIOS());
  if(btn1) btn1.style.display = shouldShow ? '' : 'none';
}

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  updateInstallButtonsVisibility();
});

window.addEventListener('appinstalled', ()=>{
  markInstalled();
  deferredPrompt = null;
  updateInstallButtonsVisibility();
});

document.getElementById('btn-instalar').addEventListener('click', async ()=>{
  // Flujo iOS: se respeta exactamente tu alerta e instrucciones
  if(isIOS()){
    Swal.fire({
      icon:'info',
      title:'Para Instalar en tu Iphone',
      html:'1) Toca Compartir (cuadro con flecha en la parte inferior).<br>2) Elige "Agregar a pantalla de inicio".<br>3) Confirma "Agregar".'
    });
    return;
  }
  // Android: requiere beforeinstallprompt (deferredPrompt)
  if(!deferredPrompt){
    Swal.fire({icon:'info',title:'Instalaci√≥n no disponible todav√≠a'});
    return;
  }

  const dp = deferredPrompt;
  dp.prompt();                           // muestra di√°logo nativo de instalaci√≥n
  const choice = await dp.userChoice;    // espera la elecci√≥n del usuario
  deferredPrompt = null;                 // limpia el prompt (solo se usa una vez)

  if (choice.outcome === 'accepted'){
    // Primera alerta (Android): confirma inicio de instalaci√≥n por 6 segundos
    markInstalled();
    __installStartShown = true;
    Swal.fire({
  icon: 'success',
  title: '¬°App instal√°ndose!',
  html: `
    <div style="text-align:center; margin-top:8px;">
      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1764209976/Robot_c2vtua.gif"
        alt="Instalando app"
        style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
      >
      <div>Debes esperar unos segundos mientras el sistema instala la App.</div>
      <div style="margin-top:10px;">
        <b>Al desaparecer este aviso, puedes salir de esta vista. La App aparecer√° en la pantalla principal de este dispositivo.</b>
      </div>
    </div>
  `,
  timer: 12000,
  showConfirmButton: false
});
  } else {
    Swal.fire({icon:'info',title:'Instalaci√≥n cancelada'});
  }

  updateInstallButtonsVisibility();
});

async function initPWAVista(){
  const installed = await detectInstalled();
  if (installed){
    showView('view-login');
  } else {
    showView('view-instalar');
    updateInstallButtonsVisibility();
  }
}
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
window.addEventListener('load', initPWAVista);
  

/* ================== FECHAS: modales (Cumple y Contrato 2026) ================== */
  // Estado exclusivo para personales
let __cumpleISO_personales = ''; // dd/mm/yyyy

// Inicializador selectores b√°sicos (puedes reutilizar si ya est√° initPickerBase)
(function initPickerCumplePersonales(){
  const dSel = document.getElementById('pCumpleDia');
  const mSel = document.getElementById('pCumpleMes');
  const aSel = document.getElementById('pCumpleAnio');
  if(dSel && !dSel.childElementCount){
    for(let d=1; d<=31; d++){
      const opt=document.createElement('option');
      opt.value=String(d).padStart(2,'0');
      opt.textContent=opt.value;
      dSel.appendChild(opt);
    }
  }
  if(mSel && !mSel.childElementCount){
    const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){
      const opt=document.createElement('option');
      opt.value=String(i+1).padStart(2,'0');
      opt.textContent=mesesNombres[i];
      mSel.appendChild(opt);
    }
  }
  if(aSel && !aSel.childElementCount){
    // Mismo rango que registro: 1936..2008 (aj√∫stalo si deseas)
    for(let y=1936;y<=2008;y++){
      const opt=document.createElement('option');
      opt.value=String(y);
      opt.textContent=String(y);
      aSel.appendChild(opt);
    }
  }
})();

function abrirPickerCumplePersonales(){
  const m=document.getElementById('pCumpleModal');
  if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
}
function cancelarPickerCumplePersonales(){
  const m=document.getElementById('pCumpleModal');
  if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
function confirmarPickerCumplePersonales(){
  const dSel=document.getElementById('pCumpleDia')?.value||'01';
  const mSel=document.getElementById('pCumpleMes')?.value||'01';
  const aSel=document.getElementById('pCumpleAnio')?.value||'2000';
  const val = `${dSel}/${mSel}/${aSel}`;
  __cumpleISO_personales = val;
  const p  = document.getElementById('p-cumple'); if(p) p.value = val;
  cancelarPickerCumplePersonales();
}

// En el guardado de personales, aseg√∫rate de usar __cumpleISO_personales:
/// body.cumpleISO: __cumpleISO_personales || ''
  
let __cumpleISO = ''; // dd/mm/yyyy
function initPickerBase(dSelId, mSelId, aSelId, years){
  const dSel = document.getElementById(dSelId);
  const mSel = document.getElementById(mSelId);
  const aSel = aSelId ? document.getElementById(aSelId) : null;
  if(dSel && !dSel.childElementCount){
    for(let d=1; d<=31; d++){ const opt=document.createElement('option'); opt.value=String(d).padStart(2,'0'); opt.textContent=opt.value; dSel.appendChild(opt); }
  }
  if(mSel && !mSel.childElementCount){
    const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){ const opt=document.createElement('option'); opt.value=String(i+1).padStart(2,'0'); opt.textContent=mesesNombres[i]; mSel.appendChild(opt); }
  }
  if(aSel && !aSel.childElementCount){
    years.forEach(y=>{ const opt=document.createElement('option'); opt.value=String(y); opt.textContent=String(y); aSel.appendChild(opt); });
  }
}
// Cumple: a√±os 1936..2008
(function(){ const ys=[]; for(let y=1936;y<=2008;y++) ys.push(y); initPickerBase('cumpleDia','cumpleMes','cumpleAnio', ys); })();
function abrirPickerCumple(){
  const m=document.getElementById('cumpleModal');
  if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
}
function cancelarPickerCumple(){
  const m=document.getElementById('cumpleModal');
  if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
function confirmarPickerCumple(){
  const dSel=document.getElementById('cumpleDia')?.value||'01';
  const mSel=document.getElementById('cumpleMes')?.value||'01';
  const aSel=document.getElementById('cumpleAnio')?.value||'2000';
  const val = `${dSel}/${mSel}/${aSel}`;
  __cumpleISO = val;
  const reg = document.getElementById('reg-cumple'); if(reg) reg.value = val;
  const p  = document.getElementById('p-cumple');    if(p)  p.value = val;
  cancelarPickerCumple();
}
// Contrato: a√±o fijo 2026; reutilizable para inicio/termino
(function(){ initPickerBase('contratoDia','contratoMes',null,[]); })();
let __pickerContratoTarget = null; // 'inicio'|'termino'
let __fechaInicioISO = ''; // dd/mm/2026
let __fechaTerminoISO = '';
function abrirPickerContrato(target){
  __pickerContratoTarget = target;
  const m=document.getElementById('contratoFechaModal');
  if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
}
function cancelarPickerContrato(){
  const m=document.getElementById('contratoFechaModal');
  if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
function confirmarPickerContrato(){
  const dSel=document.getElementById('contratoDia')?.value||'01';
  const mSel=document.getElementById('contratoMes')?.value||'01';
  const anio='2026';
  const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const idx=Math.max(1,Math.min(12,parseInt(mSel,10)))-1;
  const mesNombre = mesesNombres[idx];

  if(__pickerContratoTarget==='inicio'){
    document.getElementById('c-fechaInicio').value = `${dSel}/${mSel}/${anio}`;
    document.getElementById('c-diaInicio').value   = dSel;
    document.getElementById('c-mesInicio').value   = mesNombre;
    __fechaInicioISO = `${dSel}/${mSel}/${anio}`;
  }else if(__pickerContratoTarget==='termino'){
    document.getElementById('c-fechaTermino').value = `${dSel}/${mSel}/${anio}`;
    document.getElementById('c-diaTermino').value   = dSel;
    document.getElementById('c-mesTermino').value   = mesNombre;
    __fechaTerminoISO = `${dSel}/${mSel}/${anio}`;
  }
  cancelarPickerContrato();
  calcularPlazo();
}

 function icPad2(n){ return String(n).padStart(2,'0'); }
const icMesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
let __icRadMonth = '';
let __icRadYear  = '';

// 1) Inicio (ruleta libre, a√±o fijo 2026)
(function icInitInicio(){
  const d = document.getElementById('icInicioDia');
  const m = document.getElementById('icInicioMes');
  if (d && !d.childElementCount){
    for(let i=1;i<=31;i++){ const o=document.createElement('option'); o.value=icPad2(i); o.textContent=o.value; d.appendChild(o); }
  }
  if (m && !m.childElementCount){
    for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=icPad2(i+1); o.textContent=icMesesNombres[i]; m.appendChild(o); }
  }
})();
function icAbrirInicio(){
  const modal = document.getElementById('icInicioModal');
  if(modal){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
}
function icCancelarInicio(){
  const modal = document.getElementById('icInicioModal');
  if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
}
function icConfirmarInicio(){
  const dia = document.getElementById('icInicioDia')?.value || '';
  const mes = document.getElementById('icInicioMes')?.value || '';
  if(!dia || !mes){ showPickerSelectAlert(); return; }

  const anio = '2026';
  const idx = Math.max(1,Math.min(12,parseInt(mes,10))) - 1;
  const mesNombre = icMesesNombres[idx];
  const input = document.getElementById('ic-inicio');
  const dOut  = document.getElementById('ic-diaRat1');
  const mOut  = document.getElementById('ic-mesRat1');
  if(input) input.value = `${dia}/${mes}/${anio}`;
  if(dOut) dOut.value = dia;
  if(mOut) mOut.value = mesNombre;
  icCancelarInicio();
}


// 2) Fin (ruleta libre, a√±o fijo 2026)
(function icInitFin(){
  const d = document.getElementById('icFinDia');
  const m = document.getElementById('icFinMes');
  if (d && !d.childElementCount){
    for(let i=1;i<=31;i++){ const o=document.createElement('option'); o.value=icPad2(i); o.textContent=o.value; d.appendChild(o); }
  }
  if (m && !m.childElementCount){
    for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=icPad2(i+1); o.textContent=icMesesNombres[i]; m.appendChild(o); }
  }
})();
function icAbrirFin(){
  const modal = document.getElementById('icFinModal');
  if(modal){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
}
function icCancelarFin(){
  const modal = document.getElementById('icFinModal');
  if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
}
function icConfirmarFin(){
  const dia = document.getElementById('icFinDia')?.value || '';
  const mes = document.getElementById('icFinMes')?.value || '';
  if(!dia || !mes){ showPickerSelectAlert(); return; }

  const anio = '2026';
  const idx = Math.max(1,Math.min(12,parseInt(mes,10))) - 1;
  const mesNombre = icMesesNombres[idx];
  const input = document.getElementById('ic-fin');
  const dOut  = document.getElementById('ic-diaRat2');
  const mOut  = document.getElementById('ic-mesRat2');
  if(input) input.value = `${dia}/${mes}/${anio}`;
  if(dOut) dOut.value = dia;
  if(mOut) mOut.value = mesNombre;
  icCancelarFin();
}

// 3) Radicado (hoy + 2 h√°biles; feriados no h√°biles, excepci√≥n diciembre habilita todos excepto feriados)
const IC_FERIADOS_2026 = new Set(['23/03/2026','02/04/2026','03/04/2026','01/05/2026','18/05/2026','08/06/2026','15/06/2026','29/06/2026','20/07/2026','07/08/2026','17/08/2026','12/10/2026','02/11/2026','16/11/2026','08/12/2026','25/11/2026']);
function icEsHabil(d){
  const dd = icPad2(d.getDate()), mm = icPad2(d.getMonth()+1), yy = d.getFullYear();
  const key = `${dd}/${mm}/${yy}`;
  const dow = d.getDay(); // 0=Domingo, 6=S√°bado
  if (mm==='12'){ // diciembre: todos h√°biles excepto feriados
    return !IC_FERIADOS_2026.has(key);
  }
  if(dow===0 || dow===6) return false;
  if(IC_FERIADOS_2026.has(key)) return false;
  return true;
}
function icAbrirRadicado(){
  const m = document.getElementById('icRadicadoModal');
  const dSel = document.getElementById('icRadDia');
  const mSel = document.getElementById('icRadMes');
  const aSel = document.getElementById('icRadAnio');
  if(!m || !dSel || !mSel || !aSel) return;

  // Reset options
  dSel.innerHTML = '';
  mSel.innerHTML = '';
  aSel.innerHTML = '';

  const hoy = new Date();
  const opciones = [];
  let count = 0;
  let cursor = new Date(hoy);

  // hoy + 2 h√°biles (diciembre: todos h√°biles salvo feriados)
  while(count<3){
    if(icEsHabil(cursor)){
      opciones.push(new Date(cursor));
      count++;
    }
    cursor.setDate(cursor.getDate()+1);
  }

  // Mes/A√±o fijados por la primera opci√≥n
  const d0 = opciones[0];
  __icRadYear  = String(d0.getFullYear());
  __icRadMonth = icPad2(d0.getMonth()+1);

  const optM = document.createElement('option');
  optM.value = __icRadMonth;
  optM.textContent = icMesesNombres[d0.getMonth()];
  mSel.appendChild(optM);

  const optY = document.createElement('option');
  optY.value = __icRadYear;
  optY.textContent = __icRadYear;
  aSel.appendChild(optY);

  // D√≠as posibles
  opciones.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = icPad2(d.getDate());
    opt.textContent = icPad2(d.getDate());
    dSel.appendChild(opt);
  });
  // por seguridad, selecciona el primer d√≠a
  if (dSel.options.length) dSel.selectedIndex = 0;

  m.style.display='flex';
  m.setAttribute('aria-hidden','false');
}
function icCancelarRadicado(){
  const m=document.getElementById('icRadicadoModal');
  if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
function icConfirmarRadicado(){
  const dSel = document.getElementById('icRadDia');
  const mSel = document.getElementById('icRadMes');
  const aSel = document.getElementById('icRadAnio');

  const dia  = (dSel?.value || '').trim();
  const mes  = (mSel?.value || __icRadMonth || '').trim();
  const anio = (aSel?.value || __icRadYear  || '').trim();

  if(!dia || !mes || !anio){ showPickerSelectAlert(); return; }

  const idx = Math.max(1,Math.min(12,parseInt(mes||'1',10))) - 1;
  const mesNombre = icMesesNombres[idx] || '';

  const input = document.getElementById('ic-radicado');
  const dOut  = document.getElementById('ic-diaRad');
  const mOut  = document.getElementById('ic-mesRad');

  if(input){
    input.value = `${dia}/${mes}/${anio}`;
    if(dOut) dOut.value = dia;
    if(mOut) mOut.value = mesNombre;
  }
  icCancelarRadicado();
}

  /* ================== CUENTA DRIVE ================== */

 document.getElementById('go-cuenta-drive')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }

  try{
    const res = await apiGet('getCuentaDrive', { documento: currentUser.documento });
    if(!res || !res.found){
      await Swal.fire({
        icon:'info',
        title:'NO HAZ INGRESADO CUENTAS',
        text:'Esta opci√≥n se tom√≥ despu√©s de Ingresar una Cuenta',
        timer:4000,
        showConfirmButton:false
      });
      return;
    }

    const estado = String(res.estado||'').toUpperCase();
    const folderId = String(res.folderId||'').trim();
    const openFolder = ()=>{ if(folderId){ window.open('https://drive.google.com/drive/folders/' + folderId, '_blank'); } };

    const estadosValidos = ['INGRESADA','INCOMPLETA','APROBADA'];
    if(estadosValidos.indexOf(estado) === -1){
      await Swal.fire({
        icon:'info',
        title:'OPCI√ìN NO VALIDA POR AHORA',
        text:'Tu cuenta ya fue revisada por el Supervisor y est√° en proceso de Aprobaci√≥n',
        timer:5000,
        showConfirmButton:false
      });
      return;
    }

    if(estado === 'APROBADA'){
      const r = await Swal.fire({
        icon:'success',
        title:'UNIFICA TUS DOCUMENTOS',
        text:'Ya solo falta el cargue en el SECOP II',
        confirmButtonText:'OK'
      });
      if(r.isConfirmed) openFolder();
      return;
    }

    if(estado === 'INCOMPLETA'){
      const r = await Swal.fire({
        icon:'info',
        title:'COMPLETA TUS DOCUMENTOS',
        text:'Recuerda de nuevo tomar la opci√≥n REPORTAR CUENTA DRIVE en el Men√∫ Principal',
        confirmButtonText:'OK'
      });
      if(r.isConfirmed) openFolder();
      return;
    }

    if(estado === 'INGRESADA'){
      const r = await Swal.fire({
        icon:'info',
        title:'REVISA TUS DOCUMENTOS',
        text:'Revisa que todo est√© correcto',
        confirmButtonText:'OK'
      });
      if(r.isConfirmed) openFolder();
      return;
    }
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});
  
/* ================== FIN ================== */
</script>
</body>
</html>
