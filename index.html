<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>CONTRATISTAS</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root{
      --primary:#06402B;
      --primary-2:#04281C;
      --ok:#16a34a;
      --error:#dc2626;
      --scrim:rgba(0,0,0,.35);
    }
    html,body{
      margin:0; padding:0; height:100%; width:100%;
      overflow-x:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:#111;
      background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905870/fondo_verde_tvntsi.png') center/cover fixed no-repeat;
    }
    .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

    .view{ display:none; opacity:0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      box-sizing:border-box; padding:16px;
    }
    .view.active{ display:block; opacity:1; transform: translateY(0); }

    .card{
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(3px);
      border: 2px solid #ddd; border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      max-width: 820px; margin: 16px auto; padding: 20px 20px 16px;
    }
    h1,h2,h3{ margin: 8px 0 12px; text-align:center; }
    p.helper{ color:#444; font-size:.95rem; text-align:center; margin:8px 0 16px; }
    label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
    input, select, textarea, button{
      width:100%; padding:12px; box-sizing:border-box;
      border:1.5px solid #ccc; border-radius:8px; background:#fff;
      outline:none; transition: border-color .2s ease, transform .08s ease;
      font-size:16px;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
    button{
      cursor:pointer; border:2px solid var(--primary);
      background:#fff; color:#000; font-weight:700;
    }
    button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-row{ display:flex; gap:12px; flex-wrap:wrap; }
    .btn-row > *{ flex:1; }
    .muted{ color:#666; font-size:.85rem; }
    .center{ text-align:center; }
    .image-center{ display:flex; justify-content:center; }
    .brand{ width:240px; border-radius:12px; display:block; margin:12px auto 4px; }
    .chip{
      padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
      background:#fff; font-weight:700; color:#000; text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .danger{ background:#e11; border-color:#e11; color:#fff; }

    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
    }
    .loader.hidden{ opacity:0; pointer-events:none; }
    .spinner-ios{ position:relative; width:64px; height:64px; }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px;
      opacity:.2; animation:iosFade 1.2s linear infinite; transform-origin: center center;
    }
    @keyframes iosFade{ 0%, 39%, 100% { opacity:.2; } 40% { opacity:1; } }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    .hidden{ display:none !important; }
    .narrow{ max-width: 560px; margin: 0 auto; }
    .spaced{ margin-top:12px; }

    /* Overlay Men√∫ */
    .overlay{ position: fixed; inset: 0; pointer-events:none; }
    .overlay .scrim{ position:absolute; inset:0; background:var(--scrim); opacity:0; transition:opacity .25s ease; }
    .overlay .panel{
      position:absolute; top:0; left:0; width:min(360px, 90vw); height:100%;
      background:#06402B; color:#fff; padding:16px 16px 8px 16px; box-sizing:border-box;
      transform: translateX(-100%); transition: transform .25s ease;
      display:flex; flex-direction:column; gap:10px; overflow-y:auto; min-height: 0;
    }
    .overlay.open{ pointer-events:auto; }
    .overlay.open .scrim{ opacity:1; }
    .overlay.open .panel{ transform: translateX(0); }
    .panel h3{ margin: 4px 0 8px; text-align:center; }
    .menu-btn{
      background:#7de3ef; color:#000; border:0; font-weight:800;
      border-radius:999px; padding:12px; box-shadow: 0 6px 12px rgba(0,0,0,.18);
    }

    .avatar-emoji{
      width:120px; height:120px; display:block; margin:0 auto;
    }

    @media (max-width: 700px){ .btn-row{ flex-direction:column; } }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <div class="container">
    <!-- VISTA INSTALAR -->
    <section id="view-instalar" class="view">
      <div class="card narrow" style="text-align:center;">
        <h2 style="color:var(--primary);">APP CONTRATISTAS</h2>
        <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p style="font-weight:600;">Herramienta para Contratistas</p>
        <div class="btn-row" style="justify-content:center; margin-top:12px;">
          <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
        </div>
        <p class="center muted" style="margin-top:14px;">Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.</p>
      </div>
    </section>

    <!-- VISTA LOGIN -->
    <section id="view-login" class="view active">
      <div class="card narrow">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">CONTRATISTAS</h1>
        <p class="helper"><b>Acceso exclusivo para Contratistas activos.</b></p>

        <label>Contrase√±a</label>
        <div class="pwd-wrapper" style="position:relative;">
          <input id="login-doc" type="password" inputmode="numeric" autocomplete="off" placeholder="Sin puntos ni espacios" />
          <button type="button" id="toggle-doc" aria-label="Mostrar documento" style="position:absolute;top:50%;right:10px;transform:translateY(-50%);background:transparent;border:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:6px;">
            <img id="toggle-doc-img" src="https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png" alt="Mostrar" style="width:22px;height:22px;">
          </button>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
        </div>

        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA INICIO -->
    <section id="view-inicio" class="view">
      <div class="card narrow">
        <div class="btn-row" style="margin-bottom:12px;">
          <button class="chip danger" id="btn-logout">Cerrar Sesi√≥n</button>
          <button class="chip" id="btn-open-menu">MEN√ö</button>
        </div>

        <img class="avatar-emoji" src="https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png" alt="">

        <h2 id="inicio-nombre" style="color:var(--primary); font-weight:900; margin-top:6px;"></h2>
        <p id="inicio-sub" class="center muted" style="margin-top:0; font-weight:300;"></p>

        <div class="narrow" style="margin-top:10px;">
          <p><b>CC:</b> <span id="inicio-cc"></span></p>
          <p><b>CONTACTO:</b> <span id="inicio-contacto"></span></p>
          <p><b>DIRECCI√ìN:</b> <span id="inicio-direccion"></span></p>
          <p><b>CORREO:</b> <span id="inicio-correo"></span></p>
          <p><b>CUENTA N¬∞:</b> <span id="inicio-cuenta"></span></p>
          <p><b>EPS:</b> <span id="inicio-eps"></span></p>
          <p><b>AFP:</b> <span id="inicio-afp"></span></p>
          <p><b>ARL:</b> <span id="inicio-arl"></span></p>
          <p><b>SUPERVISOR:</b> <span id="inicio-supervisor"></span></p>
        </div>

        <img id="inicio-firma" class="brand" alt="Firma" src="" style="display:none; max-width:260px; border-radius:12px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- OVERLAY MEN√ö -->
    <div class="overlay" id="overlay">
      <div class="scrim" id="ovlClose"></div>
      <aside class="panel">
        <div class="btn-row">
          <button id="btn-ovl-back">ATR√ÅS</button>
        </div>
        <div class="image-center">
          <img alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763930524/menu_t9xli7.gif" style="max-width:180px;border-radius:10px;" />
        </div>
        <h3>Selecciona una opci√≥n</h3>
        <button class="menu-btn" id="go-noticias">VER NOTICIAS</button>
        <button class="menu-btn" id="go-contrato">DATOS DEL CONTRATO</button>
        <button class="menu-btn" id="go-personales">DATOS PERSONALES</button>
        <div style="height:24px"></div>
        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </aside>
    </div>

    <!-- VISTA REGISTRO -->
    <section id="view-registro" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">COMPLETANDO REGISTRO</h2>

        <label>Municipio de Expedici√≥n del Documento</label>
        <input id="reg-expedida" list="dl-expedida" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
        <datalist id="dl-expedida"></datalist>

        <label>Tel√©fono L√≠nea WhatsApp</label>
        <input id="reg-telefono" type="tel" inputmode="numeric" placeholder="sin puntos ni espacios">

        <label>Direcci√≥n de Residencia</label>
        <textarea id="reg-direccion" rows="2" placeholder="Usa abreviaciones. No escribas el municipio. Ej: Mz 5 Casa 16 B/ Orqu√≠deas II."></textarea>

        <label>Municipio de Residencia</label>
        <input id="reg-municipio" list="dl-municipio" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
        <datalist id="dl-municipio"></datalist>

        <label>Correo Personal</label>
        <input id="reg-correo" type="email" placeholder="correo que te pertenezca">

        <label>Tipo de cuenta</label>
        <select id="reg-tipoCuenta">
          <option value="" disabled selected>Selecciona tipo de cuenta</option>
          <option>AHORROS</option><option>CORRIENTE</option>
        </select>

        <label>Numero de cuenta</label>
        <input id="reg-numeroCuenta" type="tel" inputmode="numeric" placeholder="Ingresa n√∫mero de cuenta">

        <label>Banco</label>
        <select id="reg-banco"></select>

        <label>EPS</label>
        <select id="reg-eps"></select>

        <label>Fondo de Pensiones (AFP)</label>
        <div class="muted" style="margin:6px 0 8px;">
          <b>S√≠ eres Pensionado(a), selecciona N/A</b><br>Esto implica que, en cada cuenta debes presentar alguno de los siguientes soportes:<br>- Certificaci√≥n de Pensionado(a)<br>- Resoluci√≥n de Pensi√≥n<br>- Certificaci√≥n de Devoluci√≥n del Saldo por Vejez.
        </div>
        <select id="reg-pension"></select>

        <label>ARL</label>
        <select id="reg-arl"></select>

        <label>Imagen de Firma</label>
        <input type="file" id="reg-firma" accept="image/*" />
        <img id="reg-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <label>Fecha de nacimiento</label>
        <input id="reg-cumple" type="date" placeholder="dd/mm/aaaa">

        <div class="btn-row spaced">
          <button class="btn-primary" id="reg-guardar">Guardar</button>
          <button id="reg-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA DATOS DEL CONTRATO -->
    <section id="view-contrato" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">DATOS DEL CONTRATO</h2>

        <div id="contrato-lectura" class="narrow"></div>

        <div class="btn-row spaced">
          <button id="contrato-editar" class="btn-primary">Actualizar</button>
          <button id="contrato-volver" class="danger">Regresar</button>
        </div>

        <div id="contrato-form" class="hidden" style="margin-top:10px;">
          <label>Fecha de Inicio</label>
          <input id="c-fechaInicio" type="date" placeholder="dd/mm/aaaa">
          <input id="c-diaInicio" type="text" readonly style="display:none;">
          <input id="c-mesInicio" type="text" readonly style="display:none;">

          <label>Fecha de Terminaci√≥n</label>
          <input id="c-fechaTermino" type="date" placeholder="dd/mm/aaaa">
          <input id="c-diaTermino" type="text" readonly style="display:none;">
          <input id="c-mesTermino" type="text" readonly style="display:none;">

          <label>Meses de contrato</label>
          <input id="c-meses" type="tel" inputmode="numeric" placeholder="Autom√°tico; puedes editar">
          <label>D√≠as de complemento si Aplica</label>
          <input id="c-dias" type="tel" inputmode="numeric" placeholder="Autom√°tico; puedes editar">
          <label>Tiempo de ejecuci√≥n</label>
          <input id="c-ejecucion" type="text" readonly>

          <label>Registro Presupuestal (RP)</label>
          <input id="c-rp" type="tel" inputmode="numeric" placeholder="N¬∞ de RP" maxlength="10" style="border:1.5px solid #ccc;">

          <label>¬øR√©gimen SIMPLE?</label>
          <select id="c-costos">
            <option value="" disabled selected>Selecciona</option>
            <option>SI tomar√© costos o deducciones.</option>
            <option>NO tomar√© costos o deducciones.</option>
          </select>
          <input id="c-regimen" type="text" readonly style="display:none;">

          <div class="btn-row spaced" style="margin-top:12px;">
            <button id="c-guardar" class="btn-primary">Guardar Cambios</button>
            <button id="c-cancelar" class="danger">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VISTA DATOS PERSONALES -->
    <section id="view-personales" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">Tus Datos Personales</h2>

        <div id="personales-lectura" class="narrow"></div>

        <div class="btn-row spaced">
          <button id="personales-editar" class="btn-primary">Actualizar</button>
          <button id="personales-volver" class="danger">Regresar</button>
        </div>

        <div id="personales-form" class="hidden" style="margin-top:10px;">
          <label>Municipio de Expedici√≥n del Documento</label>
          <input id="p-expedida" list="dl-expedida2" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
          <datalist id="dl-expedida2"></datalist>

          <label>Tel√©fono L√≠nea WhatsApp</label>
          <input id="p-telefono" type="tel" inputmode="numeric" placeholder="10 d√≠gitos">

          <label>Direcci√≥n de Residencia</label>
          <textarea id="p-direccion" rows="2" placeholder="Usa abreviaciones."></textarea>

          <label>Municipio de Residencia</label>
          <input id="p-municipio" list="dl-municipio2" placeholder="Escribe para buscar‚Ä¶" autocomplete="off">
          <datalist id="dl-municipio2"></datalist>

          <label>Correo Personal</label>
          <input id="p-correo" type="email" placeholder="correo que te pertenezca">

          <label>Tipo de cuenta</label>
          <select id="p-tipoCuenta">
            <option value="" disabled selected>Selecciona tipo de cuenta</option>
            <option>AHORROS</option><option>CORRIENTE</option>
          </select>

          <label>Numero de cuenta</label>
          <input id="p-numeroCuenta" type="tel" inputmode="numeric" placeholder="Ingresa n√∫mero de cuenta">

          <label>Banco</label>
          <select id="p-banco"></select>

          <label>EPS</label>
          <select id="p-eps"></select>

          <label>Fondo de Pensiones (AFP)</label>
          <select id="p-pension"></select>

          <label>ARL</label>
          <select id="p-arl"></select>

          <label>Actualizar Firma</label>
          <input type="file" id="p-firma" accept="image/*" />
          <img id="p-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

          <label>Fecha de nacimiento</label>
          <input id="p-cumple" type="date" placeholder="dd/mm/aaaa">

          <div class="btn-row spaced" style="margin-top:12px;">
            <button id="p-guardar" class="btn-primary">Guardar Cambios</button>
            <button id="p-cancelar" class="danger">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VISTA VER NOTICIAS (lista) -->
    <section id="view-noticias" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">¬°VER NOTICIAS!</h2>
        <div id="feed-list" style="display:flex; flex-direction:column; gap:12px;"></div>
        <div class="btn-row spaced">
          <button id="feed-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA DETALLE NOTICIA -->
    <section id="view-noticia-detalle" class="view">
      <div class="card narrow" style="text-align:center;">
        <img id="fd-thumb" src="" alt="" style="width:180px; height:180px; object-fit:cover; border-radius:12px; border:1px solid #ddd; background:#eee; display:block; margin: 0 auto 10px;">
        <h3 id="fd-title" style="margin:6px 0 10px; color:#111; font-weight:900;">T√≠tulo</h3>
        <p id="fd-sub" class="muted" style="margin: 0 0 8px;"></p>
        <p id="fd-desc" style="text-align:justify; color:#222; white-space:pre-line;"></p>
        <div class="btn-row spaced" style="margin-top:12px;">
          <a id="fd-link" class="chip" href="#" target="_blank" rel="noopener" style="display:none;">Abrir V√≠nculo</a>
          <button id="fd-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>
  </div>

<script>
/* ================== CONFIGURACI√ìN ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbx5nz42xZ53WEM55Kmt_i9ngh9bn_qZjjHo3_Ub_nSz3MO0B8YDbapwk7s0LQhhnG0X/exec'; // Reemplaza por tu despliegue GS-Contratista

/* ================== SONIDOS ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
  logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3',
  menu: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Namedrop_Popup_ale2zy.mp3',
  notify: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759767435/Notificacion_d1woxv.mp3'
};
function playSoundOnce(url){
  try{ const a=new Audio(url); a.preload='auto'; a.play().catch(()=>{}); }catch(e){}
}
if (window.Swal && typeof Swal.fire === 'function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options = {}, ...rest){
    try{
      const icon = options.icon || options.type;
      if (options.soundTag === 'resumen'){ playSoundOnce(SOUNDS.info); }
      else if (icon && SOUNDS[icon]) playSoundOnce(SOUNDS[icon]);
    }catch(e){}
    return __fire(options, ...rest);
  }
}

/* ================== LOADER ================== */
const loader = document.getElementById('loader');
let loadingCount = 0, loaderTimer = null;
function startLoading(){
  loadingCount++;
  if (loadingCount === 1){
    loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer = null; }, 120);
  }
}
function stopLoading(){
  if (loadingCount === 0) return;
  loadingCount--;
  if (loadingCount === 0){
    if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
    loader.classList.add('hidden');
  }
}

/* ================== API ================== */
async function apiGet(action, params = {}){
  startLoading();
  try{
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({ action, ...params }).toString();
    const r = await fetch(url.toString(), { method: 'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}
async function apiPost(action, body = {}){
  startLoading();
  try{
    const url = API_BASE + '?action=' + encodeURIComponent(action);
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}

/* ================== ESTADO ================== */
let currentUser = null;

/* ================== VISTAS ================== */
function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  document.getElementById(id)?.classList.add('active');
  overlay.classList.remove('open');
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ================== INPUT SANITIZERS ================== */
function bindNumericSanitizer(id, maxLen){
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', ()=>{
    const raw = (el.value || '').replace(/\D/g,'');
    el.value = maxLen ? raw.slice(0, maxLen) : raw;
  });
}

/* ================== LOGIN ================== */
const loginDoc = document.getElementById('login-doc');
document.getElementById('toggle-doc').addEventListener('click', ()=>{
  const oculto = loginDoc.type === 'password';
  loginDoc.type = oculto ? 'text' : 'password';
  const src = oculto
    ? 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Ocultar_lgdxpd.png'
    : 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png';
  document.getElementById('toggle-doc-img').src = src;
  document.getElementById('toggle-doc').setAttribute('aria-label', (oculto?'Ocultar':'Mostrar') + ' documento');
});
bindNumericSanitizer('login-doc', 10);

document.getElementById('btn-login').addEventListener('click', async ()=>{
  const documento = (loginDoc.value||'').trim();
  if(documento === ''){
    Swal.fire({ icon:'question', title:'¬øDeseas comenzar?', text:'Ingresa un Documento para validar.', timer:3000 });
    return;
  }
  if(!/^\d{6,10}$/.test(documento)){
    Swal.fire({
      icon:'error',
      title:'CONTRASE√ëA INCORRECTA',
      text:'La contrase√±a contiene entre 6 y 10 digitos num√©ricos.',
      timer:3000,
      showConfirmButton:false
    });
    return;
  }
  try{
    const res = await apiGet('loginContratista', { documento });
    if(!res?.existe){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A√öN',
        text:'Una vez sea ingresada la informaci√≥n de tu contrato podr√°s acceder.',
        timer:6000,
        showConfirmButton:false
      });
      return;
    }
    if(String(res.estado||'').toUpperCase()==='INACTIVO'){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A√öN',
        text:'Una vez sea ingresada la informaci√≥n de tu contrato podr√°s acceder.',
        timer:6000,
        showConfirmButton:false
      });
      return;
    }
    // ACTIVO
    currentUser = { documento: res.documento };
    if(res.incompleto){ // H..S vac√≠as
      showView('view-registro');
    }else{
      await cargarInicio();
      playSoundOnce(SOUNDS.login);
      showView('view-inicio');
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  currentUser = null;
  loginDoc.value = '';
  showView('view-login');
});

/* ================== MEN√ö ================== */
const overlay = document.getElementById('overlay');
document.getElementById('btn-open-menu').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.menu);
  overlay.classList.add('open');
});
document.getElementById('btn-ovl-back').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});
document.getElementById('ovlClose').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});

document.getElementById('go-noticias').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarNoticias();
  showView('view-noticias');
});
document.getElementById('go-contrato').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarContratoLectura();
  showView('view-contrato');
});
document.getElementById('go-personales').addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  await cargarPersonalesLectura();
  showView('view-personales');
});

/* ================== INICIO ================== */
function thumbById(id){ return id ? ('https://drive.google.com/thumbnail?sz=w1000&id='+id) : ''; }
async function cargarInicio(){
  if(!currentUser) return;
  const d = await apiGet('getInicio', { documento: currentUser.documento });
  document.getElementById('inicio-nombre').textContent = d.nombre || '';
  document.getElementById('inicio-sub').textContent = 'CONTRATISTA - ' + (d.secretaria || '');
  document.getElementById('inicio-cc').textContent = (d.documento || '') + (d.expedida ? (' de ' + d.expedida) : '');
  document.getElementById('inicio-contacto').textContent = d.telefono || '';
  document.getElementById('inicio-direccion').textContent = ((d.direccion||'') + ' ' + (d.municipio||'')).trim();
  document.getElementById('inicio-correo').textContent = d.correo || '';
  document.getElementById('inicio-cuenta').textContent = ((d.cuenta||'') + ' ' + (d.tipoCuenta||'') + ' ' + (d.banco||'')).trim();
  document.getElementById('inicio-eps').textContent = d.eps || '';
  document.getElementById('inicio-afp').textContent = d.pension || '';
  document.getElementById('inicio-arl').textContent = d.arl || '';
  document.getElementById('inicio-supervisor').textContent = d.supervisor || '';
  const firmaEl = document.getElementById('inicio-firma');
  if(d.firmaId){ firmaEl.src = thumbById(d.firmaId); firmaEl.style.display=''; } else { firmaEl.style.display='none'; }
}

/* ================== SELECTS (banco/eps/afp/arl) ================== */
const BANKS = [
"BANCOLOMBIA","DAVIVIENDA","BANCO DE BOGOT√Å","BANCO CAJA SOCIAL","BANCO POPULAR","BANCO BBVA COLOMBIA S.A.","BANCO AV VILLAS","BANCO DE OCCIDENTE","BANCO AGRARIO DE COLOMBIA","BANCAMIA S.A.","BANCO SANTANDER COLOMBIA","BANCO FALABELLA","BANCO MUNDO MUJER S.A.","NEQUI","DAVIPLATA","DALE","NU","BANCOOMEVA S.A.","BANCO PICHINCHA S.A.","BANCO ITAU","CITIBANK COLOMBIA","BANCO COOPERATIVO COOPCENTRAL","DING","GLOBAL66","IRIS","JFK COOPERATIVA FINANCIERA","FINANCIERA JURISCOOP SA COMPA√ëIA DE FINANCIAMIENTO","ALIANZA FIDUCIARIA","BAN100","BANCO SERFINANZA","BOLD CF","COINK SA","COTRAFA","CREZCAMOS","COLTEFINANCIERA","CONFIAR COOPERATIVA FINANCIERA","CFA COOPERATIVA FINANCIERA","BANCO UNION","SCOTIABANK COLPATRIA","BANCO GNB SUDAMERIS","BANCO J.P. MORGAN COLOMBIA S.A.","BANCO FINANDINA S.A. BIC"
];
const EPS = ["SALUD TOTAL","SANITAS","FAMISANAR","NUEVA EPS","COMPENSAR","SANIDAD FUERZAS MILITARES","CONVIDA","COOSALUD","ALIANSALUD","ADRES MIN002"];
const AFP = ["PROTECCION","PORVENIR","COLFONDOS","OLD MUTUAL","COLPENSIONES","N/A"];
const ARL = ["SURA","POSITIVA","AXA COLPATRIA","COLMENA","BOLIVAR","LIBERTY","LA EQUIDAD"];

function fillSelect(id, options){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = '<option value="" disabled selected>Selecciona</option>' + options.map(o=>`<option value="${o}">${o}</option>`).join('');
}

/* ================== QUERY MUNICIPIOS ================== */
function bindQuery(inputId, datalistId){
  const input = document.getElementById(inputId);
  const list = document.getElementById(datalistId);
  if(!input || !list) return;
  input.addEventListener('input', async ()=>{
    const q = input.value.trim();
    list.innerHTML = '';
    if(q.length === 0) return;
    // Llamada directa sin startLoading/stopLoading (no usar loader en query)
    try{
      const url = new URL(API_BASE);
      url.search = new URLSearchParams({ action: 'getFilteredResidencias', query: q }).toString();
      const r = await fetch(url.toString(), { method: 'GET' });
      const j = await r.json();
      const opts = (j && j.ok && Array.isArray(j.data)) ? j.data : [];
      opts.forEach(opt=>{
        const o = document.createElement('option');
        o.value = opt;
        list.appendChild(o);
      });
    }catch(_){ /* silencio */ }
  });
}

/* ================== REGISTRO ================== */
let regFirmaDataUrl = '';
document.getElementById('reg-firma').addEventListener('change', (e)=>{
  const file = e.target.files && e.target.files[0];
  const prev = document.getElementById('reg-firma-preview');
  if(!file){ regFirmaDataUrl=''; prev.style.display='none'; prev.src=''; return; }
  const reader = new FileReader();
  reader.onload = ev => { regFirmaDataUrl = ev.target.result; prev.src = regFirmaDataUrl; prev.style.display='block'; };
  reader.readAsDataURL(file);
});
bindNumericSanitizer('reg-telefono', 10);
bindNumericSanitizer('reg-numeroCuenta', 16);

fillSelect('reg-banco', BANKS);
fillSelect('reg-eps', EPS);
fillSelect('reg-pension', AFP);
fillSelect('reg-arl', ARL);

bindQuery('reg-expedida','dl-expedida');
bindQuery('reg-municipio','dl-municipio');

document.getElementById('reg-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const telefonoRegex = /^[0-9]{10}$/;
  const correoRegex = /^[^\s@]+@(example\.org|nomedominio\.net|dominio\.edu\.co|examplo\.edu\.co|empresa\.com|nombreempresa\.org|correo\.es|dominio\.es|outlook\.com|hotmail\.com|live\.com|gmail\.com|icloud\.com|me\.com|[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})$/;
  const numeroCuentaRaw = (document.getElementById('reg-numeroCuenta').value||'').replace(/\D/g,'');
  const body = {
    documento: currentUser.documento,
    expedida: document.getElementById('reg-expedida').value.trim(),
    telefono: document.getElementById('reg-telefono').value.trim(),
    direccion: document.getElementById('reg-direccion').value.trim(),
    municipio: document.getElementById('reg-municipio').value.trim(),
    correo: document.getElementById('reg-correo').value.trim(),
    tipoCuenta: document.getElementById('reg-tipoCuenta').value,
    numeroCuenta: numeroCuentaRaw,
    banco: document.getElementById('reg-banco').value,
    eps: document.getElementById('reg-eps').value,
    pension: document.getElementById('reg-pension').value,
    arl: document.getElementById('reg-arl').value,
    firmaDataUrl: regFirmaDataUrl || '',
    cumpleISO: document.getElementById('reg-cumple').value || ''
  };
  // Requeridos
  const requiredOk = body.expedida && body.telefono && body.direccion && body.municipio && body.correo && body.tipoCuenta && body.numeroCuenta && body.banco && body.eps && body.pension && body.arl && body.firmaDataUrl && body.cumpleISO;
  if(!requiredOk){ Swal.fire({icon:'warning', title:'Faltan campos Requeridos'}); return; }
  if(!telefonoRegex.test(body.telefono)){ Swal.fire({icon:'warning', title:'Whatsapp inv√°lido'}); return; }
  if(!correoRegex.test(body.correo)){ Swal.fire({icon:'warning', title:'Correo inv√°lido'}); return; }
  if(!(body.numeroCuenta.length>=7 && body.numeroCuenta.length<=16)){ Swal.fire({icon:'warning', title:'N√∫mero de cuenta inv√°lido'}); return; }

  const resumenHtml = `
    <b>Expedida:</b> ${body.expedida}<br>
    <b>Whatsapp:</b> ${body.telefono}<br>
    <b>Direcci√≥n:</b> ${body.direccion}<br>
    <b>Municipio:</b> ${body.municipio}<br>
    <b>Correo:</b> ${body.correo}<br>
    <b>Cuenta:</b> ${body.numeroCuenta} ${body.tipoCuenta} ${body.banco}<br>
    <b>EPS:</b> ${body.eps}<br>
    <b>AFP:</b> ${body.pension}<br>
    <b>ARL:</b> ${body.arl}<br><br>
    <img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" alt="">
  `;
  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Registro', html:resumenHtml,
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  try{
    const r = await apiPost('saveRegistro', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Registro Exitoso', timer:1800, showConfirmButton:false });
      await cargarInicio();
      showView('view-inicio');
      await Swal.fire({ icon:'info', title:'DATOS DEL CONTRATO', text:'No olvides completar los datos de tu contrato sin errores', timer:4000, showConfirmButton:false });
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
document.getElementById('reg-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-login'); });

/* ================== CONTRATO (lectura + edici√≥n) ================== */
document.getElementById('contrato-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-inicio'); });
document.getElementById('contrato-editar').addEventListener('click', ()=>{
  document.getElementById('contrato-form').classList.remove('hidden');
});
bindNumericSanitizer('c-meses', 3);
bindNumericSanitizer('c-dias', 3);
bindNumericSanitizer('c-rp', 10);

document.getElementById('c-costos').addEventListener('change', function(){
  const simple = document.getElementById('c-regimen');
  if (this.value === 'SI tomar√© costos o deducciones.') {
    simple.value = 'Si pertenezco al R√©gimen Simple, por lo que se adjunta el RUT vigente, actualizado con la responsabilidad 47.';
  } else if (this.value === 'NO tomar√© costos o deducciones.') {
    simple.value = 'NO pertenezco al R√©gimen Simple';
  }
});

function actualizarCamposFecha(fechaISO, idDia, idMes){
  if(!fechaISO){ document.getElementById(idDia).value=''; document.getElementById(idMes).value=''; return; }
  const dObj = new Date(fechaISO + 'T00:00:00');
  if(isNaN(dObj)) { document.getElementById(idDia).value=''; document.getElementById(idMes).value=''; return; }
  const dd = String(dObj.getUTCDate()).padStart(2,'0');
  const meses = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
  const mm = dObj.getUTCMonth();
  document.getElementById(idDia).value = dd;
  document.getElementById(idMes).value = meses[mm];
}

document.getElementById('c-fechaInicio').addEventListener('change', ()=>{
  actualizarCamposFecha(document.getElementById('c-fechaInicio').value, 'c-diaInicio', 'c-mesInicio');
  calcularPlazo();
});
document.getElementById('c-fechaTermino').addEventListener('change', ()=>{
  actualizarCamposFecha(document.getElementById('c-fechaTermino').value, 'c-diaTermino', 'c-mesTermino');
  calcularPlazo();
});

function getDaysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function convertirNumeroATexto(n){ return String(n); } // simple
function actualizarEjecucion(){
  const meses = parseInt(document.getElementById('c-meses').value)||0;
  const dias = parseInt(document.getElementById('c-dias').value)||0;
  let txt = '';
  if(meses>0){ txt += `${meses===1?'un':convertirNumeroATexto(meses)} (${meses}) ${meses===1?'mes':'meses'}`; }
  if(dias>0){ if(txt!=='') txt += ' y '; txt += `${dias===1?'un':convertirNumeroATexto(dias)} (${dias}) ${dias===1?'d√≠a':'d√≠as'}`; }
  document.getElementById('c-ejecucion').value = txt;
}
document.getElementById('c-meses').addEventListener('input', actualizarEjecucion);
document.getElementById('c-dias').addEventListener('input', actualizarEjecucion);

function calcularPlazo(){
  const fi = document.getElementById('c-fechaInicio').value;
  const ft = document.getElementById('c-fechaTermino').value;
  if(!fi || !ft) { document.getElementById('c-meses').value=0; document.getElementById('c-dias').value=0; actualizarEjecucion(); return; }
  let fechaInicio = new Date(fi);
  let fechaTermino = new Date(ft);
  if(isNaN(fechaInicio)||isNaN(fechaTermino)||fechaTermino<fechaInicio){
    document.getElementById('c-meses').value=0; document.getElementById('c-dias').value=0; actualizarEjecucion(); return;
  }
  // Contar ambos extremos
  let diffTime = Math.abs(fechaTermino - fechaInicio) + (1000*60*60*24);
  let diffDays = Math.ceil(diffTime / (1000*60*60*24));
  let meses=0, dias=0;
  while(diffDays>0){
    const daysInMonth = getDaysInMonth(fechaInicio.getFullYear(), fechaInicio.getMonth());
    if(diffDays >= daysInMonth){
      meses++; diffDays -= daysInMonth; fechaInicio.setMonth(fechaInicio.getMonth()+1);
    }else{ dias = diffDays; diffDays = 0; }
  }
  document.getElementById('c-meses').value = meses;
  document.getElementById('c-dias').value = dias;
  actualizarEjecucion();
}

document.getElementById('c-rp').addEventListener('input', ()=>{
  const el = document.getElementById('c-rp');
  const raw = (el.value||'').replace(/\D/g,'').slice(0,10);
  el.value = raw;
  el.style.border = '';
  if(raw.length===10 && raw.startsWith('2026')){
    el.style.border = '2px solid green';
  }
});

document.getElementById('c-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const body = {
    documento: currentUser.documento,
    fechaInicioISO: document.getElementById('c-fechaInicio').value||'',
    diaInicio: document.getElementById('c-diaInicio').value||'',
    mesInicio: document.getElementById('c-mesInicio').value||'',
    fechaTerminoISO: document.getElementById('c-fechaTermino').value||'',
    diaTermino: document.getElementById('c-diaTermino').value||'',
    mesTermino: document.getElementById('c-mesTermino').value||'',
    meses: document.getElementById('c-meses').value||'0',
    dias: document.getElementById('c-dias').value||'0',
    ejecucion: document.getElementById('c-ejecucion').value||'',
    rp: (document.getElementById('c-rp').value||'').replace(/\D/g,''),
    costos: document.getElementById('c-costos').value||'',
    regimen: document.getElementById('c-regimen').value||''
  };
  const resumenHtml = `
    <b>Inicio:</b> ${body.fechaInicioISO}<br>
    <b>Terminaci√≥n:</b> ${body.fechaTerminoISO}<br>
    <b>Meses/D√≠as:</b> ${body.meses} / ${body.dias}<br>
    <b>Ejecuci√≥n:</b> ${body.ejecucion}<br>
    <b>RP:</b> ${body.rp}<br>
    <b>Costos:</b> ${body.costos}<br>
    <b>R√©gimen:</b> ${body.regimen}<br>
  `;
  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Cambios', html:resumenHtml,
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  try{
    const r = await apiPost('saveDatosContrato', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Actualizaci√≥n Exitosa', timer:1600, showConfirmButton:false });
      await cargarContratoLectura();
      document.getElementById('contrato-form').classList.add('hidden');
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
document.getElementById('c-cancelar').addEventListener('click', ()=>{
  document.getElementById('contrato-form').classList.add('hidden');
});

/* ================== PERSONALES (lectura + edici√≥n) ================== */
let pFirmaDataUrl = '';
document.getElementById('p-firma').addEventListener('change', (e)=>{
  const file = e.target.files && e.target.files[0];
  const prev = document.getElementById('p-firma-preview');
  if(!file){ pFirmaDataUrl=''; prev.style.display='none'; prev.src=''; return; }
  const reader = new FileReader();
  reader.onload = ev => { pFirmaDataUrl = ev.target.result; prev.src = pFirmaDataUrl; prev.style.display='block'; };
  reader.readAsDataURL(file);
});
bindNumericSanitizer('p-telefono', 10);
bindNumericSanitizer('p-numeroCuenta', 16);

fillSelect('p-banco', BANKS);
fillSelect('p-eps', EPS);
fillSelect('p-pension', AFP);
fillSelect('p-arl', ARL);

bindQuery('p-expedida','dl-expedida2');
bindQuery('p-municipio','dl-municipio2');

document.getElementById('personales-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-inicio'); });
document.getElementById('personales-editar').addEventListener('click', ()=>{
  document.getElementById('personales-form').classList.remove('hidden');
});
document.getElementById('p-cancelar').addEventListener('click', ()=>{
  document.getElementById('personales-form').classList.add('hidden');
});

document.getElementById('p-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const telefonoRegex = /^[0-9]{10}$/;
  const correoRegex = /^[^\s@]+@(example\.org|nomedominio\.net|dominio\.edu\.co|examplo\.edu\.co|empresa\.com|nombreempresa\.org|correo\.es|dominio\.es|outlook\.com|hotmail\.com|live\.com|gmail\.com|icloud\.com|me\.com|[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})$/;

  const body = {
    documento: currentUser.documento,
    expedida: document.getElementById('p-expedida').value.trim(),
    telefono: document.getElementById('p-telefono').value.trim(),
    direccion: document.getElementById('p-direccion').value.trim(),
    municipio: document.getElementById('p-municipio').value.trim(),
    correo: document.getElementById('p-correo').value.trim(),
    tipoCuenta: document.getElementById('p-tipoCuenta').value,
    numeroCuenta: (document.getElementById('p-numeroCuenta').value||'').replace(/\D/g,''),
    banco: document.getElementById('p-banco').value,
    eps: document.getElementById('p-eps').value,
    pension: document.getElementById('p-pension').value,
    arl: document.getElementById('p-arl').value,
    firmaDataUrl: pFirmaDataUrl || '',
    cumpleISO: document.getElementById('p-cumple').value || ''
  };

  const resumen = [];
  Object.entries(body).forEach(([k,v])=>{ if(k!=='documento' && v) resumen.push(`<b>${k}:</b> ${v}`); });
  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Cambios', html:resumen.join('<br>'),
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  // Validaciones suaves: si viene, valida; se guardan solo campos con valor
  if(body.telefono && !telefonoRegex.test(body.telefono)){ Swal.fire({icon:'warning', title:'Whatsapp inv√°lido'}); return; }
  if(body.correo && !correoRegex.test(body.correo)){ Swal.fire({icon:'warning', title:'Correo inv√°lido'}); return; }
  if(body.numeroCuenta && !(body.numeroCuenta.length>=7 && body.numeroCuenta.length<=16)){ Swal.fire({icon:'warning', title:'N√∫mero de cuenta inv√°lido'}); return; }

  try{
    const r = await apiPost('saveDatosPersonales', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Actualizaci√≥n Exitosa', timer:1600, showConfirmButton:false });
      await cargarPersonalesLectura();
      document.getElementById('personales-form').classList.add('hidden');
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

/* ================== NOTICIAS ================== */
let FEED_CACHE = [];
const FEED_READ_KEY_PREFIX = 'feedReadIds@contr:'; // por documento
function feedReadKey(){ return FEED_READ_KEY_PREFIX + (currentUser?.documento || 'anon'); }
function getReadMap(){ try{ const raw=localStorage.getItem(feedReadKey()); return raw?JSON.parse(raw):{}; }catch(_){ return {}; } }
function setReadMap(m){ try{ localStorage.setItem(feedReadKey(), JSON.stringify(m||{})); }catch(_){} }
function isRead(id){ return !!getReadMap()[id]; }
function markRead(id){ const m=getReadMap(); m[id]=true; setReadMap(m); }
function extractFirstUrl(text){
  if(!text) return null;
  const m = String(text).match(/(https?:\/\/[^\s'"<>]+|www\.[^\s'"<>]+)/i);
  if(!m) return null;
  let u = m[0];
  if(u.startsWith('www.')) u = 'https://' + u;
  return u;
}
function fallbackThumbFor(url){
  const u = String(url||'').toLowerCase();
  if(u.includes('facebook'))  return 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/facebook_nezbkz.webp';
  if(u.includes('instagram')) return 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/instragram_uft2wl.webp';
  if(u.includes('tiktok'))    return 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166342/tiktok_tdvc2x.webp';
  return 'https://res.cloudinary.com/dqqeavica/image/upload/v1759798601/noticias_dax8sd.jpg';
}
function firstLinkThumb(url){
  const placeholder = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759798601/noticias_dax8sd.jpg';
  if(!url) return placeholder;
  if(/\.(png|jpe?g|webp|gif|bmp|svg)(\?.*)?$/i.test(url)) return url;
  return 'https://image.thum.io/get/og/' + encodeURIComponent(url);
}
async function cargarNoticias(){
  const list = await apiGet('listComunicados');
  FEED_CACHE = Array.isArray(list) ? list.slice(0,20) : [];
  const wrap = document.getElementById('feed-list');
  wrap.innerHTML='';
  if(!FEED_CACHE.length){
    const p = document.createElement('p'); p.className='muted center'; p.textContent='No hay noticias disponibles.'; wrap.appendChild(p); return;
  }
  FEED_CACHE.forEach(it=>{
    const item = document.createElement('div');
    item.style.cssText = 'display:flex;gap:12px;align-items:flex-start;background:rgba(255,255,255,.9);border:2px solid #ddd;border-radius:16px;padding:10px;box-shadow:0 6px 14px rgba(0,0,0,.12);cursor:pointer;';
    item.dataset.id = it.id;
    const img = document.createElement('img');
    img.style.cssText='width:64px;height:64px;border-radius:10px;object-fit:cover;flex-shrink:0;background:#eee;border:1px solid #ddd;';
    img.alt='';
    const thumbUrl = it.imagenId ? thumbById(it.imagenId) : firstLinkThumb(it.first_link);
    img.src = thumbUrl;
    img.onerror = ()=>{ img.src = fallbackThumbFor(it.first_link); };

    const ct = document.createElement('div'); ct.style.flex='1'; ct.style.minWidth='0';
    const h = document.createElement('h4'); h.style.margin='0 0 4px 0'; h.style.fontWeight='800'; h.textContent = String(it.titulo||'');
    const p = document.createElement('p'); p.style.margin='0'; p.style.color='#333'; p.textContent = String(it.subtitulo||'');
    ct.appendChild(h); ct.appendChild(p);

    item.appendChild(img); item.appendChild(ct);
    if(!isRead(it.id)){
      const dot = document.createElement('span');
      dot.style.cssText='width:12px;height:12px;background:#e11;border-radius:999px;flex-shrink:0;margin-left:6px;margin-top:4px;box-shadow:0 0 0 2px #fff;';
      item.appendChild(dot);
      // sonido de notificaci√≥n cuando hay no le√≠das
      playSoundOnce(SOUNDS.notify);
    }
    item.addEventListener('click', ()=> abrirNoticia(it));
    wrap.appendChild(item);
  });
}
function abrirNoticia(it){
  const thumb = document.getElementById('fd-thumb');
  const title = document.getElementById('fd-title');
  const sub   = document.getElementById('fd-sub');
  const desc  = document.getElementById('fd-desc');
  const link  = document.getElementById('fd-link');

  thumb.src = it.imagenId ? thumbById(it.imagenId) : fallbackThumbFor(it.first_link);
  title.textContent = String(it.titulo||'');
  sub.textContent   = String(it.subtitulo||'');
  desc.textContent  = String(it.contenido||'');

  const urlFromDesc = extractFirstUrl(it.contenido);
  const firstUrl = urlFromDesc || it.first_link || '';
  if(firstUrl){ link.href = firstUrl; link.style.display=''; } else { link.href='#'; link.style.display='none'; }

  markRead(it.id);
  showView('view-noticia-detalle');
}
document.getElementById('fd-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-noticias'); });
document.getElementById('feed-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-inicio'); });

/* ================== CONTRATO: cargar lectura ================== */
async function cargarContratoLectura(){
  if(!currentUser) return;
  const d = await apiGet('getDatosContrato', { documento: currentUser.documento });
  const box = document.getElementById('contrato-lectura');
  const lines = [
    `<b>Secretar√≠a:</b> ${d.secretaria||''}`,
    `<b>Supervisor:</b> ${d.supervisor||''}`,
    `<b>Contrato N¬∞:</b> ${d.contrato||''} de ${d.fechaContrato||''}`,
    `<b>Tipo de Contrato:</b> ${d.tipoContrato||''}`,
    `<b>Objeto:</b> ${d.objeto||''}`
  ];
  (d.obligaciones||[]).forEach((o,i)=>{ lines.push(`<b>Obligaci√≥n ${i+1}:</b> ${o}`); });
  box.innerHTML = lines.map(l=>`<p>${l}</p>`).join('');
}

/* ================== PERSONALES: cargar lectura ================== */
async function cargarPersonalesLectura(){
  if(!currentUser) return;
  const d = await apiGet('getDatosPersonales', { documento: currentUser.documento });
  const box = document.getElementById('personales-lectura');
  const lines = [
    `<b>NOMBRE:</b> ${d.nombre||''}`,
    `<b>CC:</b> ${d.documento||''}`,
    `<b>Expedida:</b> ${d.expedida||''}`,
    `<b>Whatsapp:</b> ${d.telefono||''}`,
    `<b>Direcci√≥n:</b> ${d.direccion||''}`,
    `<b>Municipio:</b> ${d.municipio||''}`,
    `<b>Correo:</b> ${d.correo||''}`,
    `<b>Cuenta:</b> ${d.cuenta||''} ${d.tipoCuenta||''} ${d.banco||''}`,
    `<b>EPS:</b> ${d.eps||''}`,
    `<b>AFP:</b> ${d.pension||''}`,
    `<b>ARL:</b> ${d.arl||''}`,
    `<b>Cumplea√±os:</b> ${d.cumple||''}`
  ];
  box.innerHTML = lines.map(l=>`<p>${l}</p>`).join('');
}

/* ================== PWA AVANZADO ================== */
let deferredPrompt = null;
let __installStartShown = false;    // bandera: ya mostramos "App instal√°ndose"
let __installSuccessShown = false;  // bandera: ya mostramos "Instalaci√≥n exitosa"

function isStandalone(){
  const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const dmInstalled  = window.matchMedia('(display-mode: installed)').matches;
  const iosStandalone = (window.navigator.standalone === true);
  return dmStandalone || dmInstalled || iosStandalone;
}
function isIOS(){
  return /(iphone|ipad|ipod)/i.test(navigator.userAgent || '');
}
function isMarkedInstalled(){
  try{ return localStorage.getItem('pwaInstalledFlag') === '1'; }catch(_){ return false; }
}
function markInstalled(){
  try{ localStorage.setItem('pwaInstalledFlag', '1'); }catch(_){}
}
function clearInstalledMark(){
  try{ localStorage.removeItem('pwaInstalledFlag'); }catch(_){}
}
async function detectInstalled(){
  if (isStandalone()) return true;
  if (typeof navigator.getInstalledRelatedApps === 'function'){
    try{
      const apps = await navigator.getInstalledRelatedApps();
      const found = apps.some(a =>
        a.platform === 'webapp' &&
        typeof a.url === 'string' &&
        /manifest\.webmanifest$/.test(a.url)
      );
      if (found){
        markInstalled();
        return true;
      } else {
        clearInstalledMark();
      }
    }catch(_){}
  }
  return isMarkedInstalled();
}
function updateInstallButtonsVisibility(){
  const btn1 = document.getElementById('btn-instalar');
  const canPrompt = !!deferredPrompt;
  const installed = isMarkedInstalled() || isStandalone();
  const shouldShow = !installed && (canPrompt || isIOS());
  if(btn1) btn1.style.display = shouldShow ? '' : 'none';
}

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  updateInstallButtonsVisibility();
});

window.addEventListener('appinstalled', ()=>{
  markInstalled();
  deferredPrompt = null;
  updateInstallButtonsVisibility();
});

document.getElementById('btn-instalar').addEventListener('click', async ()=>{
  // Flujo iOS: se respeta exactamente tu alerta e instrucciones
  if(isIOS()){
    Swal.fire({
      icon:'info',
      title:'Para Instalar en tu Iphone',
      html:'1) Toca Compartir (cuadro con flecha en la parte inferior).<br>2) Elige "Agregar a pantalla de inicio".<br>3) Confirma "Agregar".'
    });
    return;
  }
  // Android: requiere beforeinstallprompt (deferredPrompt)
  if(!deferredPrompt){
    Swal.fire({icon:'info',title:'Instalaci√≥n no disponible todav√≠a'});
    return;
  }

  const dp = deferredPrompt;
  dp.prompt();                           // muestra di√°logo nativo de instalaci√≥n
  const choice = await dp.userChoice;    // espera la elecci√≥n del usuario
  deferredPrompt = null;                 // limpia el prompt (solo se usa una vez)

  if (choice.outcome === 'accepted'){
    // Primera alerta (Android): confirma inicio de instalaci√≥n por 6 segundos
    markInstalled();
    __installStartShown = true;
    Swal.fire({
  icon: 'success',
  title: '¬°App instal√°ndose!',
  html: `
    <div style="text-align:center; margin-top:8px;">
      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1764209976/Robot_c2vtua.gif"
        alt="Instalando app"
        style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
      >
      <div>Debes esperar unos segundos mientras el sistema instala la App.</div>
      <div style="margin-top:10px;">
        <b>Ya puedes salir de esta vista, aparecer√° en la pantalla principal de este dispositivo.</b>
      </div>
    </div>
  `,
  timer: 12000,
  showConfirmButton: false
});
  } else {
    Swal.fire({icon:'info',title:'Instalaci√≥n cancelada'});
  }

  updateInstallButtonsVisibility();
});

async function initPWAVista(){
  const installed = await detectInstalled();
  if (installed){
    showView('view-login');
  } else {
    showView('view-instalar');
    updateInstallButtonsVisibility();
  }
}
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
window.addEventListener('load', initPWAVista);

/* ================== FIN ================== */
</script>
</body>
</html>
