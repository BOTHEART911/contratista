<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>CONTRATISTA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="https://res.cloudinary.com/dqqeavica/image/upload/v1766354603/contratista_k9go6h.png">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
  <style> 
  :root{
    --primary:#06402B;
    --primary-2:#04281C;
    --ok:#16a34a;
    --error:#dc2626;
    --scrim:rgba(0,0,0,.35);
  }
  html,body{
    margin:0; padding:0; height:100%; width:100%;
    overflow-x:hidden;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:#111;
      background: url('https://res.cloudinary.com/dqqeavica/image/upload/v1746905870/fondo_verde_tvntsi.png') center/cover fixed no-repeat;
    }
    .container{ max-width: 1100px; margin: 0 auto; padding: 16px; }

    .view{ display:none; opacity:0; transform: translateY(8px);
      transition: opacity .25s ease, transform .25s ease;
      box-sizing:border-box; padding:16px;
    }
    .view.active{ display:block; opacity:1; transform: translateY(0); }

    .card{
      background: rgba(255,255,255,.06);
      backdrop-filter: blur(3px);
      border: 2px solid #ddd; border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0,0,0,.18);
      max-width: 820px; margin: 16px auto; padding: 20px 20px 16px;
    }
    h1,h2,h3{ margin: 8px 0 12px; text-align:center; }
    p.helper{ color:#444; font-size:.95rem; text-align:center; margin:8px 0 16px; }
    label{ display:block; font-weight:700; margin: 10px 0 6px; color:var(--primary); }
    input, select, textarea, button{
      width:100%; padding:12px; box-sizing:border-box;
      border:1.5px solid #ccc; border-radius:8px; background:#fff;
      outline:none; transition: border-color .2s ease, transform .08s ease;
      font-size:16px;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--primary); }
    button{
      cursor:pointer; border:2px solid var(--primary);
      background:#fff; color:#000; font-weight:700;
    }
    button:hover{ background:var(--primary-2); color:#fff; border-color:var(--primary-2); }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-row{ display:flex; gap:12px; flex-wrap:wrap; }
    .btn-row > *{ flex:1; }
    .muted{ color:#666; font-size:.85rem; }
    .center{ text-align:center; }
    .image-center{ display:flex; justify-content:center; }
    .brand{ width:240px; border-radius:12px; display:block; margin:12px auto 4px; }
    .chip{
      padding:8px 12px; border-radius:999px; border:2px solid var(--primary);
      background:#fff; font-weight:700; color:#000; text-decoration:none;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
    }
    .danger{ background:#e11; border-color:#e11; color:#fff; }

    .loader{
      position:fixed; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(0,0,0,.35);
      z-index:9999; backdrop-filter: blur(2px);
      opacity:1; transition: opacity .12s ease;
    }
    .loader.hidden{ opacity:0; pointer-events:none; }
    .spinner-ios{ position:relative; width:64px; height:64px; }
    .spinner-ios i{
      position:absolute; left:50%; top:50%;
      width:6px; height:18px; margin:-9px 0 0 -3px;
      background:#fff; border-radius:3px;
      opacity:.2; animation:iosFade 1.2s linear infinite; transform-origin: center center;
    }
    @keyframes iosFade{ 0%, 39%, 100% { opacity:.2; } 40% { opacity:1; } }
    .spinner-ios i:nth-child(1)  { transform: rotate(  0deg) translateY(-24px); animation-delay:-1.1s; }
    .spinner-ios i:nth-child(2)  { transform: rotate( 30deg) translateY(-24px); animation-delay:-1.0s; }
    .spinner-ios i:nth-child(3)  { transform: rotate( 60deg) translateY(-24px); animation-delay:-0.9s; }
    .spinner-ios i:nth-child(4)  { transform: rotate( 90deg) translateY(-24px); animation-delay:-0.8s; }
    .spinner-ios i:nth-child(5)  { transform: rotate(120deg) translateY(-24px); animation-delay:-0.7s; }
    .spinner-ios i:nth-child(6)  { transform: rotate(150deg) translateY(-24px); animation-delay:-0.6s; }
    .spinner-ios i:nth-child(7)  { transform: rotate(180deg) translateY(-24px); animation-delay:-0.5s; }
    .spinner-ios i:nth-child(8)  { transform: rotate(210deg) translateY(-24px); animation-delay:-0.4s; }
    .spinner-ios i:nth-child(9)  { transform: rotate(240deg) translateY(-24px); animation-delay:-0.3s; }
    .spinner-ios i:nth-child(10) { transform: rotate(270deg) translateY(-24px); animation-delay:-0.2s; }
    .spinner-ios i:nth-child(11) { transform: rotate(300deg) translateY(-24px); animation-delay:-0.1s; }
    .spinner-ios i:nth-child(12) { transform: rotate(330deg) translateY(-24px); animation-delay: 0s; }

    .hidden{ display:none !important; }
    .narrow{ max-width: 560px; margin: 0 auto; }
    .spaced{ margin-top:12px; }

    .oblig-block{
  background:#f8f8f8; border:1.5px solid #ccc; border-radius:12px;
  padding:10px 12px; margin:10px 0; display:flex; flex-direction:column; gap:6px;
}

    /* Overlay Men√∫ */
    .overlay{ position: fixed; inset: 0; pointer-events:none; }
    .overlay .scrim{ position:absolute; inset:0; background:var(--scrim); opacity:0; transition:opacity .25s ease; }
    .overlay .panel{
      position:absolute; top:0; left:0; width:min(360px, 90vw); height:100%;
      background:#06402B; color:#fff; padding:16px 16px 8px 16px; box-sizing:border-box;
      transform: translateX(-100%); transition: transform .25s ease;
      display:flex; flex-direction:column; gap:10px; overflow-y:auto; min-height: 0;
    }
    .overlay.open{ pointer-events:auto; }
    .overlay.open .scrim{ opacity:1; }
    .overlay.open .panel{ transform: translateX(0); }
    .panel h3{ margin: 4px 0 8px; text-align:center; }
    .menu-btn{
      background:#7de3ef; color:#000; border:0; font-weight:800;
      border-radius:999px; padding:12px; box-shadow: 0 6px 12px rgba(0,0,0,.18);
    }

    .avatar-emoji{
      width:120px; height:120px; display:block; margin:0 auto;
    }

    @media (max-width: 700px){ .btn-row{ flex-direction:column; } }

/* Estilo para previews en m√≥vil */
    .evi-preview{
  max-width:100%;
  max-height:320px;
  object-fit:contain;
  border-radius:10px;
  border:1.5px solid #d8e4ff;
  margin-top:8px;
}

/* Fuerza que TODOS los modales de fecha queden centrados horizontal y pegados abajo,
   incluso si el inline style pone align-items:center/justify-content:center */
.picker-modal{
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.5);
  z-index: 9999;
  align-items: flex-end !important;  /* sobrescribe inline */
  justify-content: center !important;/* sobrescribe inline */
  padding-bottom: 16px;              /* separa del borde inferior */
}
.picker-modal[aria-hidden="false"]{
  display: flex;
}
.picker-box{
  margin: 0;
  /* opcional: limitar ancho para que no tape el bot√≥n inferior completamente */
  width: 90%;
  max-width: 520px;
}
    
 /* Modal de fecha centrado en Plan de Pagos */
 #pagoModal{
  align-items: center !important;
  justify-content: center !important;
  padding-bottom: 0 !important;
  padding-top: 32px !important; /* desplaza el modal un poco hacia abajo */
}

    /* INSERT: Badge ‚ÄúVer Noticias‚Äù + estilos de lista/detalle de COMUNICADOS */
    .notif-wrap{ position:relative; display:inline-block; }
    .notif-bell{
      position:absolute; right:-6px; top:-6px; width:28px; height:28px; display:none;
      animation:heartbeat 1.2s infinite;
    }
    .notif-bell.active{ display:block; }
    .notif-count{
      position:absolute; right:-2px; top:-2px;
      background:#e11; color:#fff; border-radius:999px; min-width:18px; height:18px; line-height:18px;
      text-align:center; padding:0 4px; font-size:12px; font-weight:800; display:none;
      box-shadow: 0 0 0 2px #fff;
    }
    .notif-count.active{ display:inline-block; }
    .notif-label{
      position:absolute; left:calc(100% + 6px); top:-6px;
      height:28px; line-height:28px; padding:0 10px;
      background:#7de3ef; color:#000; border-radius:999px;
      font-weight:800; font-size:14px; white-space:nowrap; display:none;
      animation:heartbeat 1.2s infinite;
    }
    .notif-label.active{ display:inline-block; }
    @keyframes heartbeat{
      0%{ transform: scale(1); }
      20%{ transform: scale(1.15); }
      40%{ transform: scale(1); }
      60%{ transform: scale(1.15); }
      100%{ transform: scale(1); }
    }

    .feed-list{ display:flex; flex-direction:column; gap:12px; }
    .feed-item{
      display:flex; gap:12px; align-items:center;
      background: rgba(255,255,255,.9);
      border:2px solid #ddd; border-radius:16px; padding:10px;
      box-shadow: 0 6px 14px rgba(0,0,0,.12);
      cursor:pointer;
    }
    .feed-thumb{
      width:64px; height:64px; border-radius:50%; object-fit:cover; flex-shrink:0;
      background:#eee; border:1px solid #ddd;
    }
    .feed-content{ flex:1; min-width:0; }
    .feed-title{ font-weight:800; color:#111; margin:0 0 2px 0; }
    .feed-sub{ color:#333; margin:0; font-size:.9rem; }
    .feed-dot{
      width:12px; height:12px; background:#e11; border-radius:999px; flex-shrink:0; margin-left:6px;
      box-shadow:0 0 0 2px #fff;
    }
    .feed-detail-card{
      background: rgba(255,255,255,.9);
      border:2px solid #ddd; border-radius:16px; padding:16px;
      box-shadow:0 8px 18px rgba(0,0,0,.15);
      max-width: 560px; margin: 12px auto; text-align:center;
    }
    .feed-detail-thumb{
      width:160px; height:160px; object-fit:cover; border-radius:50%;
      border:2px solid #ddd; background:#eee; display:block; margin:0 auto 10px;
    }
    .feed-detail-title{ margin:6px 0 4px; color:#111; font-weight:900; }
    .feed-detail-sub{ margin:0 0 8px; color:#333; font-weight:700; }
    .feed-detail-desc{ text-align:justify; color:#222; overflow-wrap:anywhere; }

    /* Solo para los 3 modales de INGRESAR CUENTA: caja blanca y posici√≥n arriba */
#icInicioModal,
#icFinModal,
#icRadicadoModal{
  align-items: flex-start !important;   /* fuerza arriba */
  padding-top: 16px;
  padding-bottom: 0;
  z-index: 10001;                       /* por si hay otros overlays */
}
#icInicioModal .picker-box,
#icFinModal .picker-box,
#icRadicadoModal .picker-box{
  background:#fff;
  border-radius:12px;
  padding:16px;
  box-shadow:0 8px 18px rgba(0,0,0,.15);
  width: 90%;
  max-width: 520px;
}

      /* ================== CALENDARIO INSTITUCIONAL (CONTRATISTA) ================== */
  .cal-wrapper{
    max-width: 960px;
    margin: 0 auto;
  }
  .cal-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    margin-bottom:10px;
    flex-wrap:wrap;
  }
  .cal-title{
    font-weight:800;
    font-size:1.1rem;
    color:var(--primary);
  }
  .cal-nav-group{
    display:flex;
    align-items:center;
    gap:6px;
  }
  .cal-pill-btn{
    border-radius:999px;
    padding:8px 14px;
    border:2px solid var(--primary);
    background:#fff;
    font-weight:700;
    cursor:pointer;
  }
  .cal-pill-btn.active{
    background:var(--primary);
    color:#fff;
    border-color:var(--primary-2);
  }
  .cal-filter-wrap{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .cal-filter-input{
    border-radius:999px;
    padding:8px 12px;
    border:1.5px solid #ccc;
    min-width:220px;
  }

  .cal-grid{
    margin-top:10px;
    border-radius:16px;
    background:rgba(255,255,255,.8);
    border:2px solid #ddd;
    overflow:hidden;
  }
  .cal-month-grid{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    border-top:1px solid #eee;
  }
  .cal-weekdays{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    background:#f7fafc;
    border-bottom:1px solid #eee;
  }
  .cal-weekday,
  .cal-day-header{
    padding:6px 4px;
    text-align:center;
    font-size:.8rem;
    font-weight:700;
    color:#555;
  }
  .cal-day-cell{
    min-height:86px;
    border-right:1px solid #f1f1f1;
    border-bottom:1px solid #f1f1f1;
    padding:4px;
    box-sizing:border-box;
    position:relative;
    background:#fff;
  }
  .cal-day-cell.other-month{
    background:#f9fafb;
  }
  .cal-day-number{
    font-size:.78rem;
    font-weight:700;
    color:#111;
  }
  .cal-day-number.today{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:22px;
    height:22px;
    border-radius:999px;
    background:var(--primary);
    color:#fff;
  }

  .cal-event-chip{
    margin-top:2px;
    padding:1px 2px;
    border-radius:8px;
    font-size:clamp(.32rem, 0.7vw, .58rem);
    line-height:1.1;
    cursor:pointer;
    color:#111;
    box-shadow:0 1px 3px rgba(0,0,0,.16);
  }
  .cal-event-chip .cal-evt-title{
    font-weight:800;
    display:block;
    font-size:clamp(.34rem, 0.8vw, .66rem);
  }
  .cal-event-chip .cal-evt-time{
    font-weight:600;
    font-size:clamp(.30rem, 0.65vw, .56rem);
  }

  /* Colores por secretar√≠a (fondos claros distintos) */
  .sec-despacho{
    background:#fee2e2;
    border:1px solid #f87171;
  }
  .sec-gobierno{
    background:#dbeafe;
    border:1px solid #60a5fa;
  }
  .sec-hacienda{
    background:#fef3c7;
    border:1px solid #facc15;
  }
  .sec-educacion{
    background:#dcfce7;
    border:1px solid #22c55e;
  }
  .sec-planeacion{
    background:#ede9fe;
    border:1px solid #a855f7;
  }
  .sec-agro{
    background:#f5f3ff;
    border:1px solid #8b5cf6;
  }
  .sec-salud{
    background:#cffafe;
    border:1px solid #06b6d4;
  }
  .sec-default{
    background:#e5e7eb;
    border:1px solid #9ca3af;
  }

  .cal-day-view,
  .cal-week-view{
    border-top:1px solid #eee;
  }
  .cal-day-header-row,
  .cal-week-header-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:6px 10px;
    background:#f7fafc;
    border-bottom:1px solid #eee;
    font-size:.85rem;
    font-weight:700;
  }
  .cal-day-body,
  .cal-week-body{
    padding:8px;
    display:flex;
    flex-direction:column;
    gap:6px;
  }

  .cal-year-grid{
    border-top:1px solid #eee;
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
    gap:10px;
    padding:10px;
  }
  .cal-year-month{
    border-radius:12px;
    background:#f9fafb;
    padding:8px;
    box-sizing:border-box;
  }
  .cal-year-month h4{
    margin:0 0 4px;
    font-size:.8rem;
    text-align:center;
    color:#111;
  }
  .cal-year-month table{
    width:100%;
    border-collapse:collapse;
    font-size:.7rem;
    text-align:center;
  }
  .cal-year-month th{
    font-weight:700;
    color:#666;
    padding:2px 0;
  }
  .cal-year-month td{
    padding:2px 0;
    color:#111;
  }
  .cal-year-dot{
    width:6px;
    height:6px;
    border-radius:999px;
    display:inline-block;
    margin-left:2px;
    background:#22c55e;
  }

  .cal-footer-actions{
    margin-top:14px;
    display:flex;
    gap:12px;
    flex-wrap:wrap;
  }

   /* Solo reducir tama√±o de la LEYENDA de secretar√≠as en pantallas peque√±as */
@media (max-width: 480px){
  .cal-legend{
    font-size: 0.45rem !important;
    gap: 2px !important;
  }

  .cal-legend-item{
    gap: 2px !important;
  }

  .cal-legend-dot{
    width: 5px !important;
    height: 5px !important;
  }
}

  /* Picker modales para fechas en calendario/solicitud prensa */
  .picker-modal-cal{
    position:fixed;
    inset:0;
    display:none;
    align-items:flex-start;
    justify-content:center;
    padding-top:32px;
    background:rgba(0,0,0,.5);
    z-index:9999;
  }
  .picker-modal-cal[aria-hidden="false"]{
    display:flex;
  }
  .picker-box-cal{
    width:90%;
    max-width:520px;
    background:#fff;
    border-radius:8px;
    padding:16px;
    box-shadow:0 8px 18px rgba(0,0,0,.18);
  }
  .picker-grid-cal{
    display:grid;
    grid-template-columns:1fr 1fr 1fr;
    gap:8px;
    margin:12px 0;
  }

  /* Forzar que el modal de FECHA DE PUBLICACI√ìN quede pegado abajo en solicitud prensa */
  #spPublicacionFechaModal{
    align-items:flex-end;
    justify-content:center;
    padding-top:0;
    padding-bottom:16px;
  }

      .cal-checklist{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
  }
  .cal-check-item{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:4px 10px;
    border-radius:999px;
    background:rgba(255,255,255,.9);
    border:1.5px solid #ccc;
    font-size:.85rem;
    color:#06402B;
    box-shadow:0 1px 3px rgba(0,0,0,.12);
  }
  .cal-check-item input[type="checkbox"]{
    width:16px;
    height:16px;
    accent-color:#06402B;
  }

    .contact-list{
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .contact-item{
      display:flex;
      flex-direction:column;
      gap:6px;
      background: rgba(255,255,255,.9);
      border:2px solid #ddd;
      border-radius:16px;
      padding:10px 12px;
      box-shadow:0 6px 14px rgba(0,0,0,.12);
    }
    .contact-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .contact-name{
      font-weight:900;
      color:#06402B;
    }
    .contact-address{
      font-size:.9rem;
      color:#333;
    }
    .contact-actions-row{
      display:flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      margin-top:6px;
    }
    .contact-actions-row a,
    .contact-actions-row button{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:40px;
      height:40px;
      border-radius:10px;
      border:2px solid var(--primary);
      background:#fff;
      box-shadow:0 4px 10px rgba(0,0,0,.16);
      cursor:pointer;
    }
    .contact-actions-row img{
      width:22px;
      height:22px;
      object-fit:contain;
      border-radius:6px;
      background:#fff;
    }

    /* Estilos de calendario */

      .cal-legend{
    margin-top:4px;
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    font-size:.75rem;
    color:#6b7280; /* gris similar al texto ‚ÄúVista interactiva‚Ä¶‚Äù */
  }
  .cal-legend-item{
    display:inline-flex;
    align-items:center;
    gap:6px;
    white-space:nowrap;
  }
  .cal-legend-dot{
    width:10px;
    height:10px;
    border-radius:999px;
    display:inline-block;
    border:1px solid transparent;
  }

  /* Colores de las bolitas, armonizados con los chips existentes */
  .cal-legend-despacho{
    background:#fee2e2;       /* rosa p√°lido */
    border-color:#f87171;
  }
  .cal-legend-gobierno{
    background:#dbeafe;       /* azul cielo suave */
    border-color:#60a5fa;
  }
  .cal-legend-hacienda{
    background:#fef3c7;       /* amarillo crema */
    border-color:#facc15;
  }
  .cal-legend-educacion{
    background:#dcfce7;       /* verde menta claro */
    border-color:#22c55e;
  }
  .cal-legend-planeacion{
    background:#ede9fe;       /* lavanda p√°lido */
    border-color:#a855f7;
  }
  .cal-legend-agro{
    background:#f5f3ff;       /* malva muy p√°lido */
    border-color:#8b5cf6;
  }
  .cal-legend-salud{
    background:#cffafe;       /* cian muy claro */
    border-color:#06b6d4;
  }

  @media (max-width: 700px){
    .cal-legend{
      font-size:.7rem;
      gap:6px;
    }
  }

    /* Estilos de Overlay Men√∫ (adaptados para que las opciones queden
   inmediatamente debajo de cada bot√≥n de categor√≠a) */

/* Cada bloque de categor√≠a + sus opciones */
.menu-section-block{
  margin:6px 0;
}

/* Bot√≥n de categor√≠a */
.menu-cat-btn{
  display:flex;
  align-items:center;
  justify-content:flex-start;
  gap:10px;
  width:100%;
  border-radius:999px;
  font-weight:800;
  font-size:0.9rem;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

/* Texto dentro del bot√≥n de categor√≠a */
.menu-cat-btn span{
  flex:1 1 auto;
  text-align:left;
}

/* Icono (emoji) de la categor√≠a */
.menu-cat-icon{
  width:26px;
  height:26px;
  flex:0 0 auto;
  object-fit:contain;
}

/* Contenedor de opciones de cada categor√≠a
   (aparece justo debajo de su bot√≥n) */
.menu-cat-options{
  display:none;
  flex-direction:column;
  gap:8px;
  margin:6px 0 10px;
}

/* Botones internos (opciones) algo m√°s compactos */
.menu-cat-options .menu-btn{
  font-weight:600;
  font-size:0.86rem;
}

/* Categor√≠a activa */
.menu-cat-btn.active{
  background:#7de3ef;
  color:#000;
  border-color:#7de3ef;
}

/* Animaci√≥n de aparici√≥n (desprenderse de arriba hacia abajo) */
.menu-cat-options.showing{
  animation: menuDropIn 0.22s ease-out;
}

@keyframes menuDropIn{
  from{
    opacity:0;
    transform:translateY(-6px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

    /* Bot√≥n verde: Unificar Anexos */
.btn-unificar-anexos{
  background: var(--ok);
  color:#fff;
  border: 2px solid var(--ok);
  font-weight: 900;

  width: auto;               /* evita 100% */
  padding: 8px 14px;         /* m√°s compacto */
  font-size: 10px;           /* m√°s peque√±o */
  border-radius: 999px;      /* tipo pill */
  display: inline-flex;      /* tama√±o seg√∫n contenido */
  align-items: center;
  justify-content: center;
}
.btn-unificar-anexos:hover{
  background:#15803d;
  border-color:#15803d;
  color:#fff;
}

     /* Tutoriales: card de video horizontal sin espacios, adaptable */
  .tut-videos{
    margin-top: 8px;
    display:flex;
    flex-direction:column;
    gap:12px;
  }
  .tut-video-card{
    position:relative;
    width: 100%;
    max-width: 860px;           /* limita en desktop */
    aspect-ratio: 16 / 9;
    margin: 0 auto;             /* centrado */
    background:#000;
    border-radius: 14px;
    overflow:hidden;
    border:2px solid #ddd;
    box-shadow: 0 10px 24px rgba(0,0,0,.22);
  }
  .tut-video-thumb{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .tut-play-layer{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background: radial-gradient(circle at center, rgba(255,255,255,.16), rgba(0,0,0,.60));
    color:#fff;
    font-size:64px;
    cursor:pointer;
    user-select:none;
  }

  /* iframe ocupa todo (sin espacios) */
  .tut-video-card iframe{
    position:absolute;
    inset:0;
    width:100%;
    height:100%;
    border:0;
    display:block;
    background:#000;
  }

  /* En pantallas grandes, que no se vea gigante */
  @media (min-width: 1024px){
    .tut-video-card{ max-width: 900px; }
  }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="loader" class="loader hidden" aria-live="polite" aria-busy="true">
    <div class="spinner-ios" role="status" aria-label="Cargando">
      <i></i><i></i><i></i><i></i><i></i><i></i>
      <i></i><i></i><i></i><i></i><i></i><i></i>
    </div>
  </div>

  <div class="container">
    <!-- VISTA INSTALAR -->
     <section id="view-instalar" class="view">
      <div class="card narrow" style="text-align:center;">
        <h2 style="color:var(--primary);">APP CONTRATISTA</h2>
        <img class="brand" alt="Instalar" src="https://res.cloudinary.com/dqqeavica/image/upload/v1766349498/slider_zcq18s.gif" />
        <p style="font-weight:600;">Herramienta de uso exclusivo para CONTRATISTAS activos de la Alcald√≠a de Flandes</p>
        <div class="btn-row" style="justify-content:center; margin-top:12px;">
          <button id="btn-instalar" class="btn-primary" style="display:none;">Instalar la App üì≤</button>
        </div>
        <p class="muted" style="margin-top:14px;">Si ya instalaste la App y no se inicia autom√°ticamente, refresca en unos segundos.</p>
      </div>
    </section>

    <!-- VISTA LOGIN -->
    <section id="view-login" class="view active">
      <div class="card narrow">
        <h1 style="color:var(--primary); text-shadow: 0 2px 2px #031732;">CONTRATISTA</h1>
         <p class="helper"><b>Al usar esta aplicaci√≥n, aceptas voluntariamente el tratamiento tus datos Personales.</b><br><i>Art. 5 Ley 1581 de 2012 y Decreto 1074 de 2015</i></p>

        <label>Contrase√±a</label>
        <div class="pwd-wrapper" style="position:relative;">
          <input id="login-doc" type="password" inputmode="numeric" autocomplete="off" placeholder="Sin puntos ni espacios" />
          <button type="button" id="toggle-doc" aria-label="Mostrar documento" style="position:absolute;top:50%;right:10px;transform:translateY(-50%);background:transparent;border:0;width:28px;height:28px;display:flex;align-items:center;justify-content:center;cursor:pointer;border-radius:6px;">
            <img id="toggle-doc-img" src="https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png" alt="Mostrar" style="width:22px;height:22px;">
          </button>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="btn-login">Iniciar Sesi√≥n</button>
        </div>

        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347982/banner_wbfbf7.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- VISTA INICIO -->
    <section id="view-inicio" class="view">
      <div class="card narrow">
        <div class="btn-row" style="margin-bottom:12px;">
          <button class="chip danger" id="btn-logout">Cerrar Sesi√≥n</button>
          <button class="chip" id="btn-open-menu">MEN√ö</button>
        </div>

        <div class="image-center">
          <div class="notif-wrap">
            <img class="avatar-emoji" src="https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png" alt="">
            <img id="notif-bell" class="notif-bell" src="https://res.cloudinary.com/dqqeavica/image/upload/v1759767447/Notificaci%C3%B3n_jtptyw.webp" alt="">
            <span id="notif-count" class="notif-count">0</span>
            <span id="notif-label" class="notif-label">Ver Noticias</span>
          </div>
        </div>

        <h2 id="inicio-nombre" style="color:var(--primary); font-weight:900; margin-top:6px;"></h2>
        <p id="inicio-sub" class="center muted" style="margin-top:0; font-weight:300;"></p>

        <div class="narrow" style="margin-top:10px;">
          <p><b>CC:</b> <span id="inicio-cc"></span></p>
          <p><b>CONTACTO:</b> <span id="inicio-contacto"></span></p>
          <p><b>DIRECCI√ìN:</b> <span id="inicio-direccion"></span></p>
          <p><b>CORREO:</b> <span id="inicio-correo"></span></p>
          <p><b>CUENTA N¬∞:</b> <span id="inicio-cuenta"></span></p>
          <p><b>EPS:</b> <span id="inicio-eps"></span></p>
          <p><b>AFP:</b> <span id="inicio-afp"></span></p>
          <p><b>ARL:</b> <span id="inicio-arl"></span></p>
          <p><b>SUPERVISOR:</b> <span id="inicio-supervisor"></span></p>
        </div>

        <img id="inicio-firma" class="brand" alt="Firma" src="" style="display:none; max-width:260px; border-radius:12px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347982/banner_wbfbf7.gif" />
        <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
      </div>
    </section>

    <!-- OVERLAY MEN√ö -->
    <div class="overlay" id="overlay">
      <div class="scrim" id="ovlClose"></div>
      <aside class="panel">
  <div class="btn-row">
    <button id="btn-ovl-back">ATR√ÅS</button>
  </div>

  <div class="image-center">
    <img alt="banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1766349498/slider_zcq18s.gif" style="max-width:180px;border-radius:10px;" />
  </div>

  <h3>Selecciona una categor√≠a</h3>

  <!-- CATEGOR√çAS CON SUS OPCIONES DIRECTAMENTE DEBAJO -->

  <!-- DATOS DE PROCESOS -->
  <div class="menu-section-block">
    <button class="menu-btn menu-cat-btn" data-cat="cat-datos">
      <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347981/datos_de_procesos_liwzbm.png" alt="" class="menu-cat-icon">
      <span>DATOS DE PROCESOS</span>
    </button>
    <div id="cat-datos" class="menu-cat-options">
      <button class="menu-btn" id="go-contrato">DATOS DEL CONTRATO</button>
      <button class="menu-btn" id="go-personales">DATOS PERSONALES</button>
    </div>
  </div>

  <!-- PROCESOS DE CUENTA -->
  <div class="menu-section-block">
    <button class="menu-btn menu-cat-btn" data-cat="cat-cuenta">
      <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347980/procesos_de_cuenta_aoevkw.webp" alt="" class="menu-cat-icon">
      <span>PROCESOS DE CUENTA</span>
    </button>
    <div id="cat-cuenta" class="menu-cat-options">
      <button class="menu-btn" id="go-borrador">BORRADOR ACTIVIDADES</button>
      <button class="menu-btn" id="go-ingresar-cuenta">INGRESAR CUENTA</button>
      <button class="menu-btn" id="go-cuenta-drive">MI CUENTA DRIVE</button>
      <button class="menu-btn" id="go-reportar-drive">REPORTAR CUENTA</button>
      <button class="menu-btn" id="go-corregir-cuenta">CORREGIR CUENTA</button>
      <button class="menu-btn" id="go-reportar-plan">PLAN DE PAGOS</button>
      <button class="menu-btn" id="go-estado-cuenta">ESTADO DE CUENTA</button>
    </div>
  </div>

  <!-- TR√ÅMITES Y SOLICITUDES -->
  <div class="menu-section-block">
    <button class="menu-btn menu-cat-btn" data-cat="cat-tramites">
      <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347980/tramites_y_solicitudes_c7ve14.webp" alt="" class="menu-cat-icon">
      <span>TR√ÅMITES Y SOLICITUDES</span>
    </button>
    <div id="cat-tramites" class="menu-cat-options">
      <button class="menu-btn" id="go-solicitud-prensa">SOLICITUD PRENSA</button>
      <button class="menu-btn" id="go-certificacion-contrato">CERTIFICACI√ìN CONTRATO</button>
      <button class="menu-btn" id="go-descargar-egresos">DESCARGAR EGRESOS</button>
      <button class="menu-btn" id="go-solicitud-tesoreria">SOLICITUD TESORER√çA</button>
    </div>
  </div>

  <!-- INSTITUCIONAL -->
  <div class="menu-section-block">
    <button class="menu-btn menu-cat-btn" data-cat="cat-institucional">
      <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347984/Institucional_pxbtrc.png" alt="" class="menu-cat-icon">
      <span>INSTITUCIONAL</span>
    </button>
    <div id="cat-institucional" class="menu-cat-options">
      <button class="menu-btn" id="go-comunicados">COMUNICADOS</button>
      <button class="menu-btn" id="go-calendario">CALENDARIO INSTITUCIONAL</button>
      <button class="menu-btn" id="go-directorio">DIRECTORIO INSTITUCIONAL</button>
    </div>
  </div>

  <!-- SITIOS WEB -->
  <div class="menu-section-block">
    <button class="menu-btn menu-cat-btn" data-cat="cat-sitios">
      <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347981/sitios_web_jj8fgo.webp" alt="" class="menu-cat-icon">
      <span>SITIOS WEB</span>
    </button>
    <div id="cat-sitios" class="menu-cat-options">
      <button class="menu-btn" id="go-secop2">SECOP II</button>
      <button class="menu-btn" id="go-sia">SIA OBSERVA - INVITADO</button>
      <button class="menu-btn" id="go-admin">ALCALD√çA DE FLANDES</button>
       <button class="menu-btn" id="go-smalluni">SMALL PDF - UNIFICAR</button>
       <button class="menu-btn" id="go-smalldesb">SMALL PDF - DESBLOQUEAR</button>
    </div>
  </div>

  <!-- GU√çA DE USO -->
 <div class="menu-section-block">
    <button class="menu-btn menu-cat-btn" data-cat="cat-guia">
      <img src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347980/manual_de_uso_n0zu32.webp" alt="" class="menu-cat-icon">
      <span>GU√çA DE USO</span>
    </button>
        <div id="cat-guia" class="menu-cat-options">
      <button class="menu-btn" id="go-tutoriales">TUTORIALES</button>
      <button class="menu-btn" id="go-soporte">SOPORTE</button>
    </div>
  </div>

  <div style="height:24px"></div>
  <img class="brand" alt="Banner" src="https://res.cloudinary.com/dqqeavica/image/upload/v1766347982/banner_wbfbf7.gif" />
  <p class="center muted">Copyright ¬© <b>GOBIERNO DIGITAL</b></p>
</aside>
    </div>

    <!-- VISTA REGISTRO -->
    <section id="view-registro" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">COMPLETANDO REGISTRO</h2> 

        <label>Municipio de Expedici√≥n del Documento</label>
         <div class="muted" style="margin:6px 0 8px;">Debes esperar un par de segundos mientras cargan las opciones</div>
        <input id="reg-expedida" list="dl-expedida" placeholder="Escribe y selecciona" autocomplete="off">
        <datalist id="dl-expedida"></datalist>

        <label>Tel√©fono L√≠nea WhatsApp</label>
        <input id="reg-telefono" type="tel" inputmode="numeric" placeholder="Tel√©fono Personal">

        <label>Direcci√≥n de Residencia</label>
        <textarea id="reg-direccion" rows="2" placeholder="Usa abreviaciones. No escribas el municipio. Ej: Mz 5 Casa 16 B/ Orqu√≠deas II."></textarea>

        <label>Municipio de Residencia</label>
        <div class="muted" style="margin:6px 0 8px;">Debes esperar un par de segundos mientras cargan las opciones</div>
        <input id="reg-municipio" list="dl-municipio" placeholder="Escribe y selecciona" autocomplete="off">
        <datalist id="dl-municipio"></datalist>

        <label>Correo Personal</label>
        <input id="reg-correo" type="email" placeholder="correo que te pertenezca, NO Institucional">

        <label>Tipo de cuenta</label>
        <select id="reg-tipoCuenta">
          <option value="" disabled selected>Selecciona tipo de cuenta</option>
          <option>AHORROS</option><option>CORRIENTE</option>
        </select>

        <label>N√∫mero de cuenta</label>
        <input id="reg-numeroCuenta" type="tel" inputmode="numeric" placeholder="Ingresa n√∫mero de cuenta">

        <label>Banco</label>
        <select id="reg-banco"></select>

        <label>EPS</label>
        <select id="reg-eps"></select>

        <label>Fondo de Pensiones (AFP)</label>
        <div class="muted" style="margin:6px 0 8px;">
          <b>S√≠ eres Pensionado(a), selecciona N/A</b><br>
          Esto implica que, en cada cuenta debes presentar alguno de los siguientes soportes:<br>
          - Certificaci√≥n de Pensionado(a)<br>
          - Resoluci√≥n de Pensi√≥n<br>
          - Certificaci√≥n de Devoluci√≥n del Saldo por Vejez.
        </div>
        <select id="reg-pension"></select>

        <label>ARL</label>
        <select id="reg-arl"></select>

        <label>Imagen de Firma</label>
        <div class="muted" style="margin:6px 0 8px;">Recuerda que debe ser una imagen clara y sin marcas de agua</div>
        <input type="file" id="reg-firma" accept="image/*" />
        <img id="reg-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

        <label>Fecha de nacimiento</label>
        <input
          id="reg-cumple"
          type="text"
          placeholder="dd/mm/aaaa"
          readonly
          onclick="abrirPickerCumple()" />

        <!-- Modal Fecha (ruleta) para Cumple: a√±os 1936..2008 -->
        <div id="cumpleModal" class="picker-modal" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:9999;">
          <div class="picker-box" style="width:90%; max-width:520px; background:#fff; border-radius:8px; padding:16px;">
            <h3 style="margin:0 0 8px 0;">Selecciona tu fecha de Nacimiento</h3>
            <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
              <div>
                <small>D√≠a</small>
                <select id="cumpleDia" size="10"></select>
              </div>
              <div>
                <small>Mes</small>
                <select id="cumpleMes" size="12"></select>
              </div>
              <div>
                <small>A√±o</small>
                <select id="cumpleAnio" size="10"></select>
              </div>
            </div>
            <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
              <button type="button" class="btn btn-cancel" onclick="cancelarPickerCumple()">Cancelar</button>
              <button type="button" class="btn btn-ok" onclick="confirmarPickerCumple()">Ok</button>
            </div>
          </div>
        </div>

        <div class="btn-row spaced">
          <button class="btn-primary" id="reg-guardar">Guardar</button>
          <button id="reg-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA DATOS DEL CONTRATO -->
    <section id="view-contrato" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">DATOS DEL CONTRATO</h2>

        <div id="contrato-lectura" class="narrow"></div>

        <div class="btn-row spaced">
          <button id="contrato-editar" class="btn-primary">Actualizar</button>
          <button id="contrato-volver" class="danger">Regresar</button>
        </div>

        <div id="contrato-form" class="hidden" style="margin-top:10px;">
          <!-- Fecha Inicio (ruleta a√±o fijo 2026) -->
          <label>Fecha de Inicio</label>
          <div class="muted" style="margin:6px 0 8px;"><b>FECHA DE ACTA DE INICIO</b></div>
          <input id="c-fechaInicio" type="text" placeholder="dd/mm/2026" readonly onclick="abrirPickerContrato('inicio')">
          <input id="c-diaInicio" type="text" readonly style="display:none;">
          <input id="c-mesInicio" type="text" readonly style="display:none;">

          <label>Fecha de Terminaci√≥n</label>
          <div class="muted" style="margin:6px 0 8px;">Corrobora esta fecha en el ACTA DE INICIO</div>
          <input id="c-fechaTermino" type="text" placeholder="dd/mm/2026" readonly onclick="abrirPickerContrato('termino')">
          <input id="c-diaTermino" type="text" readonly style="display:none;">
          <input id="c-mesTermino" type="text" readonly style="display:none;">

          <!-- Modal Picker (a√±o fijo 2026) -->
          <div id="contratoFechaModal" class="picker-modal" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:9999;">
            <div class="picker-box" style="width:90%; max-width:520px; background:#fff; border-radius:8px; padding:16px;">
              <h3 style="margin:0 0 8px 0;">Selecciona la fecha</h3>
              <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
                <div>
                  <small>D√≠a</small>
                  <select id="contratoDia" size="10"></select>
                </div>
                <div>
                  <small>Mes</small>
                  <select id="contratoMes" size="12"></select>
                </div>
                <div>
                  <small>A√±o</small>
                  <select id="contratoAnio" size="3" disabled>
                    <option selected>2026</option>
                  </select>
                </div>
              </div>
              <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
                <button type="button" class="btn btn-cancel" onclick="cancelarPickerContrato()">Cancelar</button>
                <button type="button" class="btn btn-ok" onclick="confirmarPickerContrato()">Ok</button>
              </div>
            </div>
          </div>

          <label>Meses de contrato</label>
<div class="muted" style="margin:6px 0 8px;">Edita <b>solo si NO coincide</b> con el Acta de Inicio</div>
<input id="c-meses" type="tel" inputmode="numeric" placeholder="Autom√°tico">

<label>D√≠as de complemento si Aplica</label>
<div class="muted" style="margin:6px 0 8px;">Edita <b>solo si NO coincide</b> con el Acta de Inicio</div>
<input id="c-dias" type="tel" inputmode="numeric" placeholder="Autom√°tico">

<label>Tiempo de ejecuci√≥n</label>
<input id="c-ejecucion" type="text" readonly>

          <label>Registro Presupuestal (RP)</label>
          <input id="c-rp" type="tel" inputmode="numeric" placeholder="N¬∞ de RP" maxlength="10" style="border:1.5px solid #ccc;">

                    <label>Registro Presupuestal Adici√≥n (RP Adici√≥n)</label>
           <div class="muted" style="margin:6px 0 8px;"><b>Edita solo si ya tienes Adici√≥n de Contrato</b></div>
          <input id="c-rpAdicion" type="tel" inputmode="numeric" placeholder="N¬∞ de RP Adici√≥n" maxlength="10" style="border:1.5px solid #ccc;">

         <label>¬øPerteneces al R√©gimen Simple de Tributaci√≥n (SIMPLE)?</label>
<div class="muted" style="margin:6px 0 8px;">
  <b>¬øC√≥mo saberlo?</b><br>
  Revisa tu RUT. Si aparece que perteneces al ‚ÄúR√©gimen Simple de Tributaci√≥n‚Äù, debes marcar <b>S√≠.</b><br>
  Si no aparece, marca <b>No.</b>
</div>
<select id="c-regimen">
  <option value="" disabled selected>Selecciona</option>
  <option value="SI pertenezco al R√©gimen Simple.">SI</option>
  <option value="NO pertenezco al R√©gimen Simple.">NO</option>
</select>

<label>¬øEst√°s obligado a facturar electr√≥nicamente?</label>
<div class="muted" style="margin:6px 0 8px;">
  <b>¬øC√≥mo saberlo?</b><br>
  Revisa tu RUT. Si all√≠ indica que est√°s obligado a facturar electr√≥nicamente o ya manejas facturaci√≥n electr√≥nica ante la DIAN, marca <b>S√≠.</b>
</div>
<select id="c-factura">
  <option value="" disabled selected>Selecciona</option>
  <option value="SI facturo electr√≥nicamente.">SI</option>
  <option value="NO facturo electr√≥nicamente.">NO</option>
</select>

<label>¬øTomar√°s costos y deducciones en tu declaraci√≥n de renta por este contrato?</label>
<div class="muted" style="margin:6px 0 8px;">
  <b>¬øQu√© significa esta pregunta?</b><br>
  Se refiere a si vas a descontar gastos relacionados con este contrato en tu declaraci√≥n de renta, como por ejemplo: Arriendo de oficina, Internet, Equipos, Transporte, Software, Personal de apoyo.
</div>
<select id="c-costos">
  <option value="" disabled selected>Selecciona</option>
  <option value="SI tomar√© costos o deducciones.">SI</option>
  <option value="NO tomar√© costos o deducciones.">NO</option>
</select>

          <div class="btn-row spaced" style="margin-top:12px;">
            <button id="c-guardar" class="btn-primary">Guardar Cambios</button>
            <button id="c-cancelar" class="danger">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VISTA DATOS PERSONALES -->
    <section id="view-personales" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">Tus Datos Personales</h2>

        <div id="personales-lectura" class="narrow"></div>

        <div class="btn-row spaced">
          <button id="personales-editar" class="btn-primary">Actualizar</button>
          <button id="personales-volver" class="danger">Regresar</button>
        </div>

        <div id="personales-form" class="hidden" style="margin-top:10px;">
          <label>Municipio de Expedici√≥n del Documento</label>
          <div class="muted" style="margin:6px 0 8px;">Desbes esperar un par de segundos mientras cargan las opciones</div>
          <input id="p-expedida" list="dl-expedida2" placeholder="Escribe y selecciona" autocomplete="off">
          <datalist id="dl-expedida2"></datalist>

          <label>Tel√©fono L√≠nea WhatsApp</label>
          <input id="p-telefono" type="tel" inputmode="numeric" placeholder="N√∫mero Personal">

          <label>Direcci√≥n de Residencia</label>
          <textarea id="p-direccion" rows="2" placeholder="Usa abreviaciones y no escribas el nombre del Municipio. Ejemplo: Mz 5 Casa 16 B/ Orqu√≠deas II"></textarea>

          <label>Municipio de Residencia</label>
          <div class="muted" style="margin:6px 0 8px;">Desbes esperar un par de segundos mientras cargan las opciones</div>
          <input id="p-municipio" list="dl-municipio2" placeholder="Escribe y selecciona" autocomplete="off">
          <datalist id="dl-municipio2"></datalist>

          <label>Correo Personal</label>
          <input id="p-correo" type="email" placeholder="correo que te pertenezca, NO Institucional">

          <label>Tipo de cuenta</label>
          <select id="p-tipoCuenta">
            <option value="" disabled selected>Selecciona tipo de cuenta</option>
            <option>AHORROS</option><option>CORRIENTE</option>
          </select>

          <label>N√∫mero de cuenta</label>
          <input id="p-numeroCuenta" type="tel" inputmode="numeric" placeholder="Ingresa n√∫mero de cuenta">

          <label>Banco</label>
          <select id="p-banco"></select>

          <label>EPS</label>
          <select id="p-eps"></select>

          <label>Fondo de Pensiones (AFP)</label>
          <div class="muted" style="margin:6px 0 8px;">
          <b>S√≠ eres Pensionado(a), selecciona N/A</b><br>
            Esto implica que, en cada cuenta debes presentar alguno de los siguientes soportes:<br>
            - Certificaci√≥n de Pensionado(a)<br>
            - Resoluci√≥n de Pensi√≥n<br>
            - Certificaci√≥n de Devoluci√≥n del Saldo por Vejez.
        </div>

          <select id="p-pension"></select>

          <label>ARL</label>
          <select id="p-arl"></select>

          <label>Actualizar Firma</label>
          <div class="muted" style="margin:6px 0 8px;">Recuerda que debe ser una imagen clara y sin marcas de agua</div>
          <input type="file" id="p-firma" accept="image/*" />
          <img id="p-firma-preview" src="" alt="Vista previa firma" style="display:none; max-width:100%; border-radius:10px; border:1.5px solid #d8e4ff; margin-top:8px;" />

           <label>Fecha de nacimiento</label>
        <input
          id="p-cumple"
          type="text"
          placeholder="dd/mm/aaaa"
          readonly
          onclick="abrirPickerCumplePersonales()" />

          <!-- Modal Cumple (Personales) Independiente -->
<div id="pCumpleModal" class="picker-modal" aria-hidden="true" style="position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.5); z-index:9999;">
  <div class="picker-box" style="width:90%; max-width:520px; background:#fff; border-radius:8px; padding:16px;">
    <h3 style="margin:0 0 8px 0;">Selecciona tu fecha de Nacimiento</h3>
    <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
      <div>
        <small>D√≠a</small>
        <select id="pCumpleDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="pCumpleMes" size="12"></select>
      </div>
      <div>
        <small>A√±o</small>
        <select id="pCumpleAnio" size="10"></select>
      </div>
    </div>
    <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn btn-cancel" onclick="cancelarPickerCumplePersonales()">Cancelar</button>
      <button type="button" class="btn btn-ok" onclick="confirmarPickerCumplePersonales()">Ok</button>
    </div>
  </div>
</div>


          <div class="btn-row spaced" style="margin-top:12px;">
            <button id="p-guardar" class="btn-primary">Guardar Cambios</button>
            <button id="p-cancelar" class="danger">Cancelar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VISTA COMUNICADOS -->
    <section id="view-comunicados" class="view">
      <div class="card narrow" style="padding-top:12px;">
        <h2 style="color:var(--primary); text-shadow: 0 2px 2px #031732; margin-bottom:10px;">¬°COMUNICADOS!</h2>
        <div id="com-list" class="feed-list"></div>
        <div class="btn-row spaced">
          <button id="com-volver">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA COMUNICADO DETALLE -->
    <section id="view-comunicado-detalle" class="view">
      <div class="feed-detail-card">
        <img id="com-det-thumb" class="feed-detail-thumb" src="" alt="">
        <h3 id="com-det-title" class="feed-detail-title">T√≠tulo</h3>
        <p id="com-det-sub" class="feed-detail-sub">Subt√≠tulo</p>
        <p id="com-det-desc" class="feed-detail-desc">Contenido</p>
        <div class="btn-row spaced">
          <a id="com-det-link" class="chip" href="#" target="_blank" rel="noopener" style="display:none;">Abrir V√≠nculo</a>
          <button id="com-det-volver">Regresar</button>
        </div>
      </div>
    </section>

 <!-- VISTA BORRADOR DE ACTIVIDADES -->
<section id="view-borrador" class="view">
  <div class="card narrow">
    <h2 style="color:var(--primary)">TU BORRADOR DE ACTIVIDADES</h2>
    
          <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>DESCRIPCI√ìN DETALLADA CON LOS CASOS QUE APLIQUE:</b><br><b>1.</b> En tus Actividades relaciona metas del Plan de Desarrollo (Si Aplica).<br>
            <b>2.</b> Lugares de realizaci√≥n de actividades (barrios, veredas, conjuntos, oficina, etc.).<br>
            <b>3.</b> Relaci√≥n de Cantidades (Atenci√≥n al P√∫blico, Revisiones, limpiezas, estudios, creaci√≥n de archivos, recepci√≥n y env√≠o de Documentos, visitas, reuniones, suministros entregados, trabajos realizados, etc.).<br>
            <b>4.</b> N¬∞ Personas Impactadas por la Actividad.<br>
            <b>5.</b> Medios de Corroboraci√≥n de la Informaci√≥n (Link Fanpage, Link Drive con permiso, descripci√≥n de archivos, etc.).
        </div>


    
    <p class="helper">INFORME: <span id="ba-informe" class="chip">1</span>
  &nbsp; DE:
  <input id="ba-total-input" type="text" placeholder="Total" style="display:inline-block; width:auto; min-width:80px;" />
</p>

    <div id="ba-list" class="narrow"></div>

    <div class="btn-row spaced">
      <button id="ba-guardar" class="btn-primary">Guardar</button>
      <button id="ba-volver" class="danger">Regresar</button>
    </div>
  </div>
</section>

    <!-- Vista INGRESAR CUENTA -->

    <section id="view-ingresar-cuenta" class="view">
  <div class="card narrow">
    <h2 id="ic-title" style="color:var(--primary)">CREACI√ìN DE CUENTA</h2>
    <h3 class="center" style="margin-top:6px;color:#333;">RELACI√ìN DE PAGO</h3>

    <p id="ic-desc" class="helper">
      <!-- el texto se setea desde JS seg√∫n el modo -->
      INFORME:
      <span id="ic-informe" class="chip">1</span>
      &nbsp; DE:
      <input id="ic-total" type="text" placeholder="Total" required style="display:inline-block; width:auto; min-width:80px;" />
    </p>

    <!-- Fechas: inicio/fin periodo y radicaci√≥n -->
    <div class="narrow">
      <label>Inicio de Periodo Relacionado</label>
      <input id="ic-inicio" type="text" placeholder="dd/mm/aaaa" readonly onclick="icAbrirInicio()" />
      <input id="ic-diaRat1" type="text" readonly style="display:none;">
      <input id="ic-mesRat1" type="text" readonly style="display:none;">

      <div id="icInicioModal" class="picker-modal" aria-hidden="true">
  <div class="picker-box">
    <h3 style="margin:0 0 8px 0;">Selecciona Inicio del Periodo (2026)</h3>
    <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
      <div>
        <small>D√≠a</small>
        <select id="icInicioDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="icInicioMes" size="12"></select>
      </div>
      <div>
        <small>A√±o</small>
        <select id="icInicioAnio" size="3" disabled>
          <option selected>2026</option>
        </select>
      </div>
    </div>
    <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn btn-cancel" onclick="icCancelarInicio()">Cancelar</button>
      <button type="button" class="btn btn-ok" onclick="icConfirmarInicio()">Ok</button>
    </div>
  </div>
</div>

      <label>Fin de Periodo Relacionado</label>
      <input id="ic-fin" type="text" placeholder="dd/mm/aaaa" readonly onclick="icAbrirFin()" />
      <input id="ic-diaRat2" type="text" readonly style="display:none;">
      <input id="ic-mesRat2" type="text" readonly style="display:none;">

      <div id="icFinModal" class="picker-modal" aria-hidden="true">
  <div class="picker-box">
    <h3 style="margin:0 0 8px 0;">Selecciona Fin del Periodo (2026)</h3>
    <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
      <div>
        <small>D√≠a</small>
        <select id="icFinDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="icFinMes" size="12"></select>
      </div>
      <div>
        <small>A√±o</small>
        <select id="icFinAnio" size="3" disabled>
          <option selected>2026</option>
        </select>
      </div>
    </div>
    <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn btn-cancel" onclick="icCancelarFin()">Cancelar</button>
      <button type="button" class="btn btn-ok" onclick="icConfirmarFin()">Ok</button>
    </div>
  </div>
</div>

      <label>Fecha de Radicaci√≥n</label>
      <input id="ic-radicado" type="text" placeholder="dd/mm/aaaa (hoy o pr√≥ximos 2 d√≠as h√°biles)" readonly onclick="icAbrirRadicado()" />
      <input id="ic-diaRad" type="text" readonly style="display:none;">
      <input id="ic-mesRad" type="text" readonly style="display:none;">
    </div>

    <div id="icRadicadoModal" class="picker-modal" aria-hidden="true">
  <div class="picker-box">
    <h3 style="margin:0 0 8px 0;">Selecciona Fecha de Radicaci√≥n</h3>
    <div class="picker-grid" style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin:12px 0;">
      <div>
        <small>D√≠a</small>
        <select id="icRadDia" size="10"></select>
      </div>
      <div>
        <small>Mes</small>
        <select id="icRadMes" size="12" disabled></select>
      </div>
      <div>
        <small>A√±o</small>
        <select id="icRadAnio" size="3" disabled></select>
      </div>
    </div>
    <div class="picker-actions" style="display:flex; gap:8px; justify-content:flex-end;">
      <button type="button" class="btn btn-cancel" onclick="icCancelarRadicado()">Cancelar</button>
      <button type="button" class="btn btn-ok" onclick="icConfirmarRadicado()">Ok</button>
    </div>
  </div>
</div>

    <h3 class="center" style="margin-top:12px;color:#333;">RELACI√ìN DE PAGO</h3>

    <div class="narrow">
      <label>Saldo Actual</label>
      <div id="ic-saldo-first-hint" class="muted" style="margin:6px 0 8px; display:none;">
  <b>Digita el valor de tu contrato</b>
</div>
      <input id="ic-saldo" type="tel" inputmode="numeric" placeholder="Primera cuenta: valor del contrato">

      <label>Valor por Cobrar</label>
      <input id="ic-cobro" type="tel" inputmode="numeric" placeholder="Ingresa el valor de este periodo">

      <label>Nuevo Saldo</label>
      <input id="ic-nuevoSaldo" type="text" readonly placeholder="$ 0" />

      <label>N¬∞ de Planilla</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa que el N√∫mero de Planilla coincida</b>
        </div>
      <input id="ic-planilla" type="tel" inputmode="numeric" placeholder="Planilla ya pagada">

      <label>Mes Relacionado en la Planilla</label>
      <select id="ic-mesPlanilla"></select>

      <label>Base de Cotizaci√≥n</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla IBC</b>
        </div>
      <input id="ic-base" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla">

      <label>Aportes a Salud</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Salud, sin intereses</b>
        </div>
      <input id="ic-salud" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla">

      <label>Aportes a Pensi√≥n</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Pensi√≥n, sin intereses<br><br>Si NO realizas aportes escribe 0</b>
        </div>
      <input id="ic-fondo" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla">

      <label>Aportes a ARL</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Riesgos, sin intereses<br><br>Si la entidad realiza los aportes por ser Tipo 3, 4 √≥ 5; escribe el valor del aporte</b>
        </div>
      <input id="ic-riesgos" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla">

      <input id="ic-solidario" type="text" readonly style="display:none;">
      <input id="ic-aporte" type="text" readonly style="display:none;">
    </div>

    <div class="center" style="margin-top:10px;">
      <button id="btn-planilla2-show" class="chip">Relacionar Planilla Anexa</button>
    </div>

    <div id="ic-planilla2-wrap" class="narrow hidden" style="margin-top:8px;">
      <h3 class="center" style="margin-top:6px;color:#333;">RELACI√ìN DE PAGO PLANILLA ANEXA</h3>
      <label>N¬∞ de Planilla Anexa</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa que el N√∫mero de Planilla coincida</b>
        </div>
      <input id="ic-planilla2" type="tel" inputmode="numeric" placeholder="Planilla ya pagada (opcional)">

      <label>Mes Relacionado en la Planilla Anexa</label>
      <select id="ic-mesPlanilla2"></select>

      <label>Base de Cotizaci√≥n (Anexa)</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla IBC</b>
        </div>
      <input id="ic-base2" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla (opcional)">

      <label>Aportes a Salud (Anexa)</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Salud, sin intereses</b>
        </div>
      <input id="ic-salud2" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla (opcional)">

      <label>Aportes a Pensi√≥n (Anexa)</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Pensi√≥n, sin intereses<br><br>Si NO realizas aportes escribe 0</b>
        </div>
      <input id="ic-fondo2" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla (opcional)">

      <label>Aportes a ARL (Anexa)</label>
      <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
          <b>Revisa en tu Planilla Aportes Riesgos, sin intereses<br><br>Si la entidad realiza los aportes por ser Tipo 3, 4 0 5; escribe el valor que consignado por la entidad</b>
        </div>
      <input id="ic-riesgos2" type="tel" inputmode="numeric" placeholder="C√≥mo aparece en la Planilla (opcional)">

      <input id="ic-solidario2" type="text" readonly style="display:none;">
      <input id="ic-aporte2" type="text" readonly style="display:none;">

      <input id="ic-supervisor" type="hidden" />
      <input id="ic-editor-email" type="hidden" />

      <div class="center" style="margin-top:8px;">
        <button id="btn-planilla2-hide" class="chip danger">Ocultar Planilla Anexa</button>
      </div>
    </div>

    <h3 class="center" style="margin-top:12px;color:#333;">RELACI√ìN DE ACTIVIDADES</h3>

     <div class="muted" style="margin:6px 0 8px; text-align: justify; ">
            <b>DESCRIPCI√ìN DETALLADA CON LOS CASOS QUE APLIQUE:</b><br>
            <b>1.</b> En tus Actividades relaciona metas del Plan de Desarrollo (Si Aplica).<br>
            <b>2.</b> Lugares de realizaci√≥n de actividades (barrios, veredas, conjuntos, oficina, etc.).<br>
            <b>3.</b> Relaci√≥n de Cantidades (Atenci√≥n al P√∫blico, Revisiones, limpiezas, estudios, creaci√≥n de archivos, recepci√≥n y env√≠o de Documentos, visitas, reuniones, suministros entregados, trabajos realizados, etc.).<br>
            <b>4.</b> N¬∞ Personas Impactadas por la Actividad.<br>
            <b>5.</b> Medios de Corroboraci√≥n de la Informaci√≥n (Link Fanpage, ANEXOS, descripci√≥n de archivos, etc.).<br>
            <b>6. Solo se permite una imagen por Evidencia, si tienes 2 o <b>3 como m√°ximo</b>; debes crear un collage sin rebordes ni espacios.</b><br><br>
            Si tienes archivos por anexar, debes unifircarlos en un solo PDF y subirlos en el campo <b>Anexos de Actividades</b>.<br><br>
            <b>PRE-AVISOS:</b><br>
            <b>1.</b> No copies las mismas actividades en cada cuenta (est√°n bajo seguimiento).<br>
            <b>2.</b> Las cuentas que no cumplan los par√°metros seg√∫n los casos, ser√°n devueltas.<br>
            <b>3. Un informe de cuenta tiene el mismo valor que un Informe de Gesti√≥n, por tal raz√≥n, los supervisores no pueden aprobar cuentas que no cumplan con los cr√≠terios anteriores.</b>
        </div>
    
    <div id="ic-oblig-wrap" class="narrow"></div>

          <div id="ic-bankplan-wrap" class="narrow" style="margin-top:12px;">
        <h3 class="center" style="margin-top:6px;color:#333;">CARGUE DE ARCHIVOS DE CUENTA</h3>

        <label>Anexos de Actividades (PDF)</label>
        <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SI TIENES ANEXOS DE ACTIVIDADES, S√öBELOS EN UN ARCHIVO PDF UNIFICADO, MAX. 10 MB</b></div>
        <input id="actAnexos" type="file" accept="application/pdf" />
        <div class="btn-row" style="margin-top:6px;">
          <button type="button" class="chip danger" id="actAnexos-clear" style="display:none;">Quitar</button>
        </div>
        <div id="actAnexos-status" class="muted" style="margin-top:6px;"></div>

        <div class="center" style="margin-top:10px; margin-bottom:6px;">
            <button type="button" id="btn-unificar-anexos" class="chip btn-unificar-anexos">
              Puedes Unificar tus Anexos Aqu√≠
            </button>
          </div>

        <label>Certificaci√≥n Bancaria (PDF)</label>
        <input id="bancaria" type="file" accept="application/pdf" />
        <div id="bancaria-status" class="muted" style="margin-top:6px;"></div>

        <label>Baucher Planilla (PDF)</label>
        <input id="baucher1" type="file" accept="application/pdf" />
        <div id="baucher1-status" class="muted" style="margin-top:6px;"></div>

        <label>Planilla (PDF)</label>
        <input id="planaporte1" type="file" accept="application/pdf" />
        <div id="planaporte1-status" class="muted" style="margin-top:6px;"></div>

        <div class="center" style="margin-top:10px; margin-bottom:6px;">
            <button type="button" id="btn-desbloquear-pdf" class="chip btn-unificar-anexos">
              Puedas desbloquear tus PDF Aqu√≠
            </button>
          </div>

        <label>RUT (R√©gimen Simple) (PDF)</label>
        <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>REQUERIDO SOLO PARA PERSONAS QUE MANEJAN FACTURA DIGITAL</b></div>
        <input id="rutsg" type="file" accept="application/pdf" />
        <div class="btn-row" style="margin-top:6px;">
          <button type="button" class="chip danger" id="rutsg-clear" style="display:none;">Quitar</button>
        </div>
        <div id="rutsg-status" class="muted" style="margin-top:6px;"></div>
        
        <label>Certificado NO aportes a Pensi√≥n (PDF)</label>
        <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>REQUERIDO SOLO PARA PERSONAS PENSIONADAS</b></div>
        <input id="noafp" type="file" accept="application/pdf" />
        <div class="btn-row" style="margin-top:6px;">
          <button type="button" class="chip danger" id="noafp-clear" style="display:none;">Quitar</button>
        </div>
        <div id="noafp-status" class="muted" style="margin-top:6px;"></div>

        <h3 class="center" style="margin-top:6px;color:#5b5b5b;">LOS SIGUIENTES CAMPOS SON OPCIONALE</h3>

        <label>Baucher Planilla Anexa (PDF)</label>
        <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO SI VAS A PRESENTAR PLANILLA ADICIONAL</b></div>
        <input id="baucher2" type="file" accept="application/pdf" />
        <div class="btn-row" style="margin-top:6px;">
        <button type="button" class="chip danger" id="baucher2-clear" style="display:none;">Quitar</button>
        </div>
        <div id="baucher2-status" class="muted" style="margin-top:6px;"></div>

        <label>Planilla Anexa (PDF)</label>
        <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO SI VAS A PRESENTAR PLANILLA ADICIONAL</b></div>
        <input id="planaporte2" type="file" accept="application/pdf" />
        <div class="btn-row" style="margin-top:6px;">
          <button type="button" class="chip danger" id="planaporte2-clear" style="display:none;">Quitar</button>
        </div>
        <div id="planaporte2-status" class="muted" style="margin-top:6px;"></div>

        <div class="center" style="margin-top:10px;">
          <button id="btn-novedades-show" class="chip">Adjunta Documentos Primera - √∫ltima Cuenta, Otros</button>
        </div>

        <div id="ic-novedades-wrap" class="narrow hidden" style="margin-top:8px;">
          <h3 class="center" style="margin-top:6px;color:#333;">DOCUMENTOS ANEXOS (PRIMERA Y √öLTIMA CUENTA, NOVEDADES)</h3>

          <label>Acta de Inicio (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO PARA PRIMERA CUENTA</b></div>
          <input id="actaI" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="actaI-clear" style="display:none;">Quitar</button>
          </div>
          <div id="actaI-status" class="muted" style="margin-top:6px;"></div>

          <label>Clausulados del Contrato (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO PARA PRIMERA CUENTA</b></div>
          <input id="clasulados" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="clasulados-clear" style="display:none;">Quitar</button>
          </div>
          <div id="clasulados-status" class="muted" style="margin-top:6px;"></div>

          <label>CDP (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO PARA PRIMERA CUENTA</b></div>
          <input id="cdpC" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="cdpC-clear" style="display:none;">Quitar</button>
          </div>
          <div id="cdpC-status" class="muted" style="margin-top:6px;"></div>

          <label>RP (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO PARA PRIMERA CUENTA</b></div>
          <input id="rpC" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="rpC-clear" style="display:none;">Quitar</button>
          </div>
          <div id="rpC-status" class="muted" style="margin-top:6px;"></div>

          <label>RUT Persona Natural (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO PARA PRIMERA CUENTA</b></div>
          <input id="rutpn" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="rutpn-clear" style="display:none;">Quitar</button>
          </div>
          <div id="rutpn-status" class="muted" style="margin-top:6px;"></div>

          <label>Certificado ARL (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO PARA PRIMERA CUENTA</b></div>
          <input id="arlC" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="arlC-clear" style="display:none;">Quitar</button>
          </div>
          <div id="arlC-status" class="muted" style="margin-top:6px;"></div>

          <label>OTROSI (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>CASOS PUNTUALES SI APLICA</b></div>
          <input id="otrosi" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="otrosi-clear" style="display:none;">Quitar</button>
          </div>
          <div id="otrosi-status" class="muted" style="margin-top:6px;"></div>

          <label>CDP Adici√≥n (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO PARA PRIMERA CUENTA DE ADICI√ìN</b></div>
          <input id="cdpAc" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="cdpAc-clear" style="display:none;">Quitar</button>
          </div>
          <div id="cdpAc-status" class="muted" style="margin-top:6px;"></div>

          <label>RP Adici√≥n (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO PARA PRIMERA CUENTA DE ADICI√ìN</b></div>
          <input id="rpAc" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="rpAc-clear" style="display:none;">Quitar</button>
          </div>
          <div id="rpAc-status" class="muted" style="margin-top:6px;"></div>

          <label>Acta de Liquidaci√≥n (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>SOLO PARA √öLTIMA CUENTA</b></div>
          <input id="actaL" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="actaL-clear" style="display:none;">Quitar</button>
          </div>
          <div id="actaL-status" class="muted" style="margin-top:6px;"></div>

          <label>Otro Requerido (PDF)</label>
          <div class="muted" style="margin:6px 0 8px; text-align: justify; "><b>CASOS PUNTUALES SI APLICA</b></div>
          <input id="otroR" type="file" accept="application/pdf" />
          <div class="btn-row" style="margin-top:6px;">
            <button type="button" class="chip danger" id="otroR-clear" style="display:none;">Quitar</button>
          </div>
          <div id="otroR-status" class="muted" style="margin-top:6px;"></div>

          <div class="center" style="margin-top:8px;">
            <button id="btn-novedades-hide" class="chip danger">Ocultar M√°s Documentos Anexos</button>
          </div>
        </div>
            
      </div>
    
    <div class="btn-row spaced">
      <button id="ic-guardar" class="btn-primary">Guardar</button>
      <button id="ic-volver" class="danger">Regresar</button>
    </div>
  </div>
</section>

           <!-- VISTA CALENDARIO INSTITUCIONAL -->
    <section id="view-calendario" class="view">
      <div class="card">
        <div class="cal-wrapper">
          <h2 style="color:var(--primary)">ACTIVIDADES INSTITUCIONALES ALCALD√çA DE FLANDES</h2>

          <div class="cal-header">
            <div>
              <div class="cal-title" id="cal-title-text">Mes actual</div>
              <p class="muted" style="margin:2px 0 0;">Vista interactiva de eventos programados y completados</p>
            </div>
            <div class="cal-nav-group">
              <button id="cal-btn-today" class="cal-pill-btn">Hoy</button>
              <button id="cal-prev" class="cal-pill-btn" aria-label="Anterior">‚Äπ</button>
              <button id="cal-next" class="cal-pill-btn" aria-label="Siguiente">‚Ä∫</button>
            </div>
            <div class="cal-filter-wrap">
              <button id="cal-filter-toggle" class="cal-pill-btn">Filtrar</button>
              <input id="cal-filter-input" class="cal-filter-input" type="text" placeholder="Filtrar por evento, secretar√≠a o responsable" style="display:none;">
            </div>
            <div class="cal-nav-group">
              <button id="cal-view-day" class="cal-pill-btn">D√≠a</button>
              <button id="cal-view-week" class="cal-pill-btn">Semana</button>
              <button id="cal-view-month" class="cal-pill-btn active">Mes</button>
              <button id="cal-view-year" class="cal-pill-btn">A√±o</button>
            </div>
          </div>

          <!-- LEYENDA DE COLORES -->
          <div class="cal-legend">
            <span class="cal-legend-item">
              <span class="cal-legend-dot cal-legend-despacho"></span>
              DESPACHO MUNICIPAL
            </span>
            <span class="cal-legend-item">
              <span class="cal-legend-dot cal-legend-gobierno"></span>
              SECRETAR√çA DE GOBIERNO Y SERVICIOS ADMINISTRATIVOS
            </span>
            <span class="cal-legend-item">
              <span class="cal-legend-dot cal-legend-hacienda"></span>
              SECRETAR√çA DE HACIENDA
            </span>
            <span class="cal-legend-item">
              <span class="cal-legend-dot cal-legend-educacion"></span>
              SECRETAR√çA DE EDUCACI√ìN, DESARROLLO ECON√ìMICO Y SOCIAL
            </span>
            <span class="cal-legend-item">
              <span class="cal-legend-dot cal-legend-planeacion"></span>
              SECRETAR√çA DE PLANEACI√ìN E INFRAESTRUCTURA
            </span>
            <span class="cal-legend-item">
              <span class="cal-legend-dot cal-legend-agro"></span>
              SECRETAR√çA DE ASUNTOS AGROPECUARIOS
            </span>
            <span class="cal-legend-item">
              <span class="cal-legend-dot cal-legend-salud"></span>
              SECRETAR√çA DE SALUD
            </span>
          </div>

          <div id="cal-container" class="cal-grid">
            <div style="padding:14px; text-align:center; font-size:.9rem;" class="muted">
              Cargando calendario‚Ä¶
            </div>
          </div>

          <div class="cal-footer-actions">
            <button id="cal-btn-back" class="danger">Regresar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- VISTA DETALLE DE EVENTO (solo lectura) -->
    <section id="view-evento-detalle" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">DETALLES DEL EVENTO</h2>
        <div id="evento-detalle-body" class="narrow"></div>
        <div class="btn-row spaced" style="margin-top:14px;">
          <button id="evento-detalle-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA SOLICITUD PRENSA -->
    <section id="view-solicitud-prensa" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">REQUERIMIENTO A EQUIPO DE COMUNICACIONES</h2>
        <p class="helper">Debes tener el aval de tu Supervisor(a) para realizar esta solicitud con 3 d√≠as de antelaci√≥n.</p>

        <label for="sp-nombreEvento">Nombre del Evento</label>
        <div class="muted" style="margin:6px 0 8px;">Si no aplica, NO edites</div> 
        <textarea id="sp-nombreEvento" rows="2" placeholder="T√≠tulo descriptivo del evento"></textarea>

        <label>Fecha del Evento</label>
        <div class="muted" style="margin:6px 0 8px;">Si no aplica, NO edites</div> 
        <input
          id="sp-fechaEvento"
          type="text"
          placeholder="dd/mm/aaaa"
          readonly
        />

        <label for="sp-horaInicio">Hora de Inicio</label>
        <div class="muted" style="margin:6px 0 8px;">Si no aplica, NO edites</div> 
        <input id="sp-horaInicio" type="time">

        <label for="sp-horaTerminacion">Hora Aprox. de Terminaci√≥n</label>
        <div class="muted" style="margin:6px 0 8px;">Si no aplica, NO edites</div> 
        <input id="sp-horaTerminacion" type="time">

        <label>Requerimientos:</label>
        <div class="muted" style="margin:6px 0 8px;">Selecciona al menos 1 Requerimiento</div> 
        <div id="sp-requerimientos" class="cal-checklist">
          <label class="cal-check-item">
            <input type="checkbox" value="Cubrimiento Fotogr√°fico">
            <span>Cubrimiento Fotogr√°fico</span>
          </label>
          <label class="cal-check-item">
            <input type="checkbox" value="Cubrimiento Video">
            <span>Cubrimiento Video</span>
          </label>
          <label class="cal-check-item">
            <input type="checkbox" value="Dise√±o Pieza Publicitaria">
            <span>Dise√±o Pieza Publicitaria</span>
          </label>
          <label class="cal-check-item">
            <input type="checkbox" value="Perifoneo">
            <span>Perifoneo</span>
          </label>
          <label class="cal-check-item">
            <input type="checkbox" value="Apoyo Publicitario">
            <span>Apoyo Publicitario</span>
          </label>
          <label class="cal-check-item">
            <input type="checkbox" value="Producci√≥n Multimedia">
            <span>Producci√≥n Multimedia</span>
          </label>
          <label class="cal-check-item">
            <input type="checkbox" value="Publicaci√≥n P√°gina Web">
            <span>Publicaci√≥n P√°gina Web</span>
          </label>
        </div>

        <label for="sp-otros">Otros:</label>
        <div class="muted" style="margin:6px 0 8px;">Si no aplica, NO edites</div> 
        <textarea id="sp-otros" rows="2" placeholder="Requerimientos adicionales"></textarea>

        <label for="sp-lugar">Lugar del Evento</label>
        <div class="muted" style="margin:6px 0 8px;">Si no aplica, NO edites</div> 
        <textarea id="sp-lugar" rows="2" placeholder="Lugar o puntos de encuentro"></textarea>

        <label for="sp-detalles">Detalles del Evento o Requerimiento</label>
        <textarea id="sp-detalles" rows="6" placeholder="Describe el objetivo, participantes, log√≠stica u otra informaci√≥n relevante"></textarea>

        <label>Fecha de Entrega o Publicaci√≥n</label>
        <div class="muted" style="margin:6px 0 8px;">M√≠nimo 3 d√≠as de antelaci√≥n</div> 
        <input
          id="sp-publicacion"
          type="text"
          placeholder="dd/mm/aaaa"
          readonly
        />

        <label for="sp-cargo">Cargo que tienes en tu Secretar√≠a</label>
        <textarea id="sp-cargo" rows="2" placeholder="Escribe correctamente tu cargo en la Secretar√≠a"></textarea>

        <!-- Campos ocultos: nombre, secretaria, contacto -->
        <input id="sp-nombre" type="hidden" />
        <input id="sp-secretaria" type="hidden" />
        <input id="sp-contacto" type="hidden" />

        <div class="btn-row spaced" style="margin-top:14px;">
          <button id="sp-enviar" class="btn-primary">Enviar Solicitud</button>
          <button id="sp-volver" class="danger">Regresar</button>
        </div>
      </div>

      <!-- Modal Fecha del Evento (parte superior) -->
      <div id="spEventoFechaModal" class="picker-modal-cal" aria-hidden="true">
        <div class="picker-box-cal">
          <h3 style="margin:0 0 8px 0;">Selecciona la Fecha del Evento</h3>
          <div class="picker-grid-cal">
            <div>
              <small>D√≠a</small>
              <select id="spEvtDia" size="10"></select>
            </div>
            <div>
              <small>Mes</small>
              <select id="spEvtMes" size="12"></select>
            </div>
            <div>
              <small>A√±o</small>
              <select id="spEvtAnio" size="10"></select>
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" class="btn" id="spEvtFechaCancelar">Cancelar</button>
            <button type="button" class="btn-primary" id="spEvtFechaOk">Ok</button>
          </div>
        </div>
      </div>

      <!-- Modal Fecha de Entrega/Publicaci√≥n (parte inferior) -->
      <div id="spPublicacionFechaModal" class="picker-modal-cal" aria-hidden="true">
        <div class="picker-box-cal">
          <h3 style="margin:0 0 8px 0;">Selecciona la Fecha de Entrega o Publicaci√≥n</h3>
          <div class="picker-grid-cal">
            <div>
              <small>D√≠a</small>
              <select id="spPubDia" size="10"></select>
            </div>
            <div>
              <small>Mes</small>
              <select id="spPubMes" size="12"></select>
            </div>
            <div>
              <small>A√±o</small>
              <select id="spPubAnio" size="10"></select>
            </div>
          </div>
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button type="button" class="btn" id="spPubFechaCancelar">Cancelar</button>
            <button type="button" class="btn-primary" id="spPubFechaOk">Ok</button>
          </div>
        </div>
      </div>
    </section>

      <!-- VISTA SOPORTE CONTRATISTA -->
    <section id="view-soporte" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">¬øQU√â NECESITAS RESOLVER?</h2>
        <p class="helper">Redacta tu solicitud o sugerencia para Gobierno Digital</p>
        <textarea id="soporte-text" rows="6" placeholder="Describe tu duda o sugerencia con el mayor detalle posible"></textarea>
        <div class="btn-row spaced">
          <button id="soporte-enviar" class="btn-primary">Enviar</button>
          <button id="soporte-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>

    <!-- VISTA TUTORIALES -->
   <section id="view-tutoriales" class="view">
  <div class="card">
    <h2 style="color:var(--primary); text-shadow: 0 2px 2px #031732; margin-bottom:6px;">TUTORIALES DE USO</h2>
    <p class="helper" style="text-align:justify; margin-top:0;">
      Este es el manual de uso de esta poderosa herramienta. Este es un cambio pensado para facilitar tu trabajo y tu tiempo.
      Cada tr√°mite digital es un paso hacia procesos m√°s simples, m√°s confianza y un Flandes que cambia la historia contigo.
      Gracias por ser parte de esta transformaci√≥n digital.
    </p>

    <div style="text-align:center; margin:5px 0 6px;">
      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1770850107/girar_emelgh.gif"
        alt="Girar para ver mejor"
        style="width:80px; max-width:45vw; height:auto; display:block; margin:0 auto 8px; border-radius:10px;"
      >
      <div class="muted" style="font-weight:500;">
        Puedes ampliar o girar cada<br>video para una mejor experiencia.
      </div>
    </div>

    <!-- BOTONES (centrados, ancho seg√∫n texto) -->
    <div class="narrow" style="display:flex; flex-direction:column; align-items:center; gap:10px; margin-top:10px;">
      <!-- Bot√≥n 1 -->
      <button class="chip tut-btn" data-tut="primera" style="width:auto; max-width:100%;">DOCUMENTOS PRIMERA CUENTA</button>
      <div class="tut-videos" data-tut-box="primera" style="display:none; width:100%;"></div>

      <!-- Bot√≥n 2 -->
      <button class="chip tut-btn" data-tut="personales" style="width:auto; max-width:100%;">DATOS PERSONALES</button>
      <div class="tut-videos" data-tut-box="personales" style="display:none; width:100%;"></div>

      <!-- Bot√≥n 3 -->
      <button class="chip tut-btn" data-tut="contrato" style="width:auto; max-width:100%;">DATOS DEL CONTRATO</button>
      <div class="tut-videos" data-tut-box="contrato" style="display:none; width:100%;"></div>

      <!-- Bot√≥n 4 -->
      <button class="chip tut-btn" data-tut="borrador" style="width:auto; max-width:100%;">BORRADOR DE ACTIVIDADES</button>
      <div class="tut-videos" data-tut-box="borrador" style="display:none; width:100%;"></div>

      <!-- Bot√≥n 5 -->
      <button class="chip tut-btn" data-tut="ingresar" style="width:auto; max-width:100%;">INGRESAR CUENTA</button>
      <div class="tut-videos" data-tut-box="ingresar" style="display:none; width:100%;"></div>

      <!-- Bot√≥n 6 -->
      <button class="chip tut-btn" data-tut="corregir" style="width:auto; max-width:100%;">CORREGIR CUENTA</button>
      <div class="tut-videos" data-tut-box="corregir" style="display:none; width:100%;"></div>

      <!-- Bot√≥n 7 -->
      <button class="chip tut-btn" data-tut="reportes" style="width:auto; max-width:100%;">REPORTES DE CUENTA Y PLAN DE PAGOS</button>
      <div class="tut-videos" data-tut-box="reportes" style="display:none; width:100%;"></div>

      <!-- Bot√≥n 8 -->
      <button class="chip tut-btn" data-tut="estados" style="width:auto; max-width:100%;">ESTADOS DE CUENTA</button>
      <div class="tut-videos" data-tut-box="estados" style="display:none; width:100%;"></div>

      <!-- Bot√≥n 9 -->
      <button class="chip tut-btn" data-tut="tramites" style="width:auto; max-width:100%;">TRAMITES Y SOLICITUDES</button>
      <div class="tut-videos" data-tut-box="tramites" style="display:none; width:100%;"></div>

      <!-- Bot√≥n 10 -->
      <button class="chip tut-btn" data-tut="institucional" style="width:auto; max-width:100%;">INSTITUCIONAL</button>
      <div class="tut-videos" data-tut-box="institucional" style="display:none; width:100%;"></div>

      <!-- Regresar al final -->
      <button id="tutoriales-volver" class="danger" style="width:auto; max-width:100%;">Regresar</button>
    </div>
  </div>
</section>


      <!-- VISTA SOLICITUD TESORERIA -->
    <section id="view-solicitud-tesoreria" class="view">
  <div class="card narrow">
    <h2 style="color:var(--primary)">SOLICITUD TESORER√çA</h2>

    <p class="helper">
      Esta solicitud tendr√° validez si el <b>estado de cuenta es PAGADA</b> y ya han transcurrido <b>3 d√≠as h√°biles</b> despu√©s de consultar o recibir el <b>mensaje EGRESO</b> a trav√©s de WhatsApp.
    </p>

    <textarea
      id="solicitud"
      rows="5"
      placeholder="Redacta con mayor detalle tu solicitud: relaciona el n√∫mero de cuenta y la fecha de radicaci√≥n. Recuerda que esta solicitud tendr√° validez si el estado de cuenta es PADAGA"></textarea>

    <input id="st-nombre" type="hidden" />
    <input id="st-secretaria" type="hidden" />
    <input id="st-contrato" type="hidden" />
    <input id="st-telefono" type="hidden" />

    <div class="btn-row spaced" style="margin-top:14px;">
      <button id="st-enviar" class="btn-primary">Enviar Solicitud</button>
      <button id="st-volver" class="danger">Regresar</button>
    </div>
  </div>
</section>

    <!-- VISTA DIRECTORIO INSTITUCIONAL -->
    <section id="view-directorio" class="view">
      <div class="card narrow">
        <h2 style="color:var(--primary)">DIRECTORIO INSTITUCIONAL</h2>
        <div id="dir-list" class="contact-list"></div>
        <div class="btn-row spaced">
          <button id="dir-volver" class="danger">Regresar</button>
        </div>
      </div>
    </section>
    
<script>
/* ================== CONFIGURACI√ìN ================== */
const API_BASE = 'https://script.google.com/macros/s/AKfycbx5nz42xZ53WEM55Kmt_i9ngh9bn_qZjjHo3_Ub_nSz3MO0B8YDbapwk7s0LQhhnG0X/exec';
const BUILDERBOT_ENDPOINT = 'https://app.builderbot.cloud/api/v2/ff37a123-12b0-4fdc-9866-f3e2daf389fb/messages';
const BUILDERBOT_API_KEY  = 'bb-7f9ef630-5cfc-4ba4-9258-5e7cecbb4f65';

  const DATA_POLICY_LOGO = 'https://res.cloudinary.com/dqqeavica/image/upload/v1746906622/Logo_hzevh9.png';
const DATA_POLICY_BANNER = 'https://res.cloudinary.com/dqqeavica/image/upload/v1766347982/banner_wbfbf7.gif';

/* ================== SONIDOS ================== */
const SOUNDS = {
  question: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_fail_ls2aif.mp3',
  info: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Default_notification_pkp4wr.mp3',
  success: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Pay_success_t5aawh.mp3',
  error: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  warning: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Low_battery_d5qua1.mp3',
  login: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_star_g1owy4.mp3',
  logout: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Siri_End_kelv02.mp3',
  back: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011578/Keyboard_Enter_b9k2dc.mp3',
  menu: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759011577/Namedrop_Popup_ale2zy.mp3',
  notify: 'https://res.cloudinary.com/dqqeavica/video/upload/v1759767435/Notificacion_d1woxv.mp3'
};
function playSoundOnce(url){
  try{ const a=new Audio(url); a.preload='auto'; a.play().catch(()=>{}); }catch(e){}
}
if (window.Swal && typeof Swal.fire === 'function'){
  const __fire = Swal.fire.bind(Swal);
  Swal.fire = function(options = {}, ...rest){
    try{
      const icon = options.icon || options.type;
      const soundTag = options.soundTag;
      if (soundTag === 'resumen'){ playSoundOnce(SOUNDS.info); }
      else if (icon && SOUNDS[icon]){ playSoundOnce(SOUNDS[icon]); }
      if ('soundTag' in options){ delete options.soundTag; } // evita el warning
    }catch(e){ /* noop */ }
    return __fire(options, ...rest);
  };
}

  /* ================== IM√ÅGENES (preview y compresi√≥n) ================== */
const MAX_IMAGE_MB = 5;
const MAX_IMG_DIM  = 1600;   // px lado mayor para evidencias/firmas
const JPEG_QUALITY = 0.78;
const EVI_SELECT_MAX_MB = 10;

function revokeObjUrl(url){ try{ if(url) URL.revokeObjectURL(url); }catch(_){ } }

/**
 * Convierte cualquier imagen (incluido HEIC) a JPEG, redimensiona al tope y devuelve dataURL.
 * Retorna { dataUrl, sizeMB, width, height }.
 */
function compressImageToDataUrl(file, { maxDim = MAX_IMG_DIM, quality = JPEG_QUALITY } = {}){
  return new Promise((resolve, reject)=>{
    if(!file) return resolve({ dataUrl:'', sizeMB:0 });
    const reader = new FileReader();
    reader.onload = ()=>{
      const img = new Image();
      img.onload = ()=>{
        const scale = Math.min(1, maxDim / Math.max(img.width, img.height));
        const w = Math.round(img.width  * scale);
        const h = Math.round(img.height * scale);

        const canvas = document.createElement('canvas');
        canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, w, h);

        canvas.toBlob(blob=>{
          if(!blob) return reject(new Error('No se pudo comprimir la imagen'));
          const sizeMB = blob.size / (1024*1024);
          const fr = new FileReader();
          fr.onload = ()=> resolve({ dataUrl: fr.result, sizeMB, width:w, height:h });
          fr.onerror = ()=> reject(new Error('No se pudo leer la imagen comprimida'));
          fr.readAsDataURL(blob);
        }, 'image/jpeg', quality);
      };
      img.onerror = ()=> reject(new Error('La imagen no se pudo cargar'));
      img.src = reader.result;
    };
    reader.onerror = ()=> reject(new Error('No se pudo leer el archivo'));
    reader.readAsDataURL(file);
  });
}

  /* ================== PDFS ANEXOS ================== */
const MAX_PDF_MB = 1;
const MAX_NOVEDADES_MB = 1;
const MAX_ACT_ANEXOS_MB = 10;

function setPdfStatus(id, file){
  const el = document.getElementById(id + '-status');
  const btn = document.getElementById(id + '-clear');
  if(!el) return;

  if(!file){
    el.innerHTML = '';
    if(btn) btn.style.display = 'none';
    return;
  }

  const name = String(file.name || 'archivo.pdf');
  el.innerHTML = `<span style="font-weight:900;color:#16a34a;">CARGADO</span> <span style="font-weight:700;">${escapeHtml_(name)}</span>`;
  if(btn) btn.style.display = '';
}
  
function escapeHtml_(s){
  return String(s||'')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&#039;');
}

function readFileAsDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=> resolve(String(r.result||''));
    r.onerror = ()=> reject(new Error('No se pudo leer el archivo'));
    r.readAsDataURL(file);
  });
}

async function pdfFileToBase64(file){
  const dataUrl = await readFileAsDataUrl(file);
  const parts = String(dataUrl).split(',');
  return parts[1] || '';
}

function isPdfFile_(file){
  if(!file) return false;
  const nameOk = /\.pdf$/i.test(String(file.name||''));
  const typeOk = String(file.type||'').toLowerCase() === 'application/pdf';
  return nameOk || typeOk;
}

async function isEncryptedPdfFile_(file){
  if(!file) return false;
  try{
    const buf = await file.arrayBuffer();
    const bytes = new Uint8Array(buf);

    // leer m√°s del encabezado para aumentar detecci√≥n (1MB m√°x => seguro)
    const head = new TextDecoder('latin1').decode(bytes.slice(0, Math.min(bytes.length, 200000)));

    // Si tiene /Encrypt casi siempre es PDF cifrado/protegido
    if(/\/Encrypt\b/.test(head)) return true;

    // Algunos PDFs protegidos tambi√©n incluyen /Filter /Standard y /SubFilter
    if(/\/Filter\s*\/Standard\b/.test(head)) return true;

    return false;
  }catch(_){
    return true;
  }
}

function bindPdfInputStrict(id, { required=false, forbidEncrypted=false, maxMb=MAX_PDF_MB } = {}){
  const inp = document.getElementById(id);
  if(!inp) return;

  const clearBtn = document.getElementById(id + '-clear');

  function clearUi(){
    inp.value = '';
    setPdfStatus(id, null);
    try{
      inp.dispatchEvent(new Event('change', { bubbles:true }));
    }catch(_){}
  }

  if(clearBtn){
    clearBtn.type = 'button';
    clearBtn.onclick = async ()=>{
      clearUi();
    };
  }

  inp.addEventListener('change', async ()=>{
    const file = inp.files && inp.files[0];
    setPdfStatus(id, null);

    if(!file){
      if(required){
        return;
      }
      return;
    }

    if(!isPdfFile_(file)){
      clearUi();
      await Swal.fire({ icon:'warning', title:'Archivo inv√°lido', text:'Solo se permiten archivos PDF.' });
      return;
    }

    const sizeMB = file.size / (1024*1024);
    if(sizeMB > maxMb){
      clearUi();
      await Swal.fire({ icon:'warning', title:'Archivo muy pesado', text:`El PDF supera ${maxMb} MB.` });
      return;
    }

    if(forbidEncrypted){
      const encrypted = await isEncryptedPdfFile_(file);
      if(encrypted){
        clearUi();
        await Swal.fire({
          icon:'warning',
          title:'PDF protegido no permitido',
          text:'Este archivo parece estar protegido/cifrado con contrase√±a. Por favor exporta o guarda una versi√≥n sin contrase√±a e int√©ntalo nuevamente.'
        });
        return;
      }
    }

    setPdfStatus(id, file);
  });
}

async function collectBankPlanPdfsBase64_(){
  const ids = ['bancaria','baucher1','planaporte1','baucher2','planaporte2','rutsg','noafp','actAnexos'];
  const out = {};

  for(const id of ids){
    const inp = document.getElementById(id);
    const file = inp && inp.files && inp.files[0] ? inp.files[0] : null;

    if(file){
      out[id] = await pdfFileToBase64(file);
      continue;
    }

    // En correcci√≥n: si el usuario presion√≥ "Quitar" sobre un precargado, mandamos marca de borrado
    if(IC_MODE === 'correccion'){
      const st = document.getElementById(id + '-status');
      const hadPreloaded = !!(IC_STATE.bankPlanUrls && IC_STATE.bankPlanUrls[id]);
      const statusEmpty = !st || String(st.innerHTML||'').trim() === '';
      if(hadPreloaded && statusEmpty){
        out[id] = '__DELETE__';
        continue;
      }
    }

    out[id] = '';
  }

  return out;
}

  async function collectNovedadesPdfsBase64_(){
  const ids = ['actaI','clasulados','cdpC','rpC','rutpn','arlC','otrosi','cdpAc','rpAc','actaL','otroR'];
  const out = {};

  for(const id of ids){
    const inp = document.getElementById(id);
    const file = inp && inp.files && inp.files[0] ? inp.files[0] : null;

    if(file){
      out[id] = await pdfFileToBase64(file);
      continue;
    }

    // En correcci√≥n: si el usuario presion√≥ "Quitar" sobre un precargado, mandamos marca de borrado
    if(IC_MODE === 'correccion'){
      const st = document.getElementById(id + '-status');
      const hadPreloaded = !!(IC_STATE.novedadesUrls && IC_STATE.novedadesUrls[id]);
      const statusEmpty = !st || String(st.innerHTML||'').trim() === '';
      if(hadPreloaded && statusEmpty){
        out[id] = '__DELETE__';
        continue;
      }
    }

    out[id] = '';
  }

  return out;
}

/* ================== LOADER ================== */
const loader = document.getElementById('loader');
let loadingCount = 0, loaderTimer = null; let suppressLoader = false;
function startLoading(){
  if (suppressLoader) return;
  loadingCount++;
  if (loadingCount === 1){
    loaderTimer = setTimeout(()=>{ loader.classList.remove('hidden'); loaderTimer = null; }, 120);
  }
}
function stopLoading(){
  if (suppressLoader) return;
  if (loadingCount === 0) return;
  loadingCount--;
  if (loadingCount === 0){
    if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
    loader.classList.add('hidden');
  }
}

/* ================== API ================== */
async function apiGet(action, params = {}){
  startLoading();
  try{
    const url = new URL(API_BASE);
    url.search = new URLSearchParams({ action, ...params }).toString();
    const r = await fetch(url.toString(), { method: 'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}
async function apiPost(action, body = {}){
  startLoading();
  try{
    const url = API_BASE + '?action=' + encodeURIComponent(action);
    const r = await fetch(url, {
      method:'POST',
      headers: { 'Content-Type':'text/plain;charset=utf-8' },
      body: JSON.stringify(body)
    });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error || 'Error');
    return j.data;
  } finally { stopLoading(); }
}

/* ================== MENSAJE WHATSAPP A GRUPO ================== */
function normalizeNumber57(raw){
  let num = String(raw || '').replace(/\D/g,'');
  if(!num) return '';
  if(num.length === 10 && !num.startsWith('57')) num = '57' + num;
  if(!(num.length === 12 && num.startsWith('57'))) return '';
  return num;
}
// MENSAJE WHATSAPP A GRUPO / CONTACTO
function sendBuilderbotMessage(destino, mensaje){
  // Acepta IDs de grupo (alfanum√©ricos) o tel√©fonos.
  let numberField = String(destino || '').trim();
  if(!numberField) return;

  // Si parece tel√©fono, normaliza a 57 + 10 d√≠gitos
  if(/^\d{10}$/.test(numberField)){
    numberField = '57' + numberField;
  } else if(/^57\d{10}$/.test(numberField)){
    // ya viene con 57, se deja igual
  }
  // Si es alfanum√©rico (ID de grupo), se env√≠a tal cual.

  fetch(BUILDERBOT_ENDPOINT, {
    method:'POST',
    headers:{ 'Content-Type':'application/json', 'x-api-builderbot':BUILDERBOT_API_KEY },
    body: JSON.stringify({
      messages: { content: mensaje },
      number: numberField,
      checkIfExists: false
    })
  }).catch(err => console.warn('Error BuilderBot', err));
}
/* ================== ESTADO ================== */
let currentUser = null;

/* ================== VISTAS ================== */
function resetVistas(){
  // Ocultar formularios de edici√≥n y limpiar datalists y campos seg√∫n vistas
  document.getElementById('contrato-form')?.classList.add('hidden');
  document.getElementById('personales-form')?.classList.add('hidden');

  // Limpiar datalists (evita acumulaci√≥n)
  ['dl-expedida','dl-municipio','dl-expedida2','dl-municipio2'].forEach(id=>{
    const el = document.getElementById(id); if(el) el.innerHTML='';
  });

  // Limpiar previews
  const pf = document.getElementById('p-firma-preview'); if(pf){ pf.src=''; pf.style.display='none'; }
  const rf = document.getElementById('reg-firma-preview'); if(rf){ rf.src=''; rf.style.display='none'; }

  // Campos de contrato
  ['c-fechaInicio','c-diaInicio','c-mesInicio','c-fechaTermino','c-diaTermino','c-mesTermino','c-meses','c-dias','c-ejecucion','c-rp','c-rpAdicion','c-regimen','c-factura','c-costos'].forEach(id=>{
    const el=document.getElementById(id); 
    if(el){ el.value=''; }
  });

  // Campos personales edici√≥n
  ['p-expedida','p-telefono','p-direccion','p-municipio','p-correo','p-tipoCuenta','p-numeroCuenta','p-banco','p-eps','p-pension','p-arl','p-cumple'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.value=''; }
  });

  // Campos registro
  ['reg-expedida','reg-telefono','reg-direccion','reg-municipio','reg-correo','reg-tipoCuenta','reg-numeroCuenta','reg-banco','reg-eps','reg-pension','reg-arl','reg-cumple'].forEach(id=>{
    const el=document.getElementById(id); if(el){ el.value=''; }
  });

  // Limpiar caches locales del feed visual (no borra le√≠do)
  const wrap = document.getElementById('feed-list'); if(wrap) wrap.innerHTML='';
}
function showView(id){
  for(const el of document.querySelectorAll('.view')) el.classList.remove('active');
  document.getElementById(id)?.classList.add('active');
  overlay.classList.remove('open');
  window.scrollTo({ top: 0, behavior: 'smooth' });
  resetVistas();
}

/* ================== INPUT SANITIZERS ================== */
function bindNumericSanitizer(id, maxLen){
  const el = document.getElementById(id);
  if(!el) return;
  el.addEventListener('input', ()=>{
    const raw = (el.value || '').replace(/\D/g,'');
    el.value = maxLen ? raw.slice(0, maxLen) : raw;
  });
}

  // Helper simple: detecta si es m√≥vil (iOS/Android)
function isMobileDevice(){
  const ua = (navigator.userAgent || '').toLowerCase();
  return /android|iphone|ipad|ipod|opera mini|iemobile|mobile/.test(ua);
}

  async function showDataPolicyAlert(){
  const html = `
  <div style="text-align:center;">
    <div style="font-weight:900; font-size:1rem; margin-bottom:10px;">
      POL√çTICA DE TRATAMIENTO DE DATOS PERSONALES<br>
      App Contratista ‚Äì Alcald√≠a de Flandes
    </div>

    <img
      src="${DATA_POLICY_LOGO}"
      alt="Logo"
      style="width:110px; max-width:55vw; height:auto; display:block; margin:0 auto 12px;"
    >

    <div style="
      width:100%;
      max-width:560px;
      margin:0 auto;
      text-align:center;
      font-size:.95rem;
      line-height:1.38;
      padding:0 6px;
      box-sizing:border-box;
    ">
      <b>1. Responsable del Tratamiento</b><br>
      La <b>Alcald√≠a Municipal de Flandes ‚Äì Tolima</b> es responsable del tratamiento de los datos personales recolectados a trav√©s de la aplicaci√≥n <b>App Contratista</b>, usada para la gesti√≥n digital de cuentas de cobro de los contratistas vinculados mediante <b>contratos estatales de prestaci√≥n de servicios</b>.<br><br>

      <b>2. Marco Legal</b><br>
      Esta pol√≠tica se rige por:<br>
      - Art√≠culo 15 de la Constituci√≥n Pol√≠tica.<br>
      - Ley 1581 de 2012 y Decreto 1377 de 2013.<br>
      - Decreto 1074 de 2015.<br>
      - Ley 1712 de 2014 (Transparencia).<br>
      - Ley 80 de 1993 y Ley 1150 de 2007 (Contrataci√≥n estatal).<br>
      - Decreto 1082 de 2015.<br><br>

      <b>3. Finalidad del Tratamiento</b><br>
      Los datos personales se tratan para:<br>
      - Gestionar contratos estatales.<br>
      - Recibir y elaborar documentos digitales de cuentas de cobro.<br>
      - Verificar actividades ejecutadas.<br>
      - Controlar pagos y planillas.<br>
      - Cumplir obligaciones contractuales y legales.<br>
      - Publicaci√≥n posterior en la plataforma <b>SECOP II</b>, en cumplimiento del deber legal de publicidad de la contrataci√≥n p√∫blica.<br><br>

      <b>4. Datos Tratados</b><br>
      Se recolectan:<br>
      - Direcci√≥n, tel√©fono y correo electr√≥nico.<br>
      - Fechas de inicio y terminaci√≥n del contrato.<br>
      - Valores a cobrar.<br>
      - Relaci√≥n de planillas.<br>
      - Actividades ejecutadas.<br>
      - Imagen de la firma manuscrita.<br>
      No se recolectan datos sensibles.<br><br>

      <b>5. Informaci√≥n de Car√°cter P√∫blico</b><br>
      Debido a la naturaleza del <b>contrato estatal de prestaci√≥n de servicios</b>, parte de la informaci√≥n contenida en los documentos generados deber√° ser publicada en el <b>Sistema Electr√≥nico para la Contrataci√≥n P√∫blica ‚Äì SECOP II</b>, plataforma administrada por Colombia Compra Eficiente y accesible al p√∫blico, conforme a la Ley 1712 de 2014 y dem√°s normas aplicables.<br><br>

      <b>6. Derechos del Titular</b><br>
      El contratista puede ejercer los derechos de habeas data: conocer, actualizar, rectificar, revocar la autorizaci√≥n cuando sea procedente.<br><br>

      <b>7. Seguridad de la Informaci√≥n</b><br>
      La Alcald√≠a adopta medidas t√©cnicas y administrativas razonables para proteger los datos durante su tratamiento en la aplicaci√≥n.<br><br>

      <b>8. Conservaci√≥n</b><br>
      La informaci√≥n ser√° conservada conforme a las normas de archivo p√∫blico y los t√©rminos contractuales y fiscales aplicables.<br><br>

      <b>9. Aceptaci√≥n del Titular</b><br>
      Antes de usar la aplicaci√≥n, el contratista deber√° manifestar su voluntad mediante la siguiente declaraci√≥n:<br><br>

      <b>AUTORIZACI√ìN DE TRATAMIENTO DE DATOS PERSONALES</b><br><br>

      Declaro que he le√≠do y comprendido la presente Pol√≠tica de Tratamiento de Datos Personales de la <b>Alcald√≠a de Flandes</b> para la aplicaci√≥n <b>App Contratista</b>, desarrollada para la gesti√≥n de contratos estatales de prestaci√≥n de servicios en la presente adminitraci√≥n, y <b>AUTORIZO de manera previa, expresa e informada</b> el tratamiento de mis datos personales, incluida la generaci√≥n de documentos y su publicaci√≥n en el SECOP II cuando la ley lo exija.
    </div>

    <div style="margin-top:14px;">
      <img
        src="${DATA_POLICY_BANNER}"
        alt="Banner"
        style="width:240px; max-width:70vw; height:auto; display:block; margin:0 auto;"
      >
    </div>
  </div>
`;

  const res = await Swal.fire({
    icon: 'info',
    title: '',
    html,
    showCancelButton: true,
    confirmButtonText: 'ACEPTO',
    cancelButtonText: 'NO ACEPTO',
    allowOutsideClick: false,
    allowEscapeKey: false,
    width: 'min(720px, 94vw)'
  });

  return !!res.isConfirmed;
}

/* ================== LOGIN ================== */
const loginDoc = document.getElementById('login-doc');
document.getElementById('toggle-doc').addEventListener('click', ()=>{
  const oculto = loginDoc.type === 'password';
  loginDoc.type = oculto ? 'text' : 'password';
  const src = oculto
    ? 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Ocultar_lgdxpd.png'
    : 'https://res.cloudinary.com/dqqeavica/image/upload/v1764084782/Mostrar_yymceh.png';
  document.getElementById('toggle-doc-img').src = src;
  document.getElementById('toggle-doc').setAttribute('aria-label', (oculto?'Ocultar':'Mostrar') + ' documento');
});
bindNumericSanitizer('login-doc', 10);

document.getElementById('btn-login').addEventListener('click', async ()=>{
  const documento = (loginDoc.value||'').trim();
  if(documento === ''){
    Swal.fire({ icon:'question', title:'¬øDeseas comenzar?', text:'Ingresa un Documento para validar.', timer:3000 });
    return;
  }
  if(!/^\d{6,10}$/.test(documento)){
    Swal.fire({
      icon:'error',
      title:'CONTRASE√ëA INCORRECTA',
      text:'La contrase√±a contiene entre 6 y 10 digitos num√©ricos.',
      timer:3000,
      showConfirmButton:false
    });
    return;
  }

  try{
    const res = await apiGet('loginContratista', { documento });
    if(!res?.existe){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A√öN',
        text:'Una vez sea ingresada la informaci√≥n de tu contrato podr√°s acceder.',
        timer:6000,
        showConfirmButton:false
      });
      return;
    }
    if(String(res.estado||'').toUpperCase()==='INACTIVO'){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A√öN',
        text:'Una vez sea ingresada la informaci√≥n de tu contrato podr√°s acceder.',
        timer:6000,
        showConfirmButton:false
      });
      return;
    }

            // ACTIVO
    currentUser = { documento: res.documento };
    const nombreCorto = res.nombreCorto || '';
    const tituloBienvenida = nombreCorto ? 'BIENVENIDO(A) ' + nombreCorto : 'BIENVENIDO(A)';

    if(res.incompleto){
  const accepted = await showDataPolicyAlert();
  if(!accepted){
    currentUser = null;
    loginDoc.value = '';
    showView('view-login');
    return;
  }

  await Swal.fire({
    icon:'success',
    title: tituloBienvenida,
    html: 'Esta App ser√° tu gu√≠a en el proceso contractual 2026<br>Valida muy bien todos los datos que ingreses.',
    confirmButtonText:'Completar Registro'
  });
  showView('view-registro');
}else{
      // Antes: flujo original sin alerta de bienvenida
      (async ()=>{
        const boot = await apiGet('bootstrapInicio', { documento: currentUser.documento });
        const d = boot?.inicio || {};
        const list = boot?.noticias || [];

        document.getElementById('inicio-nombre').textContent = d.nombre || '';
        document.getElementById('inicio-sub').textContent = 'CONTRATISTA - ' + (d.secretaria || '');
        document.getElementById('inicio-cc').innerHTML = (d.documento || '') + (d.expedida ? (' <b>DE</b> ' + d.expedida) : '');
        document.getElementById('inicio-contacto').textContent = d.telefono || '';
        document.getElementById('inicio-direccion').textContent = ((d.direccion||'') + ' ' + (d.municipio||'')).trim();
        document.getElementById('inicio-correo').textContent = d.correo || '';
        document.getElementById('inicio-cuenta').textContent = ((d.cuenta||'') + ' ' + (d.tipoCuenta||'') + ' ' + (d.banco||'')).trim();
        document.getElementById('inicio-eps').textContent = d.eps || '';
        document.getElementById('inicio-afp').textContent = d.pension || '';
        document.getElementById('inicio-arl').textContent = d.arl || '';
        document.getElementById('inicio-supervisor').textContent = d.supervisor || '';
        const firmaEl = document.getElementById('inicio-firma');
        if(d.firmaId){
          firmaEl.src = thumbById(d.firmaId);
          firmaEl.style.display='';
        } else {
          firmaEl.style.display='none';
        }

        NOTICIAS_CACHE = Array.isArray(list) ? list : [];
        renderNoticiasList(NOTICIAS_CACHE);
        refreshNoticiasBadge();

        playSoundOnce(SOUNDS.login);
        showView('view-inicio');
      })();
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

// Bot√≥n COMUNICADOS (sin recarga innecesaria)
document.getElementById('go-comunicados')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  showView('view-comunicados'); // usa NOTICIAS_CACHE ya cargado al iniciar sesi√≥n
});

document.getElementById('btn-logout').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.logout);
  currentUser = null;
  loginDoc.value = '';
  showView('view-login');
});

/* ================== MEN√ö ================== */
const overlay = document.getElementById('overlay');
document.getElementById('btn-open-menu').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.menu);
  overlay.classList.add('open');
});
document.getElementById('btn-ovl-back').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});
document.getElementById('ovlClose').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  overlay.classList.remove('open');
});

  // Inicializar comportamiento del men√∫ por categor√≠as
(function initOverlayCategories(){
  const catButtons    = Array.from(document.querySelectorAll('.menu-cat-btn'));
  const catContainers = Array.from(document.querySelectorAll('.menu-cat-options'));

  function hideAllCategories(){
    catContainers.forEach(c =>{
      c.style.display = 'none';
      c.classList.remove('showing');
    });
    catButtons.forEach(b => b.classList.remove('active'));
  }

  function showCategory(catId){
    hideAllCategories();

    const cont = document.getElementById(catId);
    const btn  = catButtons.find(b => b.dataset.cat === catId);

    if(cont){
      cont.style.display = 'flex';
      // Reiniciar animaci√≥n
      // eslint-disable-next-line no-unused-expressions
      cont.offsetHeight;
      cont.classList.add('showing');
    }
    if(btn){
      btn.classList.add('active');
    }
  }

  // Click en categor√≠a (toggle: abrir/cerrar)
  catButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.dataset.cat;
      if(!id) return;

      // Sonido "back" al hacer clic en categor√≠a
      try{
        if(typeof playSoundOnce === 'function' && SOUNDS && SOUNDS.back){
          playSoundOnce(SOUNDS.back);
        }
      }catch(_){}

      const cont = document.getElementById(id);
      const isOpen = cont && cont.style.display === 'flex';

      if(isOpen){
        // Si ya est√° abierta, la cerramos
        hideAllCategories();
      }else{
        // Si est√° cerrada, la mostramos y ocultamos las dem√°s
        showCategory(id);
      }
    });
  });

  // Al cargar: NO abrir ninguna categor√≠a (todas cerradas)
  hideAllCategories();

  // Cuando se abre el overlay con el bot√≥n MEN√ö, mantener todas cerradas
  const openBtn = document.getElementById('btn-open-menu');
  if(openBtn){
    openBtn.addEventListener('click', ()=>{
      hideAllCategories();
    });
  }
})();
  
document.getElementById('go-contrato').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  await cargarContratoLectura();
  showView('view-contrato');
});
document.getElementById('go-personales').addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  await cargarPersonalesLectura();
  showView('view-personales');
});

  // Abrir SOPORTE desde GU√çA DE USO
document.getElementById('go-soporte')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }
  document.getElementById('soporte-text').value = '';
  showView('view-soporte');
});

  // Bot√≥n VOLVER en vista SOPORTE
document.getElementById('soporte-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

  document.getElementById('go-directorio')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({ icon:'warning', title:'Sesi√≥n inv√°lida' });
    return;
  }
  try{
    const list = await apiGet('listDirectorio', {});
    renderDirectorio(Array.isArray(list) ? list : []);
    showView('view-directorio');
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:String(e.message||e) });
  }
});


/* ================== INICIO ================== */
function thumbById(id){ return id ? ('https://drive.google.com/thumbnail?sz=w1000&id='+id) : ''; }
async function cargarInicio(){
  if(!currentUser) return;
  const d = await apiGet('getInicio', { documento: currentUser.documento });
  document.getElementById('inicio-nombre').textContent = d.nombre || '';
  document.getElementById('inicio-sub').textContent = 'CONTRATISTA - ' + (d.secretaria || '');
  document.getElementById('inicio-cc').innerHTML = (d.documento || '') + (d.expedida ? (' <b>DE</b> ' + d.expedida) : '');
  document.getElementById('inicio-contacto').textContent = d.telefono || '';
  document.getElementById('inicio-direccion').textContent = ((d.direccion||'') + ' ' + (d.municipio||'')).trim();
  document.getElementById('inicio-correo').textContent = d.correo || '';
  document.getElementById('inicio-cuenta').textContent = ((d.cuenta||'') + ' ' + (d.tipoCuenta||'') + ' ' + (d.banco||'')).trim();
  document.getElementById('inicio-eps').textContent = d.eps || '';
  document.getElementById('inicio-afp').textContent = d.pension || '';
  document.getElementById('inicio-arl').textContent = d.arl || '';
  document.getElementById('inicio-supervisor').textContent = d.supervisor || '';
  const firmaEl = document.getElementById('inicio-firma');
  if(d.firmaId){ firmaEl.src = thumbById(d.firmaId); firmaEl.style.display=''; } else { firmaEl.style.display='none'; }

  // INSERT: cargar noticias para mostrar badge
  try{ await loadNoticias(); }catch(_){}
}

/* ================== COMUNICADOS (NOTICIAS) ================== */

let NOTICIAS_CACHE = [];
const READ_KEY_PREFIX = 'noticiasRead@v1:';
function readKey(){
  return READ_KEY_PREFIX + (currentUser?.documento || 'anon');
}
function getReadMap(){
  try{ const raw = localStorage.getItem(readKey()); return raw ? JSON.parse(raw) : {}; }catch(_){ return {}; }
}
function setReadMap(map){
  try{ localStorage.setItem(readKey(), JSON.stringify(map||{})); }catch(_){}
}
function isRead(id){ const m = getReadMap(); return !!m[id]; }
function markRead(id){ const m = getReadMap(); m[id] = true; setReadMap(m); }

function thumbByIdNoticias(id){ return id ? ('https://drive.google.com/thumbnail?sz=w1000&id='+id) : 'https://res.cloudinary.com/dqqeavica/image/upload/v1758738139/user_zefosv.png'; }

/* Cargar lista desde backend (20 √∫ltimas) */
async function loadNoticias(){
  const list = await apiGet('listNoticias');
  NOTICIAS_CACHE = Array.isArray(list) ? list : [];
  renderNoticiasList(NOTICIAS_CACHE);
  refreshNoticiasBadge();
}

/* Badge en Inicio: campana + contador + ‚ÄúVer Noticias‚Äù */
function unreadNoticiasCount(items){
  if(!Array.isArray(items) || !items.length) return 0;
  let n=0; for(const it of items){ if(!isRead(it.id)) n++; }
  return n;
}
// Clave de sesi√≥n para controlar el sonido (una vez por sesi√≥n)
const NOTICIAS_SOUND_KEY = 'noticiasNotifyPlayed@session';

function refreshNoticiasBadge(){
  const count = unreadNoticiasCount(NOTICIAS_CACHE);
  const bell  = document.getElementById('notif-bell');
  const label = document.getElementById('notif-label');
  const badge = document.getElementById('notif-count');

  if(badge){
    badge.textContent = String(count);
    badge.classList.toggle('active', count > 0);
  }

  const active = count > 0;
  if(bell)  bell.classList.toggle('active', active);
  if(label) label.classList.toggle('active', active);

  // Sonar "notify" solo una vez por sesi√≥n mientras existan no le√≠das
  try{
    const played = sessionStorage.getItem(NOTICIAS_SOUND_KEY) === '1';
    if(active && !played){
      playSoundOnce(SOUNDS.notify);
      sessionStorage.setItem(NOTICIAS_SOUND_KEY, '1');
    }
    if(!active){
      sessionStorage.removeItem(NOTICIAS_SOUND_KEY);
    }
  }catch(_){}
}
/* Lista de comunicados */
function renderNoticiasList(items){
  const wrap = document.getElementById('com-list');
  if(!wrap) return;
  wrap.innerHTML = '';

  if(!items.length){
    const p = document.createElement('p');
    p.className = 'muted center';
    p.textContent = 'No hay comunicados disponibles.';
    wrap.appendChild(p);
    return;
  }

  for(const it of items){
    const item = document.createElement('div');
    item.className = 'feed-item';
    item.dataset.id = it.id;

    const img = document.createElement('img');
    img.className = 'feed-thumb';
    img.alt = '';
    img.src = thumbByIdNoticias(it.imagenId);

    const ct = document.createElement('div');
    ct.className = 'feed-content';
    const h = document.createElement('h4');
    h.className = 'feed-title';
    h.textContent = it.titulo || '';
    const s = document.createElement('p');
    s.className = 'feed-sub';
    s.textContent = it.subtitulo || '';

    ct.appendChild(h);
    ct.appendChild(s);

    item.appendChild(img);
    item.appendChild(ct);

    if(!isRead(it.id)){
      const dot = document.createElement('span');
      dot.className = 'feed-dot';
      item.appendChild(dot);
    }

    item.addEventListener('click', ()=> openComunicadoDetalle(it));
    wrap.appendChild(item);
  }
}

/* Detalle de comunicado */
function openComunicadoDetalle(it){
  const thumb = document.getElementById('com-det-thumb');
  const title = document.getElementById('com-det-title');
  const sub   = document.getElementById('com-det-sub');
  const desc  = document.getElementById('com-det-desc');
  const link  = document.getElementById('com-det-link');

  if(thumb){ thumb.src = thumbByIdNoticias(it.imagenId); }
  if(title) title.textContent = it.titulo || '';
  if(sub)   sub.textContent   = it.subtitulo || '';
  if(desc)  desc.textContent  = it.contenido || '';

  const first = String(it.first_link||'').trim();
  if(link){
    if(first){ link.href = first; link.style.display=''; }
    else { link.href='#'; link.style.display='none'; }
  }

  markRead(it.id);
  renderNoticiasList(NOTICIAS_CACHE);
  refreshNoticiasBadge();
  showView('view-comunicado-detalle');
}

/* Navegaci√≥n y eventos */
document.getElementById('go-comunicados')?.addEventListener('click', async ()=>{
  overlay.classList.remove('open');
  showView('view-comunicados');
});
document.getElementById('com-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);         
  showView('view-inicio');
});
document.getElementById('com-det-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);          
  showView('view-comunicados');
});

/* Click en etiqueta ‚ÄúVer Noticias‚Äù abre COMUNICADOS */
document.addEventListener('DOMContentLoaded', ()=>{
  const label = document.getElementById('notif-label');
  const btn   = document.getElementById('go-comunicados');
  if(!label || !btn) return;
  const openList = ()=>{
    playSoundOnce(SOUNDS.login);         
    btn.click();
  };
  // Click con mouse
  label.addEventListener('click', openList);
  label.setAttribute('role','button');
  label.setAttribute('tabindex','0');
  label.setAttribute('aria-label','Abrir comunicados');
  label.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); openList(); } });
});

  /* ================== TUTORIALES DE USO ================== */

 /* Mapa de tutoriales (deja los dem√°s listos para completar despu√©s) */
  const TUTORIALES = {
    primera: [
      // TODO: Agregar videos de "DOCUMENTOS PRIMERA CUENTA"
    ],
    personales: [
       {
        title: 'DATOS PERSONALES',
        youtube: 'https://youtu.be/xTnkA9sDBc8',
        thumb: 'https://res.cloudinary.com/dqqeavica/image/upload/v1770909972/DATOS_PERSONALES_i2uni5.png'
      }
    ],
    contrato: [
      {
        title: 'DATOS DEL CONTRATO',
        youtube: 'https://youtu.be/NcRm-BnhIoA',
        thumb: 'https://res.cloudinary.com/dqqeavica/image/upload/v1770840144/DATOS_DEL_CONTRATO_dauxyu.png'
      }
    ],
    borrador: [
      {
        title: 'BORRADOR DE ACTIVIDADES',
        youtube: 'https://youtu.be/4zQvY5Lsiw4',
        thumb: 'https://res.cloudinary.com/dqqeavica/image/upload/v1770840145/BORRADOR_DE_ACTIVIDADES_pfvbz2.png'
      }
    ],
    ingresar: [
      {
        title: 'INGRESAR CUENTA I',
        youtube: 'https://youtu.be/q285Xw8UgGk',
        thumb: 'https://res.cloudinary.com/dqqeavica/image/upload/v1770840145/INGRESAR_CUENTA_I_mlvtlx.png'
      },
      {
        title: 'INGRESAR CUENTA II',
        youtube: 'https://youtu.be/GVYqEccsSv0',
        thumb: 'https://res.cloudinary.com/dqqeavica/image/upload/v1770840145/INGRESAR_CUENTA_II_gag5ps.png'
      }
    ],
    corregir: [
      // TODO: Agregar videos de "CORREGIR CUENTA"
    ],
    reportes: [
      // TODO: Agregar videos de "REPORTES DE CUENTA Y PLAN DE PAGOS"
    ],
    estados: [
      // TODO: Agregar videos de "ESTADOS DE CUENTA"
    ],
    tramites: [
      {
        title: 'TRAMITES Y SOLICITUDES',
        youtube: 'https://youtu.be/zelWAdesZk4',
        thumb: 'https://res.cloudinary.com/dqqeavica/image/upload/v1770915557/TRAMITES_cghbep.png'
      }
    ],
    institucional: [
       {
        title: 'INSTITUCIONAL',
        youtube: 'https://youtu.be/K1plwLTwRbg',
        thumb: 'https://res.cloudinary.com/dqqeavica/image/upload/v1770915976/institucional_thxuan.png'
      }
    ]
  };

  function ytIdFromUrl(u){
    const s = String(u||'').trim();
    let m = s.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/);
    if(m) return m[1];
    m = s.match(/[?&]v=([a-zA-Z0-9_-]{6,})/);
    if(m) return m[1];
    m = s.match(/youtube\.com\/embed\/([a-zA-Z0-9_-]{6,})/);
    if(m) return m[1];
    return '';
  }
  function ytEmbedUrl(u){
    const id = ytIdFromUrl(u);
    if(!id) return '';
    return 'https://www.youtube.com/embed/' + id + '?autoplay=1&playsinline=1&rel=0&modestbranding=1';
  }

  /* Apaga TODOS los videos (para permitir solo 1 en reproducci√≥n) */
  function stopAllTutorialVideos(){
    const iframes = document.querySelectorAll('#view-tutoriales iframe');
    iframes.forEach(fr=>{
      try{ fr.src = 'about:blank'; }catch(_){}
      try{ fr.remove(); }catch(_){}
    });

    /* Restaura miniaturas/capas play si existen */
    const cards = document.querySelectorAll('#view-tutoriales .tut-video-card');
    cards.forEach(card=>{
      const thumb = card.querySelector('.tut-video-thumb');
      const layer = card.querySelector('.tut-play-layer');
      if(thumb) thumb.style.display = 'block';
      if(layer) layer.style.display = 'flex';
      card.dataset.playing = '';
    });
  }

  function buildTutorialVideoCard(v){
    const card = document.createElement('div');
    card.className = 'tut-video-card';

    const img = document.createElement('img');
    img.className = 'tut-video-thumb';
    img.src = v.thumb || '';
    img.alt = '';
    img.loading = 'lazy';

    const layer = document.createElement('div');
    layer.className = 'tut-play-layer';
    layer.textContent = '‚ñ∂';

    function play(){
      const embed = ytEmbedUrl(v.youtube);
      if(!embed) return;

      stopAllTutorialVideos();

      const iframe = document.createElement('iframe');
      iframe.src = embed;
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen';
      iframe.allowFullscreen = true;
      iframe.setAttribute('title', v.title || 'Video');

      card.appendChild(iframe);

      img.style.display = 'none';
      layer.style.display = 'none';
      card.dataset.playing = '1';
    }

    layer.addEventListener('click', ()=>{ try{ playSoundOnce(SOUNDS.back); }catch(_){} play(); });
    img.addEventListener('click',   ()=>{ try{ playSoundOnce(SOUNDS.back); }catch(_){} play(); });

    card.appendChild(img);
    card.appendChild(layer);
    return card;
  }

  /* Renderiza los videos JUSTO debajo del bot√≥n clickeado (en su contenedor hermano) */
  function renderTutorialBox(key){
    const box = document.querySelector(`#view-tutoriales .tut-videos[data-tut-box="${key}"]`);
    if(!box) return;

    const vids = Array.isArray(TUTORIALES[key]) ? TUTORIALES[key] : [];

    const isOpen = box.style.display !== 'none' && box.style.display !== '';
    const hasContent = box.childElementCount > 0;

    /* Si est√° abierto, lo cerramos (toggle) */
    if((box.style.display !== 'none') && (box.style.display !== '')){
      stopAllTutorialVideos();
      box.innerHTML = '';
      box.style.display = 'none';
      return;
    }

    /* Cerrar todos los dem√°s boxes y parar reproducci√≥n */
    document.querySelectorAll('#view-tutoriales .tut-videos').forEach(other=>{
      other.innerHTML = '';
      other.style.display = 'none';
    });
    stopAllTutorialVideos();

    /* Abrir este box */
    box.innerHTML = '';
    if(!vids.length){
      const p = document.createElement('p');
      p.className = 'muted center';
      p.style.margin = '6px 0 0';
      p.textContent = 'Tutorial pr√≥ximamente.';
      box.appendChild(p);
      box.style.display = 'block';
      return;
    }

    vids.forEach(v=>{
      box.appendChild(buildTutorialVideoCard(v));
    });
    box.style.display = 'block';

    /* Scroll suave para que quede a la vista (debajo del bot√≥n) */
    try{ box.scrollIntoView({ behavior:'smooth', block:'start' }); }catch(_){}
  }

  /* Bot√≥n del men√∫: abre vista tutoriales */
  document.getElementById('go-tutoriales')?.addEventListener('click', ()=>{
    try{ playSoundOnce(SOUNDS.login); }catch(_){}
    overlay.classList.remove('open');
    stopAllTutorialVideos();
    document.querySelectorAll('#view-tutoriales .tut-videos').forEach(b=>{
      b.innerHTML = '';
      b.style.display = 'none';
    });
    showView('view-tutoriales');
  });

  /* Click en cada bot√≥n de tutorial */
  (function bindTutorialButtons(){
    const btns = document.querySelectorAll('#view-tutoriales .tut-btn');
    btns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        try{ playSoundOnce(SOUNDS.back); }catch(_){}
        const key = btn.getAttribute('data-tut');
        if(!key) return;
        renderTutorialBox(key);
      });
    });
  })();

  /* Regresar */
  document.getElementById('tutoriales-volver')?.addEventListener('click', ()=>{
    try{ playSoundOnce(SOUNDS.back); }catch(_){}
    stopAllTutorialVideos();
    showView('view-inicio');
  });

  /* Si cambias de pesta√±a, pausa (el iframe se corta) */
  document.addEventListener('visibilitychange', ()=>{
    if(document.hidden){
      stopAllTutorialVideos();
    }
  });

  /* ================== CALENDARIO INSTITUCIONAL (CONTRATISTA) ================== */

const CAL_API_ACTION_LIST = 'listEventosCalendario';
const CAL_API_ACTION_GET  = 'getEventoCalendario';

let CAL_EVENTS = [];
let CAL_CURRENT_VIEW = 'month';
let CAL_CURRENT_DATE = new Date();
let CAL_SELECTED_EVENT = null;

const CAL_MONTHS_SHORT = ['ENE','FEB','MAR','ABR','MAY','JUN','JUL','AGO','SEP','OCT','NOV','DIC'];
const CAL_WEEKDAYS_SHORT = ['DOM','LUN','MAR','MI√â','JUE','VIE','S√ÅB'];

function calPad2(n){
  return String(n).padStart(2,'0');
}
function calFormatDMY(d){
  if(!d) return '';
  const dd = calPad2(d.getDate());
  const mm = calPad2(d.getMonth()+1);
  const yy = d.getFullYear();
  return dd + '/' + mm + '/' + yy;
}
function calParseDMY(str){
  if(!str) return null;
  const p = String(str).split('/');
  if(p.length !== 3) return null;
  const d = parseInt(p[0],10);
  const m = parseInt(p[1],10);
  const y = parseInt(p[2],10);
  if(!d || !m || !y) return null;
  const dt = new Date(y,m-1,d);
  if(isNaN(dt.getTime())) return null;
  return dt;
}
function calMinutesFromTimeStr(str){
  if(!str) return 0;
  const p = String(str).split(' ');
  const hm = (p[0]||'').split(':');
  let h = parseInt(hm[0]||'0',10);
  const m = parseInt(hm[1]||'0',10);
  const ampm = (p[1]||'AM').toUpperCase();
  if(ampm === 'PM' && h < 12) h += 12;
  if(ampm === 'AM' && h === 12) h = 0;
  if(isNaN(h) || isNaN(m)) return 0;
  return h*60 + m;
}
function calStatusColorClass(estado, secretaria){
  const v = String(secretaria||'').trim().toUpperCase();
  if(v === 'DESPACHO MUNICIPAL') return 'cal-event-chip sec-despacho';
  if(v === 'SECRETAR√çA DE GOBIERNO Y SERVICIOS ADMINISTRATIVOS') return 'cal-event-chip sec-gobierno';
  if(v === 'SECRETAR√çA DE HACIENDA') return 'cal-event-chip sec-hacienda';
  if(v === 'SECRETAR√çA DE EDUCACI√ìN, DESARROLLO ECON√ìMICO Y SOCIAL') return 'cal-event-chip sec-educacion';
  if(v === 'SECRETAR√çA DE PLANEACI√ìN E INFRAESTRUCTURA') return 'cal-event-chip sec-planeacion';
  if(v === 'SECRETAR√çA DE ASUNTOS AGROPECUARIOS') return 'cal-event-chip sec-agro';
  if(v === 'SECRETAR√çA DE SALUD') return 'cal-event-chip sec-salud';
  return 'cal-event-chip sec-default';
}
function calEventMatchesFilter(ev, query){
  if(!query) return true;
  const q = query.toLowerCase();
  return [
    ev.nombreEvento,
    ev.secretaria,
    ev.nombre,
    ev.lugar,
    ev.detalles
  ].some(v => String(v||'').toLowerCase().includes(q));
}
function calUpdateTitle(){
  const titleEl = document.getElementById('cal-title-text');
  if(!titleEl) return;
  if(CAL_CURRENT_VIEW === 'year'){
    titleEl.textContent = CAL_CURRENT_DATE.getFullYear();
    return;
  }
  if(CAL_CURRENT_VIEW === 'week'){
    const start = calStartOfWeek(CAL_CURRENT_DATE);
    const end = calEndOfWeek(CAL_CURRENT_DATE);
    const label = CAL_MONTHS_SHORT[start.getMonth()] + ' ' + start.getDate() +
      ' ‚Äì ' + CAL_MONTHS_SHORT[end.getMonth()] + ' ' + end.getDate() +
      ' ' + end.getFullYear();
    titleEl.textContent = label;
    return;
  }
  if(CAL_CURRENT_VIEW === 'day'){
    const d = CAL_CURRENT_DATE;
    const label = d.getDate() + ' ' + CAL_MONTHS_SHORT[d.getMonth()] + ' ' + d.getFullYear();
    titleEl.textContent = label;
    return;
  }
  const d = CAL_CURRENT_DATE;
  titleEl.textContent = d.toLocaleDateString('es-CO', { month:'long', year:'numeric' }).toUpperCase();
}
function calStartOfWeek(d){
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const day = dt.getDay();
  const diff = (day + 7 - 0) % 7;
  dt.setDate(dt.getDate() - diff);
  return dt;
}
function calEndOfWeek(d){
  const start = calStartOfWeek(d);
  const end = new Date(start.getFullYear(), start.getMonth(), start.getDate() + 6);
  return end;
}
function calEventsOnDay(isoDMY){
  return CAL_EVENTS.filter(ev => ev.fechaEvento === isoDMY);
}
function calRender(){
  const cont = document.getElementById('cal-container');
  if(!cont) return;
  const filterVal = document.getElementById('cal-filter-input')?.value.trim().toLowerCase() || '';
  cont.innerHTML = '';
  calUpdateTitle();

  if(CAL_CURRENT_VIEW === 'month'){
    calRenderMonth(cont, filterVal);
  }else if(CAL_CURRENT_VIEW === 'week'){
    calRenderWeek(cont, filterVal);
  }else if(CAL_CURRENT_VIEW === 'day'){
    calRenderDay(cont, filterVal);
  }else if(CAL_CURRENT_VIEW === 'year'){
    calRenderYear(cont, filterVal);
  }
}
function calRenderMonth(cont, filterVal){
  const header = document.createElement('div');
  header.className = 'cal-weekdays';
  CAL_WEEKDAYS_SHORT.forEach(d => {
    const el = document.createElement('div');
    el.className = 'cal-weekday';
    el.textContent = d;
    header.appendChild(el);
  });
  cont.appendChild(header);

  const grid = document.createElement('div');
  grid.className = 'cal-month-grid';

  const year = CAL_CURRENT_DATE.getFullYear();
  const month = CAL_CURRENT_DATE.getMonth();
  const firstDay = new Date(year,month,1);
  const startWeekDay = firstDay.getDay();
  const daysInMonth = new Date(year,month+1,0).getDate();

  const prevMonthDays = (startWeekDay + 7 - 0) % 7;
  const totalCells = prevMonthDays + daysInMonth;
  const cells = totalCells <= 35 ? 35 : 42;

  const todayDMY = calFormatDMY(new Date());

  for(let i=0; i<cells; i++){
    const cell = document.createElement('div');
    cell.className = 'cal-day-cell';
    const dayOffset = i - prevMonthDays + 1;
    let cellDate;
    let inThisMonth = true;

    if(dayOffset < 1){
      cellDate = new Date(year, month, dayOffset);
      inThisMonth = false;
    }else if(dayOffset > daysInMonth){
      cellDate = new Date(year, month, dayOffset);
      inThisMonth = false;
    }else{
      cellDate = new Date(year, month, dayOffset);
    }

    const iso = calFormatDMY(cellDate);
    if(!inThisMonth) cell.classList.add('other-month');

    const headerNum = document.createElement('div');
    headerNum.className = 'cal-day-number';

    if(iso === todayDMY){
      headerNum.classList.add('today');
      headerNum.textContent = cellDate.getDate();
    }else{
      headerNum.textContent = cellDate.getDate();
    }

    cell.appendChild(headerNum);

    const events = calEventsOnDay(iso).filter(ev => calEventMatchesFilter(ev, filterVal));
    events.sort((a,b)=> calMinutesFromTimeStr(a.horaInicio||'') - calMinutesFromTimeStr(b.horaInicio||''));

        events.forEach(ev => {
      const chip = document.createElement('div');
      chip.className = calStatusColorClass(ev.estado, ev.secretaria);

      const title = document.createElement('span');
      title.className = 'cal-evt-title';
      // Mostrar el nombre del evento en lugar de la secretar√≠a
      title.textContent = ev.nombreEvento || '';

      const time = document.createElement('span');
      time.className = 'cal-evt-time';
      time.textContent = (ev.horaInicio || '') + ' - ' + (ev.horaTerminacion || '');

      chip.appendChild(title);
      chip.appendChild(time);

      chip.addEventListener('click', () => calOpenEventForView(ev.codigo));
      cell.appendChild(chip);
    });

    grid.appendChild(cell);
  }
  cont.appendChild(grid);
}
function calRenderDay(cont, filterVal){
  const header = document.createElement('div');
  header.className = 'cal-day-header-row';
  const d = CAL_CURRENT_DATE;
  header.textContent = d.toLocaleDateString('es-CO',{ weekday:'long', day:'numeric', month:'long', year:'numeric' }).toUpperCase();
  cont.appendChild(header);

  const body = document.createElement('div');
  body.className = 'cal-day-body';

  const iso = calFormatDMY(d);
  const events = calEventsOnDay(iso).filter(ev => calEventMatchesFilter(ev, filterVal));
  events.sort((a,b)=> calMinutesFromTimeStr(a.horaInicio||'') - calMinutesFromTimeStr(b.horaInicio||''));

  if(!events.length){
    const p = document.createElement('p');
    p.className = 'muted';
    p.textContent = 'Sin eventos para este d√≠a.';
    body.appendChild(p);
  }else{
    events.forEach(ev => {
            const chip = document.createElement('div');
      chip.className = calStatusColorClass(ev.estado, ev.secretaria);

      const title = document.createElement('span');
      title.className = 'cal-evt-title';
      // En vista d√≠a tambi√©n usamos nombreEvento como t√≠tulo
      title.textContent = ev.nombreEvento || '';

      const time = document.createElement('span');
      time.className = 'cal-evt-time';
      time.textContent = (ev.horaInicio || '') + ' - ' + (ev.horaTerminacion || '');

      const desc = document.createElement('div');
      desc.style.fontSize = '.72rem';
      // Aqu√≠ puedes dejar un detalle adicional, por ejemplo la secretar√≠a
      desc.textContent = ev.secretaria || '';

      chip.appendChild(title);
      chip.appendChild(time);
      chip.appendChild(desc);

      chip.addEventListener('click', ()=> calOpenEventForView(ev.codigo));
      body.appendChild(chip);
    });
  }

  cont.appendChild(body);
}
function calRenderWeek(cont, filterVal){
  const start = calStartOfWeek(CAL_CURRENT_DATE);
  const end = calEndOfWeek(CAL_CURRENT_DATE);

  const header = document.createElement('div');
  header.className = 'cal-week-header-row';
  header.textContent = 'Semana del ' +
    start.getDate() + ' ' + CAL_MONTHS_SHORT[start.getMonth()] +
    ' al ' +
    end.getDate() + ' ' + CAL_MONTHS_SHORT[end.getMonth()] +
    ' ' + end.getFullYear();
  cont.appendChild(header);

  const body = document.createElement('div');
  body.className = 'cal-week-body';

  for(let i=0;i<7;i++){
    const d = new Date(start.getFullYear(), start.getMonth(), start.getDate() + i);
    const iso = calFormatDMY(d);

    const row = document.createElement('div');
    row.style.borderRadius = '10px';
    row.style.padding = '6px 8px';
    row.style.background = '#f9fafb';
    row.style.marginBottom = '6px';

    const head = document.createElement('div');
    head.style.display = 'flex';
    head.style.alignItems = 'center';
    head.style.justifyContent = 'space-between';

    const left = document.createElement('span');
    left.style.fontWeight = '700';
    left.style.fontSize = '.8rem';
    left.textContent = CAL_WEEKDAYS_SHORT[d.getDay()] + ' ' + d.getDate() + ' ' + CAL_MONTHS_SHORT[d.getMonth()];

    head.appendChild(left);
    row.appendChild(head);

    const evs = calEventsOnDay(iso).filter(ev => calEventMatchesFilter(ev, filterVal));
    evs.sort((a,b)=> calMinutesFromTimeStr(a.horaInicio||'') - calMinutesFromTimeStr(b.horaInicio||''));

    if(!evs.length){
      const p = document.createElement('p');
      p.className = 'muted';
      p.style.fontSize = '.72rem';
      p.textContent = 'Sin eventos';
      row.appendChild(p);
    }else{
      evs.forEach(ev => {
                const chip = document.createElement('div');
        chip.className = calStatusColorClass(ev.estado, ev.secretaria);

        const title = document.createElement('span');
        title.className = 'cal-evt-title';
        // En vista semana usamos nombreEvento como t√≠tulo
        title.textContent = ev.nombreEvento || '';

        const time = document.createElement('span');
        time.className = 'cal-evt-time';
        time.textContent = (ev.horaInicio || '') + ' - ' + (ev.horaTerminacion || '');

        chip.appendChild(title);
        chip.appendChild(time);
        chip.addEventListener('click', ()=> calOpenEventForView(ev.codigo));
        row.appendChild(chip);
      });
    }

    body.appendChild(row);
  }

  cont.appendChild(body);
}
function calRenderYear(cont, filterVal){
  const grid = document.createElement('div');
  grid.className = 'cal-year-grid';

  const year = CAL_CURRENT_DATE.getFullYear();
  const eventsByMonth = {};
  CAL_EVENTS.forEach(ev => {
    const d = calParseDMY(ev.fechaEvento);
    if(!d || d.getFullYear() !== year) return;
    const m = d.getMonth();
    if(!eventsByMonth[m]) eventsByMonth[m] = [];
    if(calEventMatchesFilter(ev, filterVal)){
      eventsByMonth[m].push(ev);
    }
  });

  for(let m=0;m<12;m++){
    const box = document.createElement('div');
    box.className = 'cal-year-month';

    const h4 = document.createElement('h4');
    h4.textContent = new Date(year,m,1).toLocaleDateString('es-CO',{ month:'long' }).toUpperCase();
    box.appendChild(h4);

    const table = document.createElement('table');
    const thead = document.createElement('thead');
    const trh = document.createElement('tr');
    CAL_WEEKDAYS_SHORT.forEach(d => {
      const th = document.createElement('th');
      th.textContent = d.charAt(0);
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    const first = new Date(year,m,1);
    const startDay = first.getDay();
    const daysInMonth = new Date(year,m+1,0).getDate();

    let day = 1;
    let done = false;
    while(!done){
      const tr = document.createElement('tr');
      for(let wd=0; wd<7; wd++){
        const td = document.createElement('td');
        if(wd < startDay && day === 1){
          td.textContent = '';
        }else if(day > daysInMonth){
          td.textContent = '';
          done = true;
        }else{
          td.textContent = day;
          const dmy = calFormatDMY(new Date(year,m,day));
          const hasEvent = (eventsByMonth[m]||[]).some(ev => ev.fechaEvento === dmy);
          if(hasEvent){
            const dot = document.createElement('span');
            dot.className = 'cal-year-dot';
            td.appendChild(dot);
          }
          day++;
        }
        tr.appendChild(td);
      }
      tbody.appendChild(tr);
    }

    table.appendChild(tbody);
    box.appendChild(table);
    grid.appendChild(box);
  }

  cont.appendChild(grid);
}
function calNormalizeEvent(ev){
  const out = Object.assign({}, ev||{});
  out.codigo = String(out.codigo||'');
  out.fechaEvento = String(out.fechaEvento||'');
  out.nombreEvento = String(out.nombreEvento||'');
  out.secretaria = String(out.secretaria||'');
  out.estado = String(out.estado||'').toUpperCase() || 'PROGRAMADO';
  out.horaInicio = String(out.horaInicio||'');
  out.horaTerminacion = String(out.horaTerminacion||'');
  out.detalles = String(out.detalles||'');
  out.lugar = String(out.lugar||'');
  out.nombre = String(out.nombre||'');
  out.contacto = String(out.contacto||'');
  out.cargo = String(out.cargo||'');
  return out;
}
async function calLoadEvents(){
  try{
    const list = await apiGet(CAL_API_ACTION_LIST, {});
    CAL_EVENTS = Array.isArray(list) ? list.map(ev => calNormalizeEvent(ev)) : [];
  }catch(e){
    CAL_EVENTS = [];
    Swal.fire({icon:'error',title:'Error cargando calendario',text:String(e.message||e)});
  }
}
async function calOpenEventForView(codigo){
  try{
    const data = await apiGet(CAL_API_ACTION_GET, { codigo });
    if(!data){
      Swal.fire({icon:'info',title:'Evento no encontrado'});
      return;
    }
    const ev = calNormalizeEvent(data);
    CAL_SELECTED_EVENT = ev;
    const body = document.getElementById('evento-detalle-body');
   const rawFecha = ev.fechaEvento || '';
let fechaDet = 'No Ingresado';
if (rawFecha) {
  // Si ya viene en dd/mm/aaaa la dejamos igual
  if (/^\d{2}\/\d{2}\/\d{4}$/.test(rawFecha.trim())) {
    fechaDet = rawFecha.trim();
  } else {
    // Intenta parsear otros formatos de fecha (como Date.toString())
    const d = new Date(rawFecha);
    if (!isNaN(d.getTime())) {
      const dd = String(d.getDate()).padStart(2,'0');
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const yy = d.getFullYear();
      fechaDet = dd + '/' + mm + '/' + yy;
    }
  }
}

const lines = [
  '<p><b>Nombre del Evento:</b> ' + (ev.nombreEvento || 'No Ingresado') + '</p>',
  '<p><b>Fecha:</b> ' + fechaDet + '</p>',
  '<p><b>Inicia:</b> ' + (ev.horaInicio || 'No Ingresado') + '</p>',
  '<p><b>Finaliza:</b> ' + (ev.horaTerminacion || 'No Ingresado') + '</p>',
  '<p><b>Lugar:</b> ' + (ev.lugar || 'No Ingresado') + '</p>',
  '<p><b>Responsable:</b> ' + (ev.nombre || 'No Ingresado') + '</p>',
  '<p><b>Secretar√≠a:</b> ' + (ev.secretaria || 'No Ingresado') + '</p>',
  '<p><b>Cargo:</b> ' + (ev.cargo || 'No Ingresado') + '</p>'
];
    body.innerHTML = lines.join('');
    showView('view-evento-detalle');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:String(e.message||e)});
  }
}

/* Navegaci√≥n Calendario */
document.getElementById('go-calendario')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  await calLoadEvents();
  CAL_CURRENT_VIEW = 'month';
  CAL_CURRENT_DATE = new Date();
  calSyncViewButtons();
  showView('view-calendario');
  calRender();
});
document.getElementById('cal-btn-back')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});
document.getElementById('evento-detalle-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-calendario');
});
function calSyncViewButtons(){
  ['cal-view-day','cal-view-week','cal-view-month','cal-view-year'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    el.classList.remove('active');
  });
  if(CAL_CURRENT_VIEW === 'day') document.getElementById('cal-view-day')?.classList.add('active');
  if(CAL_CURRENT_VIEW === 'week') document.getElementById('cal-view-week')?.classList.add('active');
  if(CAL_CURRENT_VIEW === 'month') document.getElementById('cal-view-month')?.classList.add('active');
  if(CAL_CURRENT_VIEW === 'year') document.getElementById('cal-view-year')?.classList.add('active');
}
document.getElementById('cal-btn-today')?.addEventListener('click', ()=>{
  CAL_CURRENT_DATE = new Date();
  calRender();
});
document.getElementById('cal-prev')?.addEventListener('click', ()=>{
  if(CAL_CURRENT_VIEW === 'year'){
    CAL_CURRENT_DATE.setFullYear(CAL_CURRENT_DATE.getFullYear()-1);
  }else if(CAL_CURRENT_VIEW === 'month'){
    CAL_CURRENT_DATE.setMonth(CAL_CURRENT_DATE.getMonth()-1);
  }else if(CAL_CURRENT_VIEW === 'week'){
    CAL_CURRENT_DATE.setDate(CAL_CURRENT_DATE.getDate()-7);
  }else if(CAL_CURRENT_VIEW === 'day'){
    CAL_CURRENT_DATE.setDate(CAL_CURRENT_DATE.getDate()-1);
  }
  calRender();
});
document.getElementById('cal-next')?.addEventListener('click', ()=>{
  if(CAL_CURRENT_VIEW === 'year'){
    CAL_CURRENT_DATE.setFullYear(CAL_CURRENT_DATE.getFullYear()+1);
  }else if(CAL_CURRENT_VIEW === 'month'){
    CAL_CURRENT_DATE.setMonth(CAL_CURRENT_DATE.getMonth()+1);
  }else if(CAL_CURRENT_VIEW === 'week'){
    CAL_CURRENT_DATE.setDate(CAL_CURRENT_DATE.getDate()+7);
  }else if(CAL_CURRENT_VIEW === 'day'){
    CAL_CURRENT_DATE.setDate(CAL_CURRENT_DATE.getDate()+1);
  }
  calRender();
});
document.getElementById('cal-view-day')?.addEventListener('click', ()=>{
  CAL_CURRENT_VIEW = 'day';
  calSyncViewButtons();
  calRender();
});
document.getElementById('cal-view-week')?.addEventListener('click', ()=>{
  CAL_CURRENT_VIEW = 'week';
  calSyncViewButtons();
  calRender();
});
document.getElementById('cal-view-month')?.addEventListener('click', ()=>{
  CAL_CURRENT_VIEW = 'month';
  calSyncViewButtons();
  calRender();
});
document.getElementById('cal-view-year')?.addEventListener('click', ()=>{
  CAL_CURRENT_VIEW = 'year';
  calSyncViewButtons();
  calRender();
});
document.getElementById('cal-filter-toggle')?.addEventListener('click', ()=>{
  const input = document.getElementById('cal-filter-input');
  if(!input) return;
  const visible = input.style.display !== 'none';
  if(visible){
    input.style.display = 'none';
    input.value = '';
    calRender();
  }else{
    input.style.display = '';
    input.focus();
  }
});
document.getElementById('cal-filter-input')?.addEventListener('input', ()=>{
  calRender();
});

  /* ================== SOLICITUD PRENSA (CONTRATISTA) ================== */

function spPad2(n){ return String(n).padStart(2,'0'); }

function spInitSimplePicker(dSelId,mSelId,aSelId){
  const dSel = document.getElementById(dSelId);
  const mSel = document.getElementById(mSelId);
  const aSel = document.getElementById(aSelId);

  // D√≠as 01..31
  if(dSel && !dSel.childElementCount){
    for(let d=1; d<=31; d++){
      const opt = document.createElement('option');
      opt.value = spPad2(d);
      opt.textContent = opt.value;
      dSel.appendChild(opt);
    }
  }

  // Meses con nombre
  if(mSel && !mSel.childElementCount){
    const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){
      const opt = document.createElement('option');
      opt.value = spPad2(i+1);
      opt.textContent = mesesNombres[i];
      mSel.appendChild(opt);
    }
  }

  // A√±o fijo 2026 (una sola opci√≥n seleccionada)
  if(aSel && !aSel.childElementCount){
    const opt = document.createElement('option');
    opt.value = '2026';
    opt.textContent = '2026';
    opt.selected = true;
    aSel.appendChild(opt);
  }
}

// Inicializar pickers de solicitud prensa
spInitSimplePicker('spEvtDia','spEvtMes','spEvtAnio');
spInitSimplePicker('spPubDia','spPubMes','spPubAnio');

document.getElementById('sp-fechaEvento')?.addEventListener('click', ()=>{
  const m = document.getElementById('spEventoFechaModal');
  if(m){
    m.style.display = 'flex';
    m.setAttribute('aria-hidden','false');
  }
});
document.getElementById('spEvtFechaCancelar')?.addEventListener('click', ()=>{
  const m = document.getElementById('spEventoFechaModal');
  if(m){
    m.style.display = 'none';
    m.setAttribute('aria-hidden','true');
  }
});
document.getElementById('spEvtFechaOk')?.addEventListener('click', ()=>{
  const d = document.getElementById('spEvtDia')?.value || '01';
  const m = document.getElementById('spEvtMes')?.value || '01';
  const y = document.getElementById('spEvtAnio')?.value || String(new Date().getFullYear());
  document.getElementById('sp-fechaEvento').value = d + '/' + m + '/' + y;
  const modal = document.getElementById('spEventoFechaModal');
  if(modal){
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }
});

document.getElementById('sp-publicacion')?.addEventListener('click', ()=>{
  const m = document.getElementById('spPublicacionFechaModal');
  if(m){
    m.style.display = 'flex';
    m.setAttribute('aria-hidden','false');
  }
});
document.getElementById('spPubFechaCancelar')?.addEventListener('click', ()=>{
  const m = document.getElementById('spPublicacionFechaModal');
  if(m){
    m.style.display = 'none';
    m.setAttribute('aria-hidden','true');
  }
});
document.getElementById('spPubFechaOk')?.addEventListener('click', ()=>{
  const d = document.getElementById('spPubDia')?.value || '01';
  const m = document.getElementById('spPubMes')?.value || '01';
  const y = document.getElementById('spPubAnio')?.value || String(new Date().getFullYear());
  document.getElementById('sp-publicacion').value = d + '/' + m + '/' + y;
  const modal = document.getElementById('spPublicacionFechaModal');
  if(modal){
    modal.style.display = 'none';
    modal.setAttribute('aria-hidden','true');
  }
});

document.getElementById('sp-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

// Abrir SOLICITUD PRENSA desde men√∫
document.getElementById('go-solicitud-prensa')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }
  try{
    const d = await apiGet('getDatosPersonales', { documento: currentUser.documento });
    // d.cumple ya se usa; aqu√≠ necesitamos estado ACTIVO desde hoja CONTRATISTAS.
    // Usamos getInicio para validar estado CC?
    const s = SS; // solo referencia l√≥gica, en front no se usa (comentario explicativo)
  }catch(_){}
  try{
    // Reutilizamos getDatosPersonales + getEstadoCuenta no exponen CC, as√≠ que pedimos al backend una acci√≥n espec√≠fica.
    const info = await apiGet('getSolicitudPrensaBase', { documento: currentUser.documento });
    if(!info || !info.found){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A ESTA OPCI√ìN',
        text:'Tu informaci√≥n de contrato a√∫n no est√° completa.',
        timer:4000,
        showConfirmButton:false
      });
      return;
    }
    if(String(info.estado||'').toUpperCase() !== 'ACTIVO'){
      await Swal.fire({
        icon:'info',
        title:'CONTRATO INACTIVO',
        text:'Solo los contratistas ACTIVO pueden usar esta opci√≥n.',
        timer:4000,
        showConfirmButton:false
      });
      return;
    }
    document.getElementById('sp-nombre').value = info.nombre || '';
    document.getElementById('sp-secretaria').value = info.secretaria || '';
    document.getElementById('sp-contacto').value = info.contacto || '';

    // Limpiar campos visibles
    document.getElementById('sp-nombreEvento').value = '';
    document.getElementById('sp-fechaEvento').value = '';
    document.getElementById('sp-horaInicio').value = '';
    document.getElementById('sp-horaTerminacion').value = '';
    document.getElementById('sp-otros').value = '';
    document.getElementById('sp-lugar').value = '';
    document.getElementById('sp-detalles').value = '';
    document.getElementById('sp-publicacion').value = '';
    document.getElementById('sp-cargo').value = '';
    document.querySelectorAll('#sp-requerimientos input[type="checkbox"]').forEach(ch => ch.checked = false);

    showView('view-solicitud-prensa');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});

// Guardar solicitud prensa
document.getElementById('sp-enviar')?.addEventListener('click', async ()=>{
  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }
  const nombreEvento = document.getElementById('sp-nombreEvento').value.trim();
  const fechaEvento  = document.getElementById('sp-fechaEvento').value.trim();
  const horaInicio   = document.getElementById('sp-horaInicio').value.trim();
  const horaTerminacion = document.getElementById('sp-horaTerminacion').value.trim();
  const otros        = document.getElementById('sp-otros').value.trim();
  const lugar        = document.getElementById('sp-lugar').value.trim();
  const detalles     = document.getElementById('sp-detalles').value.trim();
  const publicacion  = document.getElementById('sp-publicacion').value.trim();
  const cargo        = document.getElementById('sp-cargo').value.trim();
  const nombre       = document.getElementById('sp-nombre').value.trim();
  const secretaria   = document.getElementById('sp-secretaria').value.trim();
  const contacto     = document.getElementById('sp-contacto').value.trim();

  const checks = document.querySelectorAll('#sp-requerimientos input[type="checkbox"]');
  const reqs = [];
  checks.forEach(ch => { if(ch.checked) reqs.push(ch.value); });
  const requerimientosStr = reqs.join(', ');

  // Validaciones requeridos
  if(!requerimientosStr){
    Swal.fire({icon:'warning', title:'Selecciona al menos un requerimiento'});
    return;
  }
  if(!detalles){
    Swal.fire({icon:'warning', title:'Debes diligenciar los Detalles'});
    return;
  }
  if(!publicacion){
    Swal.fire({icon:'warning', title:'Debes seleccionar la Fecha de Entrega o Publicaci√≥n'});
    return;
  }
  if(!cargo){
    Swal.fire({icon:'warning', title:'Debes diligenciar tu Cargo en la Secretar√≠a'});
    return;
  }

  // Convertir horas HH:MM a AM/PM si vienen
  function hhmmToAmPm(str){
    if(!str) return '';
    const p = str.split(':');
    let h = parseInt(p[0]||'0',10);
    const m = parseInt(p[1]||'0',10);
    if(isNaN(h) || isNaN(m)) return '';
    let suf = 'AM';
    let hh = h;
    if(h >= 12){
      suf = 'PM';
      if(h > 12) hh = h - 12;
    }
    if(h === 0){
      hh = 12;
      suf = 'AM';
    }
    const hStr = ('0'+hh).slice(-2);
    const mStr = ('0'+m).slice(-2);
    return hStr + ':' + mStr + ' ' + suf;
  }

  const horaInicioAmPm = hhmmToAmPm(horaInicio);
  const horaTermAmPm   = hhmmToAmPm(horaTerminacion);

  // Formatear requerimientos como lista con " - "
  let requerimientosLista = '';
  if(reqs.length){
    requerimientosLista = reqs.map(x => '- ' + x).join('\n');
  }

  // Resumen con "No Ingresado" para opcionales vac√≠os
  function valOrNI(v){ return v ? v : 'No Ingresado'; }
  const resumenHtml = [
    '<b>Nombre del Evento:</b> ' + valOrNI(nombreEvento),
    '<b>Fecha del Evento:</b> ' + valOrNI(fechaEvento),
    '<b>Hora de Inicio:</b> ' + valOrNI(horaInicioAmPm),
    '<b>Hora de Terminaci√≥n:</b> ' + valOrNI(horaTermAmPm),
    '<b>Requerimientos:</b> ' + (requerimientosStr || 'No Ingresado'),
    '<b>Otros:</b> ' + valOrNI(otros),
    '<b>Lugar del Evento:</b> ' + valOrNI(lugar),
    '<b>Detalles:</b> ' + detalles,
    '<b>Fecha de Entrega o Publicaci√≥n:</b> ' + publicacion,
    '<b>Cargo:</b> ' + cargo
  ].join('<br>');

  const rs = await Swal.fire({
    icon:'info',
    title:'Resumen de Solicitud',
    html:resumenHtml,
    showCancelButton:true,
    confirmButtonText:'Confirmar',
    cancelButtonText:'Editar',
    soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  const body = {
    nombreEvento,
    fechaEvento,
    horaInicio: horaInicioAmPm,
    horaTerminacion: horaTermAmPm,
    detalles,
    requerimientos: requerimientosStr,
    otros,
    lugar,
    publicacion,
    nombre,
    contacto,
    secretaria,
    cargo
  };

  try{
    const r = await apiPost('guardarSolicitudPrensaBrief', body);
    if(!r || !r.success){
      Swal.fire({icon:'error', title:'Error al guardar', text:r && r.message ? r.message : 'Intenta nuevamente.'});
      return;
    }

    // Enviar mensaje WhatsApp a contacto
    const tel = normalizeNumber57(contacto);
    if(tel){
      const msg =
        'Estimado(a) *' + (nombre || '') + '*\n\n' +
        'Hemos recibido tu solicitud, la revisaremos en el menor tiempo posible y nos pondremos en contacto contigo para concretar detalles.\n' +
        'Agradecemos la comprensi√≥n en nuestros tiempos de respuesta seg√∫n demanda o solicitudes.\n\n' +
        'Muchas gracias por ser parte de este gran Equipo.\n\n' +
        'Cordialmente;\n\n' +
        '*Equipo de Comunicaciones*\n' +
        '> Alcald√≠a de Flandes';
      sendBuilderbotMessage(tel, msg);
    }

    Swal.fire({icon:'success', title:'Solicitud enviada', timer:2500, showConfirmButton:false});
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});
  
   /* ================== ESTADO DE CUENTA ================== */
document.getElementById('go-estado-cuenta')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({ icon:'warning', title:'Sesi√≥n inv√°lida', timer:3000, showConfirmButton:false });
    return;
  }

  try{
    const res = await apiGet('getEstadoCuenta', { documento: currentUser.documento });
    mostrarEstadoCuenta(res);
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:String(e.message||e) });
  }
});

function mostrarEstadoCuenta(res){
  // Casos sin hallazgo
  if(!res || res.found === false){
    if(res?.reason === 'first'){
      Swal.fire({ icon:'info', title:'APENAS ES TU PRIMERA CUENTA', text:'A√∫n no hay estados para esta', timer:3000, showConfirmButton:false });
      return;
    }
    Swal.fire({ icon:'info', title:'NO HAY REPORTES', text:'No haz Ingresado Cuentas a√∫n', timer:3000, showConfirmButton:false });
    return;
  }

  // Hallazgo con estado
  const estado   = String(res.estado||'').toUpperCase();
  const informe  = res.informe || '';
  const valorCOP = formatCOPView(res.valor || 0);

  switch(estado){
    case 'DEVUELTA':
      Swal.fire({
        icon:'info',
        title:'CUENTA DEVUELTA',
        html:`Tu <b>Cuenta ${informe}</b> por valor de <b>${valorCOP}</b> fue DEVUELTA<br><br>Debes corregirla y volver a Reportarla`,
        timer:8000,
        showConfirmButton:false
      });
      break;
    case 'REVISADA POR SUPERVISOR':
      Swal.fire({
        icon:'success',
        title:'REVISADA POR SUPERVISOR',
        html:`Tu <b>Cuenta ${informe}</b> por valor de <b>${valorCOP}</b> ya fue revisada por tu Supervisor(a)<br><br>A la espera de aprobaci√≥n por la oficina de Contrataci√≥n`,
        timer:8000,
        showConfirmButton:false
      });
      break;
    case 'APROBADA':
      Swal.fire({
        icon:'success',
        title:'Cuenta APROBADA',
        html:`Tu <b>Cuenta ${informe}</b> por valor de <b>${valorCOP}</b> ya fue APROBADA por la oficina de Contrataci√≥n<br><br>Realiza Plan de Pagos en el SECOP II`,
        timer:8000,
        showConfirmButton:false
      });
      break;
    case 'PLAN DE PAGOS':
      Swal.fire({
        icon:'info',
        title:'Pendiente PLAN DE PAGOS',
        html:`Tu <b>Cuenta ${informe}</b> por valor de <b>${valorCOP}</b> est√° pendiente de Aceptaci√≥n de PLAN DE PAGOS por tu Supervisor(a)`,
        timer:8000,
        showConfirmButton:false
      });
      break;
    case 'CERRADA':
      Swal.fire({
        icon:'success',
        title:'PLAN DE PAGOS ACEPTADO',
        html:`Tu <b>Cuenta ${informe}</b> por valor de <b>${valorCOP}</b> fue Aceptada en PLAN DE PAGOS por tu Supervisor(a)<br><br>A la espera de ORDEN DE PAGO por la Oficina de Contabilidad`,
        timer:8000,
        showConfirmButton:false
      });
      break;
    case 'ORDEN DE PAGO':
      Swal.fire({
        icon:'success',
        title:'ORDEN DE PAGO EMITADA',
        html:`Tu <b>Cuenta ${informe}</b> por valor de <b>${valorCOP}</b> tiene ORDEN DE PAGO por la Oficina de Contabilidad<br><br>A la espera de EGRESO por la oficina de Tesorer√≠a`,
        timer:8000,
        showConfirmButton:false
      });
      break;
    case 'EGRESO':
      Swal.fire({
        icon:'success',
        title:'EGRESO',
        html:`Tu <b>Cuenta ${informe}</b> por valor de <b>${valorCOP}</b> ya se encuentra en proceso de Pago`,
        timer:7000,
        showConfirmButton:false
      });
      break;
      case 'PAGADA':
      Swal.fire({
        icon:'success',
        title:'PAGADA',
        html:`Tu <b>Cuenta ${informe}</b> por valor de <b>${valorCOP}</b> ya fue PAGADA por la oficina de Tesorer√≠a`,
        timer:7000,
        showConfirmButton:false
      });
      break;
    default:
      Swal.fire({
        icon:'info',
        title:'Estado: '+estado,
        html:`Tu <b>Cuenta ${informe}</b> por valor de <b>${valorCOP}</b> est√° en estado: ${estado}`,
        timer:5000,
        showConfirmButton:false
      });
      break;
  }
}

  /* ================== IR A SECOP II ================== */

  document.getElementById('go-secop2')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  window.open(
    'https://community.secop.gov.co/STS/Users/Login/Index?SkinName=CCE&currentLanguage=es-CO&Page=login&Country=CO',
    '_blank',
    'noopener'
  );
});

   /* ================== SIA OBSERVA ================== */

  document.getElementById('go-sia')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  window.open(
    'https://siaobserva.auditoria.gov.co/guess/',
    '_blank',
    'noopener'
  );
});

   /* ================== IR A ALCALD√çA DE FLANDES ================== */

  document.getElementById('go-admin')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  window.open(
    'https://www.flandes-tolima.gov.co/',
    '_blank',
    'noopener'
  );
});

   /* ================== IR A SMALL PDF - UNIR ================== */

  document.getElementById('go-smalluni')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  window.open(
    'https://smallpdf.com/es/unir-pdf',
    '_blank',
    'noopener'
  );
});

              /* ================== IR A SMALL PDF - DESBLOQUEAR ================== */

  document.getElementById('go-smalldesb')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  window.open(
    'https://smallpdf.com/es/desbloquear-pdf',
    '_blank',
    'noopener'
  );
});

    /* ================== GENERAR EGRESOS ================== */

 document.getElementById('go-descargar-egresos')?.addEventListener('click', async ()=>{
  overlay.classList.remove('open');

  if(!currentUser || !currentUser.documento){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }

  // === NUEVO: desactivar spinner global y usar SweetAlert loading ===
  const prevSuppress = suppressLoader;
  suppressLoader = true;

  // Fuerza a ocultar el loader global si llegara a estar visible
  loadingCount = 0;
  if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
  const prevLoaderDisplay = loader?.style.display;
  if(loader){
    loader.classList.add('hidden');
    loader.style.display = 'none';
  }

  // SweetAlert de cargue
  Swal.fire({
    title: 'GENERANDO EGRESOS...',
    html: 'Espera unos segundos mientras filtro tu informaci√≥n<br><br>Hacemos todo por ti ü§ì',
    allowOutsideClick: false,
    allowEscapeKey: false,
    didOpen: () => { Swal.showLoading(); }
  });

  try{
    const data = await apiGet('descargarEgresosContratista', { documento: currentUser.documento });

    await Swal.close();

    if(!data?.created || !data?.exportUrl){
      Swal.fire({
        icon:'info',
        title:'NO TIENES EGRESOS EMITIDOS',
        text:'Debes consultar posteriormente.'
      });
      return;
    }

    const url = data.exportUrl;
    const isMobile = /android|iphone|ipad|mobile/i.test(navigator.userAgent);

    if(isMobile){
      window.open(url,'_blank');
    }else{
      const a = document.createElement('a');
      a.href = url;
      a.target = '_self';
      a.rel = 'noopener';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }
  }catch(e){
    await Swal.close();
    Swal.fire({icon:'error', title:'Error', text: e.message});
  }finally{
    // === NUEVO: restaurar loader global ===
    suppressLoader = prevSuppress;
    loadingCount = 0;
    if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
    if(loader){
      loader.style.display = prevLoaderDisplay || '';
      loader.classList.add('hidden');
    }
  }
});

    /* ================== GENERAR CERTIFICADO DE CONTRATO ================== */

  document.getElementById('go-certificacion-contrato')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({ icon:'warning', title:'Sesi√≥n inv√°lida', timer:3000, showConfirmButton:false });
    return;
  }

  // Desactivar loader global para esta operaci√≥n
  const prevSuppress = suppressLoader;
  suppressLoader = true;

  const waitSwal = Swal.fire({
    title: 'GENERANDO CERTIFICACI√ìN...',
    html: 'Por favor espera unos segundos<br><br>Hacemos todo por ti üë©üèª‚Äçüíª',
    allowOutsideClick: false,
    allowEscapeKey: false,
    didOpen: () => { Swal.showLoading(); }
  });

  try{
    const data = await apiGet('generarCertificacionContrato', { documento: currentUser.documento });
    await Swal.close();

    if(!data || !data.base64){
      Swal.fire({ icon:'error', title:'Error', text:'No se pudo generar la certificaci√≥n.' });
      return;
    }

    const byteCharacters = atob(data.base64);
    const byteArrays = [];
    const sliceSize = 1024;
    for(let offset = 0; offset < byteCharacters.length; offset += sliceSize){
      const slice = byteCharacters.slice(offset, offset + sliceSize);
      const byteNumbers = new Array(slice.length);
      for(let i = 0; i < slice.length; i++){
        byteNumbers[i] = slice.charCodeAt(i);
      }
      byteArrays.push(new Uint8Array(byteNumbers));
    }
    const blob = new Blob(byteArrays, { type: data.contentType || 'application/pdf' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = data.fileName || ('CERTIFICACI√ìN CONTRATO N¬∞ ' + (currentUser.documento || '') + ' DE 2026.pdf');
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 5000);
  }catch(e){
    await Swal.close();
    Swal.fire({ icon:'error', title:'Error', text:String(e.message||e) });
  }finally{
    // Restaurar el comportamiento normal del loader global
    suppressLoader = prevSuppress;
  }
});
  
  /* ================== BORRADOR ACTIVIDADES ================== */
let BA_STATE = { informe:1, obligaciones:[], actividades:[], cuentaExiste:false, activo:false, nombre:'' };

document.getElementById('go-borrador')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return;
  }
  try{
    const data = await apiGet('getBorradorActividades', { documento: currentUser.documento });
  if (data.blocked && String(data.estado||'').toUpperCase() !== 'DEVUELTA'){
  await Swal.fire({
    icon:'info',
    title:'A√öN NO PUEDES CREAR BORRADOR',
    text:'Tienes una cuenta pendiente por Terminar etapas del proceso',
    timer:5000,
    showConfirmButton:false
  });
  showView('view-inicio');
  return;
}

// 3) Si BJ es DEVUELTA: alerta 5s y regreso a inicio con mensaje especial
if (String(data.estado||'').toUpperCase() === 'DEVUELTA'){
  await Swal.fire({
    icon:'info',
    title:'OPCI√ìN NO V√ÅLIDA POR AHORA',
    text:'Toma la opci√≥n CORREGIR CUENTA',
    timer:5000,
    showConfirmButton:false
  });
  showView('view-inicio');
  return;
}

    if(data.activo === false){
      await Swal.fire({
        icon:'info',
        title:'Estado INACTIVO',
        text:'Tu contrato no est√° ACTIVO actualmente.',
        timer:4000,
        showConfirmButton:false
      });
    }
    BA_STATE = data || BA_STATE;
    renderBorradorActividades();
    showView('view-borrador');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});

function renderBorradorActividades(){
 const badge = document.getElementById('ba-informe');
  if(badge) badge.textContent = String(BA_STATE.informe||1);

  const totInput = document.getElementById('ba-total-input');
  if(totInput) totInput.value = BA_STATE.total ? String(BA_STATE.total) : '';

  const wrap = document.getElementById('ba-list');
  wrap.innerHTML = '';
  const n = Math.max(1, (BA_STATE.obligaciones||[]).length);
  for(let i=0;i<n && i<26;i++){
    const idx = i+1;
    const oblig = (BA_STATE.obligaciones[i]||'').toString();
    const act   = (BA_STATE.actividades && BA_STATE.actividades[i]) ? BA_STATE.actividades[i] : '';

    const block = document.createElement('div');
    block.className = 'oblig-block';

    const p = document.createElement('p');
    p.innerHTML = `<b>Obligaci√≥n ${idx}:</b> ${oblig || '-'}`;

    const lab = document.createElement('label');
    lab.textContent = 'Actividades por Obligaci√≥n ' + idx + ':';

    const ta = document.createElement('textarea');
    ta.id = 'ba-act-'+idx;
    ta.rows = 5;
    ta.placeholder = 'Describe la(s) actividad(es) que quieres guardar, recuerda todo el esquema explicado en la parte superior.';
    ta.value = act || '';

    block.appendChild(p);
    block.appendChild(lab);
    block.appendChild(ta);
    wrap.appendChild(block);
  }
}

document.getElementById('ba-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

document.getElementById('ba-guardar')?.addEventListener('click', async ()=>{
  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return;
  }
  const n = Math.max(1, (BA_STATE.obligaciones||[]).length);
  const actividades = [];
  for(let i=1;i<=Math.min(26,n);i++){
    const el = document.getElementById('ba-act-'+i);
    actividades.push((el && el.value) ? el.value.trim() : '');
  }
  
  const totalInput = document.getElementById('ba-total-input');
  const totalVal = totalInput ? totalInput.value : '';
  
try{
    await apiPost('saveBorradorActividades', {
      documento: currentUser.documento,
      nombre: BA_STATE.nombre || '',
      informe: BA_STATE.informe || 1,
      total: totalVal, // se guarda en columna E
      actividades
    });
    await Swal.fire({icon:'success', title:'Borrador guardado', timer:1800, showConfirmButton:false});
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});
  
/* ================== SELECTS (banco/eps/afp/arl) ================== */
const BANKS = [
"BANCOLOMBIA","DAVIVIENDA","BANCO DE BOGOT√Å","BANCO CAJA SOCIAL","BANCO POPULAR","BANCO BBVA COLOMBIA S.A.","BANCO AV VILLAS","BANCO DE OCCIDENTE","BANCO AGRARIO DE COLOMBIA","BANCAMIA S.A.","BANCO SANTANDER COLOMBIA","BANCO FALABELLA","BANCO MUNDO MUJER S.A.","NEQUI","DAVIPLATA","DALE","NU","BANCOOMEVA S.A.","BANCO PICHINCHA S.A.","BANCO ITAU","CITIBANK COLOMBIA","BANCO COOPERATIVO COOPCENTRAL","DING","GLOBAL66","IRIS","JFK COOPERATIVA FINANCIERA","FINANCIERA JURISCOOP SA COMPA√ëIA DE FINANCIAMIENTO","ALIANZA FIDUCIARIA","BAN100","BANCO SERFINANZA","BOLD CF","COINK SA","COTRAFA","CREZCAMOS","COLTEFINANCIERA","CONFIAR COOPERATIVA FINANCIERA","CFA COOPERATIVA FINANCIERA","BANCO UNION","SCOTIABANK COLPATRIA","BANCO GNB SUDAMERIS","BANCO J.P. MORGAN COLOMBIA S.A.","BANCO FINANDINA S.A. BIC"
];
const EPS = ["SALUD TOTAL","SANITAS","FAMISANAR","NUEVA EPS","COMPENSAR","SANIDAD FUERZAS MILITARES","CONVIDA","COOSALUD","ALIANSALUD","ADRES MIN002"];
const AFP = ["PROTECCION","PORVENIR","COLFONDOS","OLD MUTUAL","COLPENSIONES","N/A"];
const ARL = ["SURA","POSITIVA","AXA COLPATRIA","COLMENA","BOLIVAR","LIBERTY","LA EQUIDAD"];

function fillSelect(id, options){
  const el = document.getElementById(id);
  if(!el) return;
  el.innerHTML = '<option value="" disabled selected>Selecciona</option>' + options.map(o=>`<option value="${o}">${o}</option>`).join('');
}

/* ================== QUERY MUNICIPIOS ================== */
function bindQuery(inputId, datalistId){
  const input = document.getElementById(inputId);
  const list = document.getElementById(datalistId);
  if(!input || !list) return;

  let t = null;
  let abortCtrl = null;
  const cache = new Map(); // cache por t√©rmino

  input.addEventListener('input', ()=>{
    const q = input.value.trim();
    list.innerHTML = '';
    if (t) clearTimeout(t);
    if (!q){ if (abortCtrl) abortCtrl.abort(); return; }

    t = setTimeout(async ()=>{
      // Cache-hit
      if(cache.has(q)){
        const opts = cache.get(q);
        opts.forEach(opt=>{
          const o = document.createElement('option');
          o.value = opt;
          list.appendChild(o);
        });
        return;
      }
      // Cancelar petici√≥n anterior
      if (abortCtrl) abortCtrl.abort();
      abortCtrl = new AbortController();
      try{
        const url = new URL(API_BASE);
        url.search = new URLSearchParams({ action: 'getFilteredResidencias', query: q }).toString();
        const r = await fetch(url.toString(), { method: 'GET', signal: abortCtrl.signal });
        const j = await r.json();
        const opts = (j && j.ok && Array.isArray(j.data)) ? j.data : [];
        cache.set(q, opts);
        opts.forEach(opt=>{
          const o = document.createElement('option');
          o.value = opt;
          list.appendChild(o);
        });
      }catch(_){ /* silencio */ }
    }, 5); // debounce corto
  });
}


  /* ================== SMALL PDF ================== */
document.getElementById('btn-unificar-anexos')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  window.open('https://smallpdf.com/es/unir-pdf', '_blank', 'noopener');
});

  document.getElementById('btn-desbloquear-pdf')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  window.open('https://smallpdf.com/es/desbloquear-pdf', '_blank', 'noopener');
});

    /* ================== INGRESAR CUENTA ================== */

  // Modo de operaci√≥n de la vista de cuenta: ingreso o correcci√≥n
let IC_MODE = 'ingreso';   // 'ingreso' | 'correccion'
let IC_EDIT_ROW = null;    // fila en CUENTAS cuando es correcci√≥n
  
  /* Constantes y helpers */
const IC_SOLIDARIO_UMBRAL = 5694000;
const MESES_LIT = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
function formatCOPView(n){
  const x = Number(String(n).replace(/\D/g,''))||0;
  return '$ ' + x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
}
function numPure(s){ return Number(String(s||'').replace(/\D/g,''))||0; }
function monthNameDMY(dmy){
  const m = (String(dmy).split('/')[1]||'01'); const idx = Math.max(1,Math.min(12,parseInt(m,10))) - 1;
  return MESES_LIT[idx];
}

  function emptyIfZero(n){
  const x = Number(String(n||'').replace(/\D/g,''))||0;
  return x === 0 ? '' : String(x);
}
  
function pad2(n){ return String(n).padStart(2,'0'); }

  const IS_MOBILE_INGRESAR = isMobileDevice(); // true en m√≥viles, false en desktop

/* Estado local */
let IC_STATE = {
  informe: 1,
  total: '',
  obligaciones: [],
  actividades: [],
  evidFiles: [],    // ya no guardaremos el File para subir
  evidData: [],     // dataURL comprimida para preview + backend
  evidSizes: [],    // tama√±o MB de la dataURL comprimida
  cuentaExiste: false,
  nextMode: false,
  contrato: '',
  carpetaContratista: '',
  rowTarget: null,
  nombre: '',
  saldoQ: '',
  supervisor: ''
};

/* Bot√≥n men√∫: CORREGIR CUENTA */
document.getElementById('go-corregir-cuenta')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }

  IC_MODE = 'correccion';
  IC_EDIT_ROW = null;

  try{
    const base = await apiGet('getCorreccionCuentaData', { documento: currentUser.documento });

    // No hay ninguna fila para este documento
    if(!base || base.found === false){
      await Swal.fire({
        icon:'info',
        title:'NO PUEDES CORREGIR',
        text:'No tienes cuentas ingresadas',
        timer:3000,
        showConfirmButton:false
      });
      return;
    }

    const estado = String(base.estado||'').toUpperCase();

    // Encontrado pero no corregible
    if(base.corregible === false){
      if(estado === 'INCOMPLETA'){
        await Swal.fire({
          icon:'info',
          title:'DEBES COMPLETAR',
          html:'Toma la opci√≥n <b>MI CUENTA DRIVE</b> y completa los Documentos',
          timer:6000,
          showConfirmButton:false
        });
      }else{
        await Swal.fire({
          icon:'info',
          title:'OPCI√ìN NO V√ÅLIDA',
          html:'tu anterior cuenta se encuentra en un Estado que no requiere Correcci√≥n',
          timer:6000,
          showConfirmButton:false
        });
      }
      return;
    }

    // Corregible: INGRESADA o DEVUELTA
    IC_EDIT_ROW = base.rowIndex || null;

    // Llenar IC_STATE con datos de CUENTAS para precargar todos los campos
    IC_STATE.informe = Number(base.informe||1);
    IC_STATE.total   = String(base.totalInforme||'');

    IC_STATE.saldoQ  = String(base.saldoActual||'');
    IC_STATE.obligaciones = Array.isArray(base.obligaciones) ? base.obligaciones : [];
    IC_STATE.actividades  = Array.isArray(base.actividades)  ? base.actividades  : [];
    IC_STATE.cuentaExiste = true;
    IC_STATE.nextMode     = false;

    IC_STATE.contrato   = String(base.contrato||'').trim(); // puede venir vac√≠o, no hace da√±o
    IC_STATE.nombre     = ''; // no se necesita para correcci√≥n en esta vista
    IC_STATE.supervisor = '';
    IC_STATE.editorEmail = '';

   // Guardar evidencias existentes (urls) tal cual vienen de BK..CJ
IC_STATE.evidOriginalUrls = Array.isArray(base.evidencias) ? base.evidencias.slice() : [];

// evidData SOLO guardar√° dataURL nuevas que el usuario cargue en esta correcci√≥n.
// Se inicializa vac√≠o para NO confundir URL vieja con ‚Äúdata nueva‚Äù.
IC_STATE.evidData  = new Array(IC_STATE.evidOriginalUrls.length).fill('');
IC_STATE.evidSizes = new Array(IC_STATE.evidOriginalUrls.length).fill(0);
IC_STATE.bankPlanUrls = {
  bancaria:    String(base.bancariaUrl || ''),
  baucher1:    String(base.baucher1Url || ''),
  planaporte1: String(base.planaporte1Url || ''),
  baucher2:    String(base.baucher2Url || ''),
  planaporte2: String(base.planaporte2Url || ''),
  rutsg:       String(base.rutsgUrl || ''),
  noafp:       String(base.noafpUrl || ''),
  actAnexos:   String(base.actAnexosUrl || '')
};

    IC_STATE.novedadesUrls = {
  actaI:      String(base.actaIUrl || ''),
  clasulados: String(base.clasuladosUrl || ''),
  cdpC:       String(base.cdpCUrl || ''),
  rpC:        String(base.rpCUrl || ''),
  rutpn:      String(base.rutpnUrl || ''),
  arlC:       String(base.arlCUrl || ''),
  otrosi:     String(base.otrosiUrl || ''),
  cdpAc:      String(base.cdpAcUrl || ''),
  rpAc:       String(base.rpAcUrl || ''),
  actaL:      String(base.actaLUrl || ''),
  otroR:      String(base.otroRUrl || '')
};
    
    // Pintar vista con modo correcci√≥n
    renderIngresarCuenta();

    // Precargar relaci√≥n de pago
    const saldoEl = document.getElementById('ic-saldo');
    if(saldoEl){
      saldoEl.value = String(base.saldoActual||'');
    }
    const cobroEl = document.getElementById('ic-cobro');
    if(cobroEl){
      cobroEl.value = String(base.cobro||'');
    }
    const nuevoSaldoEl = document.getElementById('ic-nuevoSaldo');
    if(nuevoSaldoEl){
      nuevoSaldoEl.value = formatCOPView(base.nuevoSaldo||0);
    }

    // Planilla principal
    const planillaEl = document.getElementById('ic-planilla');
    if(planillaEl) planillaEl.value = String(base.numeroPlanilla||'');
    const mesPlanillaEl = document.getElementById('ic-mesPlanilla');
    if(mesPlanillaEl && base.mesPlanilla){
      mesPlanillaEl.value = String(base.mesPlanilla||'');
    }

    const baseEl = document.getElementById('ic-base');
    if(baseEl) baseEl.value = String(base.base||'');
    const saludEl = document.getElementById('ic-salud');
    if(saludEl) saludEl.value = String(base.salud||'');
    const fondoEl = document.getElementById('ic-fondo');
    if(fondoEl) fondoEl.value = String(base.fondo||'');
    const riesgosEl = document.getElementById('ic-riesgos');
    if(riesgosEl) riesgosEl.value = String(base.riesgos||'');

    // Planilla anexa
    const plan2El = document.getElementById('ic-planilla2');
    const mes2El  = document.getElementById('ic-mesPlanilla2');
    const base2El = document.getElementById('ic-base2');
    const sal2El  = document.getElementById('ic-salud2');
    const fon2El  = document.getElementById('ic-fondo2');
    const rie2El  = document.getElementById('ic-riesgos2');

    if(plan2El)  plan2El.value  = String(base.numeroPlanilla2||'');
    if(mes2El)   mes2El.value   = String(base.mesPlanilla2||'');
    if(base2El)  base2El.value  = String(base.base2||'');
    if(sal2El)   sal2El.value   = String(base.salud2||'');
    if(fon2El)   fon2El.value   = String(base.fondo2||'');
    if(rie2El)   rie2El.value   = String(base.riesgos2||'');

    showView('view-ingresar-cuenta');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});

  // M√°s Documentos Anexos toggle
  document.getElementById('btn-novedades-show')?.addEventListener('click', ()=>{
    document.getElementById('ic-novedades-wrap')?.classList.remove('hidden');
  });
  document.getElementById('btn-novedades-hide')?.addEventListener('click', ()=>{
    document.getElementById('ic-novedades-wrap')?.classList.add('hidden');
  });

  // Validaci√≥n y bind de PDFs (NOVEDADES) - opcionales, 1MB, no cifrados
  bindPdfInputStrict('actaI',      { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('clasulados', { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('cdpC',       { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('rpC',        { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('rutpn',      { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('arlC',       { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('otrosi',     { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('cdpAc',      { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('rpAc',       { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('actaL',      { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });
  bindPdfInputStrict('otroR',      { required:false, forbidEncrypted:true, maxMb: MAX_NOVEDADES_MB });

  
/* Bot√≥n men√∫: INGRESAR CUENTA (con sonido y navegaci√≥n) */
document.getElementById('go-ingresar-cuenta')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({icon:'warning',title:'Sesi√≥n inv√°lida'}); 
    return;
  }

 try{
IC_MODE = 'ingreso';
  IC_EDIT_ROW = null;
    // Usa una sola llamada optimizada del backend (CONTRATISTAS + CUENTAS)
    const base = await apiGet('getIngresarCuentaData', { documento: currentUser.documento });

    // Bloqueos por estado BJ
     const bj = String(base.estado||'').toUpperCase();
    
   if (bj === 'DEVUELTA') {
    await Swal.fire({
      icon:'info',
      title:'OPCI√ìN NO V√ÅLIDA POR AHORA',
      html:'Toma la opci√≥n <b>CORREGIR CUENTA</b>',
      timer:5000,
      showConfirmButton:false
    });
    showView('view-inicio');
    return;
  }

if (bj === 'INGRESADA' || bj === 'REPORTADA') {
  await Swal.fire({
    icon:'info',
    title:'NO PUEDES ACUMULAR CUENTAS',
    html: `Tu Supervisor no ha revisado y por ende, la oficina de Contrataci√≥n no ha Aprobado tu cuenta recientemente reportada<br><br>
           Puedes ir adelantado el registro de las Actividades de la <b>siguiente cuenta</b> desde la opci√≥n <b>BORRADOR ACTIVIDADES</b><br><br>
           ¬°No dejes acumular cuentas!`,
    timer:13000,
    showConfirmButton:false
  });
  showView('view-inicio');
  return;
}

if (bj === 'REVISADA POR SUPERVISOR') {
  await Swal.fire({
    icon:'info',
    title:'DEBES ESPERAR UN POCO M√ÅS',
    html: `La oficina de Contrataci√≥n no ha Aprobado tu anterior cuenta<br><br>
           Puedes ir adelantado el registro de las Actividades de la <b>siguiente cuenta</b> desde la opci√≥n <b>BORRADOR ACTIVIDADES</b><br><br>
           ¬°No dejes acumular cuentas!`,
    timer:11000,
    showConfirmButton:false
  });
  showView('view-inicio');
  return;
}

    // Cargar estado √∫nico
    IC_STATE.informe       = Number(base.informe||1);
    IC_STATE.total         = String(base.total||'');
    IC_STATE.saldoQ        = String(base.saldoQ||''); 
    IC_STATE.obligaciones  = Array.isArray(base.obligaciones) ? base.obligaciones : [];
    IC_STATE.actividades   = Array.isArray(base.actividades) ? base.actividades : [];
    IC_STATE.cuentaExiste  = !!base.cuentaExiste;
    IC_STATE.nextMode      = !!base.nextMode;
    IC_STATE.contrato      = String(base.contrato||'').trim();
    IC_STATE.nombre        = String(base.nombre||'').trim();
    IC_STATE.supervisor    = String(base.supervisor||'').trim();
    IC_STATE.editorEmail   = String(base.editorEmail||'').trim();

    // Pintar vista
    renderIngresarCuenta();

    // Precargar SALDO ACTUAL si viene
    const saldoEl = document.getElementById('ic-saldo');
    if(saldoEl){
      if(IC_STATE.saldoQ){
        saldoEl.value = IC_STATE.saldoQ;
        const cobro = numPure(document.getElementById('ic-cobro').value||'');
        document.getElementById('ic-nuevoSaldo').value = formatCOPView(numPure(IC_STATE.saldoQ) - cobro);
      }else{
        saldoEl.placeholder = 'Primera cuenta: valor del contrato';
      }
    }

    showView('view-ingresar-cuenta');
  }catch(e){
    Swal.fire({icon:'error',title:'Error',text:String(e.message||e)});
  }
});
  
// Alerta si el usuario da OK sin elegir un valor en el picker
function showPickerSelectAlert(){
  Swal.fire({
    icon:'info',
    title:'DEBES SELECCIONAR',
    text:'Corrobora tu selecci√≥n',
    timer:1000,
    showConfirmButton:false
  });
}

// Formato COP en inputs
const COP_INPUT_IDS = ['ic-saldo','ic-cobro','ic-base','ic-salud','ic-riesgos','ic-base2','ic-salud2','ic-fondo','ic-fondo2','ic-riesgos2'];

function formatCOPInstant(el){
  if(!el) return;
  const raw = numPure(el.value);
  if(!raw){ el.value = '$ '; return; }
  el.value = formatCOPView(raw);
}

function bindCOPFormatters(){
  COP_INPUT_IDS.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    // Valor inicial "$ "
    if(!el.value) el.value = '$ ';
    el.addEventListener('input', ()=>formatCOPInstant(el));
    el.addEventListener('blur',  ()=>formatCOPInstant(el));
  });
}

// Convierte una URL de archivo de Drive a un thumbnail usable en <img src="">
function driveUrlToThumb(url){
  if(!url) return '';
  const m = String(url).match(/\/d\/([a-zA-Z0-9_-]{10,})\//);
  const id = m ? m[1] : '';
  if(!id) return url; // si no extrae id, usa la url como est√°
  return 'https://drive.google.com/thumbnail?sz=w800&id=' + id;
}
  
/* Render de la vista */
function renderIngresarCuenta(){
  // Ajustar t√≠tulo y descripci√≥n seg√∫n modo
  const titleEl = document.getElementById('ic-title');
  const descEl  = document.getElementById('ic-desc');
  if(IC_MODE === 'correccion'){
    if(titleEl) titleEl.textContent = 'CORRECCI√ìN DE CUENTA';
    if(descEl)  descEl.innerHTML = `
      Edita los campos teniendiendo en cuenta las observaciones.<br><br>
      INFORME:
      <span id="ic-informe" class="chip">${String(IC_STATE.informe||1)}</span>
      &nbsp; DE:
      <input id="ic-total" type="text" placeholder="Total" style="display:inline-block; width:auto; min-width:80px;" />
    `;
  }else{
    if(titleEl) titleEl.textContent = 'CREACI√ìN DE CUENTA';
    if(descEl)  descEl.innerHTML = `
      INFORME:
      <span id="ic-informe" class="chip">${String(IC_STATE.informe||1)}</span>
      &nbsp; DE:
      <input id="ic-total" type="text" placeholder="Total" style="display:inline-block; width:auto; min-width:80px;" />
    `;
  }

  // Reasignar referencias de informe/total ahora que se re-renderiz√≥ HTML
  document.getElementById('ic-informe').textContent = String(IC_STATE.informe||1);
  const tot = document.getElementById('ic-total'); 
  if(tot) tot.value = IC_STATE.total||'';

// Precargar supervisor de forma oculta
  const sup = document.getElementById('ic-supervisor');
if (sup) sup.value = IC_STATE.supervisor || '';

  // Precargar correo Editor de forma oculta
  const ed = document.getElementById('ic-editor-email');    
  if (ed) ed.value = IC_STATE.editorEmail || '';         

  // Precargar SALDO ACTUAL con Q (editable)
  const saldoEl = document.getElementById('ic-saldo');
  if(saldoEl){
    saldoEl.value = IC_STATE.saldoQ || '';
  }

    // Mostrar ayuda solo en la primera cuenta (informe 1)
  const saldoHint = document.getElementById('ic-saldo-first-hint');
  if (saldoHint){
    const isFirst = Number(IC_STATE.informe || 1) === 1;
    saldoHint.style.display = isFirst ? '' : 'none';
  }

// Adjunto de archivos de cuenta certificado bancario y planilla
bindPdfInputStrict('bancaria',    { required: (IC_MODE !== 'correccion'), forbidEncrypted:true });
bindPdfInputStrict('baucher1',    { required: (IC_MODE !== 'correccion'), forbidEncrypted:true });
bindPdfInputStrict('planaporte1', { required: (IC_MODE !== 'correccion'), forbidEncrypted:true });
bindPdfInputStrict('baucher2',    { required:false, forbidEncrypted:true });
bindPdfInputStrict('planaporte2', { required:false, forbidEncrypted:true });

bindPdfInputStrict('rutsg',       { required:false, forbidEncrypted:true });
bindPdfInputStrict('noafp',       { required:false, forbidEncrypted:true });
bindPdfInputStrict('actAnexos',   { required:false, forbidEncrypted:true, maxMb: MAX_ACT_ANEXOS_MB });

// Siempre iniciar oculto el bloque de "M√°s Documentos Anexos" al entrar a la vista
document.getElementById('ic-novedades-wrap')?.classList.add('hidden');

const FILE_LABELS = {
  bancaria:    'Certificaci√≥n Bancaria.pdf',
  baucher1:    'Baucher Planilla.pdf',
  planaporte1: 'Planilla.pdf',
  baucher2:    'Baucher Planilla Anexa.pdf',
  planaporte2: 'Planilla Anexa.pdf',
  rutsg:       'RUT (R√©gimen Simple).pdf',
  noafp:       'Certificaci√≥n NO Aportes Pensi√≥n.pdf',
  actAnexos:   'ANEXOS DE ACTIVIDADES.pdf',
  actaI:       'Acta de Inicio.pdf',
  clasulados:  'Clausulados del Contrato.pdf',
  cdpC:        'CDP.pdf',
  rpC:         'RP.pdf',
  rutpn:       'RUT Persona Natural.pdf',
  arlC:        'Certificado ARL.pdf',
  otrosi:      'OTROSI.pdf',
  cdpAc:       'CDP Adici√≥n.pdf',
  rpAc:        'RP Adici√≥n.pdf',
  actaL:       'Acta de Liquidaci√≥n.pdf',
  otroR:       'Otro Requerido.pdf'
};

function resetFileUi_(id){
  const inp = document.getElementById(id);
  const st = document.getElementById(id + '-status');
  const clearBtn = document.getElementById(id + '-clear');

  if(inp) inp.value = '';
  if(st) st.innerHTML = '';
  if(clearBtn) clearBtn.style.display = 'none';
}

function setPreloadedUi_(id, url){
  const inp = document.getElementById(id);
  const st = document.getElementById(id + '-status');
  const clearBtn = document.getElementById(id + '-clear');

  if(inp) inp.value = '';

  if(!st) return;

  const hasUrl = !!String(url || '').trim();
  if(hasUrl){
    const label = FILE_LABELS[id] || 'Archivo.pdf';
    st.innerHTML = `<span style="font-weight:900;color:#16a34a;">CARGADO</span> <span style="font-weight:700;">${escapeHtml_(label)}</span>`;
    if(clearBtn) clearBtn.style.display = '';
  }else{
    st.innerHTML = '';
    if(clearBtn) clearBtn.style.display = 'none';
  }
}

// IDs de PDFs en esta vista (los que tienen status/clear)
const bankIds = ['bancaria','baucher1','planaporte1','baucher2','planaporte2','rutsg','noafp','actAnexos'];
const novIds  = ['actaI','clasulados','cdpC','rpC','rutpn','arlC','otrosi','cdpAc','rpAc','actaL','otroR'];

if(IC_MODE !== 'correccion'){
  bankIds.forEach(resetFileUi_);
  novIds.forEach(resetFileUi_);
}else{
  const map = IC_STATE.bankPlanUrls || {};
  bankIds.forEach((id)=> setPreloadedUi_(id, map[id]));

  const novMap = IC_STATE.novedadesUrls || {};
  novIds.forEach((id)=> setPreloadedUi_(id, novMap[id]));
}
  
  // Meses select
  const sel1 = document.getElementById('ic-mesPlanilla'); const sel2 = document.getElementById('ic-mesPlanilla2');
  if(sel1) sel1.innerHTML = '<option value="" disabled selected>Selecciona</option>' + MESES_LIT.map(m=>`<option>${m}</option>`).join('');
  if(sel2) sel2.innerHTML = '<option value="" disabled selected>Selecciona</option>' + MESES_LIT.map(m=>`<option>${m}</option>`).join('');

  // Planilla anexa toggle
  document.getElementById('btn-planilla2-show')?.addEventListener('click', ()=>{
    document.getElementById('ic-planilla2-wrap')?.classList.remove('hidden');
  });
  document.getElementById('btn-planilla2-hide')?.addEventListener('click', ()=>{
    document.getElementById('ic-planilla2-wrap')?.classList.add('hidden');
  });

  // Nuevo saldo din√°mico + solidario/aporte
  const recompute = ()=>{
    const saldo = numPure(document.getElementById('ic-saldo').value);
    const cobro = numPure(document.getElementById('ic-cobro').value);

    const nuevoSaldoEl = document.getElementById('ic-nuevoSaldo');
    if(!saldo && !cobro){
      nuevoSaldoEl.value = '$ ';
    } else if(cobro > saldo){
      nuevoSaldoEl.value = 'Error, revisa las cantidades';
    } else {
      nuevoSaldoEl.value = formatCOPView(saldo - cobro);
    }

    const base = numPure(document.getElementById('ic-base').value);
    if(base >= IC_SOLIDARIO_UMBRAL){
      document.getElementById('ic-solidario').value = String(Math.round(base * 0.01));
      document.getElementById('ic-aporte').value = 'COL PENSIONES';
    }else{
      document.getElementById('ic-solidario').value = '0';
      document.getElementById('ic-aporte').value = '-';
    }

   const base2 = numPure(document.getElementById('ic-base2').value);
    if(base2 >= IC_SOLIDARIO_UMBRAL){
      document.getElementById('ic-solidario2').value = String(Math.round(base2 * 0.01));
      document.getElementById('ic-aporte2').value = 'COL PENSIONES';
    }else{
      document.getElementById('ic-solidario2').value = '0';
      document.getElementById('ic-aporte2').value = '-';
    }
  };
  ['ic-saldo','ic-cobro','ic-base','ic-base2'].forEach(id=>{
    const el = document.getElementById(id); if(el){ el.addEventListener('input', recompute); }
  });

  // >>> Formato de pesos
  bindCOPFormatters();
  recompute();

  // Obligaciones + Actividades + Evidencias
  const wrap = document.getElementById('ic-oblig-wrap');
  wrap.innerHTML = '';
  const n = Math.max(1, IC_STATE.obligaciones.length);

  for(let i=0;i<n && i<26;i++){
    const idx = i + 1;
    const oblig = IC_STATE.obligaciones[i] || '-';
    const actVal = (IC_STATE.actividades && IC_STATE.actividades[i]) ? IC_STATE.actividades[i] : '';

    const block = document.createElement('div');
    block.className = 'oblig-block';

        const p = document.createElement('p');
    p.innerHTML = `<b>Obligaci√≥n ${idx}:</b> ${oblig}`;

    const lab = document.createElement('label');
    lab.textContent = 'Actividades por Obligaci√≥n ' + idx + ':';

    const ta = document.createElement('textarea');
    ta.id = 'ic-act-' + idx;
    ta.rows = 5;
    ta.placeholder = 'Describe la(s) actividad(es) que quieres ingresar, recuerda todo el esquema explicado al empezar esta secci√≥n.';
    ta.value = actVal;

    const labE = document.createElement('label');
    labE.textContent = 'Evidencia Actividades ' + idx + ' (opcional)';

    const inp = document.createElement('input');
    inp.type = 'file';
    inp.accept = 'image/*';
    inp.id = 'ic-evi-' + idx;

    // Bot√≥n VER (solo se muestra en m√≥vil); en desktop lo ocultamos
    const verBtn = document.createElement('button');
    verBtn.type = 'button';
    verBtn.textContent = 'VER';
    verBtn.className = 'chip';
    verBtn.style.marginTop = '6px';
    verBtn.style.display = IS_MOBILE_INGRESAR ? '' : 'none';

        // Preview inline (solo desktop)
    const prev = document.createElement('img');
    prev.id = 'ic-evi-prev-' + idx;
    prev.className = 'evi-preview';
    prev.loading = 'lazy';
    prev.style.display = IS_MOBILE_INGRESAR ? 'none' : 'none'; // en desktop se activar√° al tener data

    // Si estamos en correcci√≥n y hay URL existente, mostrarla como thumbnail,
// PERO NO tocar evidData (solo se llena cuando el usuario sube una nueva imagen)
if(IC_MODE === 'correccion'){
  const existingUrl = (IC_STATE.evidOriginalUrls && IC_STATE.evidOriginalUrls[i]) ? IC_STATE.evidOriginalUrls[i] : '';
  if(existingUrl && !IS_MOBILE_INGRESAR){
    prev.src = driveUrlToThumb(existingUrl);
    prev.style.display = 'block';
  }

  // En m√≥vil, el bot√≥n VER debe usar la URL original si no hay data nueva
  verBtn.addEventListener('click', ()=>{
    const dataUrl = IC_STATE.evidData[i] || existingUrl;
    if(!dataUrl){
      Swal.fire({icon:'info', title:'Sin imagen', text:'Primero carga una imagen para esta evidencia.'});
      return;
    }
    Swal.fire({
      title: `Evidencia ${idx}`,
      html: `<img src="${driveUrlToThumb(dataUrl)}" alt="Evidencia ${idx}" style="max-width:100%;max-height:70vh;border-radius:10px;border:1.5px solid #d8e4ff;">`,
      width: '90%',
      allowOutsideClick: true
    });
  });
} else {
  // En modo ingreso original, el bot√≥n VER usa solo data nueva
  verBtn.addEventListener('click', ()=>{
    const dataUrl = IC_STATE.evidData[i] || '';
    if(!dataUrl){
      Swal.fire({icon:'info', title:'Sin imagen', text:'Primero carga una imagen para esta evidencia.'});
      return;
    }
    Swal.fire({
      title: `Evidencia ${idx}`,
      html: `<img src="${dataUrl}" alt="Evidencia ${idx}" style="max-width:100%;max-height:70vh;border-radius:10px;border:1.5px solid #d8e4ff;">`,
      width: '90%',
      allowOutsideClick: true
    });
  });
}
    
    // Handler de carga/compresi√≥n
    inp.addEventListener('change', async (e)=>{
      const file = e.target.files && e.target.files[0];
      IC_STATE.evidData[i]  = '';
      IC_STATE.evidSizes[i] = 0;
      prev.src = '';
      prev.style.display = IS_MOBILE_INGRESAR ? 'none' : 'none';

      if(!file){ return; }

      if(file.size > EVI_SELECT_MAX_MB * 1024 * 1024){
        await Swal.fire({
          icon:'warning',
          title:`Imagen ${idx} muy pesada`,
          text:`Elige una foto menor a ${EVI_SELECT_MAX_MB} MB.`
        });
        inp.value = '';
        return;
      }

      try{
        const { dataUrl, sizeMB } = await compressImageToDataUrl(file);
        if(sizeMB > MAX_IMAGE_MB){
          await Swal.fire({
            icon:'warning',
            title:`Imagen ${idx} a√∫n supera ${MAX_IMAGE_MB} MB`,
            text:'Usa una foto m√°s liviana o baja la resoluci√≥n antes de cargarla.'
          });
          inp.value = '';
          return;
        }
        IC_STATE.evidData[i]  = dataUrl;
        IC_STATE.evidSizes[i] = sizeMB;

        // Desktop: muestra inline
        if(!IS_MOBILE_INGRESAR){
          prev.src = dataUrl;
          prev.style.display = 'block';
        }
      }catch(err){
        inp.value = '';
        prev.src = '';
        prev.style.display = 'none';
        await Swal.fire({ icon:'error', title:'Error con la imagen', text:String(err.message||err) });
      }
    });

    block.appendChild(p);
    block.appendChild(lab);
    block.appendChild(ta);
    block.appendChild(labE);
    block.appendChild(inp);
    block.appendChild(prev);
    block.appendChild(verBtn);
    wrap.appendChild(block);
  }
}

   // Reset de cuenta
  function resetIngresarCuentaView(){
  // Limpiar inputs principales
  ['ic-total','ic-inicio','ic-diaRat1','ic-mesRat1','ic-fin','ic-diaRat2','ic-mesRat2',
   'ic-radicado','ic-diaRad','ic-mesRad','ic-saldo','ic-cobro','ic-nuevoSaldo','ic-planilla',
   'ic-mesPlanilla','ic-base','ic-salud','ic-fondo','ic-riesgos',
   'ic-planilla2','ic-mesPlanilla2','ic-base2','ic-salud2','ic-fondo2','ic-riesgos2',
   'ic-solidario','ic-aporte','ic-solidario2','ic-aporte2'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(el){ el.value=''; }
  });

  // Limpiar actividades y evidencias previas
  const wrap = document.getElementById('ic-oblig-wrap');
    IC_STATE.evidData = [];
IC_STATE.evidSizes = [];
IC_STATE.evidFiles = [];
  if(wrap){ wrap.innerHTML=''; }

  // Reset estado local m√≠nimo
  IC_STATE = {
    informe: 1,
    total: '',
     obligaciones: [],
  actividades: [],
  evidFiles: [],
  evidData: [],
  evidSizes: [],
    cuentaExiste: false,
    nextMode: false,
    contrato: '',
    carpetaContratista: '',
    rowTarget: null,
    nombre: ''   // oculto
  };
}

/* Fechas: picker reutilizando tu base con targets distintos */
let __icPickerTarget = null; // 'inicio'|'fin'

// Garantiza que el modal de Cumple tenga opciones (si a√∫n no est√°n cargadas)
function ensureCumpleModalOptions(){
  const dSel = document.getElementById('cumpleDia');
  const mSel = document.getElementById('cumpleMes');
  const aSel = document.getElementById('cumpleAnio');

  if (dSel && !dSel.childElementCount){
    for(let d=1; d<=31; d++){
      const opt=document.createElement('option');
      opt.value=String(d).padStart(2,'0');
      opt.textContent=opt.value;
      dSel.appendChild(opt);
    }
  }
  if (mSel && !mSel.childElementCount){
    const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){
      const opt=document.createElement('option');
      opt.value=String(i+1).padStart(2,'0');
      opt.textContent=mesesNombres[i];
      mSel.appendChild(opt);
    }
  }
  if (aSel && !aSel.childElementCount){
    // Rango amplio para periodos (aj√∫stalo si deseas)
    for(let y=1936;y<=2035;y++){
      const opt=document.createElement('option');
      opt.value=String(y);
      opt.textContent=String(y);
      aSel.appendChild(opt);
    }
  }
}

function abrirPickerIC(target){
  __icPickerTarget = target;
  ensureCumpleModalOptions();
  // Abre el modal de "cumple" que ya tienes
  const m=document.getElementById('cumpleModal');
  if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
}

  
/* Fecha de Radicaci√≥n: modal limitado (hoy y siguientes 2 d√≠as h√°biles; fin de semana/festivos 2026) */
const FERIADOS_2026 = new Set(['23/03/2026','02/04/2026','03/04/2026','01/05/2026','18/05/2026','08/06/2026','15/06/2026','29/06/2026','20/07/2026','07/08/2026','17/08/2026','12/10/2026','02/11/2026','16/11/2026','08/12/2026','25/11/2026']);
function esHabil(d){ // d = Date
  const dd = pad2(d.getDate()), mm = pad2(d.getMonth()+1), yy = d.getFullYear();
  const key = `${dd}/${mm}/${yy}`;
  const dow = d.getDay(); // 0=Domingo, 6=S√°bado
  // Diciembre: todos los d√≠as habilitados excepto feriados (seg√∫n tu regla especial)
  if (mm==='12'){
    return !FERIADOS_2026.has(key);
  }
  if(dow===0 || dow===6) return false;
  if(FERIADOS_2026.has(key)) return false;
  return true;
}
function abrirPickerRadicadoLimitado(){
  const m = document.getElementById('contratoFechaModal');
  const dSel = document.getElementById('contratoDia');
  const mSel = document.getElementById('contratoMes');
  const aSel = document.getElementById('contratoAnio');
  if(!m || !dSel || !mSel || !aSel) return;

  // Limpiar y recomponer selects
  dSel.innerHTML = '';
  mSel.innerHTML = '';
  aSel.innerHTML = '';

  const hoy = new Date();
  const opciones = [];
  let count = 0;
  let cursor = new Date(hoy);

  // Junta hoy + 2 pr√≥ximos d√≠as h√°biles (regla especial para diciembre/festivos 2026)
  while(count<3){
    if(esHabil(cursor)){
      opciones.push(new Date(cursor));
      count++;
    }
    cursor.setDate(cursor.getDate()+1);
  }

  // Configura Mes/A√±o seg√∫n la primera opci√≥n
  const d0 = opciones[0];
  const anio = String(d0.getFullYear());
  const mesIdx = d0.getMonth(); // 0..11
  const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const optM = document.createElement('option');
  optM.value = pad2(mesIdx+1);
  optM.textContent = mesesNombres[mesIdx];
  mSel.appendChild(optM);

  const optY = document.createElement('option');
  optY.value = anio;
  optY.textContent = anio;
  aSel.appendChild(optY);

  // D√≠as habilitados
  opciones.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = pad2(d.getDate());
    opt.textContent = pad2(d.getDate());
    dSel.appendChild(opt);
  });

  // Abrir modal y configurar target
  m.style.display='flex'; m.setAttribute('aria-hidden','false');
  __pickerContratoTarget = 'radicado';
}

  

/* Volver con sonido */
document.getElementById('ic-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  resetIngresarCuentaView();  
  showView('view-inicio');
});

/* Guardar con resumen + backend saveNuevaCuenta + generaci√≥n de documentos */
document.getElementById('ic-guardar')?.addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning',title:'Sesi√≥n inv√°lida'}); return; }

  // Validar actividades obligatorias
  {
  const n = Math.max(1, IC_STATE.obligaciones.length);
  for (let i = 1; i <= Math.min(26, n); i++) {
    const el = document.getElementById('ic-act-' + i);
    const v = (el && el.value) ? el.value.trim() : '';
    if (!v) {
      await Swal.fire({
        icon: 'warning',
        title: `Faltan actividades`,
        text: `Debes diligenciar la actividad para la obligaci√≥n ${i}.`
      });
      return;
    }
  }
}

    if(IC_MODE !== 'correccion'){
    const banc = document.getElementById('bancaria');
    const b1   = document.getElementById('baucher1');
    const p1   = document.getElementById('planaporte1');

    const fBanc = banc && banc.files && banc.files[0] ? banc.files[0] : null;
    const fB1   = b1 && b1.files && b1.files[0] ? b1.files[0] : null;
    const fP1   = p1 && p1.files && p1.files[0] ? p1.files[0] : null;

    if(!fBanc || !fB1 || !fP1){
      Swal.fire({ icon:'warning', title:'Faltan PDFs requeridos', text:'Debes cargar Certificaci√≥n Bancaria, Baucher Planilla y Planilla.' });
      return;
    }
  }
  
  // Validaciones m√≠nimas
  const required = {
    inicio: document.getElementById('ic-inicio').value,
    fin: document.getElementById('ic-fin').value,
    radicado: document.getElementById('ic-radicado').value,
    saldo: document.getElementById('ic-saldo').value,
    cobro: document.getElementById('ic-cobro').value,
    planilla: document.getElementById('ic-planilla').value,
    mesPlanilla: document.getElementById('ic-mesPlanilla').value,
    base: document.getElementById('ic-base').value,
    salud: document.getElementById('ic-salud').value,
    fondo: document.getElementById('ic-fondo').value,
    riesgos: document.getElementById('ic-riesgos').value
  };
  if(Object.values(required).some(v=>!String(v||'').trim())){
    Swal.fire({icon:'warning',title:'Faltan campos requeridos'}); return;
  }

  // Actividades
  const n = Math.max(1, IC_STATE.obligaciones.length);
  const actividades = [];
  for(let i=1;i<=Math.min(26,n);i++){
    const el = document.getElementById('ic-act-'+i);
    actividades.push((el && el.value) ? el.value.trim() : '');
  }

 // Evidencias (1 por obligaci√≥n) ‚Üí SOLO enviamos dataURL nuevas.
// Si est√° vac√≠o, el backend conservar√° la URL existente de BK..CJ.
const evidenciasData = [];
for(let i=0;i<Math.min(26,n);i++){
  const dataUrl = IC_STATE.evidData[i] || '';
  const sz = IC_STATE.evidSizes[i] || 0;

  if(dataUrl && sz > MAX_IMAGE_MB){
    await Swal.fire({
      icon:'warning',
      title:`Evidencia ${i+1} supera ${MAX_IMAGE_MB} MB`,
      text:'Vuelve a cargarla con menor peso.'
    });
    return;
  }
  evidenciasData.push(dataUrl); // '' => no se reemplaza; dataUrl => s√≠ se reemplaza
}

  // C√°lculos
  const saldo = numPure(required.saldo);
  const cobro = numPure(required.cobro);
  const nuevoSaldo = saldo - cobro;
  const base = numPure(required.base);
  const solidario = base>=IC_SOLIDARIO_UMBRAL ? Math.round(base*0.01) : 0;
  const aporte = base>=IC_SOLIDARIO_UMBRAL ? 'COL PENSIONES' : '-';

  const base2 = numPure(document.getElementById('ic-base2').value||'');
  const solidario2 = base2>=IC_SOLIDARIO_UMBRAL ? Math.round(base2*0.01) : 0;
  const aporte2 = base2>=IC_SOLIDARIO_UMBRAL ? 'COL PENSIONES' : '-';

  // Fuerza dos d√≠gitos para d√≠as desde los inputs ocultos
  const diaRadicar  = pad2(document.getElementById('ic-diaRad').value||'');
  const diaRat1     = pad2(document.getElementById('ic-diaRat1').value||'');
  const diaRat2     = pad2(document.getElementById('ic-diaRat2').value||'');

  const total = String(document.getElementById('ic-total')?.value || '').trim();
if(!total){
  await Swal.fire({ icon:'warning', title:'Campo requerido', text:'Debes diligenciar el campo TOTAL.' });
  document.getElementById('ic-total')?.focus();
  return;
}

  // ================== NOVEDADES: validar combinaciones permitidas ==================
  function hasFile(id){
    const inp = document.getElementById(id);
    return !!(inp && inp.files && inp.files[0]);
  }

  const nov = {
    actaI: hasFile('actaI'),
    clasulados: hasFile('clasulados'),
    cdpC: hasFile('cdpC'),
    rpC: hasFile('rpC'),
    rutpn: hasFile('rutpn'),
    arlC: hasFile('arlC'),
    otrosi: hasFile('otrosi'),
    actaL: hasFile('actaL'),
    otroR: hasFile('otroR'),
    cdpAc: hasFile('cdpAc'),
    rpAc: hasFile('rpAc')
  };

  const anyNovedades = Object.values(nov).some(Boolean);

  function allowNovedades(){
    if(!anyNovedades) return true;

    const group1Base = nov.actaI && nov.clasulados && nov.cdpC && nov.rpC && nov.rutpn && nov.arlC;
    const group1Ok   = group1Base && !nov.actaL && !nov.cdpAc && !nov.rpAc && (!nov.otrosi || nov.otrosi) && (!nov.otroR || nov.otroR);

    const group2Ok = nov.cdpAc && nov.rpAc && !nov.actaI && !nov.clasulados && !nov.cdpC && !nov.rpC && !nov.rutpn && !nov.arlC && !nov.actaL;

    const group3Ok = nov.actaL && nov.otroR && !nov.actaI && !nov.clasulados && !nov.cdpC && !nov.rpC && !nov.rutpn && !nov.arlC && !nov.cdpAc && !nov.rpAc;

    const group4Ok = (nov.otrosi || nov.actaL || nov.otroR) && !nov.actaI && !nov.clasulados && !nov.cdpC && !nov.rpC && !nov.rutpn && !nov.arlC && !nov.cdpAc && !nov.rpAc;

    return !!(group1Ok || group2Ok || group3Ok || group4Ok);
  }

if(!allowNovedades()){
  await Swal.fire({
    icon:'info',
    title:'REVISA MUY BIEN LOS DOCUMENTOS ADJUNTOS',
    html: `Para <b>1ra Cuenta:</b><br>
      - Acta de Inicio<br>
      - CDP<br>
      - RP<br>
      - RUT<br>
      - Certificaci√≥n ARL<br>
      - OtroSi (Si Aplica)<br>
      - Otro Requerido (Si Aplica)<br><br>
      Para <b>√öltima Cuenta:</b><br>
      - Acta de Liquidaci√≥n<br>
      - Otro Requerido (Si Aplica)<br><br>
      Para otros casos, consulta primero con tu SUPERVISOR.`
  });
  return;
}


  const novedadesPdfs = await collectNovedadesPdfsBase64_();

  const body = {
    documento: currentUser.documento,
    nombre: IC_STATE.nombre || '',
    contrato: IC_STATE.contrato || '',
    supervisor: document.getElementById('ic-supervisor').value || '',
    editorEmail: document.getElementById('ic-editor-email').value || '',
    informe: IC_STATE.informe || 1,
    total: String(document.getElementById('ic-total').value||''),
    fechaRadicar: document.getElementById('ic-radicado').value,
    diaRadicar: diaRadicar,            // 2 d√≠gitos
    mesRadicar: document.getElementById('ic-mesRad').value,
    inicioRatificar: document.getElementById('ic-inicio').value,
    diaRatificar1: diaRat1,            // 2 d√≠gitos
    mesRatificar1: document.getElementById('ic-mesRat1').value,
    finRatificar: document.getElementById('ic-fin').value,
    diaRatificar2: diaRat2,            // 2 d√≠gitos
    mesRatificar2: document.getElementById('ic-mesRat2').value,
    saldoActual: String(saldo),
    cobro: String(cobro),
    nuevoSaldo: String(nuevoSaldo),
    planilla: String(numPure(document.getElementById('ic-planilla').value)),
    mesPlanilla: document.getElementById('ic-mesPlanilla').value,
    base: String(base),
    salud: String(numPure(document.getElementById('ic-salud').value)),
    fondo: String(numPure(document.getElementById('ic-fondo').value)),
    riesgos: String(numPure(document.getElementById('ic-riesgos').value)),
    solidario: String(solidario),
    aporte: aporte,
    planilla2: emptyIfZero(document.getElementById('ic-planilla2').value||''),
    mesPlanilla2: document.getElementById('ic-mesPlanilla2').value || '',
    base2: emptyIfZero(document.getElementById('ic-base2').value||''),
    salud2: emptyIfZero(document.getElementById('ic-salud2').value||''),
    fondo2: emptyIfZero(document.getElementById('ic-fondo2').value||''),
    riesgos2: emptyIfZero(document.getElementById('ic-riesgos2').value||''),
    solidario2: emptyIfZero(document.getElementById('ic-solidario2').value||''),
    aporte2: aporte2,
    actividades,
    evidenciasData,
    bankPlanPdfs: await collectBankPlanPdfsBase64_(),
    novedadesPdfs: novedadesPdfs,
    novedadesMeta: { maxMb: MAX_NOVEDADES_MB },
    bankPlanMeta: { maxMb: MAX_PDF_MB },
    overwrite: !IC_STATE.nextMode && IC_STATE.cuentaExiste
  };

  // Resumen breve para confirmar
    // Resumen breve para confirmar (incluye campos visibles, excepto actividades/evidencias)
  const resumenParts = [
    `<b>Informe:</b> ${body.informe} de ${body.total}`,
    `<b>Periodo:</b> ${body.inicioRatificar} ‚Äî ${body.finRatificar}`,
    `<b>Radicaci√≥n:</b> ${body.fechaRadicar} (${body.diaRadicar} / ${body.mesRadicar})`,
    `<b>Saldo Actual:</b> ${formatCOPView(body.saldoActual)}`,
    `<b>Valor por Cobrar:</b> ${formatCOPView(body.cobro)}`,
    `<b>Nuevo Saldo:</b> ${formatCOPView(body.nuevoSaldo)}`,
    `<b>Planilla:</b> ${body.planilla || '-'}`,
    `<b>Mes Planilla:</b> ${body.mesPlanilla || '-'}`,
    `<b>Base de Cotizaci√≥n:</b> ${formatCOPView(body.base)}`,
    `<b>Aportes Salud:</b> ${formatCOPView(body.salud)}`,
    `<b>Aportes Pensi√≥n:</b> ${formatCOPView(body.fondo)}`,
    `<b>Aportes ARL:</b> ${formatCOPView(body.riesgos)}`,
    `<b>Aporte Solidario:</b> ${formatCOPView(body.solidario)}`,
    `<b>Aporte (entidad):</b> ${body.aporte || '-'}`
  ];

  // Solo mostrar campos de Planilla Anexa si tienen alg√∫n valor
  if (body.planilla2 || body.mesPlanilla2 || body.base2 || body.salud2 || body.fondo2 || body.riesgos2 || body.solidario2 || body.aporte2) {
    if (body.planilla2)     resumenParts.push(`<b>Planilla Anexa:</b> ${body.planilla2}`);
    if (body.mesPlanilla2)  resumenParts.push(`<b>Mes Planilla Anexa:</b> ${body.mesPlanilla2}`);
    if (body.base2)         resumenParts.push(`<b>Base Anexa:</b> ${formatCOPView(body.base2)}`);
    if (body.salud2)        resumenParts.push(`<b>Salud Anexa:</b> ${formatCOPView(body.salud2)}`);
    if (body.fondo2)        resumenParts.push(`<b>Pensi√≥n Anexa:</b> ${formatCOPView(body.fondo2)}`);
    if (body.riesgos2)      resumenParts.push(`<b>ARL Anexa:</b> ${formatCOPView(body.riesgos2)}`);
    if (body.solidario2)    resumenParts.push(`<b>Aporte Solidario Anexo:</b> ${formatCOPView(body.solidario2)}`);
    if (body.aporte2)       resumenParts.push(`<b>Aporte Anexo (entidad):</b> ${body.aporte2}`);
  }

  const resumen = resumenParts.join('<br>');

  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Ingreso', html:resumen,
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar'
  });
  if(!rs.isConfirmed) return;

  // Suprime el loader nativo durante este flujo
  suppressLoader = true;
  loadingCount = 0;
  if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }

  const prevLoaderDisplay = loader?.style.display;
  if(loader){ loader.classList.add('hidden'); loader.style.display = 'none'; }

  // Texto distinto seg√∫n sea ingreso o correcci√≥n
const isCorrection = (IC_MODE === 'correccion');
const waitSwal = Swal.fire({
  title: isCorrection ? 'REGENERANDO TUS DOCUMENTOS...' : 'CREANDO TUS DOCUMENTOS...',
  html: 'Por favor espera un par de minutos mientras termina el proceso.<br><br><b>Entre 1.50 y 2.30 Minutos Aprox.</b> Estamos haciendo todo por ti üíö<br><br>No salgas de la App.',
  allowOutsideClick: false,
  allowEscapeKey: false,
  didOpen: () => { Swal.showLoading(); }
});

   try{
    const action = (IC_MODE === 'correccion') ? 'saveCorreccionCuenta' : 'saveNuevaCuenta';
    const r = await apiPost(action, body);
    await Swal.close();
   if(r && r.success){
  const isCorrection = (IC_MODE === 'correccion');
  if(r && r.success){
  const isCorrection = (IC_MODE === 'correccion');
  Swal.fire({
    icon:'success',
    title:'PROCESO FINALIZADO',
    html: `
      <div style="text-align:center; margin:10px 0 12px;">
        <img
          src="https://res.cloudinary.com/dqqeavica/image/upload/v1770141576/cuenta_drive_guoj5w.gif"
          alt="Cuenta Drive"
          style="width:220px; max-width:80vw; height:auto; display:block; margin:0 auto;"
        >
      </div>
      ${
        isCorrection
          ? 'La cuenta qued√≥ <b>CORREGIDA</b>.<br><br>Toma la opci√≥n <b>MI CUENTA DRIVE</b> en el Men√∫ Principal para revisar los Documentos Corregidos'
          : 'La cuenta qued√≥ <b>INGRESADA</b>.<br><br>Toma la opci√≥n <b>MI CUENTA DRIVE</b> en el Men√∫ Principal para revisar los Documentos Creados'
      }
    `,
    timer: 7000,
    showConfirmButton: false
  });
  }
  resetIngresarCuentaView();
  showView('view-inicio');
} else {
  Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
}
  }catch(e){
    await Swal.close();
    Swal.fire({ icon:'error', title:'Error', text:String(e.message||e) });
  }finally{
    // Restablece el loader y el flag
    suppressLoader = false;
    loadingCount = 0;
    if (loaderTimer){ clearTimeout(loaderTimer); loaderTimer = null; }
    if(loader){
      loader.style.display = prevLoaderDisplay || '';
      loader.classList.add('hidden');
    }
  }
});


/* ================== REGISTRO ================== */
let regFirmaDataUrl = '';
let regPreviewUrl = '';
const regFirmaInput = document.getElementById('reg-firma');
const regFirmaPreview = document.getElementById('reg-firma-preview');

if (regFirmaInput && regFirmaPreview) {
  regFirmaInput.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    regFirmaDataUrl = '';
    revokeObjUrl(regPreviewUrl);
    regPreviewUrl = '';

    if (!file) {
      regFirmaPreview.src = '';
      regFirmaPreview.style.display = 'none';
      return;
    }

    try {
      const { dataUrl, sizeMB } = await compressImageToDataUrl(file);
      if (sizeMB > MAX_IMAGE_MB) {
        await Swal.fire({
          icon: 'warning',
          title: 'Imagen muy pesada',
          text: `La firma supera ${MAX_IMAGE_MB} MB. Usa una foto m√°s liviana.`
        });
        regFirmaInput.value = '';
        regFirmaPreview.src = '';
        regFirmaPreview.style.display = 'none';
        return;
      }
      regPreviewUrl = URL.createObjectURL(file);
      regFirmaPreview.src = regPreviewUrl;
      regFirmaPreview.style.display = 'block';
      regFirmaDataUrl = dataUrl;
    } catch (err) {
      regFirmaPreview.src = '';
      regFirmaPreview.style.display = 'none';
      await Swal.fire({ icon: 'error', title: 'Error con la imagen', text: String(err.message || err) });
    }
  });
}
bindNumericSanitizer('reg-telefono', 10);
bindNumericSanitizer('reg-numeroCuenta', 16);

fillSelect('reg-banco', BANKS);
fillSelect('reg-eps', EPS);
fillSelect('reg-pension', AFP);
fillSelect('reg-arl', ARL);

bindQuery('reg-expedida','dl-expedida');
bindQuery('reg-municipio','dl-municipio');

document.getElementById('reg-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const telefonoRegex = /^[0-9]{10}$/;
  const correoRegex = /^[^\s@]+@(example\.org|nomedominio\.net|dominio\.edu\.co|examplo\.edu\.co|empresa\.com|nombreempresa\.org|correo\.es|dominio\.es|outlook\.com|hotmail\.com|live\.com|gmail\.com|icloud\.com|me\.com)$/; // solo dominios expl√≠citos
  const numeroCuentaRaw = (document.getElementById('reg-numeroCuenta').value||'').replace(/\D/g,'');
  const body = {
    documento: currentUser.documento,
    expedida: document.getElementById('reg-expedida').value.trim(),
    telefono: document.getElementById('reg-telefono').value.trim(),
    direccion: document.getElementById('reg-direccion').value.trim(),
    municipio: document.getElementById('reg-municipio').value.trim(),
    correo: document.getElementById('reg-correo').value.trim(),
    tipoCuenta: document.getElementById('reg-tipoCuenta').value,
    numeroCuenta: numeroCuentaRaw,
    banco: document.getElementById('reg-banco').value,
    eps: document.getElementById('reg-eps').value,
    pension: document.getElementById('reg-pension').value,
    arl: document.getElementById('reg-arl').value,
    firmaDataUrl: regFirmaDataUrl || '',
    cumpleISO: __cumpleISO || '' // se llena desde el modal
  };
  // Requeridos
  const requiredOk = body.expedida && body.telefono && body.direccion && body.municipio && body.correo && body.tipoCuenta && body.numeroCuenta && body.banco && body.eps && body.pension && body.arl && body.firmaDataUrl && body.cumpleISO;
  if(!requiredOk){ Swal.fire({icon:'warning', title:'Faltan campos Requeridos'}); return; }
  if(!telefonoRegex.test(body.telefono)){ Swal.fire({icon:'warning', title:'Whatsapp inv√°lido'}); return; }
  if(!correoRegex.test(body.correo)){ Swal.fire({icon:'warning', title:'Correo inv√°lido'}); return; }
  if(!(body.numeroCuenta.length>=7 && body.numeroCuenta.length<=16)){ Swal.fire({icon:'warning', title:'N√∫mero de cuenta inv√°lido'}); return; }

  // Validaci√≥n exacta de municipios (expedida/municipio) en GS tambi√©n, pero aplicamos verificaci√≥n previa
  const exactExp = await apiGet('validateMunicipioExact', { nombre: body.expedida });
  const exactMup = await apiGet('validateMunicipioExact', { nombre: body.municipio });
  if(!exactExp || !exactMup){
    Swal.fire({icon:'warning', title:'Municipio inv√°lido', text:'Debe coincidir exactamente con la lista.'});
    return;
  }

  const resumenHtml = [
    body.expedida && `<b>Municipio de Expedici√≥n:</b> ${body.expedida}`,
    body.telefono && `<b>Whatsapp:</b> ${body.telefono}`,
    body.direccion && `<b>Direcci√≥n:</b> ${body.direccion}`,
    body.municipio && `<b>Municipio de Residencia:</b> ${body.municipio}`,
    body.correo && `<b>Correo:</b> ${body.correo}`,
    `<b>Cuenta:</b> ${body.numeroCuenta} ${body.tipoCuenta} ${body.banco}`,
    `<b>EPS:</b> ${body.eps}`,
    `<b>AFP:</b> ${body.pension}`,
    `<b>ARL:</b> ${body.arl}`
  ].filter(Boolean).join('<br>') + `<br><br><img class="brand" src="https://res.cloudinary.com/dqqeavica/image/upload/v1763921425/Digital_sw3wk9.gif" alt="">`;

  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Registro', html:resumenHtml,
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

    try{
    const r = await apiPost('saveRegistro', body);
    if(r && r.success){
      const nombreCorto = r.nombreCorto || '';
      const telefonoRaw = body.telefono || '';
      const numero57 = normalizeNumber57(telefonoRaw);

      if(numero57){
        const msg =
          '*¬°Haz completado tu registro ' + (nombreCorto || '') + '!*' + '\n\n' +
          'Para mi es importante que selecciones tu *Correo Personal* al abrir y aceptar esta invitaci√≥n: https://tinyurl.com/AF-CALENDARIO-INSTITUCIONAL\n' +
          'Con esto sabr√© que estar√°s en l√≠nea con cada evento insitucional para potenciar nuestro sentido de pertenencia. Quedo atenta.\n\n' +
          '¬°Un abrazo!\n\n' +
          '*ANA JUDITH GAMBOA MANTILLA*\n' +
          '> Alcaldesa';

        sendBuilderbotMessage(numero57, msg);
      }

      await Swal.fire({ icon:'success', title:'Registro Exitoso', timer:1800, showConfirmButton:false });
      await cargarInicio();
      showView('view-inicio');
      await Swal.fire({
  icon: 'info',
  title: 'COMPLETA LOS DATOS DEL CONTRATO',
  html: `
    <div style="text-align:center;">
      <div style="font-weight:700; margin-bottom:10px;">
        Cuando tengas el Acta de Inicio y RP, completa los datos
      </div>

      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1770135185/datos_contrato_lmct1e.gif"
        alt="Datos del contrato"
        style="width:220px; max-width:75vw; height:auto; display:block; margin:0 auto 10px;"
      >

      <div style="font-weight:800;">
        ¬°Evita los reprocesos antes de Registrar tu 1ra Cuenta!
      </div>
    </div>
  `,
  confirmButtonText: 'OK',
  showConfirmButton: true,
  allowOutsideClick: true,
  allowEscapeKey: true
});
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
document.getElementById('reg-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-login'); });

/* ================== CONTRATO (lectura + edici√≥n) ================== */
document.getElementById('contrato-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-inicio'); });
document.getElementById('contrato-editar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  document.getElementById('contrato-form').classList.remove('hidden');
});

bindNumericSanitizer('c-meses', 3);
bindNumericSanitizer('c-dias', 3);
bindNumericSanitizer('c-rp', 10);
bindNumericSanitizer('c-rpAdicion', 10);


function convertirNumeroATexto(n){
  const unidades=["","UN","DOS","TRES","CUATRO","CINCO","SEIS","SIETE","OCHO","NUEVE"];
  const especiales=["DIEZ","ONCE","DOCE","TRECE","CATORCE","QUINCE","DIECISEIS","DIECISIETE","DIECIOCHO","DIECINUEVE"];
  const decenas=["","DIEZ","VEINTE","TREINTA","CUARENTA","CINCUENTA","SESENTA","SETENTA","OCHENTA","NOVENTA"];
  const centenas=["","CIENTO","DOSCIENTOS","TRESCIENTOS","CUATROCIENTOS","QUINIENTOS","SEISCIENTOS","SETECIENTOS","OCHOCIENTOS","NOVECIENTOS"];
  function cDec(n){ if(n<10) return unidades[n]; if(n<20) return especiales[n-10];
    if(n===20) return "VEINTE"; if(n<30) return "VEINTI"+unidades[n%10];
    return decenas[Math.floor(n/10)] + (n%10 ? " Y " + unidades[n%10] : "");
  }
  function cCent(n){ if(n===100) return "CIEN"; if(n>100) return (centenas[Math.floor(n/100)]+" "+cDec(n%100)).trim(); return cDec(n); }
  function cMiles(n){ if(n<1000) return cCent(n);
    if(n<1000000){ const miles=Math.floor(n/1000), resto=n%1000;
      if(miles===1) return ("MIL "+(resto?cCent(resto):"")).trim();
      return (cCent(miles)+" MIL "+(resto?cCent(resto):"")).trim();
    }
    const millones=Math.floor(n/1000000), resto=n%1000000;
    if(millones===1) return ("UN MILL√ìN "+(resto?cMiles(resto):"")).trim();
    return (cCent(millones)+" MILLONES "+(resto?cMiles(resto):"")).trim();
  }
  let t=cMiles(parseInt(n||0,10)); if(t.endsWith(" UNO")) t=t.slice(0,-4)+" UN"; return t;
}

/* ‚úÖ NUEVO: recalcula siempre el campo Tiempo de ejecuci√≥n desde los valores EDITADOS (meses/d√≠as) */
function actualizarEjecucionDesdeInputs(){
  const meses = parseInt((document.getElementById('c-meses')?.value || '0'), 10) || 0;
  const dias  = parseInt((document.getElementById('c-dias')?.value  || '0'), 10) || 0;

  let txt = '';
  if(meses > 0){
    txt += `${convertirNumeroATexto(meses)} (${meses}) ${meses===1?'MES':'MESES'}`;
  }
  if(dias > 0){
    if(txt !== '') txt += ' Y ';
    txt += `${convertirNumeroATexto(dias)} (${dias}) ${dias===1?'DIA':'DIAS'}`;
  }

  const ejecEl = document.getElementById('c-ejecucion');
  if(ejecEl) ejecEl.value = txt;
}

/* ‚úÖ NUEVO: cuando el usuario edita meses/d√≠as, actualiza "Tiempo de ejecuci√≥n" inmediatamente */
document.getElementById('c-meses')?.addEventListener('input', actualizarEjecucionDesdeInputs);
document.getElementById('c-dias')?.addEventListener('input', actualizarEjecucionDesdeInputs);

function getDaysInMonth(y,m){ return new Date(y, m+1, 0).getDate(); }
function calcularPlazo(){
  const fi = __fechaInicioISO; // desde picker ruleta
  const ft = __fechaTerminoISO; // desde picker ruleta
  const mesesEl = document.getElementById('c-meses');
  const diasEl = document.getElementById('c-dias');
  if(!fi || !ft){
    mesesEl.value=0; diasEl.value=0; actualizarEjecucion(); return;
  }
  const [di,mi,yi] = fi.split('/').map(x=>parseInt(x,10));
  const [dt,mt,yt] = ft.split('/').map(x=>parseInt(x,10));
  let fechaInicio = new Date(yi, mi-1, di);
  let fechaTermino = new Date(yt, mt-1, dt);
  if(isNaN(fechaInicio)||isNaN(fechaTermino)||fechaTermino<fechaInicio){
    mesesEl.value=0; diasEl.value=0; actualizarEjecucion(); return;
  }
  // Contar ambos extremos (incluye d√≠a final)
  let diffTime = Math.abs(fechaTermino - fechaInicio) + (1000*60*60*24);
  let diffDays = Math.ceil(diffTime / (1000*60*60*24));
  let meses=0, dias=0;
  while(diffDays>0){
    const dim = getDaysInMonth(fechaInicio.getFullYear(), fechaInicio.getMonth());
    if(diffDays >= dim){
      meses++; diffDays -= dim; fechaInicio.setMonth(fechaInicio.getMonth()+1);
    }else{ dias = diffDays; diffDays = 0; }
  }
  mesesEl.value = meses;
  diasEl.value = dias;
  actualizarEjecucionDesdeInputs();
}

document.getElementById('c-rp').addEventListener('input', ()=>{
  const el = document.getElementById('c-rp');
  const raw = (el.value||'').replace(/\D/g,'').slice(0,10);
  el.value = raw;
  el.style.border = '';
  if(raw.length===10 && raw.startsWith('2026')){
    el.style.border = '2px solid green';
  }
});

  document.getElementById('c-rpAdicion').addEventListener('input', ()=>{
  const el = document.getElementById('c-rpAdicion');
  const raw = (el.value||'').replace(/\D/g,'').slice(0,10);
  el.value = raw;
  el.style.border = '';
  if(raw.length===10 && raw.startsWith('2026')){
    el.style.border = '2px solid green';
  }
});

document.getElementById('c-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const fechaInicioISO = __fechaInicioISO || '';
  const fechaTerminoISO = __fechaTerminoISO || '';
  const mesesVal = document.getElementById('c-meses').value || '';
  const diasVal  = document.getElementById('c-dias').value  || '';

  const body = {
    documento: currentUser.documento,
    fechaInicioISO: fechaInicioISO,
    diaInicio: document.getElementById('c-diaInicio').value||'',
    mesInicio: document.getElementById('c-mesInicio').value||'',
    fechaTerminoISO: fechaTerminoISO,
    diaTermino: document.getElementById('c-diaTermino').value||'',
    mesTermino: document.getElementById('c-mesTermino').value||'',
    meses: (fechaInicioISO || fechaTerminoISO) ? (mesesVal || '0') : '',
    dias: (fechaInicioISO || fechaTerminoISO) ? (diasVal  || '0') : '',
    ejecucion: document.getElementById('c-ejecucion').value||'',
    rp: (document.getElementById('c-rp').value||'').replace(/\D/g,''),
    rpAdicion: (document.getElementById('c-rpAdicion').value||'').replace(/\D/g,''),
    regimen: document.getElementById('c-regimen').value||'',
    factura: document.getElementById('c-factura').value||'',
    costos: document.getElementById('c-costos').value||''
  };

      const hayCambiosContrato =
    !!(body.fechaInicioISO || body.fechaTerminoISO || body.rp || body.rpAdicion || body.costos || body.regimen) ||
    (!!body.meses && String(body.meses) !== '0') ||
    (!!body.dias  && String(body.dias)  !== '0') ||
    !!body.ejecucion;

if (!hayCambiosContrato) {
  Swal.fire({ icon:'info', title:'Sin cambios', text:'No hay campos editados para guardar.' });
  return;
}

  // Resumen: solo campos editados (no vac√≠os)
    const resumen = [];
  if(body.fechaInicioISO) resumen.push(`<b>Fecha de Inicio:</b> ${body.fechaInicioISO}`);
  if(body.fechaTerminoISO) resumen.push(`<b>Fecha de Terminaci√≥n:</b> ${body.fechaTerminoISO}`);
  if((body.fechaInicioISO || body.fechaTerminoISO) && (body.meses || body.dias)){
    resumen.push(`<b>Meses/D√≠as:</b> ${body.meses||'0'} / ${body.dias||'0'}`);
  }
  if(body.ejecucion) resumen.push(`<b>Tiempo de Ejecuci√≥n:</b> ${body.ejecucion}`);
  if(body.rp) resumen.push(`<b>RP:</b> ${body.rp}`);
  if(body.rpAdicion) resumen.push(`<b>RP Adici√≥n:</b> ${body.rpAdicion}`);
  if(body.regimen) resumen.push(`<b>R√©gimen Simple:</b> ${body.regimen}`);
  if(body.factura) resumen.push(`<b>Factura electr√≥nica:</b> ${body.factura}`);
  if(body.costos) resumen.push(`<b>Costos y deducciones:</b> ${body.costos}`);

  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Cambios', html:resumen.join('<br>'),
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  try{
    const r = await apiPost('saveDatosContrato', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Actualizaci√≥n Exitosa', timer:1600, showConfirmButton:false });
      await cargarContratoLectura();
      document.getElementById('contrato-form').classList.add('hidden');
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});
document.getElementById('c-cancelar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  document.getElementById('contrato-form').classList.add('hidden');
});

/* ================== PERSONALES (lectura + edici√≥n) ================== */
let pFirmaDataUrl = '';
let pPreviewUrl = '';
const pFirmaInput = document.getElementById('p-firma');
const pFirmaPreview = document.getElementById('p-firma-preview');

if (pFirmaInput && pFirmaPreview) {
  pFirmaInput.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    pFirmaDataUrl = '';
    revokeObjUrl(pPreviewUrl);
    pPreviewUrl = '';

    if (!file) {
      pFirmaPreview.src = '';
      pFirmaPreview.style.display = 'none';
      return;
    }

    try {
      const { dataUrl, sizeMB } = await compressImageToDataUrl(file);
      if (sizeMB > MAX_IMAGE_MB) {
        await Swal.fire({
          icon: 'warning',
          title: 'Imagen muy pesada',
          text: `La firma supera ${MAX_IMAGE_MB} MB. Usa una foto m√°s liviana.`
        });
        pFirmaInput.value = '';
        pFirmaPreview.src = '';
        pFirmaPreview.style.display = 'none';
        return;
      }
      pPreviewUrl = URL.createObjectURL(file);
      pFirmaPreview.src = pPreviewUrl;
      pFirmaPreview.style.display = 'block';
      pFirmaDataUrl = dataUrl;
    } catch (err) {
      pFirmaPreview.src = '';
      pFirmaPreview.style.display = 'none';
      await Swal.fire({ icon: 'error', title: 'Error con la imagen', text: String(err.message || err) });
    }
  });
}
bindNumericSanitizer('p-telefono', 10);
bindNumericSanitizer('p-numeroCuenta', 16);

fillSelect('p-banco', BANKS);
fillSelect('p-eps', EPS);
fillSelect('p-pension', AFP);
fillSelect('p-arl', ARL);

bindQuery('p-expedida','dl-expedida2');
bindQuery('p-municipio','dl-municipio2');

document.getElementById('personales-volver').addEventListener('click', ()=>{ playSoundOnce(SOUNDS.back); showView('view-inicio'); });
document.getElementById('personales-editar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.login);
  document.getElementById('personales-form').classList.remove('hidden');
});
document.getElementById('p-cancelar').addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  document.getElementById('personales-form').classList.add('hidden');
});

document.getElementById('p-guardar').addEventListener('click', async ()=>{
  if(!currentUser){ Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); return; }
  const telefonoRegex = /^[0-9]{10}$/;
  const correoRegex = /^[^\s@]+@(example\.org|nomedominio\.net|dominio\.edu\.co|examplo\.edu\.co|empresa\.com|nombreempresa\.org|correo\.es|dominio\.es|outlook\.com|hotmail\.com|live\.com|gmail\.com|icloud\.com|me\.com)$/;

  const body = {
    documento: currentUser.documento,
    expedida: document.getElementById('p-expedida').value.trim(),
    telefono: document.getElementById('p-telefono').value.trim(),
    direccion: document.getElementById('p-direccion').value.trim(),
    municipio: document.getElementById('p-municipio').value.trim(),
    correo: document.getElementById('p-correo').value.trim(),
    tipoCuenta: document.getElementById('p-tipoCuenta').value,
    numeroCuenta: (document.getElementById('p-numeroCuenta').value||'').replace(/\D/g,''),
    banco: document.getElementById('p-banco').value,
    eps: document.getElementById('p-eps').value,
    pension: document.getElementById('p-pension').value,
    arl: document.getElementById('p-arl').value,
    firmaDataUrl: pFirmaDataUrl || '',
    cumpleISO: __cumpleISO || ''
  };

  // Validaci√≥n exacta (expedida/municipio) si vienen
  if(body.expedida){
    const ok = await apiGet('validateMunicipioExact', { nombre: body.expedida });
    if(!ok){ Swal.fire({icon:'warning', title:'Municipio de Expedici√≥n inv√°lido', text:'Debe coincidir exactamente con la lista.'}); return; }
  }
  if(body.municipio){
    const ok = await apiGet('validateMunicipioExact', { nombre: body.municipio });
    if(!ok){ Swal.fire({icon:'warning', title:'Municipio de Residencia inv√°lido', text:'Debe coincidir exactamente con la lista.'}); return; }
  }

   const hayCambiosPersonales = [
  'expedida','telefono','direccion','municipio','correo',
  'tipoCuenta','numeroCuenta','banco','eps','pension','arl',
  'firmaDataUrl','cumpleISO'
].some(k => {
  const v = body[k];
  return v !== undefined && v !== null && String(v).trim() !== '';
});

if (!hayCambiosPersonales) {
  Swal.fire({ icon:'info', title:'Sin cambios', text:'No hay campos editados para guardar.' });
  return;
}
  
  // Resumen solo campos editados
  const resumen = [];
  Object.entries(body).forEach(([k,v])=>{
    if(k!=='documento' && v){ resumen.push(`<b>${k}:</b> ${k==='numeroCuenta' ? v : v}`); }
  });
  const rs = await Swal.fire({
    icon:'info', title:'Resumen de Cambios', html:resumen.join('<br>'),
    showCancelButton:true, confirmButtonText:'Confirmar', cancelButtonText:'Editar', soundTag:'resumen'
  });
  if(!rs.isConfirmed) return;

  if(body.telefono && !telefonoRegex.test(body.telefono)){ Swal.fire({icon:'warning', title:'Whatsapp inv√°lido'}); return; }
  if(body.correo && !correoRegex.test(body.correo)){ Swal.fire({icon:'warning', title:'Correo inv√°lido'}); return; }
  if(body.numeroCuenta && !(body.numeroCuenta.length>=7 && body.numeroCuenta.length<=16)){ Swal.fire({icon:'warning', title:'N√∫mero de cuenta inv√°lido'}); return; }

  try{
    const r = await apiPost('saveDatosPersonales', body);
    if(r && r.success){
      await Swal.fire({ icon:'success', title:'Actualizaci√≥n Exitosa', timer:1600, showConfirmButton:false });
      await cargarPersonalesLectura();
      document.getElementById('personales-form').classList.add('hidden');
    }else{
      Swal.fire({ icon:'error', title:'Error al guardar', text:r?.message || 'Error desconocido' });
    }
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:e.message });
  }
});

/* ================== CONTRATO: cargar lectura ================== */
async function cargarContratoLectura(){
  if(!currentUser) return;
  const d = await apiGet('getDatosContrato', { documento: currentUser.documento });
  const box = document.getElementById('contrato-lectura');
  const lines = [
    `<b>Secretar√≠a:</b> ${d.secretaria||''}`,
    `<b>Supervisor:</b> ${d.supervisor||''}`,
    `<b>Contrato N¬∞:</b> ${d.contrato||''} <b>de:</b> ${d.fechaContrato||''}`,
    `<b>Tipo de Contrato:</b> ${d.tipoContrato||''}`,
    `<b>Objeto:</b> ${d.objeto||''}`,
    `<b>Fecha de Inicio:</b> ${d.fechaInicio||''}`,
    `<b>Fecha de Terminaci√≥n:</b> ${d.fechaTermino||''}`,
    `<b>Valor Inicial:</b> ${d.valor||''}`,
    `<b>MRA:</b> ${d.mar||''}`,
    `<b>Valor Final:</b> ${d.valorFinal||''}`,
    `<b>CDP:</b> ${d.cdp||''}`,
    `<b>RP:</b> ${d.rp||''}`,
    `<b>CDP Adici√≥n:</b> ${d.cdpAdicion||''}`,
    `<b>RP Adici√≥n:</b> ${d.rpAdicion||''}`,
    `<b>Regimen Simple:</b> ${d.regimen||''}`
  ];
  (d.obligaciones||[]).forEach((o,i)=>{ lines.push(`<b>Obligaci√≥n ${i+1}:</b> ${o}`); });
  box.innerHTML = lines.map(l=>`<p>${l}</p>`).join('');
}

/* ================== PERSONALES: cargar lectura ================== */
async function cargarPersonalesLectura(){
  if(!currentUser) return;
  const d = await apiGet('getDatosPersonales', { documento: currentUser.documento });
  const box = document.getElementById('personales-lectura');
  const lines = [
    `<b>NOMBRE:</b> ${d.nombre||''}`,
    `<b>CC:</b> ${d.documento||''}`,
    `<b>EXPEDIDA:</b> ${d.expedida||''}`,
    `<b>WHATSAPP:</b> ${d.telefono||''}`,
    `<b>DIRECCI√ìN:</b> ${d.direccion||''}`,
    `<b>MUNICIPIO:</b> ${d.municipio||''}`,
    `<b>CORREO:</b> ${d.correo||''}`,
    `<b>CUENTA:</b> ${d.cuenta||''} ${d.tipoCuenta||''} ${d.banco||''}`,
    `<b>EPS:</b> ${d.eps||''}`,
    `<b>AFP:</b> ${d.pension||''}`,
    `<b>ARL:</b> ${d.arl||''}`,
    `<b>FECHA DE NACIMIENTO:</b> ${d.cumple||''}`
  ];
  box.innerHTML = lines.map(l=>`<p>${l}</p>`).join('');
}

   // ================== DIRECTORIO INSTITUCIONAL ==================
const ICON_DIR_MAPS   = 'https://res.cloudinary.com/dqqeavica/image/upload/v1760108968/ubicacion_zicnod.png';
const ICON_DIR_MAIL   = 'https://res.cloudinary.com/dqqeavica/image/upload/v1766266810/correo_czyyra.webp';
const ICON_DIR_WA     = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759166341/WhatsApp_mljaqm.webp';
const ICON_DIR_TEL    = 'https://res.cloudinary.com/dqqeavica/image/upload/v1759952569/Llamada_hra2ch.webp';
const ICON_DIR_SHARE  = 'https://res.cloudinary.com/dqqeavica/image/upload/v1766267125/compartir_szoxv7.webp';

function normalizePhoneDigits(raw){
  return String(raw || '').replace(/\D/g,'');
}

function openWhatsAppFromNumber(raw){
  const digits = normalizePhoneDigits(raw);
  if(!digits) return;
  let num = digits;
  if(/^\d{10}$/.test(num)){
    num = '57' + num;
  }
  const url = 'https://wa.me/' + num;
  window.open(url, '_blank');
}

function openTelFromNumber(raw){
  const digits = normalizePhoneDigits(raw);
  if(!digits) return;
  window.location.href = 'tel:' + digits;
}

function buildShareText(item){
  const nombre   = item.nombre   || '';
  const dir      = item.direccion|| '';
  const maps     = item.maps     || '';
  const correo   = item.correo   || '';
  const wa       = item.whatsapp || '';
  const tel      = item.telefono || '';

  const waDigits = normalizePhoneDigits(wa);
  const waUrl    = waDigits ? ('wa.me/' + waDigits) : '';

  return (
    '*INFORMACI√ìN DE CONTACTO:*\n\n' +
    '*CONTACTO:* ' + (nombre || '-') + '\n' +
    '*DIRECCI√ìN:* ' + (dir || '-') + '\n' +
    '*UBICACI√ìN:* ' + (maps || '-') + '\n' +
    '*CORREO:* ' + (correo || '-') + '\n' +
    '*WHATSAPP:* ' + (waUrl || '-') + '\n' +
    '*TELEFONO:* ' + (tel || '-')
  );
}

function buildClipboardText(item){
  const nombre   = item.nombre   || '';
  const dir      = item.direccion|| '';
  const correo   = item.correo   || '';
  const wa       = item.whatsapp || '';
  const tel      = item.telefono || '';

  return (
    'CONTACTO: ' + (nombre || '-') + '\n' +
    'DIRECCI√ìN: ' + (dir || '-') + '\n' +
    'CORREO: ' + (correo || '-') + '\n' +
    'WHATSAPP: ' + (wa || '-') + '\n' +
    'TELEFONO: ' + (tel || '-')
  );
}

async function showDirectorioShareDialog(item){
  const html =
    '<b>CONTACTO:</b> ' + (item.nombre || '-') + '<br>' +
    '<b>DIRECCI√ìN:</b> ' + (item.direccion || '-') + '<br>' +
    '<b>CORREO:</b> ' + (item.correo || '-') + '<br>' +
    '<b>WHATSAPP:</b> ' + (item.whatsapp || '-') + '<br>' +
    '<b>TELEFONO:</b> ' + (item.telefono || '-');

  const result = await Swal.fire({
    icon:'success',
    title:'Informaci√≥n de Contacto',
    html:html,
    showDenyButton:true,
    showCancelButton:true,
    confirmButtonText:'Copiar Portapapeles',
    denyButtonText:'Compartir',
    cancelButtonText:'Atr√°s'
  });

  if(result.isConfirmed){
    const text = buildClipboardText(item);
    try{
      if(navigator.clipboard && navigator.clipboard.writeText){
        await navigator.clipboard.writeText(text);
      }
      await Swal.fire({
        icon:'success',
        title:'Informaci√≥n Copiada',
        timer:2000,
        showConfirmButton:false
      });
    }catch(e){
      await Swal.fire({
        icon:'error',
        title:'No se pudo copiar',
        text:String(e.message||e)
      });
    }
    return;
  }

  if(result.isDenied){
    const shareText = buildShareText(item);
    const esMovil = /android|iphone|ipad|mobile/i.test(navigator.userAgent || '');
    const enc = encodeURIComponent(shareText);
    const url = esMovil
      ? 'whatsapp://send?text=' + enc
      : 'https://api.whatsapp.com/send?text=' + enc;
    window.open(url,'_blank');
  }
}

function renderDirectorio(items){
  const wrap = document.getElementById('dir-list');
  if(!wrap) return;
  wrap.innerHTML = '';

  if(!items.length){
    const p = document.createElement('p');
    p.className = 'muted center';
    p.textContent = 'No hay contactos institucionales disponibles.';
    wrap.appendChild(p);
    return;
  }

  items.forEach(it => {
    const item = document.createElement('div');
    item.className = 'contact-item';

    const main = document.createElement('div');
    main.className = 'contact-main';

    const nameEl = document.createElement('div');
    nameEl.className = 'contact-name';
    nameEl.textContent = it.nombre || '';

    const addrEl = document.createElement('div');
    addrEl.className = 'contact-address';
    addrEl.textContent = it.direccion || '';

    main.appendChild(nameEl);
    main.appendChild(addrEl);
    item.appendChild(main);

    const actions = document.createElement('div');
    actions.className = 'contact-actions-row';

    // Maps (columna D)
    if(it.maps){
      const a = document.createElement('a');
      a.href = it.maps;
      a.target = '_blank';
      a.rel = 'noopener';
      const img = document.createElement('img');
      img.src = ICON_DIR_MAPS;
      img.alt = '';
      a.appendChild(img);
      actions.appendChild(a);
    }

    // Correo (columna E)
    if(it.correo){
      const a = document.createElement('a');
      a.href = 'mailto:' + it.correo;
      const img = document.createElement('img');
      img.src = ICON_DIR_MAIL;
      img.alt = '';
      a.appendChild(img);
      actions.appendChild(a);
    }

    // WhatsApp (columna F)
    if(it.whatsapp){
      const a = document.createElement('a');
      a.href = 'javascript:void(0)';
      a.addEventListener('click', ()=> openWhatsAppFromNumber(it.whatsapp));
      const img = document.createElement('img');
      img.src = ICON_DIR_WA;
      img.alt = '';
      a.appendChild(img);
      actions.appendChild(a);
    }

    // Tel√©fono (columna G)
    if(it.telefono){
      const a = document.createElement('a');
      a.href = 'javascript:void(0)';
      a.addEventListener('click', ()=> openTelFromNumber(it.telefono));
      const img = document.createElement('img');
      img.src = ICON_DIR_TEL;
      img.alt = '';
      a.appendChild(img);
      actions.appendChild(a);
    }

    // Bot√≥n compartir (siempre)
    const btnShare = document.createElement('button');
    const imgShare = document.createElement('img');
    imgShare.src = ICON_DIR_SHARE;
    imgShare.alt = '';
    btnShare.appendChild(imgShare);
    btnShare.addEventListener('click', ()=> showDirectorioShareDialog(it));
    actions.appendChild(btnShare);

    item.appendChild(actions);
    wrap.appendChild(item);
  });
}

// Bot√≥n Regresar en vista directorio
document.getElementById('dir-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

  
/* ================== PWA AVANZADO ================== */
let deferredPrompt = null;
let __installStartShown = false;    // bandera: ya mostramos "App instal√°ndose"
let __installSuccessShown = false;  // bandera: ya mostramos "Instalaci√≥n exitosa"

function isStandalone(){
  const dmStandalone = window.matchMedia('(display-mode: standalone)').matches;
  const dmInstalled  = window.matchMedia('(display-mode: installed)').matches;
  const iosStandalone = (window.navigator.standalone === true);
  return dmStandalone || dmInstalled || iosStandalone;
}
function isIOS(){
  return /(iphone|ipad|ipod)/i.test(navigator.userAgent || '');
}
function isMarkedInstalled(){
  try{ return localStorage.getItem('pwaInstalledFlag') === '1'; }catch(_){ return false; }
}
function markInstalled(){
  try{ localStorage.setItem('pwaInstalledFlag', '1'); }catch(_){}
}
function clearInstalledMark(){
  try{ localStorage.removeItem('pwaInstalledFlag'); }catch(_){}
}
async function detectInstalled(){
  if (isStandalone()) return true;
  if (typeof navigator.getInstalledRelatedApps === 'function'){
    try{
      const apps = await navigator.getInstalledRelatedApps();
      const found = apps.some(a =>
        a.platform === 'webapp' &&
        typeof a.url === 'string' &&
        /manifest\.webmanifest$/.test(a.url)
      );
      if (found){
        markInstalled();
        return true;
      } else {
        clearInstalledMark();
      }
    }catch(_){}
  }
  return isMarkedInstalled();
}
function updateInstallButtonsVisibility(){
  const btn1 = document.getElementById('btn-instalar');
  const canPrompt = !!deferredPrompt;
  const installed = isMarkedInstalled() || isStandalone();
  const shouldShow = !installed && (canPrompt || isIOS());
  if(btn1) btn1.style.display = shouldShow ? '' : 'none';
}

window.addEventListener('beforeinstallprompt', (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  updateInstallButtonsVisibility();
});

window.addEventListener('appinstalled', ()=>{
  markInstalled();
  deferredPrompt = null;
  updateInstallButtonsVisibility();
});

document.getElementById('btn-instalar').addEventListener('click', async ()=>{
  // Flujo iOS: se respeta exactamente tu alerta e instrucciones
  if(isIOS()){
    Swal.fire({
      icon:'info',
      title: '¬°Para Instalar en tu Iphone!',
  html: `
    <div style="text-align:center; margin-top:8px;">
      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1765745210/instalacion_ios_ysbhnd.gif"
        alt="Instalaci√≥n de IOS"
        style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
      >
      <div style="margin-top:10px;">
        <b>1.</b> Toca Compartir.<br><b>2.</b> Elige "Agregar a pantalla de inicio".<br><b>3.</b> Confirma "Agregar".
      </div>
    </div>
  `,
    });
    return;
  }
  // Android: requiere beforeinstallprompt (deferredPrompt)
  if(!deferredPrompt){
    Swal.fire({icon:'info',title:'Instalaci√≥n no disponible todav√≠a'});
    return;
  }

  const dp = deferredPrompt;
  dp.prompt();                           // muestra di√°logo nativo de instalaci√≥n
  const choice = await dp.userChoice;    // espera la elecci√≥n del usuario
  deferredPrompt = null;                 // limpia el prompt (solo se usa una vez)

  if (choice.outcome === 'accepted'){
    // Primera alerta (Android): confirma inicio de instalaci√≥n por 6 segundos
    markInstalled();
    __installStartShown = true;
    Swal.fire({
  icon: 'success',
  title: '¬°App instal√°ndose!',
  html: `
    <div style="text-align:center; margin-top:8px;">
      <img
        src="https://res.cloudinary.com/dqqeavica/image/upload/v1765740540/instalacion_lydtcl.gif"
        alt="Instalando app"
        style="width:180px; max-width:70vw; height:auto; display:block; margin:0 auto 12px;"
      >
      <div>Debes esperar unos segundos mientras el sistema instala la App.</div>
      <div style="margin-top:10px;">
        <b>Al desaparecer este aviso, puedes salir de esta vista. La App aparecer√° en la pantalla principal de este dispositivo.</b>
      </div>
    </div>
  `,
  timer: 12000,
  showConfirmButton: false
});
  } else {
    Swal.fire({icon:'info',title:'Instalaci√≥n cancelada'});
  }

  updateInstallButtonsVisibility();
});

async function initPWAVista(){
  const installed = await detectInstalled();
  if (installed){
    showView('view-login');
  } else {
    showView('view-instalar');
    updateInstallButtonsVisibility();
  }
}
if ('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(()=>{});
  });
}
window.addEventListener('load', initPWAVista);
  
/* ================== Enviar soporte CONTRATISTA ================== */
document.getElementById('soporte-enviar')?.addEventListener('click', async ()=>{
  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }

  const texto = (document.getElementById('soporte-text').value || '').trim();
  if(!texto){
    Swal.fire({icon:'warning', title:'Debes escribir tu solicitud o sugerencia'});
    return;
  }

  try{
    const base = await apiGet('getSoporteContratista', { documento: currentUser.documento });
    if(!base || !base.found){
      Swal.fire({icon:'info', title:'No se encontr√≥ tu registro', text:'Valida primero tus datos en la App.'});
      return;
    }
    if(String(base.estado||'').toUpperCase() !== 'ACTIVO'){
      Swal.fire({icon:'info', title:'Contrato INACTIVO', text:'Solo contratistas ACTIVO pueden enviar soporte.'});
      return;
    }

    const nombreCompleto = base.nombre || '';
    const partes = String(nombreCompleto).trim().split(/\s+/);
    let nombreCorto = '';
    if(partes.length === 1){
      nombreCorto = partes[0];
    }else if(partes.length === 2 || partes.length === 3){
      nombreCorto = partes[0];
    }else if(partes.length >= 4){
      nombreCorto = partes[0] + ' ' + partes[1];
    }

    const payload = {
      documento: currentUser.documento,
      soporte: texto,
      celular: base.telefono || '',
      nombre: nombreCompleto,
      secretaria: base.secretaria || ''
    };

   const tel57 = normalizeNumber57(base.telefono || '');
if(tel57){
  const msg =
    'Estimado(a) *' + (nombreCorto || '') + '*\n\n' +
    'He recibido tu solicitud, la revisar√© en el menor tiempo posible y me pondr√© en contacto contigo para ayudarte.\n' +
    'Agradezco tu comprensi√≥n en mi tiempo de respuesta seg√∫n demanda o solicitudes.\n\n' +
    'Muchas gracias por ser parte de este gran Equipo.\n\n' +
    'Cordialmente;\n\n' +
    '*Oscar Polania*\n' +
    '> Desarrollador Gobierno Digital\n' +
    '> Alcald√≠a de Flandes';

  sendBuilderbotMessage(tel57, msg);
}

    await Swal.fire({
      icon:'success',
      title:'Solicitud enviada',
      text:'Pronto recibir√°s respuesta a trav√©s de WhatsApp.',
      timer:3500,
      showConfirmButton:false
    });
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});

    /* ================== Enviar SOLICITUD TESORERIA ================== */

    document.getElementById('go-solicitud-tesoreria')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }

  try{
    const info = await apiGet('getSolicitudTesoreriaBase', { documento: currentUser.documento });

    if(!info || !info.found){
      await Swal.fire({
        icon:'info',
        title:'NO TIENES ACCESO A ESTA OPCI√ìN',
        text:'Tu informaci√≥n de contrato a√∫n no est√° completa.',
        timer:4000,
        showConfirmButton:false
      });
      return;
    }

    document.getElementById('st-nombre').value = info.nombre || '';
    document.getElementById('st-secretaria').value = info.secretaria || '';
    document.getElementById('st-contrato').value = info.contrato || '';
    document.getElementById('st-telefono').value = info.telefono || '';

    document.getElementById('solicitud').value = '';

    showView('view-solicitud-tesoreria');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});

document.getElementById('st-volver')?.addEventListener('click', ()=>{
  playSoundOnce(SOUNDS.back);
  showView('view-inicio');
});

document.getElementById('st-enviar')?.addEventListener('click', async ()=>{
  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }

  const nombre = (document.getElementById('st-nombre').value || '').trim();
  const secretaria = (document.getElementById('st-secretaria').value || '').trim();
  const contrato = (document.getElementById('st-contrato').value || '').trim();
  const telefono = (document.getElementById('st-telefono').value || '').trim();
  const solicitud = (document.getElementById('solicitud').value || '').trim();

  if(!solicitud){
    Swal.fire({ icon:'warning', title:'Debes redactar tu solicitud' });
    return;
  }

  const resumenHtml = [
    '<b>Nombre:</b> ' + (nombre || 'No Ingresado'),
    '<b>Secretar√≠a:</b> ' + (secretaria || 'No Ingresado'),
    '<b>Contrato:</b> ' + (contrato || 'No Ingresado'),
    '<b>Telefono:</b> ' + (telefono || 'No Ingresado'),
    '<b>Solicitud:</b><br>' + (solicitud || 'No Ingresado')
  ].join('<br><br>');

  const rs = await Swal.fire({
    icon:'info',
    title:'Resumen de Solicitud',
    html: resumenHtml,
    showCancelButton:true,
    confirmButtonText:'Confirmar',
    cancelButtonText:'Editar',
    soundTag:'resumen'
  });

  if(!rs.isConfirmed) return;

  try{
    const r = await apiPost('guardarSolicitudTesoreria', {
      documento: currentUser.documento,
      nombre,
      secretaria,
      contrato,
      telefono,
      solicitud
    });

    if(!r || !r.success){
      Swal.fire({ icon:'error', title:'Error al guardar', text: r && r.message ? r.message : 'Intenta nuevamente.' });
      return;
    }

      // Enviar mensaje WhatsApp (igual que Prensa y Soporte)
    const tel = normalizeNumber57(telefono);
    if(tel){
      const msg =
        'Estimado(a) *' + (nombre || '') + '*\n\n' +
        'Hemos recibido tu solicitud y la revisaremos en el menor tiempo posible.\n' +
        'Agradecemos tu comprensi√≥n en nuestros tiempos de respuesta seg√∫n demanda.\n\n' +
        'Cordialmente;\n\n' +
        '*Tesorer√≠a*\n' +
        '> Alcald√≠a de Flandes';

      sendBuilderbotMessage(tel, msg);
    }

    Swal.fire({
      icon:'success',
      title:'SOLITUD REGISTRADA',
      text:'Ser√° respondida, seg√∫n los tiempos y demanda de solicitudes.',
      timer:5000,
      showConfirmButton:false
    });

    showView('view-inicio');
  }catch(e){
    Swal.fire({ icon:'error', title:'Error', text:String(e.message||e) });
  }
});
  
/* ================== FECHAS: modales (Cumple y Contrato 2026) ================== */
  // Estado exclusivo para personales
let __cumpleISO_personales = ''; // dd/mm/yyyy

// Inicializador selectores b√°sicos (puedes reutilizar si ya est√° initPickerBase)
(function initPickerCumplePersonales(){
  const dSel = document.getElementById('pCumpleDia');
  const mSel = document.getElementById('pCumpleMes');
  const aSel = document.getElementById('pCumpleAnio');
  if(dSel && !dSel.childElementCount){
    for(let d=1; d<=31; d++){
      const opt=document.createElement('option');
      opt.value=String(d).padStart(2,'0');
      opt.textContent=opt.value;
      dSel.appendChild(opt);
    }
  }
  if(mSel && !mSel.childElementCount){
    const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){
      const opt=document.createElement('option');
      opt.value=String(i+1).padStart(2,'0');
      opt.textContent=mesesNombres[i];
      mSel.appendChild(opt);
    }
  }
  if(aSel && !aSel.childElementCount){
    // Mismo rango que registro: 1936..2008 (aj√∫stalo si deseas)
    for(let y=1936;y<=2008;y++){
      const opt=document.createElement('option');
      opt.value=String(y);
      opt.textContent=String(y);
      aSel.appendChild(opt);
    }
  }
})();

function abrirPickerCumplePersonales(){
  const m=document.getElementById('pCumpleModal');
  if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
}
function cancelarPickerCumplePersonales(){
  const m=document.getElementById('pCumpleModal');
  if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
function confirmarPickerCumplePersonales(){
  const dSel=document.getElementById('pCumpleDia')?.value||'01';
  const mSel=document.getElementById('pCumpleMes')?.value||'01';
  const aSel=document.getElementById('pCumpleAnio')?.value||'2000';
  const val = `${dSel}/${mSel}/${aSel}`;
  __cumpleISO_personales = val;
  const p  = document.getElementById('p-cumple'); if(p) p.value = val;
  cancelarPickerCumplePersonales();
}

// En el guardado de personales, aseg√∫rate de usar __cumpleISO_personales:
/// body.cumpleISO: __cumpleISO_personales || ''
  
let __cumpleISO = ''; // dd/mm/yyyy
function initPickerBase(dSelId, mSelId, aSelId, years){
  const dSel = document.getElementById(dSelId);
  const mSel = document.getElementById(mSelId);
  const aSel = aSelId ? document.getElementById(aSelId) : null;
  if(dSel && !dSel.childElementCount){
    for(let d=1; d<=31; d++){ const opt=document.createElement('option'); opt.value=String(d).padStart(2,'0'); opt.textContent=opt.value; dSel.appendChild(opt); }
  }
  if(mSel && !mSel.childElementCount){
    const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){ const opt=document.createElement('option'); opt.value=String(i+1).padStart(2,'0'); opt.textContent=mesesNombres[i]; mSel.appendChild(opt); }
  }
  if(aSel && !aSel.childElementCount){
    years.forEach(y=>{ const opt=document.createElement('option'); opt.value=String(y); opt.textContent=String(y); aSel.appendChild(opt); });
  }
}
// Cumple: a√±os 1936..2008
(function(){ const ys=[]; for(let y=1936;y<=2008;y++) ys.push(y); initPickerBase('cumpleDia','cumpleMes','cumpleAnio', ys); })();
function abrirPickerCumple(){
  const m=document.getElementById('cumpleModal');
  if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
}
function cancelarPickerCumple(){
  const m=document.getElementById('cumpleModal');
  if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
function confirmarPickerCumple(){
  const dSel=document.getElementById('cumpleDia')?.value||'01';
  const mSel=document.getElementById('cumpleMes')?.value||'01';
  const aSel=document.getElementById('cumpleAnio')?.value||'2000';
  const val = `${dSel}/${mSel}/${aSel}`;
  __cumpleISO = val;
  const reg = document.getElementById('reg-cumple'); if(reg) reg.value = val;
  const p  = document.getElementById('p-cumple');    if(p)  p.value = val;
  cancelarPickerCumple();
}
// Contrato: a√±o fijo 2026; reutilizable para inicio/termino
(function(){ initPickerBase('contratoDia','contratoMes',null,[]); })();
let __pickerContratoTarget = null; // 'inicio'|'termino'
let __fechaInicioISO = ''; // dd/mm/2026
let __fechaTerminoISO = '';
function abrirPickerContrato(target){
  __pickerContratoTarget = target;
  const m=document.getElementById('contratoFechaModal');
  if(m){ m.style.display='flex'; m.setAttribute('aria-hidden','false'); }
}
function cancelarPickerContrato(){
  const m=document.getElementById('contratoFechaModal');
  if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
function confirmarPickerContrato(){
  const dSel=document.getElementById('contratoDia')?.value||'01';
  const mSel=document.getElementById('contratoMes')?.value||'01';
  const anio='2026';
  const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
  const idx=Math.max(1,Math.min(12,parseInt(mSel,10)))-1;
  const mesNombre = mesesNombres[idx];

  if(__pickerContratoTarget==='inicio'){
    document.getElementById('c-fechaInicio').value = `${dSel}/${mSel}/${anio}`;
    document.getElementById('c-diaInicio').value   = dSel;
    document.getElementById('c-mesInicio').value   = mesNombre;
    __fechaInicioISO = `${dSel}/${mSel}/${anio}`;
  }else if(__pickerContratoTarget==='termino'){
    document.getElementById('c-fechaTermino').value = `${dSel}/${mSel}/${anio}`;
    document.getElementById('c-diaTermino').value   = dSel;
    document.getElementById('c-mesTermino').value   = mesNombre;
    __fechaTerminoISO = `${dSel}/${mSel}/${anio}`;
  }
  cancelarPickerContrato();
  calcularPlazo();
}

 function icPad2(n){ return String(n).padStart(2,'0'); }
const icMesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
let __icRadMonth = '';
let __icRadYear  = '';

// 1) Inicio (ruleta libre, a√±o fijo 2026)
(function icInitInicio(){
  const d = document.getElementById('icInicioDia');
  const m = document.getElementById('icInicioMes');
  if (d && !d.childElementCount){
    for(let i=1;i<=31;i++){ const o=document.createElement('option'); o.value=icPad2(i); o.textContent=o.value; d.appendChild(o); }
  }
  if (m && !m.childElementCount){
    for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=icPad2(i+1); o.textContent=icMesesNombres[i]; m.appendChild(o); }
  }
})();
function icAbrirInicio(){
  const modal = document.getElementById('icInicioModal');
  if(modal){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
}
function icCancelarInicio(){
  const modal = document.getElementById('icInicioModal');
  if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
}
function icConfirmarInicio(){
  const dia = document.getElementById('icInicioDia')?.value || '';
  const mes = document.getElementById('icInicioMes')?.value || '';
  if(!dia || !mes){ showPickerSelectAlert(); return; }

  const anio = '2026';
  const idx = Math.max(1,Math.min(12,parseInt(mes,10))) - 1;
  const mesNombre = icMesesNombres[idx];
  const input = document.getElementById('ic-inicio');
  const dOut  = document.getElementById('ic-diaRat1');
  const mOut  = document.getElementById('ic-mesRat1');
  if(input) input.value = `${dia}/${mes}/${anio}`;
  if(dOut) dOut.value = dia;
  if(mOut) mOut.value = mesNombre;
  icCancelarInicio();
}


// 2) Fin (ruleta libre, a√±o fijo 2026)
(function icInitFin(){
  const d = document.getElementById('icFinDia');
  const m = document.getElementById('icFinMes');
  if (d && !d.childElementCount){
    for(let i=1;i<=31;i++){ const o=document.createElement('option'); o.value=icPad2(i); o.textContent=o.value; d.appendChild(o); }
  }
  if (m && !m.childElementCount){
    for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=icPad2(i+1); o.textContent=icMesesNombres[i]; m.appendChild(o); }
  }
})();
function icAbrirFin(){
  const modal = document.getElementById('icFinModal');
  if(modal){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
}
function icCancelarFin(){
  const modal = document.getElementById('icFinModal');
  if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
}
function icConfirmarFin(){
  const dia = document.getElementById('icFinDia')?.value || '';
  const mes = document.getElementById('icFinMes')?.value || '';
  if(!dia || !mes){ showPickerSelectAlert(); return; }

  const anio = '2026';
  const idx = Math.max(1,Math.min(12,parseInt(mes,10))) - 1;
  const mesNombre = icMesesNombres[idx];
  const input = document.getElementById('ic-fin');
  const dOut  = document.getElementById('ic-diaRat2');
  const mOut  = document.getElementById('ic-mesRat2');
  if(input) input.value = `${dia}/${mes}/${anio}`;
  if(dOut) dOut.value = dia;
  if(mOut) mOut.value = mesNombre;
  icCancelarFin();
}

// 3) Radicado (hoy + 2 h√°biles; feriados no h√°biles, excepci√≥n diciembre habilita todos excepto feriados)
const IC_FERIADOS_2026 = new Set(['23/03/2026','02/04/2026','03/04/2026','01/05/2026','18/05/2026','08/06/2026','15/06/2026','29/06/2026','20/07/2026','07/08/2026','17/08/2026','12/10/2026','02/11/2026','16/11/2026','08/12/2026','25/11/2026']);
function icEsHabil(d){
  const dd = icPad2(d.getDate());
  const mm = icPad2(d.getMonth() + 1);
  const yy = d.getFullYear();
  const key = `${dd}/${mm}/${yy}`;
  const dow = d.getDay(); // 0: domingo, 6: s√°bado

  // Nunca permite s√°bados ni domingos
  if (dow === 0 || dow === 6) return false;

  // Nunca permite d√≠as marcados como festivos
  if (IC_FERIADOS_2026.has(key)) return false;

  // Todo lo dem√°s es h√°bil
  return true;
}
function icAbrirRadicado(){
  const m = document.getElementById('icRadicadoModal');
  const dSel = document.getElementById('icRadDia');
  const mSel = document.getElementById('icRadMes');
  const aSel = document.getElementById('icRadAnio');
  if(!m || !dSel || !mSel || !aSel) return;

  // Reset options
  dSel.innerHTML = '';
  mSel.innerHTML = '';
  aSel.innerHTML = '';

  const hoy = new Date();
  const opciones = [];
  let count = 0;
  let cursor = new Date(hoy);

  // hoy + 2 h√°biles (diciembre: todos h√°biles salvo feriados)
  while(count<3){
    if(icEsHabil(cursor)){
      opciones.push(new Date(cursor));
      count++;
    }
    cursor.setDate(cursor.getDate()+1);
  }

  // Mes/A√±o fijados por la primera opci√≥n
  const d0 = opciones[0];
  __icRadYear  = String(d0.getFullYear());
  __icRadMonth = icPad2(d0.getMonth()+1);

  const optM = document.createElement('option');
  optM.value = __icRadMonth;
  optM.textContent = icMesesNombres[d0.getMonth()];
  mSel.appendChild(optM);

  const optY = document.createElement('option');
  optY.value = __icRadYear;
  optY.textContent = __icRadYear;
  aSel.appendChild(optY);

  // D√≠as posibles
  opciones.forEach(d=>{
    const opt = document.createElement('option');
    opt.value = icPad2(d.getDate());
    opt.textContent = icPad2(d.getDate());
    dSel.appendChild(opt);
  });
  // por seguridad, selecciona el primer d√≠a
  if (dSel.options.length) dSel.selectedIndex = 0;

  m.style.display='flex';
  m.setAttribute('aria-hidden','false');
}
function icCancelarRadicado(){
  const m=document.getElementById('icRadicadoModal');
  if(m){ m.style.display='none'; m.setAttribute('aria-hidden','true'); }
}
  
async function icConfirmarRadicado(){
  const dSel = document.getElementById('icRadDia');
  const mSel = document.getElementById('icRadMes');
  const aSel = document.getElementById('icRadAnio');

  const dia  = (dSel?.value || '').trim();
  const mes  = (mSel?.value || __icRadMonth || '').trim();
  const anio = (aSel?.value || __icRadYear  || '').trim();

  // Validaci√≥n: la fecha de radicaci√≥n no puede estar dentro del periodo relacionado
  const inicioVal = document.getElementById('ic-inicio')?.value || '';
  const finVal    = document.getElementById('ic-fin')?.value    || '';
  const selVal    = `${dia}/${mes}/${anio}`;

  function parseDMY(str){
    const [d,m,y] = str.split('/').map(Number);
    if(!d || !m || !y) return null;
    return new Date(y, m - 1, d);
  }

  const dInicio   = parseDMY(inicioVal);
  const dFin      = parseDMY(finVal);
  const dFechaSel = parseDMY(selVal); // renombrado para no chocar con dSel

  // Impide Fecha de Radicaci√≥n en medio de Periodo Relacionado
  if (dInicio && dFin && dFechaSel && dFechaSel >= dInicio && dFechaSel <= dFin){
    await Swal.fire({
      icon: 'info',
      title: 'NO PUEDES RADICAR EN ESTA FECHA',
      html: 'La Fecha de radicaci√≥n seleccionada no puede estar dentro del periodo relacionado<br>Debes seleccionar al menos un (1) d√≠a h√°bil despu√©s de la Fecha de Fin de Periodo relacionado',
      confirmButtonText: 'OK'
    });
    const input = document.getElementById('ic-radicado');
    const dOut  = document.getElementById('ic-diaRad');
    const mOut  = document.getElementById('ic-mesRad');
    if(input) input.value = '';
    if(dOut)  dOut.value  = '';
    if(mOut)  mOut.value  = '';
    icCancelarRadicado();
    return;
  }

  if(!dia || !mes || !anio){ showPickerSelectAlert(); return; }

  const idx = Math.max(1,Math.min(12,parseInt(mes||'1',10))) - 1;
  const mesNombre = icMesesNombres[idx] || '';

  const input = document.getElementById('ic-radicado');
  const dOut  = document.getElementById('ic-diaRad');
  const mOut  = document.getElementById('ic-mesRad');

  if(input){
    input.value = `${dia}/${mes}/${anio}`;
    if(dOut) dOut.value = dia;
    if(mOut) mOut.value = mesNombre;
  }
  icCancelarRadicado();
}

  // FECHA PLAN DE PAGOS
  let PLANPAGO_STATE = { informe:'', supervisor:'', grupo:'', nombre:'', contrato:'', pago:'' };

(function initPickerPago(){
  const d = document.getElementById('pagoDia');
  const m = document.getElementById('pagoMes');
  if(d && !d.childElementCount){
    for(let i=1;i<=31;i++){ const o=document.createElement('option'); o.value=String(i).padStart(2,'0'); o.textContent=o.value; d.appendChild(o); }
  }
  if(m && !m.childElementCount){
    const mesesNombres=['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
    for(let i=0;i<12;i++){ const o=document.createElement('option'); o.value=String(i+1).padStart(2,'0'); o.textContent=mesesNombres[i]; m.appendChild(o); }
  }
})();
function abrirPickerPago(){
  const modal=document.getElementById('pagoModal');
  if(modal){ modal.style.display='flex'; modal.setAttribute('aria-hidden','false'); }
}
function cancelarPickerPago(){
  const modal=document.getElementById('pagoModal');
  if(modal){ modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
}
function confirmarPickerPago(){
  const dSel=document.getElementById('pagoDia')?.value||'01';
  const mSel=document.getElementById('pagoMes')?.value||'01';
  const val = `${dSel}/${mSel}/2026`;
  const input=document.getElementById('pago');
  if(input) input.value = val;
  cancelarPickerPago();
}

 /* ================== FECHA ACTUAL Y HORA PARA MENSAJE ================== */
function esHorarioHabilAhora(){
  const ahora = new Date();
  const dow = ahora.getDay(); // 0 Domingo, 6 S√°bado
  if(dow === 0 || dow === 6) return false;
  const hora = ahora.getHours() + (ahora.getMinutes()/60);
  if(hora < 6 || hora >= 20) return false; // RANGO HORARIO PARA REPORTAR
  const dd = String(ahora.getDate()).padStart(2,'0');
  const mm = String(ahora.getMonth()+1).padStart(2,'0');
  const yy = String(ahora.getFullYear());
  const clave = `${dd}/${mm}/${yy}`;
  // Reutiliza el set de feriados ya definido: IC_FERIADOS_2026
  if(typeof IC_FERIADOS_2026 !== 'undefined' && IC_FERIADOS_2026.has(clave)) return false;
  return true;
}

  /* ================== CUENTA DRIVE ================== */

 document.getElementById('go-cuenta-drive')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }

  try{
    const res = await apiGet('getCuentaDrive', { documento: currentUser.documento });
    if(!res || !res.found){
      await Swal.fire({
        icon:'info',
        title:'NO HAZ INGRESADO CUENTAS',
        text:'Esta opci√≥n se toma despu√©s de Ingresar una Cuenta',
        timer:4000,
        showConfirmButton:false
      });
      return;
    }

    const estado = String(res.estado||'').toUpperCase();
    const folderId = String(res.folderId||'').trim();
    const openFolder = ()=>{ if(folderId){ window.open('https://drive.google.com/drive/folders/' + folderId, '_blank'); } };

    const estadosValidos = ['INGRESADA','INCOMPLETA','APROBADA'];
    if(estadosValidos.indexOf(estado) === -1){
      await Swal.fire({
        icon:'info',
        title:'OPCI√ìN NO VALIDA POR AHORA',
        text:'Solo ver√°s esta opci√≥n en estado: INGRESADA, INCOMPLETA y/o APROBADA',
        timer:5000,
        showConfirmButton:false
      });
      return;
    }

    if(estado === 'APROBADA'){
      const r = await Swal.fire({
        icon:'success',
        title:'DESCARGA TUS DOCUMENTOS',
        html:'Unificalos gui√°ndote con la explicaci√≥n en <b>TUTORIALES DE USO</b><br>Ya solo falta el cargue en el SECOP II',
        confirmButtonText:'OK'
      });
      if(r.isConfirmed) openFolder();
      return;
    }

    if(estado === 'INCOMPLETA'){
      const r = await Swal.fire({
        icon:'info',
        title:'COMPLETA TUS DOCUMENTOS',
        text:'Despu√©s de completar, recuerda de nuevo tomar la opci√≥n REPORTAR CUENTA DRIVE en el Men√∫ Principal',
        confirmButtonText:'OK'
      });
      if(r.isConfirmed) openFolder();
      return;
    }

    if(estado === 'REPORTADA'){
      const r = await Swal.fire({
        icon:'info',
        title:'YA REPORTASTE TU CUENTA',
        html:'Ahora debes esperar que tu Supervisor la Revise<br><br>Si la Reportaste sin revisar o completar los Documentos, evita este reproceso en el pr√≥ximo reporte.',
        confirmButtonText:'OK'
      });
      if(r.isConfirmed) openFolder();
      return;
    }

    if(estado === 'INGRESADA'){
      const r = await Swal.fire({
        icon:'info',
        title:'REVISA TUS DOCUMENTOS',
        html:'Verifica que los Datos est√©n correctos y completos.<br><br>Para realizar correctamente este proceso, revisa en el bot√≥n GUIA, <b>TUTORIALES DE USO</b>',
        confirmButtonText:'IR A MI CARPETA DRIVE'
      });
      if(r.isConfirmed) openFolder();
      return;
    }
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});

    /* ================== REPORTAR CUENTA DRIVE ================== */

  document.getElementById('go-reportar-drive')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');
  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'}); 
    return;
  }
  if(!esHorarioHabilAhora()){
    Swal.fire({
      icon:'info',
      title:'HORARIO NO H√ÅBIL',
      text:'Debes Reportar tu Cuenta entre 6:01 AM y 7:59 PM de Lunes a Viernes (No Festivos)',
      timer:6000,
      showConfirmButton:false
    });
    return;
  }
  try{
    const res = await apiGet('reportarCuentaDrive', { documento: currentUser.documento });
    if(!res || !res.found){
      Swal.fire({icon:'info', title:'NO PUEDES REPORTAR', text:'Primero debes Ingresar un Cuenta', timer:3000, showConfirmButton:false});
      return;
    }
    const estado = String(res.estadoBJ||'').toUpperCase();
    if(['INGRESADA','INCOMPLETA'].indexOf(estado) === -1){
      Swal.fire({
        icon:'info',
        title:'NO HAY CUENTAS PARA REPORTAR',
        text:'No puedes reportar la cuenta 2 veces o Tomar esta opci√≥n si tu Cuenta est√° en otro estado de revisi√≥n',
        timer:6000,
        showConfirmButton:false
      });
      return;
    }
    const informe   = res.informe || '';
    const supervisor= res.supervisor || '';
    const grupo     = res.grupo || '';
    const nombre    = res.nombre || '';
    const contrato  = res.contrato || '';
    const msg =
      '> REPORTE DE CUENTA üìÅ\n' +
      'Estimado(a) *'+supervisor+'*' + '\n\n' +
      '¬°El contratista *'+nombre+'* ha reportado la *Cuenta N¬∞ '+informe+'* del *Contrato '+contrato+'*' + '\n\n' +
      'Ingresa a la App para visualizar';

const r = await Swal.fire({
  icon:'success',
  title: `ANTES DE REPORTAR TU CUENTA ${informe}`,
  html: `Corrobora que tus Documentos est√©n:<br><br>Completos (Incluyendo Planilla, Baucher de Pago, Documentos anexos solicitados Si Aplica)<br><br>Revisados uno a uno para evitar reprocesos (No Resportes sin Revisar)`,
  showCancelButton: true,
  confirmButtonText: 'REPORTAR',
  cancelButtonText: 'CANCELAR'
});
if(!r.isConfirmed){
  showView('view-inicio');
  return;
}
    if(grupo) sendBuilderbotMessage(grupo, msg);
    await apiPost('marcarCuentaReportada', { documento: currentUser.documento });
    await Swal.fire({icon:'success', title:'Cuenta reportada', timer:2500, showConfirmButton:false});
    showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});

  /* ================== REPORTAR PLAN DE PAGOS ================== */

 document.getElementById('go-reportar-plan')?.addEventListener('click', async ()=>{
  playSoundOnce(SOUNDS.login);
  overlay.classList.remove('open');

  if(!currentUser){
    Swal.fire({icon:'warning', title:'Sesi√≥n inv√°lida'});
    return;
  }

  if(!esHorarioHabilAhora()){
    Swal.fire({
      icon:'info',
      title:'HORARIO NO H√ÅBIL',
      text:'Debes Reportar Plan de Pagos entre 6:01 AM y 7:59 PM de Lunes a Viernes (No Festivos)',
      timer:6000,
      showConfirmButton:false
    });
    return;
  }

  try{
    const res = await apiGet('reportarPlanPagos', { documento: currentUser.documento });

    // Si NO encontr√≥ registros (o no encontr√≥ ninguna APROBADA)
    if(!res || res.found === false){
      Swal.fire({
        icon:'info',
        title:'NO HAY REGISTROS',
        text:'Esta opci√≥n se toma posterior a la Aprobaci√≥n de una cuenta',
        timer:5000,
        showConfirmButton:false
      });
      return;
    }

    const estado = String(res.estadoBJ||'').toUpperCase();

    // Por seguridad (aunque backend ya devuelve solo APROBADA)
    if(estado !== 'APROBADA'){
      Swal.fire({
        icon:'info',
        title:'NO HAY REGISTROS',
        text:'Esta opci√≥n se toma posterior a la Aprobaci√≥n de una cuenta',
        timer:5000,
        showConfirmButton:false
      });
      return;
    }

    // Variables para el mensaje
    const informe = res.informe || '';
    const supervisor = res.supervisor || '';
    const grupo = res.grupo || '';
    const nombre = res.nombre || '';
    const contrato = res.contrato || '';

    // BI (egreso): si viene vac√≠o => "Primera Cuenta"
    let egreso = (res.egreso || '').toString().trim();
    if(!egreso) egreso = 'Primera Cuenta';

    const r = await Swal.fire({
      icon:'success',
      title:`ANTES DE REPORTAR EL PLAN DE PAGOS ${informe}`,
      html:`Corrobora lo siguiente en el Secop II:<br><br>1. Subida de Cuenta Unificada a Plan de Pagos<br>2. Planilla Validada correctamente<br>3. Estado Enviado a la entidad<br><br>¬°Evita los Reprocesos!`,
      showCancelButton:true,
      confirmButtonText:'REPORTAR',
      cancelButtonText:'CANCELAR'
    });

    if(!r.isConfirmed){
      showView('view-inicio');
      return;
    }

    const msg =
  '> PLAN DE PAGOS üñ•\n' +
  'Estimado(a) *'+supervisor+'*' + '\n\n' +
  '¬°El contratista *'+nombre+'* ha reportado el *PLAN DE PAGOS de la Cuenta N¬∞ '+informe+'* del *Contrato '+contrato+'*' + '\n' +
  '> Egreso: *'+egreso+'*' + '\n\n' +
  'Ingresa a la App para visualizar';

if(grupo) sendBuilderbotMessage(grupo, msg);

await apiPost('guardarPlanPagosReporte', { documento: currentUser.documento, pago: egreso });

await Swal.fire({icon:'success', title:'Plan de Pagos reportado', timer:2500, showConfirmButton:false});
showView('view-inicio');
  }catch(e){
    Swal.fire({icon:'error', title:'Error', text:String(e.message||e)});
  }
});
  
/* ================== FIN ================== */
</script>
</body>
</html>
